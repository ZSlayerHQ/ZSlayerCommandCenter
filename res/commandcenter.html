<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZSlayerHQ Command Center</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-base: #080808;
  --bg-dark: #0c0c0c;
  --bg-mid: #131310;
  --bg-panel: #181814;
  --bg-card: #1c1b17;
  --bg-hover: #242219;
  --bg-input: #0e0e0c;
  --bg-elevated: #201f1a;
  --border: #2a2620;
  --border-light: #3a3530;
  --border-focus: #5a4a30;
  --border-subtle: #1f1d18;
  --text: #c8bfa8;
  --text-dim: #6a6050;
  --text-bright: #e8e0d0;
  --text-white: #f0ece4;
  --text-muted: #4a4438;
  --accent: #c8aa6e;
  --accent-dim: #a08a50;
  --accent-bright: #e0c882;
  --accent-glow: rgba(200, 170, 110, 0.12);
  --accent-glow-strong: rgba(200, 170, 110, 0.25);
  --success: #4a7c4a;
  --success-bright: #6aad6a;
  --error: #8b3a3a;
  --error-bright: #c45050;
  --warning: #c87a3e;
  --font-display: 'Rajdhani', 'Segoe UI', sans-serif;
  --font-mono: 'Share Tech Mono', 'Consolas', monospace;
  --font-body: 'Rajdhani', -apple-system, sans-serif;
  --radius: 2px;
  --radius-md: 4px;
  --radius-lg: 6px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 12px 48px rgba(0,0,0,0.6);
  --shadow-glow: 0 0 20px rgba(200,170,110,0.08);
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  background: var(--bg-base);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
  font-size: 15px;
  font-weight: 500;
}

/* ── Scrollbar ── */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--bg-dark); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

/* ══════════════════════════════════════════════════════════
   HEADER
   ══════════════════════════════════════════════════════════ */
.header {
  background: linear-gradient(180deg, #141310 0%, #0f0e0c 100%);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,0.4);
}

.header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, var(--accent-dim) 50%, transparent 100%);
  opacity: 0.3;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.header-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-logo-icon {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
  border-radius: 3px;
  box-shadow: 0 0 12px rgba(200,170,110,0.2);
}

.header-logo-icon svg { width: 16px; height: 16px; color: #0a0a0a; }

.header-title {
  font-family: var(--font-mono);
  font-size: 15px;
  color: var(--accent);
  letter-spacing: 3px;
  text-transform: uppercase;
  text-shadow: 0 0 20px rgba(200,170,110,0.15);
}

.header-sep { width: 1px; height: 22px; background: var(--border); }

.header-social {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: 8px;
}
.header-social a {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 30px;
  height: 30px;
  border-radius: var(--radius-md);
  color: var(--text-dim);
  transition: color 0.15s, background 0.15s;
  text-decoration: none;
}
.header-social a:hover {
  color: var(--accent);
  background: var(--accent-glow);
}
.header-social a svg { width: 18px; height: 18px; }

.header-version {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  padding: 2px 8px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
}

.header-profile {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 13px;
}

.profile-status {
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-dot {
  width: 7px; height: 7px;
  background: var(--success-bright);
  border-radius: 50%;
  display: inline-block;
  box-shadow: 0 0 8px var(--success-bright);
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--success-bright); }
  50% { opacity: 0.7; box-shadow: 0 0 4px var(--success-bright); }
}

.profile-label { color: var(--text-dim); font-size: 12px; font-family: var(--font-mono); }
.profile-name-display { color: var(--accent-bright); font-weight: 700; font-size: 14px; }

/* ══════════════════════════════════════════════════════════
   NAVIGATION BAR (14 tabs)
   ══════════════════════════════════════════════════════════ */
.nav-bar {
  display: none;
  background: var(--bg-dark);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  position: sticky;
  top: 52px;
  z-index: 99;
  scrollbar-width: thin;
}
.nav-bar::-webkit-scrollbar { height: 3px; }

.nav-bar-inner {
  display: inline-flex;
  gap: 0;
  min-width: 100%;
}

.nav-btn {
  padding: 10px 16px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-dim);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-mono);
  white-space: nowrap;
  position: relative;
  flex-shrink: 0;
}
.nav-btn:hover { color: var(--text); background: rgba(200,170,110,0.03); }
.nav-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}
.nav-btn.disabled {
  opacity: 0.4;
  cursor: default;
}
.nav-btn.disabled:hover {
  color: var(--text-dim);
  background: none;
}
.nav-btn .nav-lock {
  display: inline-block;
  width: 10px;
  height: 10px;
  margin-left: 4px;
  opacity: 0.5;
  vertical-align: middle;
}
.nav-btn .nav-lock svg { width: 10px; height: 10px; }

/* ── Buttons ── */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 7px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: var(--font-body);
  letter-spacing: 0.3px;
  white-space: nowrap;
  user-select: none;
  position: relative;
}
.btn:hover { background: var(--bg-hover); border-color: var(--border-light); color: var(--text-bright); }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }

.btn-accent {
  background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dim) 100%);
  border-color: var(--accent);
  color: #0a0a0a;
  font-weight: 700;
  text-shadow: 0 1px 0 rgba(255,255,255,0.1);
  box-shadow: 0 1px 4px rgba(200,170,110,0.2);
}
.btn-accent:hover { background: linear-gradient(180deg, var(--accent-bright) 0%, var(--accent) 100%); color: #0a0a0a; box-shadow: 0 2px 8px rgba(200,170,110,0.3); }

.btn-ghost { background: transparent; border-color: transparent; color: var(--text-dim); }
.btn-ghost:hover { background: var(--bg-hover); color: var(--text); border-color: var(--border); }

.btn-success { background: var(--success); border-color: var(--success-bright); color: #ddd; }
.btn-success:hover { background: var(--success-bright); color: #fff; }

.btn-danger { background: var(--error); border-color: var(--error-bright); color: #ddd; }
.btn-danger:hover { background: var(--error-bright); color: #fff; }

.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn-xs { padding: 3px 10px; font-size: 11px; }

/* ── Inputs ── */
input[type="text"], input[type="number"] {
  padding: 8px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-bright);
  font-size: 14px;
  font-family: var(--font-body);
  font-weight: 500;
  transition: border-color 0.15s, box-shadow 0.15s;
}
input:focus {
  outline: none;
  border-color: var(--accent-dim);
  box-shadow: 0 0 0 2px var(--accent-glow), inset 0 0 6px rgba(200,170,110,0.05);
}
input[type="number"] {
  width: 64px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 13px;
  -moz-appearance: textfield;
}
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

/* ══════════════════════════════════════════════════════════
   HERO BANNER
   ══════════════════════════════════════════════════════════ */
.hero-banner {
  position: relative;
  height: 180px;
  background: linear-gradient(135deg, #0a0a08 0%, #1a1710 30%, #12100c 70%, #0a0a08 100%);
  border-bottom: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.hero-bg-grid {
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(rgba(200,170,110,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(200,170,110,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
}

.hero-bg-radial {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 50%, rgba(200,170,110,0.06) 0%, transparent 60%);
}

.hero-placeholder {
  position: relative;
  z-index: 1;
  text-align: center;
  padding: 20px;
}

.hero-placeholder-inner {
  border: 1px dashed var(--border-light);
  padding: 16px 32px;
  border-radius: var(--radius-md);
  background: rgba(0,0,0,0.3);
}

.hero-placeholder-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
}

.hero-placeholder-icon svg { width: 32px; height: 32px; color: var(--text-muted); }

.hero-placeholder-text {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 1px;
  text-transform: uppercase;
}

.hero-placeholder-sub {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  opacity: 0.5;
  margin-top: 4px;
}

.hero-image {
  position: absolute;
  inset: 0;
  object-fit: cover;
  width: 100%;
  height: 100%;
  display: none;
  z-index: 1;
}

.hero-scanline {
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
  pointer-events: none;
  z-index: 2;
}

.hero-vignette {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 30%, rgba(8,8,8,0.8) 100%);
  pointer-events: none;
  z-index: 3;
}

.hero-bottom-fade {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 40px;
  background: linear-gradient(transparent, var(--bg-base));
  z-index: 4;
}

/* ══════════════════════════════════════════════════════════
   LOGIN
   ══════════════════════════════════════════════════════════ */
.login-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg-base);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
}

.login-bg {
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse at 30% 40%, rgba(200,170,110,0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 60%, rgba(200,170,110,0.03) 0%, transparent 50%);
}

.login-box {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 44px;
  width: 420px;
  max-width: 90vw;
  position: relative;
  box-shadow: var(--shadow-lg), var(--shadow-glow);
}

.login-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent 10%, var(--accent) 50%, transparent 90%);
}

.login-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 24px;
}

.login-logo-icon {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
  border-radius: 4px;
  box-shadow: 0 0 16px rgba(200,170,110,0.25);
}

.login-logo-icon svg { width: 20px; height: 20px; color: #0a0a0a; }

.login-logo-text {
  font-family: var(--font-mono);
  font-size: 18px;
  color: var(--accent);
  letter-spacing: 3px;
  text-transform: uppercase;
}

.login-box p {
  color: var(--text-dim);
  font-size: 13px;
  margin-bottom: 24px;
  line-height: 1.7;
  text-align: center;
}

.form-group { margin-bottom: 16px; }

.form-group label {
  display: block;
  font-size: 11px;
  color: var(--text-dim);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-family: var(--font-mono);
}

.login-error {
  color: var(--error-bright);
  font-size: 13px;
  margin-top: 10px;
  display: none;
  text-align: center;
}

/* ══════════════════════════════════════════════════════════
   MAIN CONTAINER
   ══════════════════════════════════════════════════════════ */
.main-container {
  display: none;
  max-width: 1320px;
  margin: 0 auto;
  padding: 24px 32px 60px;
}

/* ── Main Tab Panels ── */
.main-tab-panel { display: none; }
.main-tab-panel.active { display: block; }

/* ── Sub-Tabs (within Items) ── */
.tab-bar {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 24px;
}

.tab-btn {
  padding: 12px 28px;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-mono);
  position: relative;
}
.tab-btn:hover { color: var(--text); background: rgba(200,170,110,0.03); }
.tab-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.tab-btn .badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px; height: 20px;
  padding: 0 6px;
  background: var(--accent);
  color: #0a0a0a;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 700;
  margin-left: 8px;
  font-family: var(--font-body);
}

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ══════════════════════════════════════════════════════════
   COMING SOON PLACEHOLDER
   ══════════════════════════════════════════════════════════ */
.coming-soon {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  text-align: center;
}

.coming-soon-icon {
  width: 64px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 20px;
}
.coming-soon-icon svg { width: 28px; height: 28px; color: var(--text-muted); }

.coming-soon h2 {
  font-family: var(--font-mono);
  font-size: 18px;
  color: var(--text-dim);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.coming-soon p {
  font-size: 14px;
  color: var(--text-muted);
  max-width: 400px;
  line-height: 1.7;
}

.coming-soon .phase-badge {
  margin-top: 16px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  padding: 3px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
}

/* ══════════════════════════════════════════════════════════
   DASHBOARD
   ══════════════════════════════════════════════════════════ */
.dash-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
.dash-grid .full-width { grid-column: 1 / -1; }
@media (max-width: 860px) { .dash-grid { grid-template-columns: 1fr; } }

.dash-widget {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
}
.dash-widget-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-card);
}
.dash-widget-title {
  font-family: var(--font-mono);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 8px;
}
.dash-widget-title svg { width: 14px; height: 14px; color: var(--accent-dim); }
.dash-widget-body { padding: 16px; }

.dash-stat-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 12px;
}
.dash-stat {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.dash-stat-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}
.dash-stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-bright);
  font-family: var(--font-display);
}
.dash-stat-value.sm { font-size: 14px; color: var(--text); }

.dash-player-list {
  max-height: 260px;
  overflow-y: auto;
}
.dash-player {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 13px;
}
.dash-player:last-child { border-bottom: none; }
.dash-player .online-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}
.dash-player .online-dot.on { background: var(--success-bright); box-shadow: 0 0 6px var(--success-bright); }
.dash-player .online-dot.off { background: var(--text-muted); }
.dash-player .p-name { flex: 1; color: var(--text); font-weight: 600; }
.dash-player .p-detail { color: var(--text-dim); font-family: var(--font-mono); font-size: 11px; }

.dash-bar-chart { display: flex; flex-direction: column; gap: 6px; }
.dash-bar-row { display: flex; align-items: center; gap: 10px; font-size: 12px; }
.dash-bar-label { width: 100px; text-align: right; color: var(--text-dim); font-family: var(--font-mono); font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.dash-bar-track { flex: 1; height: 16px; background: var(--bg-dark); border-radius: 2px; overflow: hidden; }
.dash-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 2px; transition: width 0.4s ease; }
.dash-bar-count { width: 36px; text-align: right; font-family: var(--font-mono); color: var(--text); font-size: 11px; }

.dash-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 16px;
}

/* Activity table */
.activity-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.activity-table th {
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
}
.activity-table td { padding: 8px 10px; border-bottom: 1px solid var(--border-subtle); color: var(--text-dim); }
.activity-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.activity-badge.ItemGive { background: rgba(106,173,106,0.15); color: var(--success-bright); }
.activity-badge.PresetGive { background: rgba(200,170,110,0.15); color: var(--accent); }
.activity-badge.Broadcast { background: rgba(100,150,200,0.15); color: #8ab4d8; }
.activity-badge.ServerStart { background: rgba(200,170,110,0.1); color: var(--text-dim); }
.activity-badge.ConfigChange { background: rgba(200,122,62,0.15); color: var(--warning); }

/* Console */
.console-panel {
  background: #0a0a0a;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-family: var(--font-mono);
  font-size: 12px;
  overflow: hidden;
}
.console-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border-subtle);
  cursor: pointer;
  user-select: none;
}
.console-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
}
.console-header-left svg { width: 14px; height: 14px; color: var(--accent-dim); }
.console-filters { display: flex; gap: 4px; }
.console-filter-btn {
  padding: 2px 8px;
  font-size: 10px;
  font-family: var(--font-mono);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.console-filter-btn.active { background: var(--bg-hover); color: var(--text); border-color: var(--border-light); }
.console-body {
  max-height: 350px;
  overflow-y: auto;
  padding: 8px 14px;
  line-height: 1.6;
}
.console-body.collapsed { display: none; }
.console-line { white-space: pre-wrap; word-break: break-all; }
.console-line .ts { color: var(--text-muted); margin-right: 8px; }
.console-line.level-info .msg { color: var(--text-dim); }
.console-line.level-success .msg { color: var(--success-bright); }
.console-line.level-warning .msg { color: var(--warning); }
.console-line.level-error .msg { color: var(--error-bright); }
.console-line.level-debug .msg { color: var(--text-muted); }
.console-line .src { color: var(--accent-dim); margin-right: 6px; }
.console-jump {
  display: none;
  position: sticky;
  bottom: 0;
  text-align: center;
  padding: 4px;
  background: rgba(10,10,10,0.9);
}
.console-jump button {
  font-size: 10px;
  font-family: var(--font-mono);
  padding: 3px 12px;
  background: var(--bg-hover);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-dim);
  cursor: pointer;
}
.console-search {
  padding: 0 14px 6px;
  display: none;
}
.console-search input {
  width: 100%;
  padding: 4px 10px;
  font-size: 11px;
  font-family: var(--font-mono);
  background: #111;
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  color: var(--text);
}

/* Broadcast modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 300;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 32px;
  width: 440px;
  max-width: 90vw;
  box-shadow: var(--shadow-lg);
}
.modal-box h3 {
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 16px;
}
.modal-box textarea {
  width: 100%;
  min-height: 80px;
  padding: 10px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-bright);
  font-family: var(--font-body);
  font-size: 14px;
  resize: vertical;
  margin-bottom: 16px;
}
.modal-box textarea:focus { outline: none; border-color: var(--accent-dim); }
.modal-box .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
.modal-box .form-row > * { flex: 1; }
.modal-box .form-row label { font-size: 12px; color: var(--text-dim); margin-bottom: 4px; display: block; }
.modal-box .form-row input, .modal-box .form-row select { width: 100%; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

/* ══════════════════════════════════════════════════════════
   PLAYER MANAGEMENT
   ══════════════════════════════════════════════════════════ */
.player-search-row {
  display: flex; gap: 10px; margin-bottom: 14px; align-items: center;
}
.player-search-row input {
  flex: 1; min-width: 0;
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
  padding: 8px 12px; font-size: 13px; border-radius: var(--radius); font-family: var(--font-body);
}
.player-search-row input:focus { outline: none; border-color: var(--accent-dim); }
.player-search-row select {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
  padding: 8px 12px; font-size: 13px; border-radius: var(--radius); font-family: var(--font-body);
}
.player-search-row select:focus { outline: none; border-color: var(--accent-dim); }

.player-table { width: 100%; border-collapse: collapse; }
.player-table th {
  font-family: var(--font-mono); font-size: 11px; text-transform: uppercase;
  color: var(--text-dim); padding: 8px 10px; text-align: left; cursor: pointer;
  border-bottom: 1px solid var(--border); user-select: none;
}
.player-table th:hover { color: var(--accent); }
.player-table th .sort-arrow { font-size: 10px; margin-left: 3px; }
.player-table td {
  padding: 8px 10px; font-size: 13px; border-bottom: 1px solid var(--border-subtle);
  color: var(--text);
}
.player-table tr:hover td { background: var(--bg-hover); }
.player-table tr.expanded td { background: var(--accent-glow); border-bottom-color: var(--accent-dim); }

.online-dot {
  display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 6px; vertical-align: middle;
}
.online-dot.on { background: var(--success-bright); box-shadow: 0 0 6px rgba(106,173,106,0.5); }
.online-dot.off { background: var(--text-muted); }

.ban-badge {
  font-size: 10px; color: var(--error-bright); background: rgba(139,58,58,0.25);
  padding: 1px 6px; border-radius: 8px; margin-left: 6px; font-family: var(--font-mono); text-transform: uppercase;
}

.player-detail-row td {
  padding: 0 !important; border-bottom: 2px solid var(--accent-dim);
}
.player-detail-inner {
  padding: 16px 14px; background: var(--bg-panel); border-left: 2px solid var(--accent);
}

.player-profile-tabs {
  display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 14px;
}
.player-profile-tabs .ptab {
  padding: 8px 18px; font-size: 12px; font-family: var(--font-mono); text-transform: uppercase;
  color: var(--text-dim); background: none; border: none; cursor: pointer;
  border-bottom: 2px solid transparent; letter-spacing: 0.5px;
}
.player-profile-tabs .ptab:hover { color: var(--text); }
.player-profile-tabs .ptab.active { color: var(--accent); border-bottom-color: var(--accent); }

.profile-panel { display: none; }
.profile-panel.active { display: block; }

.profile-header {
  display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 16px;
}
.profile-stat-card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md);
  padding: 12px 16px; min-width: 130px;
}
.profile-stat-card .psc-label {
  font-size: 10px; color: var(--text-dim); font-family: var(--font-mono); text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 4px;
}
.profile-stat-card .psc-value {
  font-size: 18px; font-weight: 700; color: var(--text-bright); font-family: var(--font-display);
}
.profile-stat-card .psc-value.accent { color: var(--accent); }
.profile-stat-card .psc-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

.xp-bar {
  height: 6px; background: var(--bg-input); border-radius: 3px; margin-top: 6px; overflow: hidden;
}
.xp-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s; }

.skill-bar {
  height: 4px; background: var(--bg-input); border-radius: 2px; flex: 1; overflow: hidden;
}
.skill-bar-fill { height: 100%; background: var(--accent-dim); border-radius: 2px; }

.status-badge {
  display: inline-block; font-size: 10px; padding: 2px 8px; border-radius: 8px;
  font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.5px;
}
.status-badge.active { background: rgba(200,170,110,0.15); color: var(--accent); }
.status-badge.completed, .status-badge.success { background: rgba(74,124,74,0.2); color: var(--success-bright); }
.status-badge.failed { background: rgba(139,58,58,0.2); color: var(--error-bright); }
.status-badge.locked { background: rgba(100,100,100,0.15); color: var(--text-dim); }

.quest-chevron { cursor: pointer; user-select: none; color: var(--text-dim); transition: transform 0.2s ease; display: inline-block; font-size: 11px; }
.quest-chevron.expanded { transform: rotate(90deg); color: var(--accent); }
.quest-detail-row td { padding: 0 !important; border-bottom: 1px solid var(--border-subtle); }
.quest-detail-inner { padding: 8px 12px 8px 24px; background: var(--bg-input); border-left: 2px solid var(--accent-dim); margin: 0 8px 0 0; }
.quest-condition { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 12px; }
.quest-condition .qc-icon { flex-shrink: 0; width: 14px; text-align: center; }
.quest-condition.completed .qc-icon { color: var(--success-bright); }
.quest-condition.pending .qc-icon { color: var(--text-dim); }
.quest-condition.completed .qc-text { color: var(--text-dim); }
.quest-condition.pending .qc-text { color: var(--text-muted); }
.quest-condition .qc-type { font-size: 10px; font-family: var(--font-mono); color: var(--text-dim); background: rgba(100,100,100,0.15); padding: 1px 5px; border-radius: 3px; }

/* Quest Browser */
.qb-map-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.qb-chip { padding: 4px 10px; font-size: 12px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-muted); cursor: pointer; transition: all 0.15s ease; font-family: var(--font-mono); }
.qb-chip:hover { border-color: var(--accent-dim); color: var(--text); }
.qb-chip.active { background: rgba(200,170,110,0.15); border-color: var(--accent); color: var(--accent); }
.qb-chip .qb-chip-count { font-size: 10px; color: var(--text-dim); margin-left: 3px; }
.qb-sortable { cursor: pointer; user-select: none; white-space: nowrap; }
.qb-sortable:hover { color: var(--accent); }
.qb-sort-arrow { font-size: 10px; color: var(--accent); margin-left: 2px; }
.qb-detail-row td { padding: 0 !important; border-bottom: 1px solid var(--border-subtle); }
.qb-detail-inner { padding: 10px 14px 10px 26px; background: var(--bg-input); border-left: 2px solid var(--accent-dim); }
.qb-detail-inner h4 { font-size: 11px; color: var(--text-dim); text-transform: uppercase; font-family: var(--font-mono); margin: 0 0 6px 0; letter-spacing: 0.5px; }
.qb-obj-list { margin: 0 0 12px 0; padding: 0; list-style: none; }
.qb-obj-item { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 12px; color: var(--text-muted); }
.qb-obj-item .qb-obj-type { font-size: 10px; font-family: var(--font-mono); color: var(--text-dim); background: rgba(100,100,100,0.15); padding: 1px 5px; border-radius: 3px; }
.qb-state-setter { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 4px; padding-top: 8px; border-top: 1px solid var(--border-subtle); }
.qb-state-setter select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); font-size: 12px; padding: 4px 8px; border-radius: 4px; }
.qb-state-setter label { font-size: 11px; color: var(--text-dim); font-family: var(--font-mono); text-transform: uppercase; }

.profile-mini-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.profile-mini-table th {
  font-size: 10px; color: var(--text-dim); font-family: var(--font-mono); text-transform: uppercase;
  padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border);
}
.profile-mini-table td { padding: 6px 8px; border-bottom: 1px solid var(--border-subtle); }

.player-actions-bar {
  display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap;
}

.ban-section {
  border-top: 1px solid var(--border); margin-top: 20px; padding-top: 14px;
}
.ban-section-header {
  cursor: pointer; display: flex; align-items: center; gap: 8px;
  font-family: var(--font-mono); font-size: 13px; text-transform: uppercase;
  color: var(--text-dim); letter-spacing: 0.5px; margin-bottom: 10px;
}
.ban-section-header:hover { color: var(--text); }
.ban-section-header .toggle-arrow { transition: transform 0.2s; }
.ban-section-header.collapsed .toggle-arrow { transform: rotate(-90deg); }
.ban-section-body { }
.ban-section-body.collapsed { display: none; }

.danger-btn {
  background: var(--error); color: var(--text-white); border: 1px solid var(--error-bright);
  padding: 6px 14px; font-size: 12px; font-family: var(--font-mono); text-transform: uppercase;
  border-radius: var(--radius); cursor: pointer; letter-spacing: 0.5px;
}
.danger-btn:hover { background: var(--error-bright); }
.danger-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.confirmation-input {
  background: var(--bg-input); border: 1px solid var(--error); color: var(--error-bright);
  padding: 8px 12px; font-size: 13px; font-family: var(--font-mono); border-radius: var(--radius);
  width: 100%; margin-top: 8px;
}
.confirmation-input:focus { outline: none; border-color: var(--error-bright); }

.faction-badge {
  font-size: 10px; padding: 2px 8px; border-radius: 8px; font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.faction-badge.bear { background: rgba(200,100,50,0.2); color: #e8a060; }
.faction-badge.usec { background: rgba(80,120,200,0.2); color: #80a8e8; }

.mail-item-row { display: flex; gap: 8px; margin-bottom: 6px; align-items: center; }
.mail-item-row input { flex: 1; min-width: 0; }
.mail-item-row .btn-sm { padding: 4px 8px; font-size: 11px; }

/* ══════════════════════════════════════════════════════════
   SEARCH & CATEGORY BAR
   ══════════════════════════════════════════════════════════ */
.search-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  align-items: stretch;
}

.search-input-wrap {
  flex: 1;
  position: relative;
}

.search-input-wrap .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px; height: 16px;
  color: var(--text-dim);
  pointer-events: none;
}

.search-input-wrap input {
  width: 100%;
  padding-left: 38px;
  padding-right: 12px;
}

/* ── Custom Category Dropdown ── */
.cat-dropdown {
  position: relative;
  width: 300px;
  flex-shrink: 0;
}

.cat-trigger {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 0 14px;
  height: 100%;
  min-height: 38px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-bright);
  font-size: 14px;
  font-family: var(--font-body);
  font-weight: 600;
  cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s;
  user-select: none;
}
.cat-trigger:hover { border-color: var(--border-light); }
.cat-trigger.open { border-color: var(--accent-dim); box-shadow: 0 0 0 2px var(--accent-glow); }

.cat-trigger .ct-icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.cat-trigger .ct-icon svg { width: 16px; height: 16px; color: var(--accent); }

.cat-trigger .ct-label { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.cat-trigger .ct-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-dim);
  background: rgba(200,170,110,0.08);
  padding: 2px 8px;
  border-radius: 8px;
  border: 1px solid rgba(200,170,110,0.12);
}

.cat-trigger .ct-chevron {
  width: 14px; height: 14px;
  color: var(--text-dim);
  transition: transform 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
}
.cat-trigger .ct-chevron svg { width: 14px; height: 14px; }
.cat-trigger.open .ct-chevron { transform: rotate(180deg); }

/* ── Dropdown Panel ── */
.cat-panel {
  display: none;
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  width: 360px;
  background: var(--bg-panel);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  z-index: 50;
  max-height: 480px;
  overflow: hidden;
  flex-direction: column;
}
.cat-panel.open { display: flex; }

.cat-panel-search {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-dark);
}

.cat-panel-search input {
  width: 100%;
  padding: 7px 12px 7px 32px;
  font-size: 13px;
  background: var(--bg-input);
}

.cat-panel-search .search-wrap {
  position: relative;
}

.cat-panel-search .search-wrap svg {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  color: var(--text-muted);
  pointer-events: none;
}

.cat-list {
  overflow-y: auto;
  flex: 1;
  padding: 6px 0;
}

.cat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: background 0.1s;
  font-size: 13px;
  color: var(--text);
  font-weight: 500;
  border-left: 2px solid transparent;
}
.cat-item:hover { background: var(--bg-hover); }
.cat-item.active {
  background: var(--accent-glow);
  color: var(--accent-bright);
  border-left-color: var(--accent);
}
.cat-item.is-parent {
  font-weight: 700;
  color: var(--text-bright);
  padding-top: 10px;
}

.cat-item .ci-indent { display: inline-block; flex-shrink: 0; }

.cat-item .ci-icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.cat-item .ci-icon svg { width: 14px; height: 14px; color: var(--accent-dim); }
.cat-item.active .ci-icon svg { color: var(--accent-bright); }

.cat-item .ci-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.cat-item .ci-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  min-width: 36px;
  text-align: right;
}
.cat-item.active .ci-count { color: var(--accent-dim); }

.cat-sep {
  height: 1px;
  background: var(--border);
  margin: 6px 14px;
}

/* ══════════════════════════════════════════════════════════
   RESULTS TABLE
   ══════════════════════════════════════════════════════════ */
.results-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 10px;
  font-family: var(--font-mono);
  letter-spacing: 0.5px;
}
.results-info strong { color: var(--accent); font-weight: 700; }

.item-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;
  font-size: 14px;
}

.item-table th {
  text-align: left;
  padding: 10px 14px;
  background: var(--bg-mid);
  border-bottom: 1px solid var(--border);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.item-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-subtle);
  vertical-align: middle;
  overflow: hidden;
}

.item-table tbody tr { transition: background 0.08s; }
.item-table tbody tr:hover td { background: var(--bg-hover); }

.item-name-cell {
  display: flex;
  flex-direction: column;
  gap: 2px;
  overflow: hidden;
}

.item-name { font-weight: 700; color: var(--text-bright); font-size: 14px; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.item-tpl {
  font-size: 10px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  opacity: 0.8;
  letter-spacing: 0.3px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.item-cat-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 12px;
  font-size: 11px;
  color: var(--text-dim);
  font-weight: 600;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.item-cat-badge .badge-icon { width: 12px; height: 12px; display: flex; align-items: center; }
.item-cat-badge .badge-icon svg { width: 12px; height: 12px; color: var(--accent-dim); }

.col-stack {
  text-align: center;
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-dim);
}

.col-price {
  text-align: right;
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--accent);
  white-space: nowrap;
}
.col-price .price-zero { color: var(--text-muted); }

.col-weight {
  text-align: center;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-dim);
}

.col-actions { text-align: right; white-space: nowrap; }

/* ── Sortable Headers ── */
.item-table th.sortable {
  cursor: pointer;
  user-select: none;
  transition: color 0.15s;
  position: relative;
}
.item-table th.sortable:hover { color: var(--accent); }
.item-table th.sortable .sort-arrow {
  display: inline-block;
  margin-left: 4px;
  font-size: 10px;
  opacity: 0.3;
  transition: opacity 0.15s;
}
.item-table th.sortable.sort-active .sort-arrow { opacity: 1; color: var(--accent); }
.item-table th.sortable.sort-active { color: var(--accent-bright); }

/* ── Item Name Cell (updated) ── */
.item-name-sub {
  font-size: 11px;
  color: var(--text-dim);
  font-weight: 500;
  line-height: 1.2;
}

.action-group {
  display: inline-flex;
  align-items: center;
  gap: 5px;
}
.action-group input[type="number"] { width: 52px; padding: 4px 6px; }

/* ── Pagination ── */
.pagination {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 16px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}

.pagination-info {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.pagination-btns {
  display: flex;
  gap: 8px;
}

/* ══════════════════════════════════════════════════════════
   PRESETS
   ══════════════════════════════════════════════════════════ */
.preset-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 16px;
}

.preset-card {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: border-color 0.15s, box-shadow 0.15s;
  position: relative;
}
.preset-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent-dim), transparent 80%);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}
.preset-card:hover { border-color: var(--border-light); box-shadow: var(--shadow-glow); }

.preset-card h3 {
  font-family: var(--font-mono);
  color: var(--accent);
  font-size: 15px;
  margin-bottom: 6px;
  letter-spacing: 0.5px;
}

.preset-card .preset-desc {
  color: var(--text-dim);
  font-size: 13px;
  margin-bottom: 16px;
  line-height: 1.6;
}

.preset-items { list-style: none; margin-bottom: 18px; }
.preset-items li {
  font-size: 12px;
  padding: 3px 0;
  color: var(--text);
  font-family: var(--font-mono);
}
.preset-items li .count { color: var(--accent); font-weight: 700; }

/* ══════════════════════════════════════════════════════════
   CART
   ══════════════════════════════════════════════════════════ */
.cart-empty {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-dim);
}
.cart-empty svg { width: 48px; height: 48px; color: var(--border-light); margin-bottom: 16px; }
.cart-empty p { font-size: 14px; margin-bottom: 4px; }
.cart-empty .sub { font-size: 12px; color: var(--text-muted); }

.cart-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  justify-content: flex-end;
}

.cart-summary {
  font-size: 13px;
  color: var(--text-dim);
  margin-top: 14px;
  text-align: right;
  font-family: var(--font-mono);
}

/* ══════════════════════════════════════════════════════════
   TOASTS
   ══════════════════════════════════════════════════════════ */
.toast-container {
  position: fixed;
  top: 64px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}

.toast {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text);
  box-shadow: var(--shadow-lg);
  pointer-events: auto;
  animation: toast-in 0.25s ease-out;
  max-width: 400px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.toast.success { border-left: 3px solid var(--success-bright); }
.toast.error { border-left: 3px solid var(--error-bright); }
.toast.info { border-left: 3px solid var(--accent); }
.toast-fade-out { animation: toast-out 0.3s ease-in forwards; }

@keyframes toast-in { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: none; } }
@keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateX(40px); } }

.toast-icon { width: 16px; height: 16px; flex-shrink: 0; }
.toast-icon svg { width: 16px; height: 16px; }
.toast.success .toast-icon svg { color: var(--success-bright); }
.toast.error .toast-icon svg { color: var(--error-bright); }
.toast.info .toast-icon svg { color: var(--accent); }

/* ── Spinner ── */
.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid var(--border-light);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-row td {
  text-align: center;
  padding: 60px;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 13px;
}

/* ── Responsive ── */
@media (max-width: 860px) {
  .header { padding: 0 16px; }
  .main-container { padding: 16px; }
  .search-row { flex-direction: column; }
  .cat-dropdown { width: 100%; }
  .cat-panel { width: 100%; }
  .hero-banner { height: 120px; }
  .preset-grid { grid-template-columns: 1fr; }
  .nav-bar { padding: 0 8px; }
  .nav-btn { padding: 10px 10px; font-size: 10px; letter-spacing: 0.8px; }
  .flea-cat-grid { grid-template-columns: 1fr; }
}

/* ── Flea Market Tab ── */
.flea-num-input {
  width: 70px;
  background: var(--bg-darker);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 5px 8px;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 13px;
  text-align: center;
}
.flea-num-input:focus { border-color: var(--accent); outline: none; }
.flea-wide-input { width: 100%; }
.flea-apply-btn {
  width: 100%;
  padding: 14px;
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 6px;
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: background 0.2s, opacity 0.2s;
}
.flea-apply-btn:hover:not(:disabled) { background: #d4b878; }
.flea-apply-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.flea-apply-btn.dirty { opacity: 1; }
.flea-spinner {
  width: 18px; height: 18px;
  border: 2px solid rgba(0,0,0,0.2);
  border-top-color: #000;
  border-radius: 50%;
  animation: flea-spin 0.6s linear infinite;
}
@keyframes flea-spin { to { transform: rotate(360deg); } }
.flea-cat-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.flea-cat-card {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px 14px;
  transition: border-color 0.2s;
}
.flea-cat-card.modified { border-color: var(--accent); }
.flea-cat-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.flea-cat-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}
.flea-cat-count {
  font-size: 11px;
  color: var(--text-dim);
  background: var(--bg-darker);
  padding: 2px 8px;
  border-radius: 10px;
}
.flea-cat-reset {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  font-family: var(--font-mono);
}
.flea-cat-reset:hover { border-color: var(--accent); color: var(--accent); }
.flea-cat-slider-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}
.flea-cat-slider-row label {
  font-size: 11px;
  color: var(--text-dim);
  width: 32px;
  flex-shrink: 0;
}
.flea-cat-slider-row input[type="range"] { flex: 1; accent-color: var(--accent); }
.flea-cat-slider-row input[type="number"] { width: 60px; }
.flea-toggle {
  position: relative;
  display: inline-block;
  width: 38px;
  height: 20px;
}
.flea-toggle input { opacity: 0; width: 0; height: 0; }
.flea-toggle-slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: var(--border);
  border-radius: 20px;
  transition: background 0.2s;
}
.flea-toggle-slider:before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  left: 3px; bottom: 3px;
  background: var(--text-dim);
  border-radius: 50%;
  transition: transform 0.2s, background 0.2s;
}
.flea-toggle input:checked + .flea-toggle-slider { background: var(--accent); }
.flea-toggle input:checked + .flea-toggle-slider:before { transform: translateX(18px); background: #000; }
.flea-status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 16px;
  padding: 10px 16px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 12px;
  font-family: var(--font-mono);
  color: var(--text-dim);
}
.flea-search-results {
  position: absolute;
  left: 0; right: 0; top: 100%;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 0 0 6px 6px;
  max-height: 240px;
  overflow-y: auto;
  z-index: 50;
}
.flea-search-item {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}
.flea-search-item:hover { background: var(--accent-glow); }
.flea-search-item:last-child { border-bottom: none; }
.flea-override-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.flea-override-table th {
  text-align: left;
  padding: 8px 10px;
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}
.flea-override-table td {
  padding: 6px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}
.flea-override-table input[type="number"] { width: 65px; }
.flea-override-remove {
  background: none;
  border: 1px solid var(--danger);
  color: var(--danger);
  padding: 3px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
}
.flea-override-remove:hover { background: var(--danger); color: #fff; }
.flea-unsaved-dot {
  display: none;
  width: 6px; height: 6px;
  background: var(--warning);
  border-radius: 50%;
  margin-left: 4px;
}
.flea-unsaved-dot.visible { display: inline-block; }
</style>
</head>
<body>

<!-- ═══════ HEADER ═══════ -->
<div class="header">
  <div class="header-left">
    <div class="header-logo">
      <div class="header-logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <span class="header-title">ZSlayerHQ Command Center</span>
    </div>
    <div class="header-sep"></div>
    <span class="header-version">v2.2.0</span>
    <div class="header-social">
      <a href="https://discord.gg/ZSlayerHQ" target="_blank" title="Discord">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
      </a>
      <a href="https://www.youtube.com/@ZSlayerHQ-ImBenCole" target="_blank" title="YouTube">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
      </a>
      <div class="header-sep"></div>
      <a href="https://discord.com/invite/Xn9msqQZan" target="_blank" title="SPT Discord">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
      </a>
      <a href="https://discord.gg/project-fika" target="_blank" title="Fika Discord">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
      </a>
      <a href="https://forge.sp-tarkov.com/" target="_blank" title="SPT Forge — Mods">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.7 4.3l4 4-9.7 9.7H6v-4z"/><path d="M17.7 2.3l4 4"/><path d="M2 18v4h4"/><path d="M22 22H2"/></svg>
      </a>
    </div>
  </div>
  <div class="header-profile" id="headerProfile" style="display:none">
    <div class="profile-status">
      <span class="status-dot"></span>
      <span class="profile-label">Connected</span>
    </div>
    <span style="color:var(--text-dim);font-size:13px">Profile:</span>
    <span class="profile-name-display" id="profileNameDisplay"></span>
    <button class="btn btn-ghost btn-sm" onclick="logout()">Disconnect</button>
  </div>
</div>

<!-- ═══════ NAVIGATION BAR ═══════ -->
<div class="nav-bar" id="navBar">
  <div class="nav-bar-inner">
    <button class="nav-btn active" data-nav="dashboard" onclick="switchMainTab('dashboard')">Dashboard</button>
    <button class="nav-btn" data-nav="items" onclick="switchMainTab('items')">Items</button>
    <button class="nav-btn" data-nav="players" onclick="switchMainTab('players')">Players</button>
    <button class="nav-btn" data-nav="flea" onclick="switchMainTab('flea')">Flea Market</button>
    <button class="nav-btn disabled" data-nav="traders" onclick="switchMainTab('traders')">Traders <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn" data-nav="quests" onclick="switchMainTab('quests')">Quests</button>
    <button class="nav-btn disabled" data-nav="progression" onclick="switchMainTab('progression')">Progression <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="backups" onclick="switchMainTab('backups')">Backups <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="events" onclick="switchMainTab('events')">Events <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="gamevalues" onclick="switchMainTab('gamevalues')">Game Values <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="profiles" onclick="switchMainTab('profiles')">Profiles <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="loadouts" onclick="switchMainTab('loadouts')">Loadouts <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="bounties" onclick="switchMainTab('bounties')">Bounties <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="clans" onclick="switchMainTab('clans')">Clans <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
  </div>
</div>

<!-- ═══════ LOGIN ═══════ -->
<div class="login-overlay" id="loginScreen">
  <div class="login-bg"></div>
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <span class="login-logo-text">ZSlayerHQ Command Center</span>
    </div>
    <p>Enter your SPT Session ID to connect. Find this in your SPT launcher profile settings.</p>
    <div class="form-group">
      <label>Session ID</label>
      <input type="text" id="sessionInput" placeholder="Paste your session ID here..." autocomplete="off" style="width:100%">
    </div>
    <button class="btn btn-accent" id="connectBtn" onclick="connect()" style="width:100%;padding:11px;font-size:14px;margin-top:6px">CONNECT</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- ═══════ HERO BANNER ═══════ -->
<div class="hero-banner" id="heroBanner" style="display:none">
  <div class="hero-bg-grid"></div>
  <div class="hero-bg-radial"></div>
  <img class="hero-image" id="heroImage" src="banner" alt="Banner" style="display:block">
  <div class="hero-placeholder" id="heroPlaceholder" style="display:none">
    <div class="hero-placeholder-inner">
      <div class="hero-placeholder-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
      </div>
      <div class="hero-placeholder-text">ZSlayerHQ Command Center</div>
      <div class="hero-placeholder-sub">Replace hero-image src with your custom graphic</div>
    </div>
  </div>
  <div class="hero-scanline"></div>
  <div class="hero-vignette"></div>
  <div class="hero-bottom-fade"></div>
</div>

<!-- ═══════ MAIN INTERFACE ═══════ -->
<div class="main-container" id="mainContainer">

  <!-- ═══════ ITEMS TAB ═══════ -->
  <div class="main-tab-panel" id="main-items">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="items" onclick="switchTab('items')">Items</button>
      <button class="tab-btn" data-tab="presets" onclick="switchTab('presets')">Presets</button>
      <button class="tab-btn" data-tab="cart" onclick="switchTab('cart')">Cart <span class="badge" id="cartBadge" style="display:none">0</span></button>
    </div>

    <!-- Items Sub-Tab -->
    <div class="tab-panel active" id="tab-items">
      <div class="search-row">
        <div class="search-input-wrap">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="searchInput" placeholder="Search items by name or template ID...">
        </div>

        <!-- Custom Category Dropdown -->
        <div class="cat-dropdown" id="catDropdown">
          <div class="cat-trigger" id="catTrigger" onclick="toggleCatDropdown()">
            <span class="ct-icon" id="ctIcon"></span>
            <span class="ct-label" id="ctLabel">All Categories</span>
            <span class="ct-count" id="ctCount" style="display:none"></span>
            <span class="ct-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></span>
          </div>
          <div class="cat-panel" id="catPanel">
            <div class="cat-panel-search">
              <div class="search-wrap">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" id="catSearchInput" placeholder="Filter categories..." oninput="filterCategories(this.value)">
              </div>
            </div>
            <div class="cat-list" id="catList"></div>
          </div>
        </div>
      </div>

      <div class="results-info" id="resultsInfo"></div>

      <table class="item-table">
        <thead>
          <tr>
            <th style="width:30%" class="sortable" id="th-name" onclick="toggleSort('name')">Name <span class="sort-arrow">&#9650;</span></th>
            <th style="width:14%">Category</th>
            <th style="width:12%;text-align:right" class="sortable" id="th-price" onclick="toggleSort('price')">Price <span class="sort-arrow">&#9650;</span></th>
            <th style="width:10%;text-align:center" class="sortable" id="th-weight" onclick="toggleSort('weight')">Weight <span class="sort-arrow">&#9650;</span></th>
            <th style="width:8%;text-align:center">Stack</th>
            <th style="width:26%;text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="itemsBody">
          <tr class="loading-row"><td colspan="6">Search for items above</td></tr>
        </tbody>
      </table>

      <div class="pagination" id="pagination" style="display:none">
        <div class="pagination-info" id="paginationInfo"></div>
        <div class="pagination-btns">
          <button class="btn btn-sm" id="prevBtn" onclick="prevPage()">&#9664; Previous</button>
          <button class="btn btn-sm" id="nextBtn" onclick="nextPage()">Next &#9654;</button>
        </div>
      </div>
    </div>

    <!-- Presets Sub-Tab -->
    <div class="tab-panel" id="tab-presets">
      <div class="preset-grid" id="presetsGrid">
        <div style="color:var(--text-dim);padding:40px;text-align:center;font-family:var(--font-mono)">Loading presets...</div>
      </div>
    </div>

    <!-- Cart Sub-Tab -->
    <div class="tab-panel" id="tab-cart">
      <div id="cartContent"></div>
    </div>
  </div>

  <!-- ═══════ DASHBOARD ═══════ -->
  <div class="main-tab-panel active" id="main-dashboard">

    <!-- Top Stats Grid -->
    <div class="dash-grid">

      <!-- Server Status -->
      <div class="dash-widget" id="widgetServerStatus">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg> Server Status</span>
          <span id="dashLastRefresh" style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono)"></span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Uptime</span><span class="dash-stat-value" id="dashUptime">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">SPT Version</span><span class="dash-stat-value sm" id="dashSptVer">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">CC Version</span><span class="dash-stat-value sm" id="dashCcVer">--</span></div>
          </div>
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Memory</span><span class="dash-stat-value sm" id="dashMemory">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Mods Loaded</span><span class="dash-stat-value sm" id="dashModCount">--</span></div>
          </div>
          <details style="margin-top:8px">
            <summary style="cursor:pointer;font-size:11px;color:var(--text-dim);font-family:var(--font-mono);letter-spacing:1px;text-transform:uppercase">Mod List</summary>
            <div id="dashModList" style="max-height:180px;overflow-y:auto;margin-top:8px;font-size:12px"></div>
          </details>
        </div>
      </div>

      <!-- Online Players -->
      <div class="dash-widget" id="widgetPlayers">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Players</span>
          <span id="dashOnlineBadge" style="font-size:11px;font-family:var(--font-mono);color:var(--success-bright)"></span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Profiles</span><span class="dash-stat-value" id="dashTotalProfiles">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Online</span><span class="dash-stat-value" id="dashOnlineCount" style="color:var(--success-bright)">--</span></div>
          </div>
          <div class="dash-player-list" id="dashPlayerList"></div>
        </div>
      </div>

      <!-- Raid Stats -->
      <div class="dash-widget" id="widgetRaids">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Raid Statistics</span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Raids</span><span class="dash-stat-value" id="dashTotalRaids">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Survival Rate</span><span class="dash-stat-value" id="dashSurvivalRate">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Avg Time</span><span class="dash-stat-value sm" id="dashAvgTime">--</span></div>
          </div>
          <div class="dash-bar-chart" id="dashRaidsByMap"></div>
        </div>
      </div>

      <!-- Economy -->
      <div class="dash-widget" id="widgetEconomy">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg> Economy</span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Roubles</span><span class="dash-stat-value" id="dashTotalRoubles">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Average Wealth</span><span class="dash-stat-value sm" id="dashAvgWealth">--</span></div>
          </div>
          <div id="dashTopPlayers" style="margin-top:8px"></div>
        </div>
      </div>

    </div>

    <!-- Quick Actions -->
    <div class="dash-actions">
      <button class="btn btn-accent btn-sm" onclick="openBroadcastModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Send Broadcast</button>
      <button class="btn btn-sm" onclick="sendUrlsToPlayers()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Send URLs to Players</button>
      <button class="btn btn-sm" onclick="refreshDashboard()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> Refresh Data</button>
      <button class="btn btn-ghost btn-sm" onclick="switchMainTab('items')">Items Tab</button>
    </div>

    <!-- Activity Log -->
    <div class="dash-widget full-width" style="margin-bottom:16px">
      <div class="dash-widget-header">
        <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Activity Log</span>
        <select id="activityTypeFilter" style="font-size:11px;font-family:var(--font-mono);background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);padding:3px 8px" onchange="loadActivity()">
          <option value="">All Types</option>
          <option value="ItemGive">Item Give</option>
          <option value="PresetGive">Preset Give</option>
          <option value="Broadcast">Broadcast</option>
          <option value="ServerStart">Server Start</option>
        </select>
      </div>
      <div class="dash-widget-body" style="padding:0">
        <div id="dashActivity" style="max-height:300px;overflow-y:auto">
          <table class="activity-table">
            <thead><tr><th>Time</th><th>Type</th><th>Admin</th><th>Details</th></tr></thead>
            <tbody id="activityBody"><tr><td colspan="4" style="text-align:center;padding:24px;color:var(--text-muted)">Loading...</td></tr></tbody>
          </table>
        </div>
        <div id="activityPagination" style="display:none;padding:8px 16px;border-top:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;font-size:11px;font-family:var(--font-mono);color:var(--text-dim)">
          <span id="activityPageInfo"></span>
          <div style="display:flex;gap:6px">
            <button class="btn btn-xs" id="activityPrevBtn" onclick="activityPrev()">Prev</button>
            <button class="btn btn-xs" id="activityNextBtn" onclick="activityNext()">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Server Console -->
    <div class="console-panel" id="consolePanel">
      <div class="console-header" onclick="toggleConsole()">
        <span class="console-header-left"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg> Server Console <span id="consoleCount" style="color:var(--text-muted)"></span></span>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="console-filters" onclick="event.stopPropagation()">
            <button class="console-filter-btn active" data-level="info" onclick="toggleConsoleFilter(this)">Info</button>
            <button class="console-filter-btn active" data-level="warning" onclick="toggleConsoleFilter(this)">Warn</button>
            <button class="console-filter-btn active" data-level="error" onclick="toggleConsoleFilter(this)">Error</button>
            <button class="console-filter-btn" data-level="debug" onclick="toggleConsoleFilter(this)">Debug</button>
          </div>
          <span id="consoleToggleIcon" style="color:var(--text-muted);font-size:12px">&#x25BC;</span>
        </div>
      </div>
      <div class="console-search" id="consoleSearchWrap">
        <input type="text" id="consoleSearchInput" placeholder="Search console..." oninput="filterConsole()">
      </div>
      <div class="console-body" id="consoleBody"></div>
      <div class="console-jump" id="consoleJump"><button onclick="scrollConsoleBottom()">Jump to bottom</button></div>
    </div>

    <!-- Headless Process Manager -->
    <div class="card" id="headlessManagerCard" style="margin-top:16px;display:none">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
        <span style="display:flex;align-items:center;gap:10px">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;color:var(--accent-dim)"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span style="font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim)">Headless Client</span>
        </span>
        <span id="headlessStatusBadge" style="font-size:11px;font-family:var(--font-mono)"></span>
      </div>
      <div id="headlessManagerBody" style="padding:16px">
        <div id="headlessUnavailable" style="display:none;text-align:center;color:var(--text-muted);padding:12px">
          EscapeFromTarkov.exe not found — headless management unavailable
        </div>
        <div id="headlessControls" style="display:none">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:14px;flex-wrap:wrap">
            <div id="headlessUptimeInfo" style="font-size:12px;font-family:var(--font-mono);color:var(--text-dim)"></div>
            <div style="display:flex;gap:6px;margin-left:auto">
              <button class="btn btn-sm" id="btnHeadlessStart" onclick="startHeadless()">Start</button>
              <button class="btn btn-sm" id="btnHeadlessStop" onclick="stopHeadless()" disabled>Stop</button>
              <button class="btn btn-sm" id="btnHeadlessRestart" onclick="restartHeadless()" disabled>Restart</button>
            </div>
          </div>
          <div id="headlessCrashInfo" style="display:none;font-size:11px;color:var(--error-bright);margin-bottom:10px;font-family:var(--font-mono)"></div>
          <div style="border-top:1px solid var(--border-subtle);padding-top:12px;margin-top:4px">
            <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:10px">Settings</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 20px;font-size:12px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="hlAutoStart" onchange="saveHeadlessConfig()"> Auto-start with server
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="hlAutoRestart" onchange="saveHeadlessConfig()"> Auto-restart on crash
              </label>
              <div style="display:flex;align-items:center;gap:8px">
                <span style="color:var(--text-dim);white-space:nowrap">Delay:</span>
                <input type="range" id="hlDelay" min="1" max="300" value="30" oninput="document.getElementById('hlDelayVal').textContent=this.value+'s'" onchange="saveHeadlessConfig()" style="flex:1;accent-color:var(--accent)">
                <span id="hlDelayVal" style="font-family:var(--font-mono);color:var(--text-dim);min-width:35px">30s</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span style="color:var(--text-dim);white-space:nowrap">Profile ID:</span>
                <input type="text" id="hlProfileId" placeholder="Enter profile ID" style="flex:1;padding:3px 8px;font-size:11px;font-family:var(--font-mono);background:var(--bg-input);border:1px solid var(--border-subtle);border-radius:var(--radius);color:var(--text)">
                <button class="btn btn-sm" onclick="saveHeadlessConfig()" style="padding:3px 10px">Save</button>
              </div>
            </div>
            <div id="hlProfileWarning" style="display:none;font-size:11px;color:var(--warning);margin-top:8px">Profile ID required — enter the session ID of the headless profile to enable start.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Headless Client Console -->
    <div class="console-panel" id="headlessPanel" style="margin-top:16px">
      <div class="console-header" onclick="toggleHeadless()">
        <span class="console-header-left"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg> Headless Client <span id="headlessCount" style="color:var(--text-muted)"></span></span>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="console-filters" onclick="event.stopPropagation()">
            <button class="console-filter-btn active" data-level="info" onclick="toggleHeadlessFilter(this)">Info</button>
            <button class="console-filter-btn active" data-level="warning" onclick="toggleHeadlessFilter(this)">Warn</button>
            <button class="console-filter-btn active" data-level="error" onclick="toggleHeadlessFilter(this)">Error</button>
            <button class="console-filter-btn" data-level="debug" onclick="toggleHeadlessFilter(this)">Debug</button>
          </div>
          <span id="headlessToggleIcon" style="color:var(--text-muted);font-size:12px">&#x25BC;</span>
        </div>
      </div>
      <div class="console-search" id="headlessSearchWrap">
        <input type="text" id="headlessSearchInput" placeholder="Search headless..." oninput="filterHeadless()">
      </div>
      <div class="console-body" id="headlessBody"></div>
      <div class="console-jump" id="headlessJump"><button onclick="scrollHeadlessBottom()">Jump to bottom</button></div>
    </div>

  </div>

  <!-- Broadcast Modal -->
  <div class="modal-overlay" id="broadcastModal">
    <div class="modal-box">
      <h3>Send Broadcast</h3>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px">Send a system message to all registered profiles.</p>
      <textarea id="broadcastMessage" placeholder="Enter your broadcast message..."></textarea>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeBroadcastModal()">Cancel</button>
        <button class="btn btn-accent" onclick="sendBroadcast()">Send</button>
      </div>
    </div>
  </div>

  <div class="main-tab-panel" id="main-players">
    <!-- Player Roster -->
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3 style="font-family:var(--font-mono);font-size:14px;text-transform:uppercase;color:var(--text-dim);letter-spacing:0.5px">Player Roster</h3>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm" onclick="openBroadcastMailModal()">Broadcast Mail</button>
          <button class="btn btn-ghost btn-sm" onclick="openGiveAllModal()">Give to All</button>
          <button class="btn btn-ghost btn-sm" onclick="loadPlayerRoster()">Refresh</button>
        </div>
      </div>
      <div class="player-search-row">
        <input type="text" id="playerSearchInput" placeholder="Search by nickname..." oninput="debouncePlayerSearch()">
        <select id="playerFactionFilter" onchange="loadPlayerRoster()">
          <option value="">All Factions</option>
          <option value="Bear">BEAR</option>
          <option value="Usec">USEC</option>
        </select>
      </div>
      <div id="playerRosterBody">
        <div style="color:var(--text-dim);text-align:center;padding:40px 0">Loading players...</div>
      </div>
      <div class="pagination" id="playerPagination" style="display:none">
        <span class="pagination-info" id="playerPaginationInfo"></span>
        <div class="pagination-btns">
          <button class="btn btn-ghost btn-sm" onclick="playerPagePrev()">Prev</button>
          <button class="btn btn-ghost btn-sm" onclick="playerPageNext()">Next</button>
        </div>
      </div>
    </div>

    <!-- Ban List Section -->
    <div class="card ban-section">
      <div class="ban-section-header" id="banSectionHeader" onclick="toggleBanSection()">
        <span class="toggle-arrow">&#9660;</span> Ban List <span id="banCount" style="color:var(--text-muted);font-size:11px">(0)</span>
      </div>
      <div class="ban-section-body" id="banSectionBody">
        <div id="banListBody">
          <div style="color:var(--text-dim);text-align:center;padding:20px 0;font-size:13px">No banned players</div>
        </div>
      </div>
    </div>

    <!-- Player Mail Modal -->
    <div class="modal-overlay" id="playerMailModal">
      <div class="modal-box" style="max-width:500px">
        <h3>Send Mail</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">To: <strong id="mailRecipientName"></strong></p>
        <div style="margin-bottom:10px">
          <label style="font-size:12px;color:var(--text-dim);margin-bottom:4px;display:block">Template</label>
          <select id="mailTemplate" onchange="applyMailTemplate()" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:6px 10px;font-size:13px;border-radius:var(--radius)">
            <option value="">Custom Message</option>
            <option value="welcome">Welcome</option>
            <option value="rules">Server Rules</option>
            <option value="event">Event Announcement</option>
          </select>
        </div>
        <textarea id="mailMessage" placeholder="Enter your message..."></textarea>
        <div style="margin:10px 0 6px"><span style="font-size:12px;color:var(--text-dim);font-family:var(--font-mono);text-transform:uppercase">Attach Items</span></div>
        <div id="mailItemRows"></div>
        <button class="btn btn-ghost btn-sm" onclick="addMailItemRow()" style="margin-bottom:10px;font-size:11px">+ Add Item</button>
        <div class="form-row">
          <div><label>Roubles</label><input type="number" id="mailRoubles" min="0" value="0"></div>
          <div><label>Dollars</label><input type="number" id="mailDollars" min="0" value="0"></div>
          <div><label>Euros</label><input type="number" id="mailEuros" min="0" value="0"></div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerMailModal')">Cancel</button>
          <button class="btn btn-accent" onclick="sendPlayerMail()">Send</button>
        </div>
      </div>
    </div>

    <!-- Player Modify Modal -->
    <div class="modal-overlay" id="playerModifyModal">
      <div class="modal-box" style="max-width:480px">
        <h3>Modify Player</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Player: <strong id="modifyTargetName"></strong></p>
        <div class="form-row">
          <div><label>Level (1-79)</label><input type="number" id="modifyLevel" min="1" max="79" placeholder="Leave empty to skip"></div>
          <div><label>Faction</label><select id="modifyFaction" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:8px 10px;font-size:13px;border-radius:var(--radius)"><option value="">No change</option><option value="Bear">BEAR</option><option value="Usec">USEC</option></select></div>
        </div>
        <div class="form-row">
          <div><label>Add Roubles</label><input type="number" id="modifyRoubles" min="0" value="0"></div>
          <div><label>Add Dollars</label><input type="number" id="modifyDollars" min="0" value="0"></div>
          <div><label>Add Euros</label><input type="number" id="modifyEuros" min="0" value="0"></div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerModifyModal')">Cancel</button>
          <button class="btn btn-accent" onclick="submitModify()">Apply</button>
        </div>
      </div>
    </div>

    <!-- Player Reset Modal -->
    <div class="modal-overlay" id="playerResetModal">
      <div class="modal-box" style="max-width:420px">
        <h3 style="color:var(--error-bright)">Reset Player</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Player: <strong id="resetTargetName"></strong></p>
        <div style="margin-bottom:12px">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetSkills"> Skills</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetQuests"> Quests</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetTraders"> Traders</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetHideout"> Hideout</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer;color:var(--error-bright)"><input type="checkbox" id="resetFull" onchange="toggleFullReset()"> Full Reset (all above)</label>
        </div>
        <div style="font-size:12px;color:var(--error-bright);margin-bottom:6px">Type RESET to confirm:</div>
        <input type="text" class="confirmation-input" id="resetConfirmInput" placeholder="Type RESET" oninput="checkResetConfirm()">
        <div class="modal-actions" style="margin-top:12px">
          <button class="btn btn-ghost" onclick="closeModal('playerResetModal')">Cancel</button>
          <button class="danger-btn" id="resetConfirmBtn" disabled onclick="submitReset()">Reset</button>
        </div>
      </div>
    </div>

    <!-- Player Ban Modal -->
    <div class="modal-overlay" id="playerBanModal">
      <div class="modal-box" style="max-width:420px">
        <h3 style="color:var(--error-bright)">Ban Player</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Player: <strong id="banTargetName"></strong></p>
        <textarea id="banReason" placeholder="Reason for ban..."></textarea>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerBanModal')">Cancel</button>
          <button class="danger-btn" onclick="confirmBan()">Ban</button>
        </div>
      </div>
    </div>

    <!-- Give Items Modal -->
    <div class="modal-overlay" id="playerGiveModal">
      <div class="modal-box" style="max-width:480px">
        <h3 id="giveModalTitle">Give Items</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px" id="giveModalSub"></p>
        <div id="giveItemRows"></div>
        <button class="btn btn-ghost btn-sm" onclick="addGiveItemRow()" style="margin-bottom:10px;font-size:11px">+ Add Item</button>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerGiveModal')">Cancel</button>
          <button class="btn btn-accent" id="giveSubmitBtn" onclick="submitGive()">Send</button>
        </div>
      </div>
    </div>

    <!-- Broadcast Mail Modal -->
    <div class="modal-overlay" id="broadcastMailModal">
      <div class="modal-box" style="max-width:500px">
        <h3>Broadcast Mail</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Send a message with optional items to all players.</p>
        <textarea id="broadcastMailMessage" placeholder="Enter your broadcast message..."></textarea>
        <div style="margin:10px 0 6px"><span style="font-size:12px;color:var(--text-dim);font-family:var(--font-mono);text-transform:uppercase">Attach Items</span></div>
        <div id="broadcastItemRows"></div>
        <button class="btn btn-ghost btn-sm" onclick="addBroadcastItemRow()" style="margin-bottom:10px;font-size:11px">+ Add Item</button>
        <div class="form-row">
          <div><label>Roubles</label><input type="number" id="broadcastRoubles" min="0" value="0"></div>
          <div><label>Dollars</label><input type="number" id="broadcastDollars" min="0" value="0"></div>
          <div><label>Euros</label><input type="number" id="broadcastEuros" min="0" value="0"></div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('broadcastMailModal')">Cancel</button>
          <button class="btn btn-accent" onclick="sendBroadcastMail()">Broadcast</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-tab-panel" id="main-flea">
    <!-- Warning banner -->
    <div style="background:rgba(200,122,62,0.1);border:1px solid rgba(200,122,62,0.3);border-radius:6px;padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--warning)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Changes apply to <strong>all players</strong> on the server. Click "Apply &amp; Regenerate" to activate.
    </div>

    <!-- Modifier Info Panel -->
    <div id="fleaInfoPanel" style="display:none;background:rgba(100,160,220,0.08);border:1px solid rgba(100,160,220,0.25);border-radius:6px;padding:14px 18px;margin-bottom:16px;font-size:12.5px;color:var(--text);line-height:1.7">
      <div style="font-weight:600;color:#7ab3e0;margin-bottom:8px;font-size:13px">How Modifiers Work</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Global Multiplier</span> &mdash; Base multiplier applied to <em>all</em> flea market buy prices.</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Category Multiplier</span> &mdash; Stacks multiplicatively with Global. E.g. 2&times; Global &times; 3&times; Category = <strong>6&times;</strong> final price. Leave at 1.0&times; for no additional change.</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Per-Item Override</span> &mdash; Replaces all other modifiers. The item uses <em>only</em> the override value.</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Tax Multiplier</span> &mdash; Scales flea market listing tax. 0 = free listings, 1 = normal, 2 = double tax. <span style="color:#7ab3e0;font-weight:600">Players must restart their game client</span> for tax changes to take effect.</div>
      <div style="border-top:1px solid rgba(100,160,220,0.15);padding-top:8px;margin-top:8px;color:var(--text-dim)">
        <strong>Price Formula:</strong> Final Price = Base Price &times; Global &times; Category<br>
        <strong>Exception:</strong> Items with a Per-Item Override use only that value<br>
        <strong>Economy Tip:</strong> Use tax multiplier to balance player income &mdash; higher tax discourages flea selling, lower tax encourages it
      </div>
    </div>
    <div style="margin-bottom:14px">
      <button onclick="document.getElementById('fleaInfoPanel').style.display=document.getElementById('fleaInfoPanel').style.display==='none'?'block':'none'" style="background:none;border:1px solid rgba(100,160,220,0.3);border-radius:4px;padding:4px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;color:#7ab3e0;font-size:12px;font-family:var(--font-mono)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        How Modifiers Work
      </button>
    </div>

    <!-- PRESETS -->
    <div class="flea-panel" style="border-left:3px solid #7ab3e0;padding:14px 20px;background:var(--bg-panel);border-radius:6px;margin-bottom:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="font-size:14px;font-weight:600;color:#7ab3e0;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Presets</div>
        <div style="display:flex;gap:6px">
          <button onclick="fleaExportPreset()" style="padding:4px 10px;background:var(--bg-dark);color:var(--text-dim);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:11px" title="Copy current config to clipboard">Export</button>
          <button onclick="fleaShowImport()" style="padding:4px 10px;background:var(--bg-dark);color:var(--text-dim);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:11px" title="Import preset from JSON">Import</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="fleaPresetSelect" style="flex:1;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-family:var(--font-mono);font-size:12px">
          <option value="">— Select a preset —</option>
        </select>
        <button onclick="fleaLoadPreset()" style="padding:6px 12px;background:var(--bg-dark);color:#7ab3e0;border:1px solid rgba(100,160,220,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Load</button>
        <button onclick="fleaDeletePreset()" style="padding:6px 12px;background:var(--bg-dark);color:var(--error-bright);border:1px solid rgba(139,58,58,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Delete</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <input type="text" id="fleaPresetName" placeholder="Preset name..." style="flex:1;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-family:var(--font-mono);font-size:12px">
        <button onclick="fleaSavePreset()" style="padding:6px 12px;background:rgba(100,160,220,0.15);color:#7ab3e0;border:1px solid rgba(100,160,220,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px;font-weight:600">Save Current</button>
      </div>
      <!-- Import text area (hidden by default) -->
      <div id="fleaImportArea" style="display:none;margin-top:10px">
        <textarea id="fleaImportJson" style="width:100%;height:100px;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;font-family:var(--font-mono);font-size:11px;resize:vertical" placeholder="Paste preset JSON here..."></textarea>
        <div style="display:flex;gap:8px;margin-top:6px;justify-content:flex-end">
          <button onclick="document.getElementById('fleaImportArea').style.display='none'" style="padding:4px 10px;background:var(--bg-dark);color:var(--text-dim);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:11px">Cancel</button>
          <button onclick="fleaImportPreset()" style="padding:4px 10px;background:rgba(100,160,220,0.15);color:#7ab3e0;border:1px solid rgba(100,160,220,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Import &amp; Load</button>
        </div>
      </div>
    </div>

    <!-- A) GLOBAL CONTROLS -->
    <div class="flea-panel" style="border-left:3px solid var(--accent);padding:16px 20px;background:var(--bg-panel);border-radius:6px;margin-bottom:14px">
      <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:14px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Global Price Controls</div>
      <div style="margin-bottom:16px">
        <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Global Price Multiplier</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input type="range" id="fleaGlobalBuy" min="0.1" max="10" step="0.1" value="1.0" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaGlobalBuy','fleaGlobalBuyVal')">
          <input type="number" id="fleaGlobalBuyVal" min="0.1" max="10" step="0.1" value="1.0" class="flea-num-input" oninput="fleaNumChanged('fleaGlobalBuyVal','fleaGlobalBuy')">
          <span style="font-size:12px;color:var(--text-dim)">&times;</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Price Variance</label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="range" id="fleaVariance" min="0" max="1" step="0.01" value="0" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaVariance','fleaVarianceVal',true)">
            <input type="number" id="fleaVarianceVal" min="0" max="100" step="1" value="0" class="flea-num-input" oninput="fleaVarianceNumChanged()">
            <span style="font-size:12px;color:var(--text-dim)">%</span>
          </div>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Min Price (&#8381;)</label>
          <input type="number" id="fleaMinPrice" min="1" max="50000000" step="1" value="1" class="flea-num-input flea-wide-input" oninput="fleaMarkDirty()">
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Max Price (&#8381;)</label>
          <input type="number" id="fleaMaxPrice" min="1" max="50000000" step="1" value="50000000" class="flea-num-input flea-wide-input" oninput="fleaMarkDirty()">
        </div>
      </div>
    </div>

    <!-- Tax restart notice (hidden by default, shown after Apply if tax changed) -->
    <div id="fleaTaxRestartNotice" style="display:none;background:rgba(100,160,220,0.08);border:1px solid rgba(100,160,220,0.25);border-radius:6px;padding:12px 16px;margin-bottom:14px;align-items:center;gap:10px;font-size:13px;color:#7ab3e0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      <div><strong>Client restart required.</strong> Tax changes have been applied to the server. All players must restart their game client for the new tax rates to take effect.</div>
      <button onclick="this.parentElement.style.display='none'" style="background:none;border:none;color:#7ab3e0;cursor:pointer;font-size:16px;padding:0 4px;flex-shrink:0">&times;</button>
    </div>

    <!-- B) MARKET SETTINGS -->
    <div class="flea-panel" style="border-left:3px solid var(--accent);padding:16px 20px;background:var(--bg-panel);border-radius:6px;margin-bottom:14px">
      <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:14px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Market Settings</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:flex;align-items:center;gap:6px;margin-bottom:6px">Flea Tax Multiplier
            <span style="background:rgba(100,160,220,0.15);color:#7ab3e0;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;text-transform:uppercase;letter-spacing:0.5px">Restart Required</span>
          </label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="range" id="fleaTax" min="0" max="5" step="0.1" value="1.0" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaTax','fleaTaxVal')">
            <input type="number" id="fleaTaxVal" min="0" max="5" step="0.1" value="1.0" class="flea-num-input" oninput="fleaNumChanged('fleaTaxVal','fleaTax')">
            <span style="font-size:12px;color:var(--text-dim)">&times;</span>
          </div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:4px">0 = free listings &middot; 1 = normal &middot; 2 = double tax</div>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Max Player Listings</label>
          <input type="number" id="fleaMaxOffers" min="1" max="100" step="1" value="2" class="flea-num-input flea-wide-input" oninput="fleaMarkDirty()">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Offer Duration (hours)</label>
          <input type="number" id="fleaDuration" min="1" max="168" step="1" value="24" class="flea-num-input flea-wide-input" oninput="fleaMarkDirty()">
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Restock Interval (minutes)</label>
          <input type="number" id="fleaRestock" min="1" max="360" step="1" value="60" class="flea-num-input flea-wide-input" oninput="fleaMarkDirty()">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center">
        <div style="display:flex;align-items:center;gap:10px">
          <label style="font-size:12px;color:var(--text-dim)">Barter Offers</label>
          <label class="flea-toggle"><input type="checkbox" id="fleaBarterEnabled" checked onchange="fleaBarterToggled()"><span class="flea-toggle-slider"></span></label>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Barter Frequency</label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="range" id="fleaBarterFreq" min="0" max="100" step="1" value="15" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaBarterFreq','fleaBarterFreqVal')">
            <input type="number" id="fleaBarterFreqVal" min="0" max="100" step="1" value="15" class="flea-num-input" oninput="fleaNumChanged('fleaBarterFreqVal','fleaBarterFreq')">
            <span style="font-size:12px;color:var(--text-dim)">%</span>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:24px;margin-top:12px">
        <div style="display:flex;align-items:center;gap:10px">
          <label style="font-size:12px;color:var(--text-dim)">Dollar Offers</label>
          <label class="flea-toggle"><input type="checkbox" id="fleaDollarEnabled" checked onchange="fleaMarkDirty()"><span class="flea-toggle-slider"></span></label>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <label style="font-size:12px;color:var(--text-dim)">Euro Offers</label>
          <label class="flea-toggle"><input type="checkbox" id="fleaEuroEnabled" checked onchange="fleaMarkDirty()"><span class="flea-toggle-slider"></span></label>
        </div>
      </div>
    </div>

    <!-- D) CATEGORY CONTROLS -->
    <div style="margin-top:14px">
      <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:12px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Category Multipliers</div>
      <div id="fleaCategoryGrid" class="flea-cat-grid">
        <div style="color:var(--text-dim);font-size:13px;padding:20px;text-align:center">Loading categories...</div>
      </div>
    </div>

    <!-- E) PER-ITEM OVERRIDES -->
    <div style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:10px" onclick="fleaToggleOverrides()">
        <span id="fleaOverrideArrow" style="font-size:12px;color:var(--text-dim);transition:transform 0.2s">&#9654;</span>
        <span style="font-size:14px;font-weight:600;color:var(--accent);font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Per-Item Overrides</span>
        <span id="fleaOverrideCount" style="font-size:11px;color:var(--text-dim);background:var(--bg-dark);padding:2px 8px;border-radius:10px">0</span>
      </div>
      <div id="fleaOverridePanel" style="display:none">
        <div style="display:flex;gap:10px;margin-bottom:10px;position:relative">
          <input type="text" id="fleaItemSearch" class="search-input" placeholder="Search items by name..." style="flex:1" oninput="fleaItemSearchDebounce()">
        </div>
        <div id="fleaItemSearchResults" class="flea-search-results" style="display:none"></div>
        <div id="fleaOverrideTable"></div>
      </div>
    </div>

    <!-- C) APPLY BUTTON -->
    <button id="fleaApplyBtn" class="flea-apply-btn" onclick="fleaApplyAndRegenerate()" disabled style="margin-top:14px">
      <span id="fleaApplyText">Apply &amp; Regenerate Offers</span>
      <span id="fleaApplySpinner" class="flea-spinner" style="display:none"></span>
    </button>

    <!-- F) STATUS BAR -->
    <div class="flea-status-bar">
      <span id="fleaStatusRegen">Last regenerated: Never</span>
      <span id="fleaStatusOffers">Active offers: —</span>
      <span style="color:var(--text-dim)">v2.3.0</span>
    </div>

    <!-- G) DEBUG PANEL -->
    <div style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:10px" onclick="fleaToggleDebug()">
        <span id="fleaDebugArrow" style="font-size:12px;color:var(--text-dim);transition:transform 0.2s">&#9654;</span>
        <span style="font-size:14px;font-weight:600;color:var(--text-dim);font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Debug</span>
      </div>
      <div id="fleaDebugPanel" style="display:none">
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <button onclick="fleaRunDiagnostic()" style="padding:6px 16px;background:var(--bg-dark);color:var(--accent);border:1px solid var(--accent);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Run Diagnostic</button>
        </div>
        <div id="fleaDiagResult" style="margin-bottom:12px"></div>
        <div style="font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:6px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">API Log</div>
        <div id="fleaApiLogPanel" style="max-height:300px;overflow-y:auto;background:var(--bg-dark);border-radius:4px;padding:8px;font-family:var(--font-mono);font-size:11px"></div>
      </div>
    </div>
  </div>

  <div class="main-tab-panel" id="main-traders">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg></div>
      <h2>Trader Control</h2>
      <p>Adjust trader prices, restock timers, loyalty levels, and currency settings.</p>
      <span class="phase-badge">Phase 4</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-quests">
    <!-- Quest Browser Controls -->
    <div style="display:flex;gap:10px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
      <input type="text" id="questSearchInput" class="search-input" placeholder="Search quests..." style="flex:1;min-width:200px;max-width:360px" oninput="debounceQuestSearch()">
      <span style="font-size:12px;color:var(--text-dim);font-family:var(--font-mono)" id="questCountLabel">0 quests</span>
    </div>
    <!-- Map Filter Chips -->
    <div class="qb-map-chips" id="questMapChips"></div>
    <!-- Quest Table -->
    <div class="table-wrap">
      <table class="data-table" id="questBrowserTable">
        <thead>
          <tr>
            <th class="qb-sortable" data-sort="name" onclick="setQuestSort('name')">Quest Name <span class="qb-sort-arrow" id="qbArrow_name"></span></th>
            <th class="qb-sortable" data-sort="trader" onclick="setQuestSort('trader')">Trader <span class="qb-sort-arrow" id="qbArrow_trader"></span></th>
            <th class="qb-sortable" data-sort="map" onclick="setQuestSort('map')">Map <span class="qb-sort-arrow" id="qbArrow_map"></span></th>
            <th class="qb-sortable" data-sort="level" onclick="setQuestSort('level')">Level <span class="qb-sort-arrow" id="qbArrow_level"></span></th>
            <th class="qb-sortable" data-sort="objectives" onclick="setQuestSort('objectives')">Obj. <span class="qb-sort-arrow" id="qbArrow_objectives"></span></th>
            <th style="width:30px"></th>
          </tr>
        </thead>
        <tbody id="questBrowserBody">
          <tr><td colspan="6" style="text-align:center;color:var(--text-dim);padding:30px">Loading quests...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="main-tab-panel" id="main-progression">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
      <h2>Progression & Skills</h2>
      <p>XP multipliers, skill leveling rates, fatigue settings, and hideout timers.</p>
      <span class="phase-badge">Phase 6</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-backups">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
      <h2>Backup & Restore</h2>
      <p>Create backups, restore configurations, and manage save snapshots.</p>
      <span class="phase-badge">Phase 7</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-events">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
      <h2>Scheduler & Events</h2>
      <p>Schedule automated events, timed actions, and recurring server tasks.</p>
      <span class="phase-badge">Phase 8</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-gamevalues">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
      <h2>Game Values</h2>
      <p>Edit ammo stats, armor values, weapon properties, bot spawns, and raid settings.</p>
      <span class="phase-badge">Phase 9</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-profiles">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 22h14a2 2 0 002-2V7.5L14.5 2H6a2 2 0 00-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M3 15h6"/><path d="M6 12v6"/></svg></div>
      <h2>Config Profiles</h2>
      <p>Save, load, and share configuration profiles. Export and import settings.</p>
      <span class="phase-badge">Phase 10</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-loadouts">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg></div>
      <h2>Gear Presets & Loadouts</h2>
      <p>Build and manage full gear loadouts. One-click equip for raid preparation.</p>
      <span class="phase-badge">Phase 11</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-bounties">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg></div>
      <h2>Bounty Board</h2>
      <p>Create and track bounties on players. Reward-based PvP challenges.</p>
      <span class="phase-badge">Phase 12</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-clans">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></div>
      <h2>Clan System</h2>
      <p>Form clans, manage shared storage, clan rankings, and group features.</p>
      <span class="phase-badge">Phase 13</span>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastContainer"></div>

<script>
(function() {
  'use strict';

  // ═══════════════════════════════════════════════════════
  // CATEGORY ICONS (inline SVG)
  // ═══════════════════════════════════════════════════════
  const ICONS = {
    weapon:      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.5 2.5l5 5-10 10-5-5L14.5 2.5z"/><path d="M3 21l3.5-3.5"/><path d="M5.5 13.5l5 5"/></svg>',
    ammo:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="8" y="2" width="8" height="20" rx="2"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="14" x2="16" y2="14"/></svg>',
    armor:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
    medical:     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
    food:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
    barter:      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M20 21L3 4"/></svg>',
    key:         '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>',
    container:   '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
    mod:         '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',
    equipment:   '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>',
    tool:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>',
    electronics: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="15" x2="23" y2="15"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="15" x2="4" y2="15"/></svg>',
    money:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
    info:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
    all:         '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
    fallback:    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    check:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
    x:           '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    alert:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
  };

  function getIconKey(name) {
    var n = (name || '').toLowerCase();
    if (n.includes('weapon') && !n.includes('mod')) return 'weapon';
    if (n.includes('ammo') || n.includes('ammunition')) return 'ammo';
    if (n.includes('armor') || n.includes('vest') || n.includes('helmet') || n.includes('plate')) return 'armor';
    if (n.includes('medical') || n.includes('medkit') || n.includes('drug') || n.includes('stimulant') || n.includes('medikit')) return 'medical';
    if (n.includes('food') || n.includes('drink') || n.includes('provision')) return 'food';
    if (n.includes('barter')) return 'barter';
    if (n.includes('key') || n.includes('keycard') || n.includes('mechanical')) return 'key';
    if (n.includes('container') || n.includes('backpack') || n.includes('rig') || n.includes('pouch') || n.includes('case') || n.includes('belt')) return 'container';
    if (n.includes('mod') || n.includes('mount') || n.includes('sight') || n.includes('muzzle') || n.includes('grip') || n.includes('stock') || n.includes('handguard') || n.includes('magazine') || n.includes('barrel') || n.includes('receiver') || n.includes('scope') || n.includes('flashlight') || n.includes('laser') || n.includes('silencer') || n.includes('suppressor') || n.includes('foregrip') || n.includes('bipod') || n.includes('charge') || n.includes('rail') || n.includes('gas block')) return 'mod';
    if (n.includes('equipment') || n.includes('gear') || n.includes('headwear') || n.includes('eyewear') || n.includes('facecover') || n.includes('headset') || n.includes('armband')) return 'equipment';
    if (n.includes('tool')) return 'tool';
    if (n.includes('electron') || n.includes('battery') || n.includes('circuit')) return 'electronics';
    if (n.includes('build') || n.includes('material')) return 'tool';
    if (n.includes('household') || n.includes('lubricant') || n.includes('fuel')) return 'barter';
    if (n.includes('jewelry') || n.includes('valuable')) return 'barter';
    if (n.includes('money') || n.includes('currency')) return 'money';
    if (n.includes('info') || n.includes('special') || n.includes('map')) return 'info';
    return 'fallback';
  }

  function icon(key, cls) {
    return '<span class="' + (cls || 'ci-icon') + '">' + (ICONS[key] || ICONS.fallback) + '</span>';
  }

  // ═══════════════════════════════════════════════════════
  // STATE
  // ═══════════════════════════════════════════════════════
  var sessionId = localStorage.getItem('zslayer_session') || '';
  var profileName = '';
  var cart = JSON.parse(localStorage.getItem('zslayer_cart') || '[]');
  var flatCats = [];
  var currentSearch = '';
  var currentCategory = '';
  var currentCategoryName = 'All Categories';
  var currentCategoryCount = null;
  var currentOffset = 0;
  var PAGE_SIZE = 50;
  var totalItems = 0;
  var searchTimer = null;
  var ddOpen = false;
  var currentSortField = 'name';
  var currentSortDir = 'asc';
  var lastItems = [];
  var currentMainTab = localStorage.getItem('zslayer_cc_tab') || 'dashboard';

  // ═══════════════════════════════════════════════════════
  // API
  // ═══════════════════════════════════════════════════════
  var BASE = '/zslayer/cc/';
  function api(endpoint, opts) {
    opts = opts || {};
    var h = { 'X-Session-Id': sessionId };
    if (opts.body) h['Content-Type'] = 'application/json';
    return fetch(BASE + endpoint, Object.assign({}, opts, { headers: Object.assign(h, opts.headers || {}) }))
      .then(function(r) { return r.json().then(function(d) { if (!r.ok) throw new Error(d.error || 'Request failed'); return d; }); });
  }

  // ═══════════════════════════════════════════════════════
  // TOASTS
  // ═══════════════════════════════════════════════════════
  function toast(msg, type) {
    type = type || 'info';
    var iconSvg = type === 'success' ? ICONS.check : type === 'error' ? ICONS.x : ICONS.alert;
    var c = document.getElementById('toastContainer');
    var el = document.createElement('div');
    el.className = 'toast ' + type;
    el.innerHTML = '<span class="toast-icon">' + iconSvg + '</span>' + escH(msg);
    c.appendChild(el);
    setTimeout(function() { el.classList.add('toast-fade-out'); setTimeout(function() { el.remove(); }, 300); }, 3500);
  }

  // ═══════════════════════════════════════════════════════
  // AUTH
  // ═══════════════════════════════════════════════════════
  window.connect = function() {
    var input = document.getElementById('sessionInput');
    var errEl = document.getElementById('loginError');
    var btn = document.getElementById('connectBtn');
    var id = input.value.trim();
    if (!id) { errEl.textContent = 'Please enter a session ID'; errEl.style.display = 'block'; return; }
    btn.disabled = true; btn.textContent = 'CONNECTING...'; errEl.style.display = 'none';
    sessionId = id;
    api('auth').then(function(data) {
      if (!data.authorized) { errEl.textContent = data.reason || 'Access denied'; errEl.style.display = 'block'; sessionId = ''; return; }
      profileName = data.profileName;
      localStorage.setItem('zslayer_session', id);
      showMain();
    }).catch(function(e) {
      errEl.textContent = e.message || 'Connection failed'; errEl.style.display = 'block'; sessionId = '';
    }).finally(function() { btn.disabled = false; btn.textContent = 'CONNECT'; });
  };

  window.logout = function() {
    sessionId = ''; profileName = '';
    localStorage.removeItem('zslayer_session');
    document.getElementById('loginScreen').style.display = '';
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('heroBanner').style.display = 'none';
    document.getElementById('headerProfile').style.display = 'none';
    document.getElementById('navBar').style.display = 'none';
    document.getElementById('sessionInput').value = '';
  };

  function showMain() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    document.getElementById('heroBanner').style.display = 'flex';
    document.getElementById('headerProfile').style.display = 'flex';
    document.getElementById('navBar').style.display = 'block';
    document.getElementById('profileNameDisplay').textContent = profileName;
    // Set initial category trigger icon
    document.getElementById('ctIcon').innerHTML = ICONS.all;

    // Restore main tab from hash or localStorage
    var hash = window.location.hash.replace('#', '');
    if (hash && document.getElementById('main-' + hash)) {
      currentMainTab = hash;
    }
    switchMainTab(currentMainTab);

    loadCategories();
    searchItems();
    loadPresets();
    updateCartBadge();
    initDashboard();
    loadConsoleHistory();
    loadHeadlessHistory();
    if (currentMainTab === 'players' && !playersLoaded) loadPlayerRoster();
  }

  // ═══════════════════════════════════════════════════════
  // MAIN NAV TABS (14-tab bar)
  // ═══════════════════════════════════════════════════════
  window.switchMainTab = function(tab) {
    currentMainTab = tab;
    localStorage.setItem('zslayer_cc_tab', tab);
    window.location.hash = tab;

    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(function(b) {
      b.classList.toggle('active', b.dataset.nav === tab);
    });

    // Show/hide main panels
    document.querySelectorAll('.main-tab-panel').forEach(function(p) {
      p.classList.toggle('active', p.id === 'main-' + tab);
    });

    // Lazy-load players on first visit
    if (tab === 'players' && !playersLoaded) loadPlayerRoster();
    // Lazy-load quests on first visit
    if (tab === 'quests' && !questsLoaded) loadQuestBrowser();
    // Lazy-load flea on first visit
    if (tab === 'flea' && !fleaLoaded) fleaInit();
  };

  // ═══════════════════════════════════════════════════════
  // SUB-TABS (Items/Presets/Cart within Items)
  // ═══════════════════════════════════════════════════════
  window.switchTab = function(tab) {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tab); });
    document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.toggle('active', p.id === 'tab-' + tab); });
    if (tab === 'cart') renderCart();
  };

  // ═══════════════════════════════════════════════════════
  // CATEGORY DROPDOWN
  // ═══════════════════════════════════════════════════════
  window.toggleCatDropdown = function() {
    ddOpen = !ddOpen;
    document.getElementById('catTrigger').classList.toggle('open', ddOpen);
    document.getElementById('catPanel').classList.toggle('open', ddOpen);
    if (ddOpen) {
      document.getElementById('catSearchInput').value = '';
      filterCategories('');
      setTimeout(function() { document.getElementById('catSearchInput').focus(); }, 60);
    }
  };

  function closeDd() {
    ddOpen = false;
    document.getElementById('catTrigger').classList.remove('open');
    document.getElementById('catPanel').classList.remove('open');
  }

  function selectCat(id, name, count) {
    currentCategory = id;
    currentCategoryName = name;
    currentCategoryCount = count;
    currentOffset = 0;

    // Update trigger display
    document.getElementById('ctLabel').textContent = name;
    var countEl = document.getElementById('ctCount');
    if (count !== null && count !== undefined) {
      countEl.textContent = count.toLocaleString();
      countEl.style.display = '';
    } else {
      countEl.style.display = 'none';
    }
    var iconKey = id ? getIconKey(name) : 'all';
    document.getElementById('ctIcon').innerHTML = ICONS[iconKey] || ICONS.fallback;

    // Update active state in dropdown
    document.querySelectorAll('.cat-item').forEach(function(el) {
      el.classList.toggle('active', (el.dataset.id || '') === id);
    });

    closeDd();
    searchItems();
  }

  window.filterCategories = function(q) {
    q = (q || '').toLowerCase();
    document.querySelectorAll('.cat-item').forEach(function(el) {
      var name = (el.dataset.name || '').toLowerCase();
      el.style.display = (!q || name.includes(q)) ? '' : 'none';
    });
  };

  document.addEventListener('click', function(e) {
    if (ddOpen && !document.getElementById('catDropdown').contains(e.target)) closeDd();
  });

  // ═══════════════════════════════════════════════════════
  // CATEGORIES
  // ═══════════════════════════════════════════════════════
  function loadCategories() {
    api('categories').then(function(data) {
      var cats = data.categories || [];
      flatCats = [];
      flattenCats(cats, 0);
      renderCatList();
    }).catch(function(e) { console.error('Categories error:', e); });
  }

  function flattenCats(cats, depth) {
    for (var i = 0; i < cats.length; i++) {
      var c = cats[i];
      flatCats.push({ id: c.id, name: c.name, count: c.itemCount, depth: depth, hasKids: c.children && c.children.length > 0 });
      if (c.children && c.children.length) flattenCats(c.children, depth + 1);
    }
  }

  function renderCatList() {
    var list = document.getElementById('catList');
    var html = '';

    // "All Categories" item
    html += '<div class="cat-item active" data-id="" data-name="All Categories" onclick="window._selCat(\'\',\'All Categories\',null)">';
    html += icon('all', 'ci-icon');
    html += '<span class="ci-name">All Categories</span></div>';
    html += '<div class="cat-sep"></div>';

    for (var i = 0; i < flatCats.length; i++) {
      var c = flatCats[i];
      var iKey = getIconKey(c.name);
      var indent = c.depth * 18;
      var parentCls = c.hasKids ? ' is-parent' : '';
      html += '<div class="cat-item' + parentCls + '" data-id="' + escA(c.id) + '" data-name="' + escA(c.name) + '" onclick="window._selCat(\'' + escA(c.id) + '\',\'' + escA(c.name) + '\',' + c.count + ')">';
      if (indent > 0) html += '<span class="ci-indent" style="width:' + indent + 'px"></span>';
      html += icon(iKey, 'ci-icon');
      html += '<span class="ci-name">' + escH(c.name) + '</span>';
      if (c.count > 0) html += '<span class="ci-count">' + c.count.toLocaleString() + '</span>';
      html += '</div>';
    }
    list.innerHTML = html;
  }

  window._selCat = function(id, name, count) { selectCat(id, name, count); };

  // ═══════════════════════════════════════════════════════
  // SORTING
  // ═══════════════════════════════════════════════════════
  window.toggleSort = function(field) {
    if (currentSortField === field) {
      currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortField = field;
      currentSortDir = field === 'name' ? 'asc' : 'desc';
    }
    updateSortHeaders();
    currentOffset = 0;
    searchItems();
  };

  function updateSortHeaders() {
    document.querySelectorAll('.item-table th.sortable').forEach(function(th) {
      var f = th.id.replace('th-', '');
      var arrow = th.querySelector('.sort-arrow');
      if (f === currentSortField) {
        th.classList.add('sort-active');
        arrow.textContent = currentSortDir === 'asc' ? '\u25B2' : '\u25BC';
      } else {
        th.classList.remove('sort-active');
        arrow.textContent = '\u25B2';
      }
    });
  }

  function formatPrice(p) {
    if (!p) return '<span class="price-zero">&mdash;</span>';
    return '\u20BD ' + p.toLocaleString();
  }

  function formatWeight(w) {
    if (!w) return '\u2014';
    return w < 1 ? (w * 1000).toFixed(0) + 'g' : w.toFixed(2) + 'kg';
  }

  // ═══════════════════════════════════════════════════════
  // ITEMS
  // ═══════════════════════════════════════════════════════
  function searchItems() {
    var body = document.getElementById('itemsBody');
    body.innerHTML = '<tr class="loading-row"><td colspan="6"><span class="spinner"></span> Searching...</td></tr>';
    var params = new URLSearchParams();
    if (currentSearch) params.set('search', currentSearch);
    if (currentCategory) params.set('category', currentCategory);
    params.set('limit', PAGE_SIZE);
    params.set('offset', currentOffset);
    params.set('sort', currentSortField);
    params.set('dir', currentSortDir);
    api('items?' + params.toString()).then(function(data) {
      totalItems = data.total;
      lastItems = data.items || [];
      renderItems(lastItems);
      updatePagination();
      updateSortHeaders();
    }).catch(function(e) {
      body.innerHTML = '<tr class="loading-row"><td colspan="6">Error: ' + escH(e.message) + '</td></tr>';
    });
  }

  function renderItems(items) {
    var body = document.getElementById('itemsBody');
    var info = document.getElementById('resultsInfo');
    if (items.length === 0) {
      body.innerHTML = '<tr class="loading-row"><td colspan="6">No items found</td></tr>';
      info.innerHTML = '<span><strong>0</strong> results</span>';
      return;
    }
    var from = currentOffset + 1;
    var to = Math.min(currentOffset + PAGE_SIZE, totalItems);
    var rangeText = totalItems > PAGE_SIZE ? ' &middot; showing ' + from + '&ndash;' + to : '';
    info.innerHTML = '<span><strong>' + totalItems.toLocaleString() + '</strong> result' + (totalItems !== 1 ? 's' : '') + rangeText + '</span>';

    body.innerHTML = items.map(function(item) {
      var catKey = getIconKey(item.category);
      return '<tr>' +
        '<td><div class="item-name-cell"><span class="item-name">' + escH(item.fullName) + '</span><span class="item-name-sub">' + escH(item.shortName) + '</span><span class="item-tpl">' + escH(item.tpl) + '</span></div></td>' +
        '<td><span class="item-cat-badge"><span class="badge-icon">' + (ICONS[catKey] || ICONS.fallback) + '</span> ' + escH(item.category) + '</span></td>' +
        '<td class="col-price">' + formatPrice(item.handbookPrice) + '</td>' +
        '<td class="col-weight">' + formatWeight(item.weight) + '</td>' +
        '<td class="col-stack">' + item.stackMaxSize + '</td>' +
        '<td class="col-actions"><div class="action-group">' +
          '<input type="number" value="1" min="1" max="9999" id="qty-' + item.tpl + '">' +
          '<button class="btn btn-xs btn-accent" onclick="giveItem(\'' + escA(item.tpl) + '\',\'' + escA(item.shortName) + '\')">Give</button>' +
          '<button class="btn btn-xs btn-ghost" onclick="addToCart(\'' + escA(item.tpl) + '\',\'' + escA(item.shortName) + '\',' + item.stackMaxSize + ')" title="Add to cart">+</button>' +
        '</div></td></tr>';
    }).join('');
  }

  function updatePagination() {
    var pag = document.getElementById('pagination');
    var hasPages = totalItems > PAGE_SIZE;
    pag.style.display = hasPages ? 'flex' : 'none';
    if (!hasPages) return;
    var page = Math.floor(currentOffset / PAGE_SIZE) + 1;
    var total = Math.ceil(totalItems / PAGE_SIZE);
    document.getElementById('paginationInfo').textContent = 'Page ' + page + ' of ' + total;
    document.getElementById('prevBtn').disabled = currentOffset === 0;
    document.getElementById('nextBtn').disabled = currentOffset + PAGE_SIZE >= totalItems;
  }

  window.prevPage = function() { currentOffset = Math.max(0, currentOffset - PAGE_SIZE); searchItems(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
  window.nextPage = function() { if (currentOffset + PAGE_SIZE < totalItems) { currentOffset += PAGE_SIZE; searchItems(); window.scrollTo({ top: 0, behavior: 'smooth' }); } };

  // Search input
  document.getElementById('searchInput').addEventListener('input', function() {
    var self = this;
    clearTimeout(searchTimer);
    searchTimer = setTimeout(function() { currentSearch = self.value.trim(); currentOffset = 0; searchItems(); }, 300);
  });
  document.getElementById('searchInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { clearTimeout(searchTimer); currentSearch = this.value.trim(); currentOffset = 0; searchItems(); }
  });
  document.getElementById('sessionInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') window.connect(); });

  // ═══════════════════════════════════════════════════════
  // GIVE
  // ═══════════════════════════════════════════════════════
  window.giveItem = function(tpl, name) {
    var qtyInput = document.getElementById('qty-' + tpl);
    var count = parseInt(qtyInput ? qtyInput.value : '1', 10) || 1;
    api('give', { method: 'POST', body: JSON.stringify({ items: [{ tpl: tpl, count: count }] }) }).then(function(data) {
      if (data.success) toast(count + 'x ' + name + ' sent to mailbox', 'success');
      else toast('Failed: ' + (data.error || 'Unknown error'), 'error');
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  // ═══════════════════════════════════════════════════════
  // CART
  // ═══════════════════════════════════════════════════════
  window.addToCart = function(tpl, name, stackMax) {
    var qtyInput = document.getElementById('qty-' + tpl);
    var count = parseInt(qtyInput ? qtyInput.value : '1', 10) || 1;
    var existing = cart.find(function(c) { return c.tpl === tpl; });
    if (existing) existing.count += count;
    else cart.push({ tpl: tpl, name: name, count: count, stackMax: stackMax });
    saveCart(); updateCartBadge(); toast(count + 'x ' + name + ' added to cart', 'info');
  };

  function saveCart() { localStorage.setItem('zslayer_cart', JSON.stringify(cart)); }
  function updateCartBadge() {
    var b = document.getElementById('cartBadge');
    b.style.display = cart.length > 0 ? 'inline-flex' : 'none';
    b.textContent = cart.length;
  }

  function renderCart() {
    var c = document.getElementById('cartContent');
    if (cart.length === 0) {
      c.innerHTML = '<div class="cart-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg><p>Your cart is empty</p><p class="sub">Use the + button on items to add them here</p></div>';
      return;
    }
    var html = '<table class="item-table"><thead><tr><th>Item</th><th style="text-align:center">Quantity</th><th style="text-align:right">Actions</th></tr></thead><tbody>';
    cart.forEach(function(item, i) {
      html += '<tr><td><div class="item-name-cell"><span class="item-name">' + escH(item.name) + '</span><span class="item-tpl">' + escH(item.tpl) + '</span></div></td>' +
        '<td style="text-align:center"><input type="number" value="' + item.count + '" min="1" max="9999" onchange="updateCartQty(' + i + ',this.value)"></td>' +
        '<td style="text-align:right"><button class="btn btn-sm btn-danger" onclick="removeFromCart(' + i + ')">Remove</button></td></tr>';
    });
    html += '</tbody></table>';
    html += '<div class="cart-summary">' + cart.length + ' item type' + (cart.length !== 1 ? 's' : '') + ' &middot; ' + cart.reduce(function(s, c) { return s + c.count; }, 0) + ' total items</div>';
    html += '<div class="cart-actions"><button class="btn btn-danger" onclick="clearCart()">Clear Cart</button><button class="btn btn-success" onclick="giveCart()">Give All Items</button></div>';
    c.innerHTML = html;
  }

  window.updateCartQty = function(i, v) { cart[i].count = Math.max(1, parseInt(v, 10) || 1); saveCart(); };
  window.removeFromCart = function(i) { var r = cart.splice(i, 1); saveCart(); updateCartBadge(); renderCart(); if (r.length) toast(r[0].name + ' removed', 'info'); };
  window.clearCart = function() { cart = []; saveCart(); updateCartBadge(); renderCart(); toast('Cart cleared', 'info'); };
  window.giveCart = function() {
    if (!cart.length) return;
    api('give', { method: 'POST', body: JSON.stringify({ items: cart.map(function(c) { return { tpl: c.tpl, count: c.count }; }) }) }).then(function(data) {
      if (data.success) { toast(data.itemsGiven + ' items sent to mailbox', 'success'); cart = []; saveCart(); updateCartBadge(); renderCart(); }
      else toast('Failed: ' + (data.error || 'Unknown'), 'error');
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  // ═══════════════════════════════════════════════════════
  // PRESETS
  // ═══════════════════════════════════════════════════════
  function loadPresets() {
    api('presets').then(function(data) {
      var presets = data.presets || [];
      var grid = document.getElementById('presetsGrid');
      if (!presets.length) { grid.innerHTML = '<div style="color:var(--text-dim);padding:60px;text-align:center;font-family:var(--font-mono)">No presets configured &mdash; add presets in server config</div>'; return; }
      grid.innerHTML = presets.map(function(p) {
        return '<div class="preset-card"><h3>' + escH(p.name) + '</h3><div class="preset-desc">' + escH(p.description) + '</div>' +
          '<ul class="preset-items">' + p.items.map(function(it) { return '<li><span class="count">' + it.count + 'x</span> ' + escH(it.note || it.tpl) + '</li>'; }).join('') + '</ul>' +
          '<button class="btn btn-accent btn-sm" onclick="givePreset(\'' + escA(p.id) + '\',\'' + escA(p.name) + '\')">Give Preset</button></div>';
      }).join('');
    }).catch(function(e) { document.getElementById('presetsGrid').innerHTML = '<div style="color:var(--error-bright)">Error: ' + escH(e.message) + '</div>'; });
  }

  window.givePreset = function(id, name) {
    api('preset', { method: 'POST', body: JSON.stringify({ presetId: id }) }).then(function(data) {
      if (data.success) toast(name + ' sent (' + data.itemsGiven + ' items)', 'success');
      else toast('Failed: ' + (data.error || 'Unknown'), 'error');
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  // ═══════════════════════════════════════════════════════
  // DASHBOARD
  // ═══════════════════════════════════════════════════════
  var dashRefreshTimer = null;
  var consoleTimer = null;
  var consoleSince = new Date().toISOString();
  var consoleCollapsed = false;
  var consoleFilters = { info: true, success: true, warning: true, error: true, debug: false };
  var consoleSearchQuery = '';
  var allConsoleEntries = [];
  var headlessTimer = null;
  var headlessStatusTimer = null;
  var headlessSince = new Date().toISOString();
  var headlessCollapsed = false;
  var headlessFilters = { info: true, success: true, warning: true, error: true, debug: false };
  var headlessSearchQuery = '';
  var allHeadlessEntries = [];
  var headlessConfigured = null;
  var activityOffset = 0;
  var activityTotal = 0;
  var ACTIVITY_PAGE = 20;
  var dashConfig = { refreshIntervalSeconds: 30, consolePollingMs: 3000 };

  function initDashboard() {
    // Fetch config first, then load data
    api('dashboard/config').then(function(cfg) {
      dashConfig = cfg;
    }).catch(function(){}).finally(function() {
      refreshDashboard();
      startDashboardTimers();
    });
  }

  function startDashboardTimers() {
    stopDashboardTimers();
    dashRefreshTimer = setInterval(refreshDashboard, dashConfig.refreshIntervalSeconds * 1000);
    consoleTimer = setInterval(pollConsole, dashConfig.consolePollingMs);
    headlessTimer = setInterval(pollHeadless, dashConfig.consolePollingMs);
    headlessStatusTimer = setInterval(pollHeadlessStatus, dashConfig.refreshIntervalSeconds * 1000);
  }

  function stopDashboardTimers() {
    if (dashRefreshTimer) { clearInterval(dashRefreshTimer); dashRefreshTimer = null; }
    if (consoleTimer) { clearInterval(consoleTimer); consoleTimer = null; }
    if (headlessTimer) { clearInterval(headlessTimer); headlessTimer = null; }
    if (headlessStatusTimer) { clearInterval(headlessStatusTimer); headlessStatusTimer = null; }
  }

  window.refreshDashboard = function() {
    loadServerStatus();
    loadPlayers();
    loadEconomy();
    loadRaidStats();
    loadActivity();
    pollConsole();
    pollHeadless();
    pollHeadlessStatus();
    document.getElementById('dashLastRefresh').textContent = new Date().toLocaleTimeString();
  };

  function loadServerStatus() {
    api('dashboard/status').then(function(d) {
      document.getElementById('dashUptime').textContent = d.uptime;
      document.getElementById('dashSptVer').textContent = d.sptVersion || '--';
      document.getElementById('dashCcVer').textContent = d.ccVersion || '--';
      document.getElementById('dashMemory').textContent = d.workingSetMb + ' MB';
      document.getElementById('dashModCount').textContent = d.modCount;
      var modHtml = '';
      (d.mods || []).forEach(function(m) {
        modHtml += '<div style="padding:3px 0;border-bottom:1px solid var(--border-subtle);display:flex;justify-content:space-between">' +
          '<span style="color:var(--text)">' + escH(m.name) + '</span>' +
          '<span style="color:var(--text-muted)">' + escH(m.version) + '</span></div>';
      });
      document.getElementById('dashModList').innerHTML = modHtml || '<span style="color:var(--text-muted)">No mods</span>';
    }).catch(function(e) { console.error('Status error:', e); });
  }

  function loadPlayers() {
    api('dashboard/players').then(function(d) {
      document.getElementById('dashTotalProfiles').textContent = d.totalProfiles;
      document.getElementById('dashOnlineCount').textContent = d.onlineCount;
      document.getElementById('dashOnlineBadge').textContent = d.onlineCount > 0 ? d.onlineCount + ' online' : '';
      var html = '';
      (d.players || []).forEach(function(p) {
        html += '<div class="dash-player">' +
          '<span class="online-dot ' + (p.online ? 'on' : 'off') + '"></span>' +
          '<span class="p-name">' + escH(p.nickname) + '</span>' +
          '<span class="p-detail">Lvl ' + p.level + '</span>' +
          '<span class="p-detail">' + escH(p.side) + '</span>' +
          '<span class="p-detail">' + formatRoubles(p.roubles) + '</span></div>';
      });
      document.getElementById('dashPlayerList').innerHTML = html || '<div style="padding:12px;color:var(--text-muted);text-align:center">No profiles found</div>';
    }).catch(function(e) { console.error('Players error:', e); });
  }

  function loadEconomy() {
    api('dashboard/economy').then(function(d) {
      document.getElementById('dashTotalRoubles').textContent = formatRoubles(d.totalRoubles);
      document.getElementById('dashAvgWealth').textContent = formatRoubles(d.averageWealth);
      var html = '';
      (d.topPlayers || []).forEach(function(p, i) {
        html += '<div class="dash-player">' +
          '<span style="color:var(--accent-dim);font-family:var(--font-mono);font-size:11px;width:18px">#' + (i+1) + '</span>' +
          '<span class="p-name">' + escH(p.nickname) + '</span>' +
          '<span class="p-detail">' + formatRoubles(p.roubles) + '</span></div>';
      });
      document.getElementById('dashTopPlayers').innerHTML = html;
    }).catch(function(e) { console.error('Economy error:', e); });
  }

  function loadRaidStats() {
    api('dashboard/raids').then(function(d) {
      document.getElementById('dashTotalRaids').textContent = d.totalRaids;
      document.getElementById('dashSurvivalRate').textContent = d.totalRaids > 0 ? d.survivalRate + '%' : '--';
      document.getElementById('dashAvgTime').textContent = d.totalRaids > 0 ? formatSeconds(d.avgPlayTimeSeconds) : '--';
      // Raids by map bar chart
      var entries = Object.entries(d.raidsByMap || {}).sort(function(a,b) { return b[1] - a[1]; });
      var maxCount = entries.length > 0 ? entries[0][1] : 1;
      var html = '';
      entries.forEach(function(e) {
        var pct = (e[1] / maxCount * 100).toFixed(0);
        html += '<div class="dash-bar-row">' +
          '<span class="dash-bar-label">' + escH(e[0]) + '</span>' +
          '<div class="dash-bar-track"><div class="dash-bar-fill" style="width:' + pct + '%"></div></div>' +
          '<span class="dash-bar-count">' + e[1] + '</span></div>';
      });
      document.getElementById('dashRaidsByMap').innerHTML = html || '<div style="color:var(--text-muted);font-size:12px">No raids recorded yet</div>';
    }).catch(function(e) { console.error('Raids error:', e); });
  }

  window.loadActivity = function() {
    var typeFilter = document.getElementById('activityTypeFilter').value;
    var params = new URLSearchParams();
    params.set('limit', ACTIVITY_PAGE);
    params.set('offset', activityOffset);
    if (typeFilter) params.set('type', typeFilter);
    api('dashboard/activity?' + params.toString()).then(function(d) {
      activityTotal = d.total;
      var body = document.getElementById('activityBody');
      if (!d.entries || d.entries.length === 0) {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;color:var(--text-muted)">No activity recorded yet</td></tr>';
        document.getElementById('activityPagination').style.display = 'none';
        return;
      }
      body.innerHTML = d.entries.map(function(e) {
        var ts = new Date(e.timestamp);
        return '<tr>' +
          '<td style="white-space:nowrap;font-family:var(--font-mono);font-size:11px">' + ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString() + '</td>' +
          '<td><span class="activity-badge ' + escH(e.type) + '">' + escH(e.type) + '</span></td>' +
          '<td>' + escH(e.adminName) + '</td>' +
          '<td style="color:var(--text)">' + escH(e.details) + '</td></tr>';
      }).join('');
      if (activityTotal > ACTIVITY_PAGE) {
        var pag = document.getElementById('activityPagination');
        pag.style.display = 'flex';
        var page = Math.floor(activityOffset / ACTIVITY_PAGE) + 1;
        var totalPages = Math.ceil(activityTotal / ACTIVITY_PAGE);
        document.getElementById('activityPageInfo').textContent = 'Page ' + page + ' / ' + totalPages;
        document.getElementById('activityPrevBtn').disabled = activityOffset === 0;
        document.getElementById('activityNextBtn').disabled = activityOffset + ACTIVITY_PAGE >= activityTotal;
      } else {
        document.getElementById('activityPagination').style.display = 'none';
      }
    }).catch(function(e) { console.error('Activity error:', e); });
  };

  window.activityPrev = function() { activityOffset = Math.max(0, activityOffset - ACTIVITY_PAGE); loadActivity(); };
  window.activityNext = function() { if (activityOffset + ACTIVITY_PAGE < activityTotal) { activityOffset += ACTIVITY_PAGE; loadActivity(); } };

  // Console
  function pollConsole() {
    if (consoleCollapsed) return;
    api('console?since=' + encodeURIComponent(consoleSince)).then(function(d) {
      if (d.entries && d.entries.length > 0) {
        allConsoleEntries = allConsoleEntries.concat(d.entries);
        // Cap buffer
        if (allConsoleEntries.length > 1000) allConsoleEntries = allConsoleEntries.slice(-500);
        consoleSince = d.entries[d.entries.length - 1].timestamp;
        renderConsole();
      }
      document.getElementById('consoleCount').textContent = '(' + allConsoleEntries.length + ')';
    }).catch(function(){});
  }

  function loadConsoleHistory() {
    api('console?lines=200').then(function(d) {
      if (d.entries && d.entries.length > 0) {
        allConsoleEntries = d.entries;
        consoleSince = d.entries[d.entries.length - 1].timestamp;
        renderConsole();
        document.getElementById('consoleCount').textContent = '(' + allConsoleEntries.length + ')';
      }
    }).catch(function(){});
  }

  function renderConsole() {
    var body = document.getElementById('consoleBody');
    var q = consoleSearchQuery.toLowerCase();
    var html = '';
    var shown = 0;
    for (var i = 0; i < allConsoleEntries.length; i++) {
      var e = allConsoleEntries[i];
      var lvl = (e.level || 'info').toLowerCase();
      if (!consoleFilters[lvl]) continue;
      var msg = e.message || '';
      if (q && msg.toLowerCase().indexOf(q) === -1 && (e.source || '').toLowerCase().indexOf(q) === -1) continue;
      var ts = new Date(e.timestamp);
      var timeStr = ts.toLocaleTimeString();
      html += '<div class="console-line level-' + lvl + '">' +
        '<span class="ts">' + timeStr + '</span>' +
        (e.source ? '<span class="src">[' + escH(e.source) + ']</span>' : '') +
        '<span class="msg">' + escH(msg) + '</span></div>';
      shown++;
    }
    body.innerHTML = html || '<div style="padding:24px;text-align:center;color:var(--text-muted)">No console output</div>';
    // Auto-scroll
    var isNearBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 60;
    if (isNearBottom) body.scrollTop = body.scrollHeight;
    // Show jump button if not at bottom
    var jump = document.getElementById('consoleJump');
    if (body.scrollHeight > body.clientHeight + 80 && !isNearBottom) {
      jump.style.display = 'block';
    } else {
      jump.style.display = 'none';
    }
  }

  window.toggleConsole = function() {
    consoleCollapsed = !consoleCollapsed;
    document.getElementById('consoleBody').classList.toggle('collapsed', consoleCollapsed);
    document.getElementById('consoleSearchWrap').style.display = consoleCollapsed ? 'none' : 'block';
    document.getElementById('consoleJump').style.display = 'none';
    document.getElementById('consoleToggleIcon').innerHTML = consoleCollapsed ? '&#x25B6;' : '&#x25BC;';
    if (!consoleCollapsed) pollConsole();
  };

  window.toggleConsoleFilter = function(btn) {
    var lvl = btn.dataset.level;
    consoleFilters[lvl] = !consoleFilters[lvl];
    btn.classList.toggle('active', consoleFilters[lvl]);
    renderConsole();
  };

  window.filterConsole = function() {
    consoleSearchQuery = document.getElementById('consoleSearchInput').value;
    renderConsole();
  };

  window.scrollConsoleBottom = function() {
    var body = document.getElementById('consoleBody');
    body.scrollTop = body.scrollHeight;
    document.getElementById('consoleJump').style.display = 'none';
  };

  // Headless Process Manager
  function pollHeadlessStatus() {
    api('headless/status').then(function(d) {
      var card = document.getElementById('headlessManagerCard');
      card.style.display = 'block';
      var unavail = document.getElementById('headlessUnavailable');
      var controls = document.getElementById('headlessControls');
      if (!d.available) {
        unavail.style.display = 'block';
        controls.style.display = 'none';
        document.getElementById('headlessStatusBadge').innerHTML = '<span style="color:var(--text-muted)">Unavailable</span>';
        return;
      }
      unavail.style.display = 'none';
      controls.style.display = 'block';
      var badge = document.getElementById('headlessStatusBadge');
      if (d.running) {
        badge.innerHTML = '<span style="color:var(--success-bright)">● Running</span>' + (d.pid ? ' <span style="color:var(--text-muted)">(PID ' + d.pid + ')</span>' : '');
      } else {
        badge.innerHTML = '<span style="color:var(--text-muted)">● Stopped</span>';
      }
      var info = '';
      if (d.running && d.uptime) info += 'Uptime: ' + d.uptime;
      if (d.restartCount > 0) info += (info ? '  |  ' : '') + 'Restarts: ' + d.restartCount;
      document.getElementById('headlessUptimeInfo').textContent = info;
      document.getElementById('btnHeadlessStart').disabled = d.running || !d.profileId;
      document.getElementById('btnHeadlessStop').disabled = !d.running;
      document.getElementById('btnHeadlessRestart').disabled = !d.running;
      var crash = document.getElementById('headlessCrashInfo');
      if (d.lastCrashReason && !d.running) {
        crash.style.display = 'block';
        crash.textContent = d.lastCrashReason;
      } else {
        crash.style.display = 'none';
      }
      document.getElementById('hlAutoStart').checked = d.autoStart;
      document.getElementById('hlAutoRestart').checked = d.autoRestart;
      document.getElementById('hlDelay').value = d.autoStartDelaySec;
      document.getElementById('hlDelayVal').textContent = d.autoStartDelaySec + 's';
      var pid = document.getElementById('hlProfileId');
      if (document.activeElement !== pid) pid.value = d.profileId;
      var warn = document.getElementById('hlProfileWarning');
      warn.style.display = d.profileId ? 'none' : 'block';
    }).catch(function(){});
  }

  window.startHeadless = function() {
    api('headless/start', { method: 'POST' }).then(function(d) {
      if (d.running) showToast('Headless client started (PID ' + d.pid + ')', 'success');
      else showToast(d.lastCrashReason || 'Failed to start', 'error');
      pollHeadlessStatus();
    }).catch(function() { showToast('Failed to start headless', 'error'); });
  };

  window.stopHeadless = function() {
    if (!confirm('Stop the headless client?')) return;
    api('headless/stop', { method: 'POST' }).then(function() {
      showToast('Headless client stopped', 'success');
      pollHeadlessStatus();
    }).catch(function() { showToast('Failed to stop', 'error'); });
  };

  window.restartHeadless = function() {
    api('headless/restart', { method: 'POST' }).then(function(d) {
      if (d.running) showToast('Headless client restarted (PID ' + d.pid + ')', 'success');
      else showToast(d.lastCrashReason || 'Failed to restart', 'error');
      pollHeadlessStatus();
    }).catch(function() { showToast('Failed to restart', 'error'); });
  };

  window.saveHeadlessConfig = function() {
    var body = {
      autoStart: document.getElementById('hlAutoStart').checked,
      autoRestart: document.getElementById('hlAutoRestart').checked,
      autoStartDelaySec: parseInt(document.getElementById('hlDelay').value),
      profileId: document.getElementById('hlProfileId').value.trim()
    };
    api('headless/config', { method: 'POST', body: JSON.stringify(body) }).then(function() {
      pollHeadlessStatus();
    }).catch(function() { showToast('Failed to save config', 'error'); });
  };

  // Headless Console
  function pollHeadless() {
    if (headlessCollapsed) return;
    if (headlessConfigured === false) return;
    api('headless-console?since=' + encodeURIComponent(headlessSince)).then(function(d) {
      if (d.configured === false) {
        headlessConfigured = false;
        document.getElementById('headlessBody').innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)">Headless log path not configured &mdash; set <code>headlessLogPath</code> in config.json</div>';
        document.getElementById('headlessCount').textContent = '';
        return;
      }
      headlessConfigured = true;
      if (d.entries && d.entries.length > 0) {
        allHeadlessEntries = allHeadlessEntries.concat(d.entries);
        if (allHeadlessEntries.length > 1000) allHeadlessEntries = allHeadlessEntries.slice(-500);
        headlessSince = d.entries[d.entries.length - 1].timestamp;
        renderHeadless();
      }
      document.getElementById('headlessCount').textContent = '(' + allHeadlessEntries.length + ')';
    }).catch(function(){});
  }

  function loadHeadlessHistory() {
    api('headless-console?lines=200').then(function(d) {
      if (d.configured === false) {
        headlessConfigured = false;
        document.getElementById('headlessBody').innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)">Headless log path not configured &mdash; set <code>headlessLogPath</code> in config.json</div>';
        document.getElementById('headlessCount').textContent = '';
        return;
      }
      headlessConfigured = true;
      if (d.entries && d.entries.length > 0) {
        allHeadlessEntries = d.entries;
        headlessSince = d.entries[d.entries.length - 1].timestamp;
        renderHeadless();
        document.getElementById('headlessCount').textContent = '(' + allHeadlessEntries.length + ')';
      }
    }).catch(function(){});
  }

  function renderHeadless() {
    var body = document.getElementById('headlessBody');
    var q = headlessSearchQuery.toLowerCase();
    var html = '';
    for (var i = 0; i < allHeadlessEntries.length; i++) {
      var e = allHeadlessEntries[i];
      var lvl = (e.level || 'info').toLowerCase();
      if (!headlessFilters[lvl]) continue;
      var msg = e.message || '';
      if (q && msg.toLowerCase().indexOf(q) === -1 && (e.source || '').toLowerCase().indexOf(q) === -1) continue;
      var ts = new Date(e.timestamp);
      var timeStr = ts.toLocaleTimeString();
      html += '<div class="console-line level-' + lvl + '">' +
        '<span class="ts">' + timeStr + '</span>' +
        (e.source ? '<span class="src">[' + escH(e.source) + ']</span>' : '') +
        '<span class="msg">' + escH(msg) + '</span></div>';
    }
    body.innerHTML = html || '<div style="padding:24px;text-align:center;color:var(--text-muted)">No headless output</div>';
    var isNearBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 60;
    if (isNearBottom) body.scrollTop = body.scrollHeight;
    var jump = document.getElementById('headlessJump');
    if (body.scrollHeight > body.clientHeight + 80 && !isNearBottom) {
      jump.style.display = 'block';
    } else {
      jump.style.display = 'none';
    }
  }

  window.toggleHeadless = function() {
    headlessCollapsed = !headlessCollapsed;
    document.getElementById('headlessBody').classList.toggle('collapsed', headlessCollapsed);
    document.getElementById('headlessSearchWrap').style.display = headlessCollapsed ? 'none' : 'block';
    document.getElementById('headlessJump').style.display = 'none';
    document.getElementById('headlessToggleIcon').innerHTML = headlessCollapsed ? '&#x25B6;' : '&#x25BC;';
    if (!headlessCollapsed) pollHeadless();
  };

  window.toggleHeadlessFilter = function(btn) {
    var lvl = btn.dataset.level;
    headlessFilters[lvl] = !headlessFilters[lvl];
    btn.classList.toggle('active', headlessFilters[lvl]);
    renderHeadless();
  };

  window.filterHeadless = function() {
    headlessSearchQuery = document.getElementById('headlessSearchInput').value;
    renderHeadless();
  };

  window.scrollHeadlessBottom = function() {
    var body = document.getElementById('headlessBody');
    body.scrollTop = body.scrollHeight;
    document.getElementById('headlessJump').style.display = 'none';
  };

  // Broadcast
  window.sendUrlsToPlayers = function() {
    if (!confirm('Send Command Center URLs to all players via in-game mail?')) return;
    api('dashboard/send-urls', { method: 'POST' }).then(function(d) {
      if (d.success) showToast('URLs sent to ' + d.recipientCount + ' player(s)', 'success');
      else showToast('Failed: ' + (d.error || 'Unknown error'), 'error');
    }).catch(function() { showToast('Failed to send URLs', 'error'); });
  };

  window.openBroadcastModal = function() {
    document.getElementById('broadcastModal').classList.add('open');
    document.getElementById('broadcastMessage').value = '';
    document.getElementById('broadcastMessage').focus();
  };

  window.closeBroadcastModal = function() {
    document.getElementById('broadcastModal').classList.remove('open');
  };

  window.sendBroadcast = function() {
    var msg = document.getElementById('broadcastMessage').value.trim();
    if (!msg) { toast('Message cannot be empty', 'error'); return; }
    api('dashboard/broadcast', { method: 'POST', body: JSON.stringify({ message: msg }) }).then(function(d) {
      if (d.success) {
        toast('Broadcast sent to ' + d.recipientCount + ' profiles', 'success');
        closeBroadcastModal();
        loadActivity();
      } else {
        toast('Failed: ' + (d.error || 'Unknown'), 'error');
      }
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  function formatRoubles(n) {
    if (n == null) return '--';
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
    return n.toLocaleString();
  }

  function formatSeconds(s) {
    if (!s) return '--';
    var m = Math.floor(s / 60);
    var sec = s % 60;
    return m + 'm ' + sec + 's';
  }

  // ═══════════════════════════════════════════════════════
  // PLAYER MANAGEMENT
  // ═══════════════════════════════════════════════════════
  var playersData = [], playerSearch = '', playerFaction = '';
  var playerSort = 'level', playerSortDir = 'desc';
  var playerOffset = 0, playerTotal = 0, PLAYER_PAGE = 50;
  var expandedPlayerId = null, playerProfileCache = {};
  var playerSearchTimer = null;
  var currentMailTarget = '', currentModifyTarget = '', currentResetTarget = '', currentBanTarget = '';
  var currentGiveTarget = '', giveMode = 'player'; // 'player' or 'all'
  var banSectionCollapsed = false;
  var playersLoaded = false;

  var MAIL_TEMPLATES = {
    welcome: 'Welcome to the server! Please read the rules in Discord and enjoy your raids.',
    rules: 'Reminder: No cheating, no exploiting, be respectful to other players. Violations will result in a ban.',
    event: 'A special event is now live! Check Discord for details and enjoy the limited-time rewards.'
  };

  window.debouncePlayerSearch = function() {
    clearTimeout(playerSearchTimer);
    playerSearchTimer = setTimeout(function() { playerOffset = 0; loadPlayerRoster(); }, 300);
  };

  window.loadPlayerRoster = function() {
    var search = document.getElementById('playerSearchInput').value.trim();
    var faction = document.getElementById('playerFactionFilter').value;
    var qs = 'players?sort=' + encodeURIComponent(playerSort) + '&dir=' + encodeURIComponent(playerSortDir);
    if (search) qs += '&search=' + encodeURIComponent(search);
    if (faction) qs += '&faction=' + encodeURIComponent(faction);
    api(qs).then(function(data) {
      playersData = data.players || [];
      playerTotal = data.total || 0;
      playersLoaded = true;
      renderPlayerRoster();
      loadBanList();
    }).catch(function(e) {
      document.getElementById('playerRosterBody').innerHTML = '<div style="color:var(--error-bright);text-align:center;padding:30px">Error loading players: ' + escH(e.message) + '</div>';
    });
  };

  function renderPlayerRoster() {
    var body = document.getElementById('playerRosterBody');
    if (playersData.length === 0) {
      body.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:40px 0">No players found</div>';
      document.getElementById('playerPagination').style.display = 'none';
      return;
    }
    var paged = playersData.slice(playerOffset, playerOffset + PLAYER_PAGE);
    var html = '<table class="player-table"><thead><tr>';
    html += '<th onclick="togglePlayerSort(\'name\')">Name' + playerSortArrow('name') + '</th>';
    html += '<th onclick="togglePlayerSort(\'level\')">Level' + playerSortArrow('level') + '</th>';
    html += '<th>Side</th>';
    html += '<th onclick="togglePlayerSort(\'roubles\')">Roubles' + playerSortArrow('roubles') + '</th>';
    html += '<th>Status</th>';
    html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';
    for (var i = 0; i < paged.length; i++) {
      var p = paged[i];
      var isExpanded = expandedPlayerId === p.sessionId;
      html += '<tr class="' + (isExpanded ? 'expanded' : '') + '" style="cursor:pointer" onclick="togglePlayerExpand(\'' + escA(p.sessionId) + '\')">';
      html += '<td><span class="online-dot ' + (p.online ? 'on' : 'off') + '"></span>' + escH(p.nickname);
      if (p.banned) html += ' <span class="ban-badge">banned</span>';
      html += '</td>';
      html += '<td>' + p.level + '</td>';
      html += '<td><span class="faction-badge ' + (p.side || '').toLowerCase() + '">' + escH(p.side) + '</span></td>';
      html += '<td style="font-family:var(--font-mono);font-size:12px">' + formatRoubles(p.roubles) + '</td>';
      html += '<td>' + (p.online ? '<span style="color:var(--success-bright);font-size:12px">Online</span>' : '<span style="color:var(--text-muted);font-size:12px">Offline</span>') + '</td>';
      html += '<td style="white-space:nowrap">';
      html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openMailModal(\'' + escA(p.sessionId) + '\',\'' + escA(p.nickname) + '\')" title="Mail">Mail</button> ';
      html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openGiveModal(\'' + escA(p.sessionId) + '\',\'' + escA(p.nickname) + '\')" title="Give">Give</button> ';
      if (!p.banned) html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openBanModal(\'' + escA(p.sessionId) + '\',\'' + escA(p.nickname) + '\')" title="Ban" style="color:var(--error-bright)">Ban</button>';
      else html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();unbanPlayer(\'' + escA(p.sessionId) + '\')" title="Unban" style="color:var(--success-bright)">Unban</button>';
      html += '</td></tr>';
      if (isExpanded) {
        html += '<tr class="player-detail-row"><td colspan="6"><div class="player-detail-inner" id="playerDetailInner">Loading...</div></td></tr>';
      }
    }
    html += '</tbody></table>';
    body.innerHTML = html;

    // Pagination
    var pg = document.getElementById('playerPagination');
    if (playerTotal > PLAYER_PAGE) {
      pg.style.display = 'flex';
      document.getElementById('playerPaginationInfo').textContent = (playerOffset + 1) + '-' + Math.min(playerOffset + PLAYER_PAGE, playerTotal) + ' of ' + playerTotal;
    } else {
      pg.style.display = 'none';
    }

    if (expandedPlayerId) loadPlayerProfile(expandedPlayerId);
  }

  function playerSortArrow(field) {
    if (playerSort !== field) return '';
    return ' <span class="sort-arrow">' + (playerSortDir === 'asc' ? '&#9650;' : '&#9660;') + '</span>';
  }

  window.togglePlayerSort = function(field) {
    if (playerSort === field) playerSortDir = playerSortDir === 'asc' ? 'desc' : 'asc';
    else { playerSort = field; playerSortDir = field === 'name' ? 'asc' : 'desc'; }
    loadPlayerRoster();
  };

  window.playerPagePrev = function() {
    if (playerOffset > 0) { playerOffset -= PLAYER_PAGE; renderPlayerRoster(); }
  };
  window.playerPageNext = function() {
    if (playerOffset + PLAYER_PAGE < playerTotal) { playerOffset += PLAYER_PAGE; renderPlayerRoster(); }
  };

  // ── Player Expand / Profile Viewer ──
  window.togglePlayerExpand = function(sid) {
    if (expandedPlayerId === sid) { expandedPlayerId = null; renderPlayerRoster(); }
    else { expandedPlayerId = sid; renderPlayerRoster(); }
  };

  function loadPlayerProfile(sid) {
    api('player/' + encodeURIComponent(sid)).then(function(data) {
      playerProfileCache[sid] = data;
      renderPlayerProfile(data);
    }).catch(function(e) {
      var inner = document.getElementById('playerDetailInner');
      if (inner) inner.innerHTML = '<div style="color:var(--error-bright)">Error: ' + escH(e.message) + '</div>';
    });
  }

  var activeProfileTab = 'overview';

  function renderPlayerProfile(data) {
    var inner = document.getElementById('playerDetailInner');
    if (!inner) return;
    var sid = data.sessionId;
    var html = '';

    // Actions bar
    html += '<div class="player-actions-bar">';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openMailModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')">Mail</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openGiveModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')">Give Items</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModifyModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')">Modify</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openResetModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')" style="color:var(--warning)">Reset</button>';
    html += '</div>';

    // Sub-tabs
    html += '<div class="player-profile-tabs" onclick="event.stopPropagation()">';
    var tabs = ['overview','stash','skills','quests','hideout','traders'];
    var tabLabels = ['Overview','Stash','Skills','Quests','Hideout','Traders'];
    for (var i = 0; i < tabs.length; i++) {
      html += '<button class="ptab' + (activeProfileTab === tabs[i] ? ' active' : '') + '" onclick="event.stopPropagation();switchProfileTab(\'' + tabs[i] + '\',\'' + escA(sid) + '\')">' + tabLabels[i] + '</button>';
    }
    html += '</div>';

    // Panels
    html += renderProfileOverview(data);
    html += renderProfileStash(sid);
    html += renderProfileSkills(data);
    html += renderProfileQuests(data);
    html += renderProfileHideout(data);
    html += renderProfileTraders(data);

    inner.innerHTML = html;
  }

  window.switchProfileTab = function(tab, sid) {
    activeProfileTab = tab;
    document.querySelectorAll('.player-profile-tabs .ptab').forEach(function(b) {
      b.classList.toggle('active', b.textContent.toLowerCase() === tab);
    });
    document.querySelectorAll('.profile-panel').forEach(function(p) {
      p.classList.toggle('active', p.dataset.panel === tab);
    });
    if (tab === 'stash' && sid) loadPlayerStash(sid, 0);
  };

  function renderProfileOverview(d) {
    var active = activeProfileTab === 'overview' ? ' active' : '';
    var kd = (d.pmcKills || 0) + (d.scavKills || 0);
    var deaths = (d.kia || 0) + (d.mia || 0);
    var kdRatio = deaths > 0 ? (kd / deaths).toFixed(2) : kd > 0 ? kd + '.00' : '0.00';
    var xpPct = d.experienceToNextLevel > 0 ? Math.round(100 - (d.experienceToNextLevel / (d.experience + d.experienceToNextLevel) * 100)) : 100;
    var html = '<div class="profile-panel' + active + '" data-panel="overview">';
    html += '<div class="profile-header">';
    html += statCard('Level', d.level, '<div class="xp-bar"><div class="xp-bar-fill" style="width:' + xpPct + '%"></div></div><div class="psc-sub">' + (d.experience || 0).toLocaleString() + ' XP (' + (d.experienceToNextLevel || 0).toLocaleString() + ' to next)</div>');
    html += statCard('Faction', '<span class="faction-badge ' + (d.side || '').toLowerCase() + '">' + escH(d.side) + '</span>');
    html += statCard('Stash Value', formatRoubles(Math.round(d.stashValue || 0)), '', 'accent');
    html += statCard('Roubles', formatRoubles(d.currencies ? d.currencies.roubles : 0));
    html += statCard('Dollars', formatRoubles(d.currencies ? d.currencies.dollars : 0));
    html += statCard('Euros', formatRoubles(d.currencies ? d.currencies.euros : 0));
    html += '</div>';
    html += '<div class="profile-header">';
    html += statCard('Survival Rate', (d.survivalRate || 0) + '%');
    html += statCard('Total Raids', d.totalRaids || 0);
    html += statCard('Survived', d.survived || 0);
    html += statCard('KIA', d.kia || 0);
    html += statCard('MIA', d.mia || 0);
    html += statCard('Run Through', d.runThrough || 0);
    html += statCard('PMC Kills', d.pmcKills || 0);
    html += statCard('Scav Kills', d.scavKills || 0);
    html += statCard('K/D', kdRatio);
    html += '</div>';
    html += '</div>';
    return html;
  }

  function statCard(label, value, extra, cls) {
    return '<div class="profile-stat-card"><div class="psc-label">' + label + '</div><div class="psc-value' + (cls ? ' ' + cls : '') + '">' + value + '</div>' + (extra || '') + '</div>';
  }

  // ── Stash ──
  var stashCache = {};
  function renderProfileStash(sid) {
    var active = activeProfileTab === 'stash' ? ' active' : '';
    return '<div class="profile-panel' + active + '" data-panel="stash" id="stashPanel_' + sid + '">' +
      '<div style="color:var(--text-dim);text-align:center;padding:20px">Click to load stash data</div></div>';
  }

  window.loadPlayerStash = function(sid, offset) {
    var panel = document.getElementById('stashPanel_' + sid);
    if (!panel) return;
    panel.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px">Loading stash...</div>';
    api('player/' + encodeURIComponent(sid) + '/stash?limit=50&offset=' + (offset || 0)).then(function(data) {
      stashCache[sid] = data;
      var html = '<div style="margin-bottom:8px;font-size:12px;color:var(--text-dim)">' + (data.totalItems || 0) + ' items | Stash value: ' + formatRoubles(Math.round(data.stashValue || 0)) + '</div>';
      if (data.items && data.items.length > 0) {
        html += '<table class="profile-mini-table"><thead><tr><th>Name</th><th>TPL</th><th>Qty</th></tr></thead><tbody>';
        for (var i = 0; i < data.items.length; i++) {
          var it = data.items[i];
          html += '<tr><td>' + escH(it.name) + '</td><td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">' + escH(it.tpl).substring(0, 12) + '...</td><td>' + it.count + '</td></tr>';
        }
        html += '</tbody></table>';
        // pagination
        var total = data.totalItems || 0;
        var off = data.offset || 0;
        var lim = data.limit || 50;
        if (total > lim) {
          html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px">';
          html += '<span style="color:var(--text-dim)">' + (off + 1) + '-' + Math.min(off + lim, total) + ' of ' + total + '</span>';
          html += '<div>';
          if (off > 0) html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();loadPlayerStash(\'' + escA(sid) + '\',' + (off - lim) + ')">Prev</button> ';
          if (off + lim < total) html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();loadPlayerStash(\'' + escA(sid) + '\',' + (off + lim) + ')">Next</button>';
          html += '</div></div>';
        }
      } else {
        html += '<div style="color:var(--text-dim);text-align:center;padding:20px">Stash is empty</div>';
      }
      panel.innerHTML = html;
    }).catch(function(e) {
      panel.innerHTML = '<div style="color:var(--error-bright)">Error: ' + escH(e.message) + '</div>';
    });
  };

  // ── Skills ──
  function renderProfileSkills(d) {
    var active = activeProfileTab === 'skills' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="skills">';
    var skills = d.skills || [];
    if (skills.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No skill data</div>'; }
    else {
      html += '<table class="profile-mini-table"><thead><tr><th>Skill</th><th>Level</th><th>Progress</th><th></th></tr></thead><tbody>';
      for (var i = 0; i < skills.length; i++) {
        var s = skills[i];
        var pct = Math.min(100, (s.progress % 100));
        html += '<tr><td>' + escH(s.id) + '</td><td>' + s.level;
        if (s.isElite) html += ' <span class="status-badge completed">Elite</span>';
        html += '</td><td><div class="skill-bar"><div class="skill-bar-fill" style="width:' + pct + '%"></div></div></td>';
        html += '<td style="font-size:11px;color:var(--text-dim)">' + Math.round(s.progress) + '</td></tr>';
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Quests ──
  var expandedQuests = {};
  window.toggleQuestDetail = function(idx) {
    expandedQuests[idx] = !expandedQuests[idx];
    var chevron = document.getElementById('qchev_' + idx);
    var detail = document.getElementById('qdet_' + idx);
    if (chevron) chevron.classList.toggle('expanded', !!expandedQuests[idx]);
    if (detail) detail.style.display = expandedQuests[idx] ? '' : 'none';
  };

  function renderProfileQuests(d) {
    var active = activeProfileTab === 'quests' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="quests">';
    var quests = d.quests || [];
    if (quests.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No quest data</div>'; }
    else {
      html += '<table class="profile-mini-table"><thead><tr><th>Quest Name</th><th>Quest ID</th><th>Trader</th><th>Status</th><th style="width:30px"></th></tr></thead><tbody>';
      for (var i = 0; i < quests.length; i++) {
        var q = quests[i];
        var st = (q.status || '').toLowerCase();
        var badgeCls = st.includes('success') || st.includes('complete') ? 'completed' : st.includes('fail') ? 'failed' : st.includes('started') || st.includes('avail') ? 'active' : 'locked';
        var qid = q.questId || '';
        var qidShort = qid.length > 8 ? qid.substring(0, 8) + '...' : qid;
        var hasConds = q.conditions && q.conditions.length > 0;
        var isExp = !!expandedQuests[i];
        html += '<tr>';
        html += '<td style="font-weight:500">' + escH(q.questName || qid) + '</td>';
        html += '<td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)" title="' + escA(qid) + '">' + escH(qidShort) + '</td>';
        html += '<td>' + escH(q.traderName || 'Unknown') + '</td>';
        html += '<td><span class="status-badge ' + badgeCls + '">' + escH(q.status) + '</span></td>';
        html += '<td style="text-align:center">';
        if (hasConds) {
          html += '<span id="qchev_' + i + '" class="quest-chevron' + (isExp ? ' expanded' : '') + '" onclick="event.stopPropagation();toggleQuestDetail(' + i + ')">&#9654;</span>';
        }
        html += '</td></tr>';
        // Detail row
        if (hasConds) {
          html += '<tr id="qdet_' + i + '" class="quest-detail-row" style="display:' + (isExp ? '' : 'none') + '"><td colspan="5"><div class="quest-detail-inner">';
          for (var j = 0; j < q.conditions.length; j++) {
            var c = q.conditions[j];
            var cls = c.completed ? 'completed' : 'pending';
            var icon = c.completed ? '&#10003;' : '&#9675;';
            html += '<div class="quest-condition ' + cls + '">';
            html += '<span class="qc-icon">' + icon + '</span>';
            html += '<span class="qc-type">' + escH(c.type) + '</span>';
            html += '<span class="qc-text">' + escH(c.description) + '</span>';
            html += '</div>';
          }
          html += '</div></td></tr>';
        }
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Hideout ──
  var HIDEOUT_NAMES = ['NotSet','Vents','Security','Lavatory','Stash','Generator','Heating','Water','MedStation','Nutrition','Illumination','Workbench','IntelCenter','ShootingRange','Library','ScavCase','Stash2','Stash3','Stash4','Christmas','EmergencyWall','Gym','Defective','IntegratedSecurity','MetalCutting','Greenhouse','CultistAltar'];
  function renderProfileHideout(d) {
    var active = activeProfileTab === 'hideout' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="hideout">';
    var areas = d.hideoutAreas || [];
    if (areas.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No hideout data</div>'; }
    else {
      html += '<table class="profile-mini-table"><thead><tr><th>Area</th><th>Level</th><th>Status</th></tr></thead><tbody>';
      for (var i = 0; i < areas.length; i++) {
        var a = areas[i];
        var name = HIDEOUT_NAMES[a.areaType] || ('Area ' + a.areaType);
        var status = a.constructing ? '<span style="color:var(--warning);font-size:11px">Constructing</span>' : a.active ? '<span style="color:var(--success-bright);font-size:11px">Active</span>' : '<span style="color:var(--text-dim);font-size:11px">Inactive</span>';
        html += '<tr><td>' + escH(name) + '</td><td>' + a.level + '</td><td>' + status + '</td></tr>';
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Traders ──
  function renderProfileTraders(d) {
    var active = activeProfileTab === 'traders' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="traders">';
    var traders = d.traders || [];
    if (traders.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No trader data</div>'; }
    else {
      var romans = ['0','I','II','III','IV'];
      html += '<table class="profile-mini-table"><thead><tr><th>Trader</th><th>Loyalty</th><th>Standing</th><th>Sales</th></tr></thead><tbody>';
      for (var i = 0; i < traders.length; i++) {
        var t = traders[i];
        html += '<tr><td>' + escH(t.traderName) + '</td>';
        html += '<td style="color:var(--accent);font-family:var(--font-mono)">' + (romans[t.loyaltyLevel] || t.loyaltyLevel) + '</td>';
        html += '<td style="font-family:var(--font-mono)">' + (t.standing || 0).toFixed(2) + '</td>';
        html += '<td style="font-family:var(--font-mono);font-size:12px">' + formatRoubles(t.salesSum || 0) + '</td></tr>';
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Modals ──
  window.closeModal = function(id) {
    document.getElementById(id).classList.remove('open');
  };

  window.openMailModal = function(sid, name) {
    currentMailTarget = sid;
    document.getElementById('mailRecipientName').textContent = name;
    document.getElementById('mailMessage').value = '';
    document.getElementById('mailTemplate').value = '';
    document.getElementById('mailRoubles').value = '0';
    document.getElementById('mailDollars').value = '0';
    document.getElementById('mailEuros').value = '0';
    document.getElementById('mailItemRows').innerHTML = '';
    document.getElementById('playerMailModal').classList.add('open');
  };

  window.applyMailTemplate = function() {
    var key = document.getElementById('mailTemplate').value;
    if (MAIL_TEMPLATES[key]) document.getElementById('mailMessage').value = MAIL_TEMPLATES[key];
  };

  window.addMailItemRow = function() {
    var container = document.getElementById('mailItemRows');
    var row = document.createElement('div');
    row.className = 'mail-item-row';
    row.innerHTML = '<input type="text" placeholder="Item Template ID" class="mail-item-tpl"><input type="number" min="1" value="1" class="mail-item-count" style="max-width:80px"><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">X</button>';
    container.appendChild(row);
  };

  window.sendPlayerMail = function() {
    var msg = document.getElementById('mailMessage').value.trim();
    if (!msg) { toast('Message is required', 'error'); return; }
    var items = collectItemRows('mailItemRows');
    var body = {
      message: msg, items: items,
      roubles: parseInt(document.getElementById('mailRoubles').value) || 0,
      dollars: parseInt(document.getElementById('mailDollars').value) || 0,
      euros: parseInt(document.getElementById('mailEuros').value) || 0
    };
    api('player/' + encodeURIComponent(currentMailTarget) + '/mail', { method: 'POST', body: JSON.stringify(body) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Mail sent', 'success'); closeModal('playerMailModal'); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openModifyModal = function(sid, name) {
    currentModifyTarget = sid;
    document.getElementById('modifyTargetName').textContent = name;
    document.getElementById('modifyLevel').value = '';
    document.getElementById('modifyFaction').value = '';
    document.getElementById('modifyRoubles').value = '0';
    document.getElementById('modifyDollars').value = '0';
    document.getElementById('modifyEuros').value = '0';
    document.getElementById('playerModifyModal').classList.add('open');
  };

  window.submitModify = function() {
    var body = {};
    var lvl = parseInt(document.getElementById('modifyLevel').value);
    if (lvl > 0) body.level = lvl;
    var fac = document.getElementById('modifyFaction').value;
    if (fac) body.faction = fac;
    var r = parseInt(document.getElementById('modifyRoubles').value) || 0;
    var d = parseInt(document.getElementById('modifyDollars').value) || 0;
    var e = parseInt(document.getElementById('modifyEuros').value) || 0;
    if (r > 0) body.roubles = r;
    if (d > 0) body.dollars = d;
    if (e > 0) body.euros = e;
    api('player/' + encodeURIComponent(currentModifyTarget) + '/modify', { method: 'POST', body: JSON.stringify(body) })
      .then(function(res) {
        if (res.success) { toast(res.message || 'Modified', 'success'); closeModal('playerModifyModal'); delete playerProfileCache[currentModifyTarget]; if (expandedPlayerId === currentModifyTarget) loadPlayerProfile(currentModifyTarget); loadPlayerRoster(); }
        else toast(res.error || 'Failed', 'error');
      }).catch(function(err) { toast('Error: ' + err.message, 'error'); });
  };

  window.openResetModal = function(sid, name) {
    currentResetTarget = sid;
    document.getElementById('resetTargetName').textContent = name;
    document.getElementById('resetSkills').checked = false;
    document.getElementById('resetQuests').checked = false;
    document.getElementById('resetTraders').checked = false;
    document.getElementById('resetHideout').checked = false;
    document.getElementById('resetFull').checked = false;
    document.getElementById('resetConfirmInput').value = '';
    document.getElementById('resetConfirmBtn').disabled = true;
    document.getElementById('playerResetModal').classList.add('open');
  };

  window.toggleFullReset = function() {
    var full = document.getElementById('resetFull').checked;
    document.getElementById('resetSkills').checked = full;
    document.getElementById('resetQuests').checked = full;
    document.getElementById('resetTraders').checked = full;
    document.getElementById('resetHideout').checked = full;
  };

  window.checkResetConfirm = function() {
    document.getElementById('resetConfirmBtn').disabled = document.getElementById('resetConfirmInput').value.trim() !== 'RESET';
  };

  window.submitReset = function() {
    var cats = [];
    if (document.getElementById('resetFull').checked) cats.push('full');
    else {
      if (document.getElementById('resetSkills').checked) cats.push('skills');
      if (document.getElementById('resetQuests').checked) cats.push('quests');
      if (document.getElementById('resetTraders').checked) cats.push('traders');
      if (document.getElementById('resetHideout').checked) cats.push('hideout');
    }
    if (cats.length === 0) { toast('Select at least one category', 'error'); return; }
    api('player/' + encodeURIComponent(currentResetTarget) + '/reset', { method: 'POST', body: JSON.stringify({ categories: cats }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Reset complete', 'success'); closeModal('playerResetModal'); delete playerProfileCache[currentResetTarget]; if (expandedPlayerId === currentResetTarget) loadPlayerProfile(currentResetTarget); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openBanModal = function(sid, name) {
    currentBanTarget = sid;
    document.getElementById('banTargetName').textContent = name;
    document.getElementById('banReason').value = '';
    document.getElementById('playerBanModal').classList.add('open');
  };

  window.confirmBan = function() {
    var reason = document.getElementById('banReason').value.trim() || 'No reason given';
    api('players/ban', { method: 'POST', body: JSON.stringify({ sessionId: currentBanTarget, reason: reason }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Banned', 'success'); closeModal('playerBanModal'); loadPlayerRoster(); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.unbanPlayer = function(sid) {
    api('players/unban', { method: 'POST', body: JSON.stringify({ sessionId: sid }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Unbanned', 'success'); loadPlayerRoster(); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openGiveModal = function(sid, name) {
    currentGiveTarget = sid; giveMode = 'player';
    document.getElementById('giveModalTitle').textContent = 'Give Items';
    document.getElementById('giveModalSub').textContent = 'To: ' + name;
    document.getElementById('giveItemRows').innerHTML = '';
    addGiveItemRow();
    document.getElementById('playerGiveModal').classList.add('open');
  };

  window.openGiveAllModal = function() {
    giveMode = 'all';
    document.getElementById('giveModalTitle').textContent = 'Give Items to All';
    document.getElementById('giveModalSub').textContent = 'Items will be sent to all registered players.';
    document.getElementById('giveItemRows').innerHTML = '';
    addGiveItemRow();
    document.getElementById('playerGiveModal').classList.add('open');
  };

  window.addGiveItemRow = function() {
    var container = document.getElementById('giveItemRows');
    var row = document.createElement('div');
    row.className = 'mail-item-row';
    row.innerHTML = '<input type="text" placeholder="Item Template ID" class="give-item-tpl"><input type="number" min="1" value="1" class="give-item-count" style="max-width:80px"><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">X</button>';
    container.appendChild(row);
  };

  window.submitGive = function() {
    var items = collectItemRows('giveItemRows');
    if (items.length === 0) { toast('Add at least one item', 'error'); return; }
    var endpoint = giveMode === 'all' ? 'player/give-all' : 'player/' + encodeURIComponent(currentGiveTarget) + '/give';
    api(endpoint, { method: 'POST', body: JSON.stringify({ items: items }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Items sent', 'success'); closeModal('playerGiveModal'); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openBroadcastMailModal = function() {
    document.getElementById('broadcastMailMessage').value = '';
    document.getElementById('broadcastRoubles').value = '0';
    document.getElementById('broadcastDollars').value = '0';
    document.getElementById('broadcastEuros').value = '0';
    document.getElementById('broadcastItemRows').innerHTML = '';
    document.getElementById('broadcastMailModal').classList.add('open');
  };

  window.addBroadcastItemRow = function() {
    var container = document.getElementById('broadcastItemRows');
    var row = document.createElement('div');
    row.className = 'mail-item-row';
    row.innerHTML = '<input type="text" placeholder="Item Template ID" class="bc-item-tpl"><input type="number" min="1" value="1" class="bc-item-count" style="max-width:80px"><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">X</button>';
    container.appendChild(row);
  };

  window.sendBroadcastMail = function() {
    var msg = document.getElementById('broadcastMailMessage').value.trim();
    if (!msg) { toast('Message is required', 'error'); return; }
    var items = [];
    document.querySelectorAll('#broadcastItemRows .mail-item-row').forEach(function(row) {
      var tpl = row.querySelector('.bc-item-tpl').value.trim();
      var cnt = parseInt(row.querySelector('.bc-item-count').value) || 1;
      if (tpl) items.push({ tpl: tpl, count: cnt });
    });
    var body = {
      message: msg, items: items,
      roubles: parseInt(document.getElementById('broadcastRoubles').value) || 0,
      dollars: parseInt(document.getElementById('broadcastDollars').value) || 0,
      euros: parseInt(document.getElementById('broadcastEuros').value) || 0
    };
    api('player/broadcast', { method: 'POST', body: JSON.stringify(body) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Broadcast sent', 'success'); closeModal('broadcastMailModal'); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  function collectItemRows(containerId) {
    var items = [];
    document.querySelectorAll('#' + containerId + ' .mail-item-row').forEach(function(row) {
      var tplInput = row.querySelector('input[type="text"]');
      var cntInput = row.querySelector('input[type="number"]');
      var tpl = tplInput ? tplInput.value.trim() : '';
      var cnt = cntInput ? (parseInt(cntInput.value) || 1) : 1;
      if (tpl) items.push({ tpl: tpl, count: cnt });
    });
    return items;
  }

  // ── Ban List ──
  function loadBanList() {
    api('players/bans').then(function(data) {
      var entries = data.entries || [];
      document.getElementById('banCount').textContent = '(' + entries.length + ')';
      var body = document.getElementById('banListBody');
      if (entries.length === 0) {
        body.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px 0;font-size:13px">No banned players</div>';
        return;
      }
      var html = '<table class="profile-mini-table"><thead><tr><th>Nickname</th><th>Session</th><th>Reason</th><th>Date</th><th></th></tr></thead><tbody>';
      for (var i = 0; i < entries.length; i++) {
        var b = entries[i];
        var maskedSid = b.sessionId ? '...' + b.sessionId.slice(-4) : '';
        html += '<tr><td>' + escH(b.nickname) + '</td>';
        html += '<td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">' + escH(maskedSid) + '</td>';
        html += '<td>' + escH(b.reason) + '</td>';
        html += '<td style="font-size:11px;color:var(--text-dim)">' + new Date(b.bannedAt).toLocaleDateString() + '</td>';
        html += '<td><button class="btn btn-ghost btn-sm" onclick="unbanPlayer(\'' + escA(b.sessionId) + '\')" style="color:var(--success-bright)">Unban</button></td></tr>';
      }
      html += '</tbody></table>';
      body.innerHTML = html;
    }).catch(function() {});
  }

  window.toggleBanSection = function() {
    banSectionCollapsed = !banSectionCollapsed;
    document.getElementById('banSectionHeader').classList.toggle('collapsed', banSectionCollapsed);
    document.getElementById('banSectionBody').classList.toggle('collapsed', banSectionCollapsed);
  };

  // ═══════════════════════════════════════════════════════
  // QUEST BROWSER
  // ═══════════════════════════════════════════════════════
  var questsLoaded = false;
  var questBrowserData = [];
  var questBrowserMaps = [];
  var questBrowserExpanded = {};
  var questBrowserSort = 'trader';
  var questBrowserSortDir = 'asc';
  var questBrowserMapFilter = 'all';
  var questSearchTimer = null;
  var questPlayersCache = null;

  function debounceQuestSearch() {
    clearTimeout(questSearchTimer);
    questSearchTimer = setTimeout(function() { loadQuestBrowser(); }, 300);
  }

  function loadQuestBrowser() {
    var search = (document.getElementById('questSearchInput') || {}).value || '';
    var params = 'quests?sort=' + encodeURIComponent(questBrowserSort)
      + '&dir=' + encodeURIComponent(questBrowserSortDir);
    if (search) params += '&search=' + encodeURIComponent(search);
    if (questBrowserMapFilter && questBrowserMapFilter !== 'all')
      params += '&map=' + encodeURIComponent(questBrowserMapFilter);

    api(params).then(function(d) {
      questsLoaded = true;
      questBrowserData = d.quests || [];
      questBrowserMaps = d.maps || [];
      document.getElementById('questCountLabel').textContent = d.total + ' quests';
      renderQuestMapChips();
      renderQuestBrowserTable();
    }).catch(function(e) {
      document.getElementById('questBrowserBody').innerHTML =
        '<tr><td colspan="6" style="text-align:center;color:var(--error-bright);padding:20px">Failed to load quests: ' + escH(e.message) + '</td></tr>';
    });
  }

  function renderQuestMapChips() {
    var el = document.getElementById('questMapChips');
    var total = 0;
    questBrowserMaps.forEach(function(m) { total += m.count; });

    var html = '<button class="qb-chip' + (questBrowserMapFilter === 'all' ? ' active' : '') +
      '" onclick="setQuestMapFilter(\'all\')">All <span class="qb-chip-count">(' + total + ')</span></button>';

    questBrowserMaps.forEach(function(m) {
      var active = questBrowserMapFilter === m.location ? ' active' : '';
      html += '<button class="qb-chip' + active + '" onclick="setQuestMapFilter(\'' + escA(m.location) + '\')">' +
        escH(m.locationName) + ' <span class="qb-chip-count">(' + m.count + ')</span></button>';
    });
    el.innerHTML = html;
  }

  function renderQuestBrowserTable() {
    // Update sort arrows
    ['name','trader','map','level','objectives'].forEach(function(f) {
      var arrow = document.getElementById('qbArrow_' + f);
      if (arrow) arrow.textContent = questBrowserSort === f ? (questBrowserSortDir === 'asc' ? '\u25B2' : '\u25BC') : '';
    });

    var body = document.getElementById('questBrowserBody');
    if (questBrowserData.length === 0) {
      body.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);padding:30px">No quests found</td></tr>';
      return;
    }

    var html = '';
    questBrowserData.forEach(function(q, i) {
      var isExp = !!questBrowserExpanded[q.questId];
      html += '<tr>';
      html += '<td style="font-weight:500">' + escH(q.questName) + '</td>';
      html += '<td>' + escH(q.traderName) + '</td>';
      html += '<td>' + escH(q.locationName) + '</td>';
      html += '<td style="text-align:center">' + q.levelRequired + '</td>';
      html += '<td style="text-align:center">' + q.objectiveCount + '</td>';
      html += '<td><span class="quest-chevron' + (isExp ? ' expanded' : '') + '" id="qbchev_' + i + '" onclick="toggleQuestBrowserDetail(\'' + escA(q.questId) + '\',' + i + ')">&#9654;</span></td>';
      html += '</tr>';
      // Detail row (hidden by default)
      html += '<tr class="qb-detail-row" id="qbdet_' + i + '" style="display:' + (isExp ? '' : 'none') + '">';
      html += '<td colspan="6"><div class="qb-detail-inner" id="qbdetc_' + i + '">';
      if (isExp) html += buildQuestDetailHtml(q.questId, i);
      html += '</div></td></tr>';
    });
    body.innerHTML = html;
  }

  window.toggleQuestBrowserDetail = function(questId, idx) {
    var wasExpanded = !!questBrowserExpanded[questId];
    questBrowserExpanded[questId] = !wasExpanded;
    var chevron = document.getElementById('qbchev_' + idx);
    var detail = document.getElementById('qbdet_' + idx);
    var detailContent = document.getElementById('qbdetc_' + idx);
    if (chevron) chevron.classList.toggle('expanded', !wasExpanded);
    if (detail) detail.style.display = wasExpanded ? 'none' : '';
    if (!wasExpanded && detailContent) {
      detailContent.innerHTML = '<div style="color:var(--text-dim);font-size:12px;padding:8px">Loading...</div>';
      api('quests/' + encodeURIComponent(questId)).then(function(d) {
        detailContent.innerHTML = buildQuestDetailFromData(d);
      }).catch(function(e) {
        detailContent.innerHTML = '<div style="color:var(--error-bright);font-size:12px;padding:8px">Failed to load: ' + escH(e.message) + '</div>';
      });
    }
  };

  function buildQuestDetailHtml(questId, idx) {
    return '<div style="color:var(--text-dim);font-size:12px;padding:8px">Loading...</div>';
  }

  function buildQuestDetailFromData(d) {
    var html = '';
    // Objectives
    if (d.objectives && d.objectives.length > 0) {
      html += '<h4>Objectives</h4><ul class="qb-obj-list">';
      d.objectives.forEach(function(obj) {
        html += '<li class="qb-obj-item">';
        html += '<span class="qb-obj-type">' + escH(obj.type) + '</span>';
        html += '<span>' + escH(obj.description) + '</span>';
        html += '</li>';
      });
      html += '</ul>';
    } else {
      html += '<div style="font-size:12px;color:var(--text-dim);margin-bottom:8px">No objectives defined</div>';
    }

    // Player state setter
    html += '<h4>Set Player Quest State</h4>';
    html += '<div class="qb-state-setter">';
    html += '<label>Player</label>';
    html += '<select id="qbPlayer_' + escA(d.questId) + '" class="qb-player-select" style="min-width:140px">';
    html += '<option value="">Select player...</option>';
    if (questPlayersCache) {
      questPlayersCache.forEach(function(p) {
        html += '<option value="' + escA(p.sessionId) + '">' + escH(p.nickname) + ' (Lv ' + p.level + ')</option>';
      });
    }
    html += '</select>';
    html += '<label>Status</label>';
    html += '<select id="qbStatus_' + escA(d.questId) + '">';
    ['Locked','AvailableForStart','Started','AvailableForFinish','Success','Fail','FailRestartable','MarkedAsFailed','Expired'].forEach(function(s) {
      html += '<option value="' + s + '">' + s + '</option>';
    });
    html += '</select>';
    html += '<button class="btn btn-accent btn-sm" onclick="submitQuestBrowserState(\'' + escA(d.questId) + '\')">Set</button>';
    html += '<span id="qbStateMsg_' + escA(d.questId) + '" style="font-size:12px"></span>';
    html += '</div>';

    return html;
  }

  window.submitQuestBrowserState = function(questId) {
    var playerSel = document.getElementById('qbPlayer_' + questId);
    var statusSel = document.getElementById('qbStatus_' + questId);
    var msgEl = document.getElementById('qbStateMsg_' + questId);
    if (!playerSel || !statusSel) return;
    var sid = playerSel.value;
    var status = statusSel.value;
    if (!sid) { if (msgEl) { msgEl.style.color = 'var(--error-bright)'; msgEl.textContent = 'Select a player'; } return; }
    if (msgEl) { msgEl.style.color = 'var(--text-dim)'; msgEl.textContent = 'Setting...'; }

    api('quests/' + encodeURIComponent(questId) + '/state', {
      method: 'POST',
      body: JSON.stringify({ sessionId: sid, status: status })
    }).then(function(d) {
      if (d.success) {
        if (msgEl) { msgEl.style.color = 'var(--success-bright)'; msgEl.textContent = d.message || 'Done'; }
      } else {
        if (msgEl) { msgEl.style.color = 'var(--error-bright)'; msgEl.textContent = d.error || 'Failed'; }
      }
    }).catch(function(e) {
      if (msgEl) { msgEl.style.color = 'var(--error-bright)'; msgEl.textContent = e.message; }
    });
  };

  window.setQuestSort = function(field) {
    if (questBrowserSort === field) {
      questBrowserSortDir = questBrowserSortDir === 'asc' ? 'desc' : 'asc';
    } else {
      questBrowserSort = field;
      questBrowserSortDir = 'asc';
    }
    questBrowserExpanded = {};
    loadQuestBrowser();
  };

  window.setQuestMapFilter = function(location) {
    questBrowserMapFilter = location;
    questBrowserExpanded = {};
    loadQuestBrowser();
  };

  // Pre-fetch player list for quest state setter
  function ensureQuestPlayersCache() {
    if (questPlayersCache !== null) return;
    api('players').then(function(d) {
      questPlayersCache = d.players || [];
    }).catch(function() { questPlayersCache = []; });
  }

  // Override loadQuestBrowser to also load players cache
  var _origLoadQuestBrowser = loadQuestBrowser;
  loadQuestBrowser = function() {
    ensureQuestPlayersCache();
    _origLoadQuestBrowser();
  };

  // ═══════════════════════════════════════════════════════
  // UTILS
  // ═══════════════════════════════════════════════════════
  // FLEA MARKET TAB
  // ═══════════════════════════════════════════════════════
  var fleaLoaded = false;
  var fleaDirty = false;
  var fleaConfig = null;
  var fleaCategories = [];
  var fleaOverridesOpen = false;
  var fleaItemSearchTimer = null;

  function fleaInit() {
    fleaLoaded = true;
    Promise.all([
      api('flea/config'),
      api('flea/categories'),
      api('flea/status')
    ]).then(function(results) {
      fleaConfig = results[0];
      fleaCategories = results[1].categories || [];
      fleaPopulateUI();
      fleaUpdateStatus(results[2]);
      fleaDirty = false;
      fleaUpdateApplyBtn();
      fleaRefreshPresets();
    }).catch(function(e) {
      toast('Failed to load flea config: ' + e.message, 'error');
    });
  }

  function fleaPopulateUI() {
    if (!fleaConfig) return;
    var c = fleaConfig;
    // Global controls
    document.getElementById('fleaGlobalBuy').value = c.globalBuyMultiplier;
    document.getElementById('fleaGlobalBuyVal').value = c.globalBuyMultiplier;
    document.getElementById('fleaVariance').value = c.dynamicPriceVariance;
    document.getElementById('fleaVarianceVal').value = Math.round(c.dynamicPriceVariance * 100);
    document.getElementById('fleaMinPrice').value = c.minPriceRoubles;
    document.getElementById('fleaMaxPrice').value = c.maxPriceRoubles;
    // Market settings
    document.getElementById('fleaTax').value = c.fleaTaxMultiplier;
    document.getElementById('fleaTaxVal').value = c.fleaTaxMultiplier;
    document.getElementById('fleaMaxOffers').value = c.playerMaxOffers;
    document.getElementById('fleaDuration').value = c.offerDurationHours;
    document.getElementById('fleaRestock').value = c.restockIntervalMinutes;
    document.getElementById('fleaBarterEnabled').checked = c.barterOffersEnabled;
    document.getElementById('fleaBarterFreq').value = c.barterOfferFrequency;
    document.getElementById('fleaBarterFreqVal').value = c.barterOfferFrequency;
    fleaBarterToggled();
    document.getElementById('fleaDollarEnabled').checked = c.dollarOffersEnabled !== false;
    document.getElementById('fleaEuroEnabled').checked = c.euroOffersEnabled !== false;
    // Categories
    fleaRenderCategories();
    // Item overrides
    fleaRenderOverrides();
  }

  function fleaGatherConfig() {
    var c = fleaConfig || {};
    c.globalBuyMultiplier = parseFloat(document.getElementById('fleaGlobalBuyVal').value) || 1.0;
    c.dynamicPriceVariance = parseFloat(document.getElementById('fleaVariance').value) || 0;
    c.minPriceRoubles = parseInt(document.getElementById('fleaMinPrice').value) || 1;
    c.maxPriceRoubles = parseInt(document.getElementById('fleaMaxPrice').value) || 50000000;
    c.fleaTaxMultiplier = parseFloat(document.getElementById('fleaTaxVal').value) || 1.0;
    c.playerMaxOffers = parseInt(document.getElementById('fleaMaxOffers').value) || 2;
    c.offerDurationHours = parseInt(document.getElementById('fleaDuration').value) || 24;
    c.restockIntervalMinutes = parseInt(document.getElementById('fleaRestock').value) || 60;
    c.barterOffersEnabled = document.getElementById('fleaBarterEnabled').checked;
    c.barterOfferFrequency = parseInt(document.getElementById('fleaBarterFreqVal').value) || 15;
    c.dollarOffersEnabled = document.getElementById('fleaDollarEnabled').checked;
    c.euroOffersEnabled = document.getElementById('fleaEuroEnabled').checked;
    // Gather category multipliers — all categories sent (stacking: global × category)
    c.categoryMultipliers = {};
    fleaCategories.forEach(function(cat) {
      var buyEl = document.getElementById('fleaCatBuy_' + cat.key);
      if (buyEl) {
        c.categoryMultipliers[cat.key] = {
          buyMultiplier: parseFloat(buyEl.value) || 1.0
        };
      }
    });
    return c;
  }

  window.fleaApplyAndRegenerate = function() {
    var btn = document.getElementById('fleaApplyBtn');
    var txt = document.getElementById('fleaApplyText');
    var spin = document.getElementById('fleaApplySpinner');
    btn.disabled = true;
    txt.textContent = 'Applying...';
    spin.style.display = '';

    // Track if tax changed to show restart notice
    var oldTax = fleaConfig ? fleaConfig.fleaTaxMultiplier : 1.0;
    var cfg = fleaGatherConfig();
    var taxChanged = Math.abs(cfg.fleaTaxMultiplier - oldTax) > 0.001;

    fleaLoggedFetch('flea/config', { method: 'POST', body: JSON.stringify(cfg) })
    .then(function(savedConfig) {
      fleaConfig = savedConfig;
      txt.textContent = 'Regenerating offers...';
      return fleaLoggedFetch('flea/regenerate', { method: 'POST' });
    })
    .then(function(regen) {
      if (regen.success) {
        toast('Regenerated ' + regen.offerCount.toLocaleString() + ' offers in ' + regen.durationMs + 'ms', 'success');
        // Show restart notice if tax was changed
        if (taxChanged) {
          var notice = document.getElementById('fleaTaxRestartNotice');
          if (notice) notice.style.display = 'flex';
        }
      } else {
        toast('Regeneration failed: ' + (regen.error || 'Unknown error'), 'error');
      }
      fleaDirty = false;
      fleaUpdateApplyBtn();
      return fleaLoggedFetch('flea/status', { method: 'GET' });
    })
    .then(function(status) {
      fleaUpdateStatus(status);
    })
    .catch(function(e) {
      toast('Error: ' + e.message, 'error');
    })
    .finally(function() {
      btn.disabled = false;
      txt.textContent = 'Apply & Regenerate Offers';
      spin.style.display = 'none';
      if (fleaDirty) btn.disabled = false;
    });
  };

  function fleaMarkDirty() {
    fleaDirty = true;
    fleaUpdateApplyBtn();
  }

  function fleaUpdateApplyBtn() {
    var btn = document.getElementById('fleaApplyBtn');
    btn.disabled = !fleaDirty;
    btn.classList.toggle('dirty', fleaDirty);
    // Update nav unsaved indicator
    var navBtn = document.querySelector('.nav-btn[data-nav="flea"]');
    if (navBtn) {
      var dot = navBtn.querySelector('.flea-unsaved-dot');
      if (!dot) {
        dot = document.createElement('span');
        dot.className = 'flea-unsaved-dot';
        navBtn.appendChild(dot);
      }
      dot.classList.toggle('visible', fleaDirty);
    }
  }

  window.fleaSliderChanged = function(sliderId, numId, isPercent) {
    var v = parseFloat(document.getElementById(sliderId).value);
    document.getElementById(numId).value = isPercent ? Math.round(v * 100) : v;
    fleaMarkDirty();
  };

  window.fleaNumChanged = function(numId, sliderId) {
    var v = parseFloat(document.getElementById(numId).value);
    if (!isNaN(v)) document.getElementById(sliderId).value = v;
    fleaMarkDirty();
  };

  window.fleaVarianceNumChanged = function() {
    var v = parseInt(document.getElementById('fleaVarianceVal').value) || 0;
    document.getElementById('fleaVariance').value = v / 100;
    fleaMarkDirty();
  };

  window.fleaBarterToggled = function() {
    var on = document.getElementById('fleaBarterEnabled').checked;
    document.getElementById('fleaBarterFreq').disabled = !on;
    document.getElementById('fleaBarterFreqVal').disabled = !on;
    fleaMarkDirty();
  };

  // ── Flea Presets ──
  function fleaRefreshPresets() {
    fleaLoggedFetch('flea/presets', { method: 'GET' }).then(function(data) {
      var sel = document.getElementById('fleaPresetSelect');
      var prev = sel.value;
      sel.innerHTML = '<option value="">— Select a preset —</option>';
      (data.presets || []).forEach(function(p) {
        var opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name + (p.description ? ' — ' + p.description : '');
        sel.appendChild(opt);
      });
      if (prev) sel.value = prev;
    }).catch(function() {});
  }

  window.fleaSavePreset = function() {
    var name = document.getElementById('fleaPresetName').value.trim();
    if (!name) { toast('Enter a preset name', 'error'); return; }
    fleaLoggedFetch('flea/presets', {
      method: 'POST',
      body: JSON.stringify({ name: name, description: '' })
    }).then(function() {
      toast('Preset "' + name + '" saved', 'success');
      document.getElementById('fleaPresetName').value = '';
      fleaRefreshPresets();
    }).catch(function(e) { toast('Save failed: ' + e.message, 'error'); });
  };

  window.fleaLoadPreset = function() {
    var name = document.getElementById('fleaPresetSelect').value;
    if (!name) { toast('Select a preset first', 'error'); return; }
    fleaLoggedFetch('flea/presets/load', {
      method: 'POST',
      body: JSON.stringify({ name: name })
    }).then(function(preset) {
      if (preset && preset.config) {
        fleaConfig = preset.config;
        fleaPopulateUI();
        fleaMarkDirty();
        toast('Loaded preset "' + name + '" — click Apply to activate', 'success');
      } else {
        toast('Preset not found', 'error');
      }
    }).catch(function(e) { toast('Load failed: ' + e.message, 'error'); });
  };

  window.fleaDeletePreset = function() {
    var name = document.getElementById('fleaPresetSelect').value;
    if (!name) { toast('Select a preset first', 'error'); return; }
    if (!confirm('Delete preset "' + name + '"?')) return;
    fleaLoggedFetch('flea/presets/' + encodeURIComponent(name), {
      method: 'DELETE'
    }).then(function() {
      toast('Deleted preset "' + name + '"', 'success');
      fleaRefreshPresets();
    }).catch(function(e) { toast('Delete failed: ' + e.message, 'error'); });
  };

  window.fleaExportPreset = function() {
    var cfg = fleaGatherConfig();
    var preset = { name: 'exported', description: 'Exported from Command Center', config: cfg };
    var json = JSON.stringify(preset, null, 2);
    navigator.clipboard.writeText(json).then(function() {
      toast('Config copied to clipboard', 'success');
    }).catch(function() {
      // Fallback: show in import area
      document.getElementById('fleaImportArea').style.display = 'block';
      document.getElementById('fleaImportJson').value = json;
      toast('Clipboard failed — JSON shown below', 'warning');
    });
  };

  window.fleaShowImport = function() {
    var area = document.getElementById('fleaImportArea');
    area.style.display = area.style.display === 'none' ? 'block' : 'none';
    document.getElementById('fleaImportJson').value = '';
  };

  window.fleaImportPreset = function() {
    var json = document.getElementById('fleaImportJson').value.trim();
    if (!json) { toast('Paste preset JSON first', 'error'); return; }
    var preset;
    try { preset = JSON.parse(json); } catch(e) { toast('Invalid JSON: ' + e.message, 'error'); return; }
    // Accept either a full preset object or just a config object
    var config = preset.config || preset;
    if (!config.globalBuyMultiplier && config.globalBuyMultiplier !== 0) {
      toast('Invalid preset — missing config data', 'error'); return;
    }
    // If it has a name, import it to the server
    if (preset.name && preset.config) {
      fleaLoggedFetch('flea/presets/import', {
        method: 'POST',
        body: JSON.stringify(preset)
      }).then(function() {
        fleaConfig = preset.config;
        fleaPopulateUI();
        fleaMarkDirty();
        document.getElementById('fleaImportArea').style.display = 'none';
        fleaRefreshPresets();
        toast('Imported "' + preset.name + '" — click Apply to activate', 'success');
      }).catch(function(e) { toast('Import failed: ' + e.message, 'error'); });
    } else {
      // Just a config blob — load directly into UI
      fleaConfig = config;
      fleaPopulateUI();
      fleaMarkDirty();
      document.getElementById('fleaImportArea').style.display = 'none';
      toast('Config loaded — click Apply to activate', 'success');
    }
  };

  // ── Category cards ──
  function fleaRenderCategories() {
    var grid = document.getElementById('fleaCategoryGrid');
    if (!fleaCategories.length) {
      grid.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:20px;text-align:center;grid-column:1/-1">No categories loaded</div>';
      return;
    }
    var catMults = (fleaConfig && fleaConfig.categoryMultipliers) || {};
    var html = '';
    fleaCategories.forEach(function(cat) {
      var m = catMults[cat.key] || { buyMultiplier: 1.0 };
      var isModified = m.buyMultiplier !== 1.0;
      html += '<div class="flea-cat-card' + (isModified ? ' modified' : '') + '" id="fleaCatCard_' + cat.key + '">';
      html += '<div class="flea-cat-card-header">';
      html += '<div><span class="flea-cat-name">' + escH(cat.name) + '</span> <span class="flea-cat-count">' + cat.itemCount + '</span></div>';
      html += '<button class="flea-cat-reset" onclick="fleaCatReset(\'' + escA(cat.key) + '\')">Reset</button>';
      html += '</div>';
      html += '<div class="flea-cat-slider-row"><label>Mult</label>';
      html += '<input type="range" min="0.1" max="10" step="0.1" value="' + m.buyMultiplier + '" id="fleaCatBuySlider_' + cat.key + '" oninput="fleaCatSlider(\'' + escA(cat.key) + '\')">';
      html += '<input type="number" class="flea-num-input" min="0.1" max="10" step="0.1" value="' + m.buyMultiplier + '" id="fleaCatBuy_' + cat.key + '" oninput="fleaCatNum(\'' + escA(cat.key) + '\')">';
      html += '<span style="font-size:11px;color:var(--text-dim)">&times;</span></div>';
      html += '</div>';
    });
    grid.innerHTML = html;
  }

  window.fleaCatSlider = function(key) {
    var v = parseFloat(document.getElementById('fleaCatBuySlider_' + key).value);
    document.getElementById('fleaCatBuy_' + key).value = v;
    fleaCatUpdateCard(key);
    fleaMarkDirty();
  };

  window.fleaCatNum = function(key) {
    var v = parseFloat(document.getElementById('fleaCatBuy_' + key).value);
    if (!isNaN(v)) document.getElementById('fleaCatBuySlider_' + key).value = v;
    fleaCatUpdateCard(key);
    fleaMarkDirty();
  };

  window.fleaCatReset = function(key) {
    document.getElementById('fleaCatBuy_' + key).value = 1.0;
    document.getElementById('fleaCatBuySlider_' + key).value = 1.0;
    fleaCatUpdateCard(key);
    fleaMarkDirty();
  };

  function fleaCatUpdateCard(key) {
    var card = document.getElementById('fleaCatCard_' + key);
    if (!card) return;
    var b = parseFloat(document.getElementById('fleaCatBuy_' + key).value) || 1.0;
    card.classList.toggle('modified', b !== 1.0);
  }

  // ── Per-item overrides ──
  window.fleaToggleOverrides = function() {
    fleaOverridesOpen = !fleaOverridesOpen;
    document.getElementById('fleaOverridePanel').style.display = fleaOverridesOpen ? '' : 'none';
    document.getElementById('fleaOverrideArrow').style.transform = fleaOverridesOpen ? 'rotate(90deg)' : '';
  };

  function fleaRenderOverrides() {
    var overrides = (fleaConfig && fleaConfig.itemOverrides) || {};
    var keys = Object.keys(overrides);
    document.getElementById('fleaOverrideCount').textContent = keys.length;
    var el = document.getElementById('fleaOverrideTable');
    if (!keys.length) {
      el.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:16px;text-align:center">No item overrides. Search above to add items.</div>';
      return;
    }
    var html = '<table class="flea-override-table"><thead><tr><th>Item Name</th><th>Template ID</th><th>Multiplier</th><th></th></tr></thead><tbody>';
    keys.forEach(function(tpl) {
      var o = overrides[tpl];
      html += '<tr>';
      html += '<td>' + escH(o.name) + '</td>';
      html += '<td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">' + escH(tpl.substring(0, 12)) + '...</td>';
      html += '<td><input type="number" class="flea-num-input" min="0.01" max="100" step="0.01" value="' + o.buyMultiplier + '" onchange="fleaOverrideChanged(\'' + escA(tpl) + '\',this.value)"></td>';
      html += '<td><button class="flea-override-remove" onclick="fleaRemoveOverride(\'' + escA(tpl) + '\')">Remove</button></td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    el.innerHTML = html;
  }

  window.fleaOverrideChanged = function(tpl, val) {
    if (!fleaConfig || !fleaConfig.itemOverrides || !fleaConfig.itemOverrides[tpl]) return;
    fleaConfig.itemOverrides[tpl].buyMultiplier = parseFloat(val) || 1.0;
    fleaMarkDirty();
  };

  window.fleaRemoveOverride = function(tpl) {
    if (!fleaConfig || !fleaConfig.itemOverrides) return;
    delete fleaConfig.itemOverrides[tpl];
    fleaRenderOverrides();
    fleaMarkDirty();
  };

  function fleaItemSearchDebounce() {
    clearTimeout(fleaItemSearchTimer);
    fleaItemSearchTimer = setTimeout(fleaItemSearch, 300);
  }

  function fleaItemSearch() {
    var q = document.getElementById('fleaItemSearch').value.trim();
    var resultsEl = document.getElementById('fleaItemSearchResults');
    if (q.length < 2) { resultsEl.style.display = 'none'; return; }
    api('flea/items/search?q=' + encodeURIComponent(q)).then(function(data) {
      var items = data.items || [];
      if (!items.length) {
        resultsEl.innerHTML = '<div style="padding:12px;color:var(--text-dim);font-size:13px;text-align:center">No items found</div>';
        resultsEl.style.display = '';
        return;
      }
      var html = '';
      items.forEach(function(item) {
        html += '<div class="flea-search-item" onclick="fleaAddOverride(\'' + escA(item.templateId) + '\',\'' + escA(item.name) + '\')">';
        html += '<div><strong>' + escH(item.name) + '</strong> <span style="font-size:11px;color:var(--text-dim)">' + escH(item.category) + '</span></div>';
        html += '<span style="font-family:var(--font-mono);font-size:12px;color:var(--accent)">&#8381;' + (item.basePrice || 0).toLocaleString() + '</span>';
        html += '</div>';
      });
      resultsEl.innerHTML = html;
      resultsEl.style.display = '';
    }).catch(function() { resultsEl.style.display = 'none'; });
  }

  window.fleaAddOverride = function(tpl, name) {
    if (!fleaConfig) fleaConfig = {};
    if (!fleaConfig.itemOverrides) fleaConfig.itemOverrides = {};
    if (fleaConfig.itemOverrides[tpl]) {
      toast(name + ' already has an override', 'info');
      return;
    }
    fleaConfig.itemOverrides[tpl] = { name: name, buyMultiplier: 1.0 };
    fleaRenderOverrides();
    fleaMarkDirty();
    document.getElementById('fleaItemSearch').value = '';
    document.getElementById('fleaItemSearchResults').style.display = 'none';
    toast('Added override for ' + name, 'success');
    // Auto-open overrides if closed
    if (!fleaOverridesOpen) fleaToggleOverrides();
  };

  // Close search results when clicking outside
  document.addEventListener('click', function(e) {
    var results = document.getElementById('fleaItemSearchResults');
    var search = document.getElementById('fleaItemSearch');
    if (results && search && !results.contains(e.target) && e.target !== search) {
      results.style.display = 'none';
    }
  });

  function fleaUpdateStatus(status) {
    if (!status) return;
    var regenEl = document.getElementById('fleaStatusRegen');
    var offersEl = document.getElementById('fleaStatusOffers');
    if (status.lastRegeneratedUtc) {
      var d = new Date(status.lastRegeneratedUtc);
      var ago = Math.round((Date.now() - d.getTime()) / 60000);
      regenEl.textContent = 'Last regenerated: ' + (ago < 1 ? 'Just now' : ago + 'm ago');
    } else {
      regenEl.textContent = 'Last regenerated: Never';
    }
    offersEl.textContent = 'Active offers: ' + (status.activeOfferCount != null ? status.activeOfferCount.toLocaleString() : '—');
  }

  // ── Debug Panel ──
  var fleaDebugOpen = false;
  var fleaApiLog = [];

  window.fleaToggleDebug = function() {
    fleaDebugOpen = !fleaDebugOpen;
    document.getElementById('fleaDebugPanel').style.display = fleaDebugOpen ? '' : 'none';
    document.getElementById('fleaDebugArrow').style.transform = fleaDebugOpen ? 'rotate(90deg)' : '';
  };

  window.fleaRunDiagnostic = function() {
    var el = document.getElementById('fleaDiagResult');
    el.innerHTML = '<div style="color:var(--text-dim)">Running diagnostic...</div>';
    fleaLoggedFetch('flea/debug', { method: 'GET' })
    .then(function(data) {
      var html = '<div style="background:var(--bg-dark);border-radius:4px;padding:12px;margin-bottom:8px">';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">';
      html += '<div><span style="color:var(--text-dim);font-size:11px">Price Modification</span><br><span style="color:' + (data.priceModificationActive ? '#4caf50' : '#f44336') + ';font-weight:600">' + (data.priceModificationActive ? 'ACTIVE' : 'INACTIVE') + '</span></div>';
      html += '<div><span style="color:var(--text-dim);font-size:11px">Prices in Table</span><br><span style="color:var(--text-main);font-weight:600">' + (data.totalPricesInTable || 0).toLocaleString() + '</span></div>';
      html += '<div><span style="color:var(--text-dim);font-size:11px">Modified Prices</span><br><span style="color:' + (data.modifiedPriceCount > 0 ? 'var(--accent)' : 'var(--text-dim)') + ';font-weight:600">' + (data.modifiedPriceCount || 0).toLocaleString() + '</span></div>';
      html += '</div>';
      html += '<div style="font-size:11px;color:var(--text-dim);margin-bottom:6px">Global Multiplier: <span style="color:var(--accent)">' + (data.currentGlobalMultiplier || 1.0) + 'x</span></div>';
      if (data.samples && data.samples.length) {
        html += '<table style="width:100%;font-size:11px;border-collapse:collapse">';
        html += '<tr style="color:var(--text-dim);text-align:left"><th style="padding:4px 6px">Item</th><th style="padding:4px 6px;text-align:right">Original</th><th style="padding:4px 6px;text-align:right">Current</th><th style="padding:4px 6px;text-align:right">Mult</th><th style="padding:4px 6px">Source</th></tr>';
        data.samples.forEach(function(s) {
          var changed = Math.abs(s.originalPrice - s.currentPrice) > 0.5;
          var color = changed ? 'var(--accent)' : 'var(--text-main)';
          html += '<tr style="border-top:1px solid var(--bg-panel)">';
          html += '<td style="padding:4px 6px;color:var(--text-main)">' + s.name + '</td>';
          html += '<td style="padding:4px 6px;text-align:right;color:var(--text-dim)">' + Math.round(s.originalPrice).toLocaleString() + '</td>';
          html += '<td style="padding:4px 6px;text-align:right;color:' + color + ';font-weight:600">' + Math.round(s.currentPrice).toLocaleString() + '</td>';
          html += '<td style="padding:4px 6px;text-align:right;color:var(--text-main)">' + s.effectiveMultiplier.toFixed(2) + 'x</td>';
          html += '<td style="padding:4px 6px;color:var(--text-dim)">' + s.multiplierSource + '</td>';
          html += '</tr>';
        });
        html += '</table>';
      }
      html += '</div>';
      el.innerHTML = html;
    })
    .catch(function(e) {
      el.innerHTML = '<div style="color:#f44336">Diagnostic failed: ' + e.message + '</div>';
    });
  };

  // Logged fetch wrapper for API log
  function fleaLoggedFetch(path, options) {
    var entry = {
      time: new Date().toISOString().substr(11, 12),
      method: (options && options.method) || 'GET',
      path: path,
      requestBody: null,
      status: null,
      responseBody: null,
      durationMs: 0
    };
    if (options && options.body) {
      try { entry.requestBody = JSON.parse(options.body); } catch(e) { entry.requestBody = options.body; }
    }
    var start = Date.now();
    return api(path, options).then(function(data) {
      entry.durationMs = Date.now() - start;
      entry.status = 200;
      entry.responseBody = data;
      fleaApiLog.unshift(entry);
      if (fleaApiLog.length > 10) fleaApiLog.pop();
      fleaRenderApiLog();
      return data;
    }).catch(function(err) {
      entry.durationMs = Date.now() - start;
      entry.status = 'ERR';
      entry.responseBody = { error: err.message };
      fleaApiLog.unshift(entry);
      if (fleaApiLog.length > 10) fleaApiLog.pop();
      fleaRenderApiLog();
      throw err;
    });
  }

  function fleaRenderApiLog() {
    var el = document.getElementById('fleaApiLogPanel');
    if (!el) return;
    if (!fleaApiLog.length) {
      el.innerHTML = '<div style="color:var(--text-dim);padding:4px">No API calls logged yet</div>';
      return;
    }
    var html = '';
    fleaApiLog.forEach(function(e) {
      var statusColor = e.status === 200 ? '#4caf50' : '#f44336';
      html += '<div style="border-bottom:1px solid var(--bg-panel);padding:4px 0">';
      html += '<span style="color:var(--text-dim)">' + e.time + '</span> ';
      html += '<span style="color:var(--accent);font-weight:600">' + e.method + '</span> ';
      html += '<span style="color:var(--text-main)">' + e.path + '</span> ';
      html += '<span style="color:' + statusColor + '">' + e.status + '</span> ';
      html += '<span style="color:var(--text-dim)">' + e.durationMs + 'ms</span>';
      if (e.requestBody) {
        var reqStr = JSON.stringify(e.requestBody);
        if (reqStr.length > 300) reqStr = reqStr.substr(0, 300) + '...';
        html += '<div style="color:var(--text-dim);padding-left:12px;word-break:break-all">REQ: ' + reqStr + '</div>';
      }
      if (e.responseBody) {
        var resStr = JSON.stringify(e.responseBody);
        if (resStr.length > 300) resStr = resStr.substr(0, 300) + '...';
        html += '<div style="color:var(--text-dim);padding-left:12px;word-break:break-all">RES: ' + resStr + '</div>';
      }
      html += '</div>';
    });
    el.innerHTML = html;
  }

  // ═══════════════════════════════════════════════════════
  function escH(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
  function escA(s) { return s ? s.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"') : ''; }

  // ═══════════════════════════════════════════════════════
  // HASH NAVIGATION
  // ═══════════════════════════════════════════════════════
  window.addEventListener('hashchange', function() {
    var hash = window.location.hash.replace('#', '');
    if (hash && document.getElementById('main-' + hash)) {
      switchMainTab(hash);
    }
  });

  // ═══════════════════════════════════════════════════════
  // AUTO-LOGIN
  // ═══════════════════════════════════════════════════════
  if (sessionId) {
    document.getElementById('sessionInput').value = sessionId;
    api('auth').then(function(data) {
      if (data.authorized) { profileName = data.profileName; showMain(); }
      else { sessionId = ''; localStorage.removeItem('zslayer_session'); }
    }).catch(function() { sessionId = ''; localStorage.removeItem('zslayer_session'); });
  }
})();
</script>
</body>
</html>
