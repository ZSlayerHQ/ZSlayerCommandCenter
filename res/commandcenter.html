<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZSlayerHQ Command Center</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-base: #080808;
  --bg-dark: #0c0c0c;
  --bg-mid: #131310;
  --bg-panel: #181814;
  --bg-card: #1c1b17;
  --bg-hover: #242219;
  --bg-input: #0e0e0c;
  --bg-elevated: #201f1a;
  --border: #2a2620;
  --border-light: #3a3530;
  --border-focus: #5a4a30;
  --border-subtle: #1f1d18;
  --text: #c8bfa8;
  --text-dim: #6a6050;
  --text-bright: #e8e0d0;
  --text-white: #f0ece4;
  --text-muted: #4a4438;
  --accent: #c8aa6e;
  --accent-dim: #a08a50;
  --accent-bright: #e0c882;
  --accent-glow: rgba(200, 170, 110, 0.12);
  --accent-glow-strong: rgba(200, 170, 110, 0.25);
  --success: #4a7c4a;
  --success-bright: #6aad6a;
  --error: #8b3a3a;
  --error-bright: #c45050;
  --warning: #c87a3e;
  --font-display: 'Rajdhani', 'Segoe UI', sans-serif;
  --font-mono: 'Share Tech Mono', 'Consolas', monospace;
  --font-body: 'Rajdhani', -apple-system, sans-serif;
  --radius: 2px;
  --radius-md: 4px;
  --radius-lg: 6px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 12px 48px rgba(0,0,0,0.6);
  --shadow-glow: 0 0 20px rgba(200,170,110,0.08);
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  background: var(--bg-base);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
  font-size: 15px;
  font-weight: 500;
}

/* ── Scrollbar ── */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--bg-dark); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

/* ══════════════════════════════════════════════════════════
   HEADER
   ══════════════════════════════════════════════════════════ */
.header {
  background: linear-gradient(180deg, #141310 0%, #0f0e0c 100%);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,0.4);
}

.header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, var(--accent-dim) 50%, transparent 100%);
  opacity: 0.3;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.header-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-logo-icon {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
  border-radius: 3px;
  box-shadow: 0 0 12px rgba(200,170,110,0.2);
}

.header-logo-icon svg { width: 16px; height: 16px; color: #0a0a0a; }

.header-title {
  font-family: var(--font-mono);
  font-size: 15px;
  color: var(--accent);
  letter-spacing: 3px;
  text-transform: uppercase;
  text-shadow: 0 0 20px rgba(200,170,110,0.15);
}

.header-sep { width: 1px; height: 22px; background: var(--border); }

.header-social {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: 8px;
}
.header-social a {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 30px;
  height: 30px;
  border-radius: var(--radius-md);
  color: var(--text-dim);
  transition: color 0.15s, background 0.15s;
  text-decoration: none;
}
.header-social a:hover {
  color: var(--accent);
  background: var(--accent-glow);
}
.header-social a svg { width: 18px; height: 18px; }

.header-version {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  padding: 2px 8px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
}

.header-profile {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 13px;
}

.profile-status {
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-dot {
  width: 7px; height: 7px;
  background: var(--success-bright);
  border-radius: 50%;
  display: inline-block;
  box-shadow: 0 0 8px var(--success-bright);
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--success-bright); }
  50% { opacity: 0.7; box-shadow: 0 0 4px var(--success-bright); }
}

.profile-label { color: var(--text-dim); font-size: 12px; font-family: var(--font-mono); }
.profile-name-display { color: var(--accent-bright); font-weight: 700; font-size: 14px; }

/* ══════════════════════════════════════════════════════════
   NAVIGATION BAR (14 tabs)
   ══════════════════════════════════════════════════════════ */
.nav-bar {
  display: none;
  background: var(--bg-dark);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  position: sticky;
  top: 52px;
  z-index: 99;
  scrollbar-width: thin;
}
.nav-bar::-webkit-scrollbar { height: 3px; }

.nav-bar-inner {
  display: inline-flex;
  gap: 0;
  min-width: 100%;
}

.nav-btn {
  padding: 10px 16px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-dim);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-mono);
  white-space: nowrap;
  position: relative;
  flex-shrink: 0;
}
.nav-btn:hover { color: var(--text); background: rgba(200,170,110,0.03); }
.nav-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}
.nav-btn.disabled {
  opacity: 0.4;
  cursor: default;
}
.nav-btn.disabled:hover {
  color: var(--text-dim);
  background: none;
}
.nav-btn .nav-lock {
  display: inline-block;
  width: 10px;
  height: 10px;
  margin-left: 4px;
  opacity: 0.5;
  vertical-align: middle;
}
.nav-btn .nav-lock svg { width: 10px; height: 10px; }

/* ── Buttons ── */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 7px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-card);
  color: var(--text);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: var(--font-body);
  letter-spacing: 0.3px;
  white-space: nowrap;
  user-select: none;
  position: relative;
}
.btn:hover { background: var(--bg-hover); border-color: var(--border-light); color: var(--text-bright); }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }

.btn-accent {
  background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dim) 100%);
  border-color: var(--accent);
  color: #0a0a0a;
  font-weight: 700;
  text-shadow: 0 1px 0 rgba(255,255,255,0.1);
  box-shadow: 0 1px 4px rgba(200,170,110,0.2);
}
.btn-accent:hover { background: linear-gradient(180deg, var(--accent-bright) 0%, var(--accent) 100%); color: #0a0a0a; box-shadow: 0 2px 8px rgba(200,170,110,0.3); }

.btn-ghost { background: transparent; border-color: transparent; color: var(--text-dim); }
.btn-ghost:hover { background: var(--bg-hover); color: var(--text); border-color: var(--border); }

.btn-success { background: var(--success); border-color: var(--success-bright); color: #ddd; }
.btn-success:hover { background: var(--success-bright); color: #fff; }

.btn-danger { background: var(--error); border-color: var(--error-bright); color: #ddd; }
.btn-danger:hover { background: var(--error-bright); color: #fff; }

.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn-xs { padding: 3px 10px; font-size: 11px; }
.btn-disabled { opacity: 0.35; pointer-events: none; cursor: default; }

/* ── Headless Status Pill ── */
.hl-status-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 12px; border-radius: 10px;
  font-size: 12px; font-weight: 600; font-family: var(--font-body);
  letter-spacing: 0.3px; white-space: nowrap;
}
.hl-status-pill.pill-stopped { background: #8b3a3a; color: #e8d0d0; }
.hl-status-pill.pill-running { background: #4a7c59; color: #d0e8d4; }
.hl-status-pill.pill-transition { background: #6b5a28; color: #f0e0d0; }
.hl-status-pill.pill-unavailable { background: var(--bg-hover); color: var(--text-muted); }

@keyframes hl-spin { to { transform: rotate(360deg); } }
.hl-spinner {
  display: inline-block; width: 10px; height: 10px;
  border: 2px solid currentColor; border-top-color: transparent;
  border-radius: 50%; animation: hl-spin 0.7s linear infinite;
}

/* ── Inputs ── */
input[type="text"], input[type="number"], input[type="password"] {
  padding: 8px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-bright);
  font-size: 14px;
  font-family: var(--font-body);
  font-weight: 500;
  transition: border-color 0.15s, box-shadow 0.15s;
}
input:focus {
  outline: none;
  border-color: var(--accent-dim);
  box-shadow: 0 0 0 2px var(--accent-glow), inset 0 0 6px rgba(200,170,110,0.05);
}
input[type="number"] {
  width: 64px;
  text-align: center;
  font-family: var(--font-mono);
  font-size: 13px;
  -moz-appearance: textfield;
}
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

/* ══════════════════════════════════════════════════════════
   HERO BANNER
   ══════════════════════════════════════════════════════════ */
.hero-banner {
  position: relative;
  height: 56px;
  background: linear-gradient(135deg, #0a0a08 0%, #1a1710 30%, #12100c 70%, #0a0a08 100%);
  border-bottom: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.hero-bg-grid {
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(rgba(200,170,110,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(200,170,110,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
}

.hero-bg-radial {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 50%, rgba(200,170,110,0.06) 0%, transparent 60%);
}

.hero-placeholder {
  position: relative;
  z-index: 1;
  text-align: center;
  padding: 8px 20px;
}

.hero-placeholder-inner {
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
}

.hero-placeholder-icon {
  display: flex;
  align-items: center;
  justify-content: center;
}

.hero-placeholder-icon svg { width: 20px; height: 20px; color: var(--text-muted); }

.hero-placeholder-text {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 1px;
  text-transform: uppercase;
}

.hero-placeholder-sub {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  margin-left: 8px;
}

.hero-image {
  position: absolute;
  inset: 0;
  object-fit: cover;
  width: 100%;
  height: 100%;
  display: none;
  z-index: 1;
}

.hero-scanline {
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
  pointer-events: none;
  z-index: 2;
}

.hero-vignette {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 30%, rgba(8,8,8,0.8) 100%);
  pointer-events: none;
  z-index: 3;
}

.hero-bottom-fade {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 16px;
  background: linear-gradient(transparent, var(--bg-base));
  z-index: 4;
}

/* ══════════════════════════════════════════════════════════
   LOGIN
   ══════════════════════════════════════════════════════════ */
.login-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg-base);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
}

.login-bg {
  position: absolute;
  inset: 0;
  background:
    repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(200,170,110,0.035) 39px, rgba(200,170,110,0.035) 40px),
    repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(200,170,110,0.035) 39px, rgba(200,170,110,0.035) 40px),
    radial-gradient(ellipse at 30% 40%, rgba(200,170,110,0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 60%, rgba(200,170,110,0.03) 0%, transparent 50%);
}

.login-bg::after {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.02) 2px, rgba(0,0,0,0.02) 4px);
  pointer-events: none;
}

.login-bg::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 50%, rgba(200,170,110,0.05), transparent 70%);
  animation: loginGlow 4s ease-in-out infinite;
  pointer-events: none;
}

@keyframes loginGlow {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

@keyframes loginBoxIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-box {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 44px;
  width: 520px;
  max-width: 90vw;
  position: relative;
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  animation: loginBoxIn 0.4s ease-out;
}

.login-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent 10%, var(--accent) 50%, transparent 90%);
}

.login-logo {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 24px;
}

.login-logo-icon {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
  border-radius: 4px;
  box-shadow: 0 0 16px rgba(200,170,110,0.25);
}

.login-logo-icon svg { width: 20px; height: 20px; color: #0a0a0a; }

.login-logo-text {
  display: flex;
  flex-direction: column;
}

.login-brand {
  font-family: var(--font-mono);
  font-size: 20px;
  color: var(--accent);
  letter-spacing: 4px;
  text-transform: uppercase;
  font-weight: 700;
  line-height: 1.2;
}

.login-subtitle {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  letter-spacing: 5.5px;
  text-transform: uppercase;
  line-height: 1;
  margin-top: 4px;
}

.login-box p {
  color: var(--text-dim);
  font-size: 13px;
  margin-bottom: 24px;
  line-height: 1.7;
  text-align: center;
}

.form-group { margin-bottom: 16px; }

.form-group label {
  display: block;
  font-size: 11px;
  color: var(--text-dim);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-family: var(--font-mono);
}

.login-error {
  color: var(--error-bright);
  font-size: 13px;
  margin-top: 10px;
  display: none;
  text-align: center;
}

.login-steps-container { position: relative; }

.login-step {
  opacity: 0;
  transform: translateX(10px);
  transition: opacity 0.25s, transform 0.25s;
  pointer-events: none;
  position: absolute;
  width: 100%;
}
.login-step.active {
  opacity: 1;
  transform: translateX(0);
  pointer-events: auto;
  position: relative;
}

/* Profile Avatars */
.profile-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  font-family: var(--font-display);
  flex-shrink: 0;
}
.profile-avatar.usec { background: rgba(59,130,246,0.2); color: #60a5fa; }
.profile-avatar.bear { background: rgba(239,68,68,0.2); color: #f87171; }
.profile-avatar.savage { background: rgba(168,162,158,0.2); color: #a8a29e; }

/* Last-Used Highlight */
.profile-card.last-used {
  border-left: 3px solid var(--accent);
  background: rgba(200,170,110,0.04);
}
.profile-card-last-tag {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
  white-space: nowrap;
}

/* Login Footer */
.login-footer {
  text-align: center;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 16px;
  letter-spacing: 1px;
  position: relative;
  z-index: 1001;
}

.profile-grid {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 340px;
  overflow-y: auto;
  padding-right: 4px;
}

.profile-grid::-webkit-scrollbar { width: 4px; }
.profile-grid::-webkit-scrollbar-track { background: transparent; }
.profile-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.profile-card {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
}

.profile-card:hover {
  border-color: var(--accent);
  box-shadow: 0 0 12px rgba(200,170,110,0.15);
  background: rgba(200,170,110,0.04);
}

.profile-card .profile-card-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-bright);
  flex: 1;
}

.profile-card .profile-card-level {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-dim);
  white-space: nowrap;
}

.faction-badge {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 3px 8px;
  border-radius: 3px;
  line-height: 1;
}

.faction-badge.usec { background: rgba(59,130,246,0.15); color: #60a5fa; }
.faction-badge.bear { background: rgba(239,68,68,0.15); color: #f87171; }
.faction-badge.savage { background: rgba(168,162,158,0.15); color: #a8a29e; }

.login-back {
  display: inline-block;
  margin-top: 14px;
  font-size: 12px;
  color: var(--text-dim);
  cursor: pointer;
  text-align: center;
  width: 100%;
  transition: color 0.15s;
}

.login-back:hover { color: var(--accent); }

.login-selected-profile {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
  padding: 10px 14px;
  background: var(--bg-surface);
  border: 1px solid var(--accent-dim);
  border-radius: var(--radius);
  font-size: 14px;
  color: var(--text-bright);
  font-weight: 600;
}

.profile-loading {
  text-align: center;
  padding: 32px 0;
  color: var(--text-dim);
  font-size: 13px;
}

.profile-empty {
  text-align: center;
  padding: 32px 0;
  color: var(--text-dim);
  font-size: 13px;
}

/* ══════════════════════════════════════════════════════════
   SERVER VITALS WIDGET (login screen)
   ══════════════════════════════════════════════════════════ */
.server-vitals {
  position: fixed;
  top: 20px;
  left: 20px;
  width: 220px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px 18px;
  z-index: 201;
  box-shadow: var(--shadow-lg);
  animation: loginBoxIn 0.5s ease-out 0.2s both;
  font-family: var(--font-mono);
}

.server-vitals::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  background: linear-gradient(90deg, transparent 5%, var(--accent) 50%, transparent 95%);
}

.server-vitals-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.server-vitals-title {
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  font-weight: 600;
}

.server-vitals-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
  box-shadow: 0 0 6px rgba(34,197,94,0.5);
  animation: vitalsPulse 2s ease-in-out infinite;
}

.server-vitals-dot.amber {
  background: #f59e0b;
  box-shadow: 0 0 6px rgba(245,158,11,0.5);
}

@keyframes vitalsPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.server-vitals-divider {
  height: 1px;
  background: var(--border);
  margin-bottom: 10px;
}

.server-vitals-stats {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.server-vitals-stat {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  color: var(--text-bright);
}

.server-vitals-stat .sv-diamond {
  color: var(--accent);
  font-size: 8px;
}

.server-vitals-stat .sv-label {
  color: var(--text-dim);
  font-size: 10px;
}

.server-vitals-raid {
  font-size: 11px;
}

.server-vitals-raid-label {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--accent);
  font-weight: 600;
  margin-bottom: 4px;
}

.server-vitals-raid-label svg {
  width: 10px;
  height: 10px;
}

.server-vitals-raid-info {
  color: var(--text-bright);
  font-size: 12px;
  line-height: 1.6;
}

.server-vitals-raid-info .sv-muted {
  color: var(--text-muted);
  font-size: 11px;
}

.server-vitals-players {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
}

.server-vitals-players-label {
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-dim);
  font-weight: 600;
  margin-bottom: 6px;
}

.sv-player-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 3px 0;
  font-size: 11px;
}

.sv-player-name {
  color: var(--text-bright);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 110px;
}

.sv-player-status {
  font-size: 10px;
  padding: 1px 6px;
  border-radius: 3px;
  white-space: nowrap;
}

.sv-player-status.stash {
  color: #94a3b8;
  background: rgba(148,163,184,0.12);
}

.sv-player-status.raid {
  color: #22c55e;
  background: rgba(34,197,94,0.12);
}

.server-vitals-uptime {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
}

/* ══════════════════════════════════════════════════════════
   MAIN CONTAINER
   ══════════════════════════════════════════════════════════ */
.main-container {
  display: none;
  max-width: 1320px;
  margin: 0 auto;
  padding: 24px 32px 60px;
}

/* ── Main Tab Panels ── */
.main-tab-panel { display: none; }
.main-tab-panel.active { display: block; }

/* ── Sub-Tabs (within Items) ── */
.tab-bar {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 24px;
}

.tab-btn {
  padding: 12px 28px;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-mono);
  position: relative;
}
.tab-btn:hover { color: var(--text); background: rgba(200,170,110,0.03); }
.tab-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.tab-btn .badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px; height: 20px;
  padding: 0 6px;
  background: var(--accent);
  color: #0a0a0a;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 700;
  margin-left: 8px;
  font-family: var(--font-body);
}

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ══════════════════════════════════════════════════════════
   COMING SOON PLACEHOLDER
   ══════════════════════════════════════════════════════════ */
.coming-soon {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  text-align: center;
}

.coming-soon-icon {
  width: 64px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 20px;
}
.coming-soon-icon svg { width: 28px; height: 28px; color: var(--text-muted); }

.coming-soon h2 {
  font-family: var(--font-mono);
  font-size: 18px;
  color: var(--text-dim);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.coming-soon p {
  font-size: 14px;
  color: var(--text-muted);
  max-width: 400px;
  line-height: 1.7;
}

.coming-soon .phase-badge {
  margin-top: 16px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  padding: 3px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
}

/* ══════════════════════════════════════════════════════════
   DASHBOARD
   ══════════════════════════════════════════════════════════ */
.dash-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
  align-items: start;
}
.dash-grid .full-width { grid-column: 1 / -1; }
@media (max-width: 860px) { .dash-grid { grid-template-columns: 1fr; } }

.dash-widget {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
}
.dash-widget-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-card);
}
.dash-widget-title {
  font-family: var(--font-mono);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 8px;
}
.dash-widget-title svg { width: 14px; height: 14px; color: var(--accent-dim); }
.dash-widget-body { padding: 16px; }

.dash-stat-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 12px;
}
.dash-stat {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.dash-stat-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}
.dash-stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-bright);
  font-family: var(--font-display);
}
.dash-stat-value.sm { font-size: 14px; color: var(--text); }

.dash-player-list {
  max-height: 260px;
  overflow-y: auto;
}
.dash-player {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 13px;
}
.dash-player:last-child { border-bottom: none; }
.dash-player .online-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}
.dash-player .online-dot.on { background: var(--success-bright); box-shadow: 0 0 6px var(--success-bright); }
.dash-player .online-dot.off { background: var(--text-muted); }
.dash-player .p-name { flex: 1; color: var(--text); font-weight: 600; }
.dash-player .p-detail { color: var(--text-dim); font-family: var(--font-mono); font-size: 11px; }

.dash-bar-chart { display: flex; flex-direction: column; gap: 6px; }
.dash-bar-row { display: flex; align-items: center; gap: 10px; font-size: 12px; }
.dash-bar-label { width: 140px; text-align: right; color: var(--text-dim); font-family: var(--font-mono); font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.dash-bar-track { flex: 1; height: 16px; background: var(--bg-dark); border-radius: 2px; overflow: hidden; }
.dash-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 2px; transition: width 0.4s ease; }
.dash-bar-count { width: 36px; text-align: right; font-family: var(--font-mono); color: var(--text); font-size: 11px; }

.dash-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 16px;
}

/* Activity table */
.activity-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.activity-table th {
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
}
.activity-table td { padding: 8px 10px; border-bottom: 1px solid var(--border-subtle); color: var(--text-dim); }
.activity-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.activity-badge.ItemGive { background: rgba(106,173,106,0.15); color: var(--success-bright); }
.activity-badge.PresetGive { background: rgba(200,170,110,0.15); color: var(--accent); }
.activity-badge.Broadcast { background: rgba(100,150,200,0.15); color: #8ab4d8; }
.activity-badge.ServerStart { background: rgba(200,170,110,0.1); color: var(--text-dim); }
.activity-badge.ConfigChange { background: rgba(200,122,62,0.15); color: var(--warning); }

/* ── Raid Info Tab Layout ── */
.raidinfo-status-bar {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 14px 20px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 24px;
  flex-wrap: wrap;
}
.raidinfo-status-bar .dash-stat-label { margin-bottom: 0; }
.raidinfo-idle-msg {
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 12px;
  letter-spacing: 0.5px;
}
.raidinfo-system-bar {
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 8px 16px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
}
.system-info-label {
  color: var(--accent);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-right: 6px;
}
.system-info-item { color: var(--text); }
.system-info-sep { color: var(--border); }
.raidinfo-columns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
  align-items: start;
}
@media (max-width: 960px) { .raidinfo-columns { grid-template-columns: 1fr; } }
.raidinfo-section {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
}
.raidinfo-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-card);
  font-family: var(--font-mono);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
}
.raidinfo-section-header svg { width: 14px; height: 14px; color: var(--accent-dim); margin-right: 8px; }
.raidinfo-section-body { padding: 12px 16px; }

/* ── Telemetry: Live Raid ── */
.telem-raid-header {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}
.telem-raid-status {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 10px;
  font-size: 10px;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.telem-raid-status.in-raid { background: rgba(106,173,106,0.2); color: var(--success-bright); }
.telem-raid-status.loading, .telem-raid-status.deploying { background: rgba(200,170,110,0.15); color: var(--accent); }
.telem-raid-status.extracting, .telem-raid-status.post-raid { background: rgba(100,150,200,0.15); color: #8ab4d8; }
.telem-raid-status.idle { background: rgba(100,100,100,0.15); color: var(--text-dim); }

.telem-fps { font-family: var(--font-mono); font-weight: 700; font-size: 14px; }
.telem-fps.fps-good { color: #4a7c59; }
.telem-fps.fps-mid { color: #c87a3e; }
.telem-fps.fps-low { color: #8b3a3a; }

.telem-player-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.telem-player-table th {
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  padding: 6px 8px;
  border-bottom: 1px solid var(--border);
}
.telem-player-table td { padding: 6px 8px; border-bottom: 1px solid var(--border-subtle); }
.telem-player-table tr.dead td { opacity: 0.45; }

.telem-health-bar {
  width: 60px; height: 8px;
  background: var(--bg-dark);
  border-radius: 2px;
  overflow: hidden;
  display: inline-block;
  vertical-align: middle;
}
.telem-health-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.4s ease;
}
.telem-health-fill.hp-high { background: var(--success-bright); }
.telem-health-fill.hp-mid { background: var(--warning); }
.telem-health-fill.hp-low { background: var(--error-bright); }

.telem-ping { font-family: var(--font-mono); font-size: 11px; }
.telem-ping.ping-good { color: #4a7c59; }
.telem-ping.ping-fair { color: #c8aa6e; }
.telem-ping.ping-warn { color: #c87a3e; }
.telem-ping.ping-bad { color: #8b3a3a; }

.telem-bots {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-subtle);
}
.telem-bot-group { display: flex; flex-direction: column; gap: 2px; }
.telem-bot-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-family: var(--font-mono); }
.telem-bot-value { font-size: 14px; font-weight: 600; color: var(--text); font-family: var(--font-display); }
.telem-bot-value .alive { color: var(--success-bright); }
.telem-bot-value .dead-count { color: var(--text-muted); }

.telem-boss-list { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
.telem-boss-tag {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.telem-boss-tag.boss-alive { background: rgba(74,124,89,0.3); color: #5cb870; }
.telem-boss-tag.boss-dead { background: rgba(200,80,80,0.2); color: #c45050; text-decoration: line-through; }

/* ── Telemetry: Kill Feed ── */
.telem-kill-feed {
  max-height: 500px;
  overflow-y: auto;
}
.telem-kill-entry {
  display: flex;
  align-items: baseline;
  gap: 8px;
  padding: 5px 4px;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 12px;
  font-family: var(--font-mono);
  line-height: 1.4;
  border-left: 3px solid transparent;
}
.telem-kill-entry:last-child { border-bottom: none; }
.telem-kill-entry.kill-border-pmc { border-left-color: var(--success-bright); }
.telem-kill-entry.kill-border-boss { border-left-color: var(--warning); }
.telem-kill-entry.kill-border-raider { border-left-color: var(--warning); }
.telem-kill-time { color: var(--text-muted); font-size: 10px; white-space: nowrap; }
.telem-kill-detail { flex: 1; }
.telem-kill-dist { color: var(--text-muted); font-size: 10px; white-space: nowrap; font-family: var(--font-mono); }
.telem-kill-name.pmc { color: var(--success-bright); font-weight: 600; }
.telem-kill-name.boss { color: var(--warning); font-weight: 600; }
.telem-kill-name.raider, .telem-kill-name.rogue { color: var(--warning); font-weight: 600; }
.telem-kill-name.scav, .telem-kill-name.follower { color: var(--text-dim); }
.telem-kill-weapon { color: var(--text); }
.telem-kill-meta { color: var(--text-muted); font-size: 10px; }
.telem-headshot { background: rgba(196,80,80,0.2); color: #c45050; font-weight: 700; padding: 0 4px; border-radius: 3px; font-size: 10px; }
.telem-kill-arrow { color: var(--text-muted); margin: 0 2px; }

/* ── Telemetry: Raid History ── */
.telem-history-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.telem-history-table th {
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  padding: 6px 8px;
  border-bottom: 1px solid var(--border);
}
.telem-history-table td { padding: 6px 8px; border-bottom: 1px solid var(--border-subtle); color: var(--text); }
.telem-history-table tr { cursor: pointer; }
.telem-history-table tr:hover td { background: var(--bg-hover); }
.telem-history-detail {
  display: none;
  padding: 12px 16px;
  background: var(--bg-dark);
  border-bottom: 1px solid var(--border-subtle);
}
.telem-history-detail.open { display: block; }
.telem-history-sub { display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 10px; }
.telem-no-data { text-align: center; padding: 24px; color: var(--text-muted); font-size: 12px; font-family: var(--font-mono); }

/* ── Combat Stats Panel ── */
.combat-stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 12px;
}
.combat-stat-item {
  text-align: center;
  padding: 8px 4px;
  background: var(--bg-dark);
  border-radius: var(--radius-sm);
}
.combat-stat-value {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  display: block;
}
.combat-stat-label {
  font-family: var(--font-mono);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
}
.body-part-chart { margin-top: 8px; }
.body-part-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
  font-family: var(--font-mono);
  font-size: 11px;
}
.body-part-label {
  width: 70px;
  text-align: right;
  color: var(--text-dim);
  font-size: 10px;
}
.body-part-bar-bg {
  flex: 1;
  height: 10px;
  background: var(--bg-dark);
  border-radius: 2px;
  overflow: hidden;
}
.body-part-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 0.3s ease;
  min-width: 1px;
}
.body-part-bar-fill.bp-head { background: #c45050; }
.body-part-count {
  width: 24px;
  text-align: right;
  color: var(--text-muted);
  font-size: 10px;
}

/* ── Outcome Badges ── */
.outcome-badge {
  display: inline-block;
  padding: 1px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}
.outcome-badge.survived { background: rgba(106,173,106,0.2); color: var(--success-bright); }
.outcome-badge.kia { background: rgba(196,80,80,0.2); color: #c45050; }
.outcome-badge.mia { background: rgba(200,170,110,0.15); color: var(--accent); }
.outcome-badge.runthrough { background: rgba(200,170,110,0.1); color: #b8a060; }

/* ── Player Scoreboard ── */
.player-scoreboard { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 12px; }
.player-scoreboard th {
  text-align: left;
  padding: 4px 6px;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  border-bottom: 1px solid var(--border);
}
.player-scoreboard td { padding: 4px 6px; border-bottom: 1px solid var(--border-subtle); }
.player-scoreboard td.num { text-align: center; font-family: var(--font-mono); }

/* ── System Gauges (CPU/RAM semicircle + history charts) ── */
.system-gauges-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 12px;
  margin: 12px 0;
}
.system-gauges-panel .section-header {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border-subtle);
}
.gauge-row {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 8px 0;
}
.gauge-row + .gauge-row {
  border-top: 1px solid var(--border-subtle);
}
.gauge-container {
  flex-shrink: 0;
  width: 130px;
  text-align: center;
}
.gauge-svg {
  width: 120px;
  height: 70px;
}
.gauge-value {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 700;
}
.gauge-label {
  font-family: var(--font-mono);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-top: 2px;
}
.gauge-sub {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 1px;
}
.chart-container {
  flex: 1;
  position: relative;
  height: 90px;
  min-width: 0;
}
.chart-container canvas {
  width: 100%;
  height: 100%;
}
.chart-tooltip {
  position: absolute;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 4px 8px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text);
  pointer-events: none;
  white-space: nowrap;
  z-index: 10;
  display: none;
}

/* ── Performance mode toggle ── */
.perf-mode-toggle {
  display: inline-flex;
  margin-left: 12px;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  vertical-align: middle;
}
.perf-mode-btn {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 10px;
  font-family: var(--font-mono);
  padding: 2px 10px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.perf-mode-btn:hover { color: var(--text); }
.perf-mode-btn.active {
  background: var(--gold);
  color: var(--bg-dark);
  font-weight: 600;
}

/* ── Chart legends ── */
.chart-legend {
  display: flex;
  gap: 12px;
  justify-content: center;
  padding: 2px 0 0;
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-dim);
}
.legend-item { display: inline-flex; align-items: center; gap: 4px; }
.legend-swatch {
  display: inline-block;
  width: 10px;
  height: 3px;
  border-radius: 1px;
}

/* ── Alerts ── */
.alert-bell {
  position: relative;
  cursor: pointer;
  padding: 4px 8px;
  font-size: 14px;
  color: var(--text-dim);
  transition: color 0.2s;
}
.alert-bell:hover { color: var(--accent); }
.alert-bell .alert-count {
  position: absolute;
  top: 0;
  right: 0;
  background: var(--error-bright);
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  min-width: 14px;
  height: 14px;
  border-radius: 7px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
}
.alert-feed {
  max-height: 300px;
  overflow-y: auto;
}
.alert-feed.collapsed { display: none; }
.alert-entry {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 6px 4px;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 11px;
  font-family: var(--font-mono);
}
.alert-entry:last-child { border-bottom: none; }
.alert-icon {
  font-size: 12px;
  flex-shrink: 0;
  width: 16px;
  text-align: center;
}
.alert-icon.boss-spawn { color: #c45050; }
.alert-icon.pmc-kill { color: var(--accent); }
.alert-icon.headshot { color: #c45050; }
.alert-icon.raid-start { color: var(--success-bright); }
.alert-icon.raid-end { color: var(--text-muted); }
.alert-icon.extract { color: var(--success-bright); }
.alert-msg { flex: 1; color: var(--text); }
.alert-time { color: var(--text-muted); font-size: 10px; white-space: nowrap; }

/* Toast notifications */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column-reverse;
  gap: 8px;
}
.toast {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius-sm);
  padding: 8px 14px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  animation: toastIn 0.3s ease;
  max-width: 320px;
}
.toast.toast-out { animation: toastOut 0.3s ease forwards; }
.toast.toast-boss { border-left-color: #c45050; }
.toast.toast-kill { border-left-color: var(--accent); }
.toast.toast-headshot { border-left-color: #c45050; }
.toast.toast-raid { border-left-color: var(--success-bright); }
@keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: none; } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(40px); } }

/* ── Lifetime Stats ── */
.lifetime-stats-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 12px;
  margin: 12px 0;
}
.lifetime-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 8px;
}
.lifetime-stat-card {
  text-align: center;
  padding: 10px 6px;
  background: var(--bg-dark);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-subtle);
}
.lifetime-stat-value {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
  color: var(--accent);
  display: block;
}
.lifetime-stat-label {
  font-family: var(--font-mono);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-top: 2px;
}
.lifetime-stat-sub {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 2px;
}

/* ── Live Map ── */
.live-map-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 12px;
  margin: 12px 0;
}
.live-map-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border-subtle);
}
.live-map-header .section-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}
.live-map-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
}
.live-map-controls label {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}
.live-map-controls input[type="range"] {
  width: 100px;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--border);
  border-radius: 2px;
  outline: none;
}
.live-map-controls input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
}
.live-map-controls .rate-label {
  min-width: 40px;
  text-align: right;
  color: var(--text-muted);
}
.live-map-controls select {
  background: var(--bg-dark);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 10px;
}
.live-map-canvas-wrap {
  position: relative;
  width: 100%;
  height: 500px;
  background: #0a0c0e;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-subtle);
  overflow: hidden;
  cursor: grab;
}
.live-map-canvas-wrap:active { cursor: grabbing; }
.live-map-canvas-wrap canvas {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
}
.live-map-legend {
  display: flex;
  gap: 14px;
  margin-top: 8px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  flex-wrap: wrap;
}
.live-map-legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.live-map-legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}
.live-map-no-raid {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 13px;
}

/* Console */
.console-panel {
  background: #0a0a0a;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-family: var(--font-mono);
  font-size: 12px;
  overflow: hidden;
}
.console-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border-subtle);
  cursor: pointer;
  user-select: none;
}
.console-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
}
.console-header-left svg { width: 14px; height: 14px; color: var(--accent-dim); }
.console-filters { display: flex; gap: 4px; }
.console-filter-btn {
  padding: 2px 8px;
  font-size: 10px;
  font-family: var(--font-mono);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.console-filter-btn.active { background: var(--bg-hover); color: var(--text); border-color: var(--border-light); }
.console-body {
  max-height: 350px;
  overflow-y: auto;
  padding: 8px 14px;
  line-height: 1.6;
}
.console-body.collapsed { display: none; }
.console-line { white-space: pre-wrap; word-break: break-all; }
.console-line .ts { color: var(--text-muted); margin-right: 8px; }
.console-line.level-info .msg { color: var(--text-dim); }
.console-line.level-success .msg { color: var(--success-bright); }
.console-line.level-warning .msg { color: var(--warning); }
.console-line.level-error .msg { color: var(--error-bright); }
.console-line.level-debug .msg { color: var(--text-muted); }
.console-line .src { color: var(--accent-dim); margin-right: 6px; }
.console-jump {
  display: none;
  position: sticky;
  bottom: 0;
  text-align: center;
  padding: 4px;
  background: rgba(10,10,10,0.9);
}
.console-jump button {
  font-size: 10px;
  font-family: var(--font-mono);
  padding: 3px 12px;
  background: var(--bg-hover);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-dim);
  cursor: pointer;
}
.console-search {
  padding: 0 14px 6px;
  display: none;
}
.console-search input {
  width: 100%;
  padding: 4px 10px;
  font-size: 11px;
  font-family: var(--font-mono);
  background: #111;
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius);
  color: var(--text);
}

/* Broadcast modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 300;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 32px;
  width: 440px;
  max-width: 90vw;
  box-shadow: var(--shadow-lg);
}
.modal-box h3 {
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 16px;
}
.modal-box textarea {
  width: 100%;
  min-height: 80px;
  padding: 10px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-bright);
  font-family: var(--font-body);
  font-size: 14px;
  resize: vertical;
  margin-bottom: 16px;
}
.modal-box textarea:focus { outline: none; border-color: var(--accent-dim); }
.modal-box .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
.modal-box .form-row > * { flex: 1; }
.modal-box .form-row label { font-size: 12px; color: var(--text-dim); margin-bottom: 4px; display: block; }
.modal-box .form-row input, .modal-box .form-row select { width: 100%; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

/* ══════════════════════════════════════════════════════════
   PLAYER MANAGEMENT
   ══════════════════════════════════════════════════════════ */
.player-search-row {
  display: flex; gap: 10px; margin-bottom: 14px; align-items: center;
}
.player-search-row input {
  flex: 1; min-width: 0;
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
  padding: 8px 12px; font-size: 13px; border-radius: var(--radius); font-family: var(--font-body);
}
.player-search-row input:focus { outline: none; border-color: var(--accent-dim); }
.player-search-row select {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
  padding: 8px 12px; font-size: 13px; border-radius: var(--radius); font-family: var(--font-body);
}
.player-search-row select:focus { outline: none; border-color: var(--accent-dim); }

.player-table { width: 100%; border-collapse: collapse; }
.player-table th {
  font-family: var(--font-mono); font-size: 11px; text-transform: uppercase;
  color: var(--text-dim); padding: 8px 10px; text-align: left; cursor: pointer;
  border-bottom: 1px solid var(--border); user-select: none;
}
.player-table th:hover { color: var(--accent); }
.player-table th .sort-arrow { font-size: 10px; margin-left: 3px; }
.player-table td {
  padding: 8px 10px; font-size: 13px; border-bottom: 1px solid var(--border-subtle);
  color: var(--text);
}
.player-table tr:hover td { background: var(--bg-hover); }
.player-table tr.expanded td { background: var(--accent-glow); border-bottom-color: var(--accent-dim); }

.online-dot {
  display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 6px; vertical-align: middle;
}
.online-dot.on { background: var(--success-bright); box-shadow: 0 0 6px rgba(106,173,106,0.5); }
.online-dot.off { background: var(--text-muted); }

.ban-badge {
  font-size: 10px; color: var(--error-bright); background: rgba(139,58,58,0.25);
  padding: 1px 6px; border-radius: 8px; margin-left: 6px; font-family: var(--font-mono); text-transform: uppercase;
}

.player-detail-row td {
  padding: 0 !important; border-bottom: 2px solid var(--accent-dim);
}
.player-detail-inner {
  padding: 16px 14px; background: var(--bg-panel); border-left: 2px solid var(--accent);
}

.player-profile-tabs {
  display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 14px;
}
.player-profile-tabs .ptab {
  padding: 8px 18px; font-size: 12px; font-family: var(--font-mono); text-transform: uppercase;
  color: var(--text-dim); background: none; border: none; cursor: pointer;
  border-bottom: 2px solid transparent; letter-spacing: 0.5px;
}
.player-profile-tabs .ptab:hover { color: var(--text); }
.player-profile-tabs .ptab.active { color: var(--accent); border-bottom-color: var(--accent); }

.profile-panel { display: none; }
.profile-panel.active { display: block; }

.profile-header {
  display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 16px;
}
.profile-stat-card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md);
  padding: 12px 16px; min-width: 130px;
}
.profile-stat-card .psc-label {
  font-size: 10px; color: var(--text-dim); font-family: var(--font-mono); text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 4px;
}
.profile-stat-card .psc-value {
  font-size: 18px; font-weight: 700; color: var(--text-bright); font-family: var(--font-display);
}
.profile-stat-card .psc-value.accent { color: var(--accent); }
.profile-stat-card .psc-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

.xp-bar {
  height: 6px; background: var(--bg-input); border-radius: 3px; margin-top: 6px; overflow: hidden;
}
.xp-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s; }

/* Stats sections (collapsible) */
.stats-section { border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 10px; overflow: hidden; }
.stats-section-header {
  display: flex; justify-content: space-between; align-items: center; padding: 10px 16px;
  background: var(--bg-card); cursor: pointer; user-select: none;
  font-size: 13px; font-weight: 700; color: var(--accent); text-transform: uppercase;
  letter-spacing: 0.5px; font-family: var(--font-mono);
}
.stats-section-header:hover { background: var(--bg-input); }
.stats-toggle-icon::after { content: '\25B6'; font-size: 10px; color: var(--text-dim); transition: transform 0.2s; display: inline-block; }
.stats-section.open .stats-toggle-icon::after { transform: rotate(90deg); }
.stats-section-body { display: none; padding: 12px 16px; }
.stats-section.open .stats-section-body { display: block; }
.stats-grid { display: flex; gap: 12px; flex-wrap: wrap; }
.stats-grid .profile-stat-card { min-width: 140px; flex: 1 1 140px; max-width: 200px; }

.skill-bar {
  height: 4px; background: var(--bg-input); border-radius: 2px; flex: 1; overflow: hidden;
}
.skill-bar-fill { height: 100%; background: var(--accent-dim); border-radius: 2px; }

.status-badge {
  display: inline-block; font-size: 10px; padding: 2px 8px; border-radius: 8px;
  font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.5px;
}
.status-badge.active { background: rgba(200,170,110,0.15); color: var(--accent); }
.status-badge.completed, .status-badge.success { background: rgba(74,124,74,0.2); color: var(--success-bright); }
.status-badge.failed { background: rgba(139,58,58,0.2); color: var(--error-bright); }
.status-badge.locked { background: rgba(100,100,100,0.15); color: var(--text-dim); }

.quest-chevron { cursor: pointer; user-select: none; color: var(--text-dim); transition: transform 0.2s ease; display: inline-block; font-size: 11px; }
.quest-chevron.expanded { transform: rotate(90deg); color: var(--accent); }
.quest-detail-row td { padding: 0 !important; border-bottom: 1px solid var(--border-subtle); }
.quest-detail-inner { padding: 8px 12px 8px 24px; background: var(--bg-input); border-left: 2px solid var(--accent-dim); margin: 0 8px 0 0; }
.quest-condition { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 12px; }
.quest-condition .qc-icon { flex-shrink: 0; width: 14px; text-align: center; }
.quest-condition.completed .qc-icon { color: var(--success-bright); }
.quest-condition.pending .qc-icon { color: var(--text-dim); }
.quest-condition.completed .qc-text { color: var(--text-dim); }
.quest-condition.pending .qc-text { color: var(--text-muted); }
.quest-condition .qc-type { font-size: 10px; font-family: var(--font-mono); color: var(--text-dim); background: rgba(100,100,100,0.15); padding: 1px 5px; border-radius: 3px; }

/* Quest Browser */
.qb-map-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.qb-chip { padding: 4px 10px; font-size: 12px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-muted); cursor: pointer; transition: all 0.15s ease; font-family: var(--font-mono); }
.qb-chip:hover { border-color: var(--accent-dim); color: var(--text); }
.qb-chip.active { background: rgba(200,170,110,0.15); border-color: var(--accent); color: var(--accent); }
.qb-chip .qb-chip-count { font-size: 10px; color: var(--text-dim); margin-left: 3px; }
.qb-sortable { cursor: pointer; user-select: none; white-space: nowrap; }
.qb-sortable:hover { color: var(--accent); }
.qb-sort-arrow { font-size: 10px; color: var(--accent); margin-left: 2px; }
.qb-detail-row td { padding: 0 !important; border-bottom: 1px solid var(--border-subtle); }
.qb-detail-inner { padding: 10px 14px 10px 26px; background: var(--bg-input); border-left: 2px solid var(--accent-dim); }
.qb-detail-inner h4 { font-size: 11px; color: var(--text-dim); text-transform: uppercase; font-family: var(--font-mono); margin: 0 0 6px 0; letter-spacing: 0.5px; }
.qb-obj-list { margin: 0 0 12px 0; padding: 0; list-style: none; }
.qb-obj-item { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 12px; color: var(--text-muted); }
.qb-obj-item .qb-obj-type { font-size: 10px; font-family: var(--font-mono); color: var(--text-dim); background: rgba(100,100,100,0.15); padding: 1px 5px; border-radius: 3px; }
.qb-state-setter { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 4px; padding-top: 8px; border-top: 1px solid var(--border-subtle); }
.qb-state-setter select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); font-size: 12px; padding: 4px 8px; border-radius: 4px; }
.qb-state-setter label { font-size: 11px; color: var(--text-dim); font-family: var(--font-mono); text-transform: uppercase; }

.profile-mini-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.profile-mini-table th {
  font-size: 10px; color: var(--text-dim); font-family: var(--font-mono); text-transform: uppercase;
  padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border);
}
.profile-mini-table td { padding: 6px 8px; border-bottom: 1px solid var(--border-subtle); }

.player-actions-bar {
  display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap;
}

.ban-section {
  border-top: 1px solid var(--border); margin-top: 20px; padding-top: 14px;
}
.ban-section-header {
  cursor: pointer; display: flex; align-items: center; gap: 8px;
  font-family: var(--font-mono); font-size: 13px; text-transform: uppercase;
  color: var(--text-dim); letter-spacing: 0.5px; margin-bottom: 10px;
}
.ban-section-header:hover { color: var(--text); }
.ban-section-header .toggle-arrow { transition: transform 0.2s; }
.ban-section-header.collapsed .toggle-arrow { transform: rotate(-90deg); }
.ban-section-body { }
.ban-section-body.collapsed { display: none; }

.danger-btn {
  background: var(--error); color: var(--text-white); border: 1px solid var(--error-bright);
  padding: 6px 14px; font-size: 12px; font-family: var(--font-mono); text-transform: uppercase;
  border-radius: var(--radius); cursor: pointer; letter-spacing: 0.5px;
}
.danger-btn:hover { background: var(--error-bright); }
.danger-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.confirmation-input {
  background: var(--bg-input); border: 1px solid var(--error); color: var(--error-bright);
  padding: 8px 12px; font-size: 13px; font-family: var(--font-mono); border-radius: var(--radius);
  width: 100%; margin-top: 8px;
}
.confirmation-input:focus { outline: none; border-color: var(--error-bright); }

.faction-badge {
  font-size: 10px; padding: 2px 8px; border-radius: 8px; font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.faction-badge.bear { background: rgba(200,100,50,0.2); color: #e8a060; }
.faction-badge.usec { background: rgba(80,120,200,0.2); color: #80a8e8; }

.mail-item-row { display: flex; gap: 8px; margin-bottom: 6px; align-items: center; }
.mail-item-row input { flex: 1; min-width: 0; }
.mail-item-row .btn-sm { padding: 4px 8px; font-size: 11px; }

/* ══════════════════════════════════════════════════════════
   SEARCH & CATEGORY BAR
   ══════════════════════════════════════════════════════════ */
.search-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  align-items: stretch;
}

.search-input-wrap {
  flex: 1;
  position: relative;
}

.search-input-wrap .search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px; height: 16px;
  color: var(--text-dim);
  pointer-events: none;
}

.search-input-wrap input {
  width: 100%;
  padding-left: 38px;
  padding-right: 12px;
}

/* ── Custom Category Dropdown ── */
.cat-dropdown {
  position: relative;
  width: 300px;
  flex-shrink: 0;
}

.cat-trigger {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 0 14px;
  height: 100%;
  min-height: 38px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-bright);
  font-size: 14px;
  font-family: var(--font-body);
  font-weight: 600;
  cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s;
  user-select: none;
}
.cat-trigger:hover { border-color: var(--border-light); }
.cat-trigger.open { border-color: var(--accent-dim); box-shadow: 0 0 0 2px var(--accent-glow); }

.cat-trigger .ct-icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.cat-trigger .ct-icon svg { width: 16px; height: 16px; color: var(--accent); }

.cat-trigger .ct-label { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.cat-trigger .ct-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-dim);
  background: rgba(200,170,110,0.08);
  padding: 2px 8px;
  border-radius: 8px;
  border: 1px solid rgba(200,170,110,0.12);
}

.cat-trigger .ct-chevron {
  width: 14px; height: 14px;
  color: var(--text-dim);
  transition: transform 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
}
.cat-trigger .ct-chevron svg { width: 14px; height: 14px; }
.cat-trigger.open .ct-chevron { transform: rotate(180deg); }

/* ── Dropdown Panel ── */
.cat-panel {
  display: none;
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  width: 360px;
  background: var(--bg-panel);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  z-index: 50;
  max-height: 480px;
  overflow: hidden;
  flex-direction: column;
}
.cat-panel.open { display: flex; }

.cat-panel-search {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-dark);
}

.cat-panel-search input {
  width: 100%;
  padding: 7px 12px 7px 32px;
  font-size: 13px;
  background: var(--bg-input);
}

.cat-panel-search .search-wrap {
  position: relative;
}

.cat-panel-search .search-wrap svg {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  color: var(--text-muted);
  pointer-events: none;
}

.cat-list {
  overflow-y: auto;
  flex: 1;
  padding: 6px 0;
}

.cat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: background 0.1s;
  font-size: 13px;
  color: var(--text);
  font-weight: 500;
  border-left: 2px solid transparent;
}
.cat-item:hover { background: var(--bg-hover); }
.cat-item.active {
  background: var(--accent-glow);
  color: var(--accent-bright);
  border-left-color: var(--accent);
}
.cat-item.is-parent {
  font-weight: 700;
  color: var(--text-bright);
  padding-top: 10px;
}

.cat-item .ci-indent { display: inline-block; flex-shrink: 0; }

.cat-item .ci-icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.cat-item .ci-icon svg { width: 14px; height: 14px; color: var(--accent-dim); }
.cat-item.active .ci-icon svg { color: var(--accent-bright); }

.cat-item .ci-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.cat-item .ci-count {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  min-width: 36px;
  text-align: right;
}
.cat-item.active .ci-count { color: var(--accent-dim); }

.cat-sep {
  height: 1px;
  background: var(--border);
  margin: 6px 14px;
}

/* ══════════════════════════════════════════════════════════
   RESULTS TABLE
   ══════════════════════════════════════════════════════════ */
.results-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 10px;
  font-family: var(--font-mono);
  letter-spacing: 0.5px;
}
.results-info strong { color: var(--accent); font-weight: 700; }

.item-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;
  font-size: 14px;
}

.item-table th {
  text-align: left;
  padding: 10px 14px;
  background: var(--bg-mid);
  border-bottom: 1px solid var(--border);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.item-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-subtle);
  vertical-align: middle;
  overflow: hidden;
}

.item-table tbody tr { transition: background 0.08s; }
.item-table tbody tr:hover td { background: var(--bg-hover); }

.item-name-cell {
  display: flex;
  flex-direction: column;
  gap: 2px;
  overflow: hidden;
}

.item-name { font-weight: 700; color: var(--text-bright); font-size: 14px; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.item-tpl {
  font-size: 10px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  opacity: 0.8;
  letter-spacing: 0.3px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.item-cat-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 12px;
  font-size: 11px;
  color: var(--text-dim);
  font-weight: 600;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.item-cat-badge .badge-icon { width: 12px; height: 12px; display: flex; align-items: center; }
.item-cat-badge .badge-icon svg { width: 12px; height: 12px; color: var(--accent-dim); }

.col-stack {
  text-align: center;
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-dim);
}

.col-price {
  text-align: right;
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--accent);
  white-space: nowrap;
}
.col-price .price-zero { color: var(--text-muted); }

.col-weight {
  text-align: center;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-dim);
}

.col-actions { text-align: right; white-space: nowrap; }

/* ── Sortable Headers ── */
.item-table th.sortable {
  cursor: pointer;
  user-select: none;
  transition: color 0.15s;
  position: relative;
}
.item-table th.sortable:hover { color: var(--accent); }
.item-table th.sortable .sort-arrow {
  display: inline-block;
  margin-left: 4px;
  font-size: 10px;
  opacity: 0.3;
  transition: opacity 0.15s;
}
.item-table th.sortable.sort-active .sort-arrow { opacity: 1; color: var(--accent); }
.item-table th.sortable.sort-active { color: var(--accent-bright); }

/* ── Item Name Cell (updated) ── */
.item-name-sub {
  font-size: 11px;
  color: var(--text-dim);
  font-weight: 500;
  line-height: 1.2;
}

.action-group {
  display: inline-flex;
  align-items: center;
  gap: 5px;
}
.action-group input[type="number"] { width: 52px; padding: 4px 6px; }

/* ── Pagination ── */
.pagination {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 16px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}

.pagination-info {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--font-mono);
}

.pagination-btns {
  display: flex;
  gap: 8px;
}

/* ══════════════════════════════════════════════════════════
   PRESETS
   ══════════════════════════════════════════════════════════ */
.preset-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 16px;
}

.preset-card {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  transition: border-color 0.15s, box-shadow 0.15s;
  position: relative;
}
.preset-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent-dim), transparent 80%);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}
.preset-card:hover { border-color: var(--border-light); box-shadow: var(--shadow-glow); }

.preset-card h3 {
  font-family: var(--font-mono);
  color: var(--accent);
  font-size: 15px;
  margin-bottom: 6px;
  letter-spacing: 0.5px;
}

.preset-card .preset-desc {
  color: var(--text-dim);
  font-size: 13px;
  margin-bottom: 16px;
  line-height: 1.6;
}

.preset-items { list-style: none; margin-bottom: 18px; }
.preset-items li {
  font-size: 12px;
  padding: 3px 0;
  color: var(--text);
  font-family: var(--font-mono);
}
.preset-items li .count { color: var(--accent); font-weight: 700; }

/* ══════════════════════════════════════════════════════════
   CART
   ══════════════════════════════════════════════════════════ */
.cart-empty {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-dim);
}
.cart-empty svg { width: 48px; height: 48px; color: var(--border-light); margin-bottom: 16px; }
.cart-empty p { font-size: 14px; margin-bottom: 4px; }
.cart-empty .sub { font-size: 12px; color: var(--text-muted); }

.cart-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  justify-content: flex-end;
}

.cart-summary {
  font-size: 13px;
  color: var(--text-dim);
  margin-top: 14px;
  text-align: right;
  font-family: var(--font-mono);
}

/* ══════════════════════════════════════════════════════════
   TOASTS
   ══════════════════════════════════════════════════════════ */
.toast-container {
  position: fixed;
  top: 64px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}

.toast {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text);
  box-shadow: var(--shadow-lg);
  pointer-events: auto;
  animation: toast-in 0.25s ease-out;
  max-width: 400px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.toast.success { border-left: 3px solid var(--success-bright); }
.toast.error { border-left: 3px solid var(--error-bright); }
.toast.info { border-left: 3px solid var(--accent); }
.toast-fade-out { animation: toast-out 0.3s ease-in forwards; }

@keyframes toast-in { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: none; } }
@keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateX(40px); } }

.toast-icon { width: 16px; height: 16px; flex-shrink: 0; }
.toast-icon svg { width: 16px; height: 16px; }
.toast.success .toast-icon svg { color: var(--success-bright); }
.toast.error .toast-icon svg { color: var(--error-bright); }
.toast.info .toast-icon svg { color: var(--accent); }

/* ── Spinner ── */
.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid var(--border-light);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-row td {
  text-align: center;
  padding: 60px;
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: 13px;
}

/* ── Responsive ── */
@media (max-width: 860px) {
  .header { padding: 0 16px; }
  .main-container { padding: 16px; }
  .search-row { flex-direction: column; }
  .cat-dropdown { width: 100%; }
  .cat-panel { width: 100%; }
  .hero-banner { height: 48px; }
  .preset-grid { grid-template-columns: 1fr; }
  .nav-bar { padding: 0 8px; }
  .nav-btn { padding: 10px 10px; font-size: 10px; letter-spacing: 0.8px; }
  .flea-cat-grid { grid-template-columns: 1fr; }
}

/* ── Flea Market Tab ── */
.cc-num-input {
  width: 70px;
  background: var(--bg-darker);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 5px 8px;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 13px;
  text-align: center;
}
.cc-num-input:focus { border-color: var(--accent); outline: none; }
.cc-wide-input { width: 100%; }
.cc-apply-btn {
  width: 100%;
  padding: 14px;
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 6px;
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: background 0.2s, opacity 0.2s;
}
.cc-apply-btn:hover:not(:disabled) { background: #d4b878; }
.cc-apply-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.cc-apply-btn.dirty { opacity: 1; }
.cc-spinner {
  width: 18px; height: 18px;
  border: 2px solid rgba(0,0,0,0.2);
  border-top-color: #000;
  border-radius: 50%;
  animation: flea-spin 0.6s linear infinite;
}
@keyframes flea-spin { to { transform: rotate(360deg); } }
.flea-cat-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.flea-cat-card {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px 14px;
  transition: border-color 0.2s;
}
.flea-cat-card.modified { border-color: var(--accent); }
.flea-cat-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.flea-cat-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}
.flea-cat-count {
  font-size: 11px;
  color: var(--text-dim);
  background: var(--bg-darker);
  padding: 2px 8px;
  border-radius: 10px;
}
.flea-cat-reset {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  font-family: var(--font-mono);
}
.flea-cat-reset:hover { border-color: var(--accent); color: var(--accent); }
.flea-cat-slider-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}
.flea-cat-slider-row label {
  font-size: 11px;
  color: var(--text-dim);
  width: 32px;
  flex-shrink: 0;
}
.flea-cat-slider-row input[type="range"] { flex: 1; accent-color: var(--accent); }
.flea-cat-slider-row input[type="number"] { width: 60px; }
.cc-toggle {
  position: relative;
  display: inline-block;
  width: 38px;
  height: 20px;
}
.cc-toggle input { opacity: 0; width: 0; height: 0; }
.cc-toggle-slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: var(--border);
  border-radius: 20px;
  transition: background 0.2s;
}
.cc-toggle-slider:before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  left: 3px; bottom: 3px;
  background: var(--text-dim);
  border-radius: 50%;
  transition: transform 0.2s, background 0.2s;
}
.cc-toggle input:checked + .cc-toggle-slider { background: var(--accent); }
.cc-toggle input:checked + .cc-toggle-slider:before { transform: translateX(18px); background: #000; }
.cc-status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 16px;
  padding: 10px 16px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 12px;
  font-family: var(--font-mono);
  color: var(--text-dim);
}
.flea-search-results {
  position: absolute;
  left: 0; right: 0; top: 100%;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 0 0 6px 6px;
  max-height: 240px;
  overflow-y: auto;
  z-index: 50;
}
.flea-search-item {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}
.flea-search-item:hover { background: var(--accent-glow); }
.flea-search-item:last-child { border-bottom: none; }
.flea-override-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.flea-override-table th {
  text-align: left;
  padding: 8px 10px;
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}
.flea-override-table td {
  padding: 6px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}
.flea-override-table input[type="number"] { width: 65px; }
.flea-override-remove {
  background: none;
  border: 1px solid var(--danger);
  color: var(--danger);
  padding: 3px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
}
.flea-override-remove:hover { background: var(--danger); color: #fff; }
.flea-unsaved-dot {
  display: none;
  width: 6px; height: 6px;
  background: var(--warning);
  border-radius: 50%;
  margin-left: 4px;
}
.flea-unsaved-dot.visible { display: inline-block; }
</style>
</head>
<body>

<!-- ═══════ HEADER ═══════ -->
<div class="header">
  <div class="header-left">
    <div class="header-logo">
      <div class="header-logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <span class="header-title">ZSlayerHQ Command Center</span>
    </div>
    <div class="header-sep"></div>
    <span class="header-version">v2.2.0</span>
    <div class="header-social">
      <a href="https://discord.gg/ZSlayerHQ" target="_blank" title="Discord">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
      </a>
      <a href="https://www.youtube.com/@ZSlayerHQ-ImBenCole" target="_blank" title="YouTube">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
      </a>
      <div class="header-sep"></div>
      <a href="https://discord.com/invite/Xn9msqQZan" target="_blank" title="SPT Discord">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
      </a>
      <a href="https://discord.gg/project-fika" target="_blank" title="Fika Discord">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
      </a>
      <a href="https://forge.sp-tarkov.com/" target="_blank" title="SPT Forge — Mods">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.7 4.3l4 4-9.7 9.7H6v-4z"/><path d="M17.7 2.3l4 4"/><path d="M2 18v4h4"/><path d="M22 22H2"/></svg>
      </a>
    </div>
  </div>
  <div class="header-profile" id="headerProfile" style="display:none">
    <div class="profile-status">
      <span class="status-dot"></span>
      <span class="profile-label">Connected</span>
    </div>
    <span style="color:var(--text-dim);font-size:13px">Profile:</span>
    <span class="profile-name-display" id="profileNameDisplay"></span>
    <button class="btn btn-ghost btn-sm" onclick="logout()">Disconnect</button>
  </div>
</div>

<!-- ═══════ NAVIGATION BAR ═══════ -->
<div class="nav-bar" id="navBar">
  <div class="nav-bar-inner">
    <button class="nav-btn active" data-nav="dashboard" onclick="switchMainTab('dashboard')">Dashboard</button>
    <button class="nav-btn" data-nav="raidinfo" onclick="switchMainTab('raidinfo')">Raid Info</button>
    <button class="nav-btn" data-nav="items" onclick="switchMainTab('items')">Items</button>
    <button class="nav-btn" data-nav="players" onclick="switchMainTab('players')">Players</button>
    <button class="nav-btn" data-nav="flea" onclick="switchMainTab('flea')">Flea Market</button>
    <button class="nav-btn disabled" data-nav="traders" onclick="switchMainTab('traders')">Traders <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn" data-nav="quests" onclick="switchMainTab('quests')">Quests</button>
    <button class="nav-btn disabled" data-nav="progression" onclick="switchMainTab('progression')">Progression <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="backups" onclick="switchMainTab('backups')">Backups <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="events" onclick="switchMainTab('events')">Events <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="gamevalues" onclick="switchMainTab('gamevalues')">Game Values <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="profiles" onclick="switchMainTab('profiles')">Profiles <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="loadouts" onclick="switchMainTab('loadouts')">Loadouts <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="bounties" onclick="switchMainTab('bounties')">Bounties <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
    <button class="nav-btn disabled" data-nav="clans" onclick="switchMainTab('clans')">Clans <span class="nav-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span></button>
  </div>
</div>

<!-- ═══════ LOGIN ═══════ -->
<div class="login-overlay" id="loginScreen">
  <div class="login-bg"></div>

  <!-- Server Vitals Widget -->
  <div class="server-vitals" id="serverVitals" style="display:none">
    <div class="server-vitals-header">
      <span class="server-vitals-title">Server Status</span>
      <span class="server-vitals-dot" id="svDot"></span>
    </div>
    <div class="server-vitals-divider"></div>
    <div class="server-vitals-stats">
      <div class="server-vitals-stat"><span class="sv-diamond">&#9670;</span> <span id="svOnline">0</span> <span class="sv-label">Online</span></div>
      <div class="server-vitals-stat"><span class="sv-diamond">&#9670;</span> <span id="svTotal">0</span> <span class="sv-label">Total</span></div>
    </div>
    <div class="server-vitals-raid" id="svRaidSection">
      <div class="server-vitals-raid-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        <span>Active Raid</span>
      </div>
      <div class="server-vitals-raid-info" id="svRaidInfo">
        <span class="sv-muted">No active raid</span>
      </div>
    </div>
    <div class="server-vitals-players" id="svPlayersSection" style="display:none">
      <div class="server-vitals-players-label">Online Players</div>
      <div id="svPlayersList"></div>
    </div>
    <div class="server-vitals-uptime" id="svUptime"></div>
  </div>

  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <div class="login-logo-text">
        <span class="login-brand">ZSlayerHQ</span>
        <span class="login-subtitle">Command Center</span>
      </div>
    </div>

    <div class="login-steps-container">
      <!-- Step 1: Profile Select -->
      <div class="login-step active" id="loginStep1">
        <p>Select a profile to connect.</p>
        <div class="profile-grid" id="profileGrid">
          <div class="profile-loading">Loading profiles...</div>
        </div>
        <div class="login-error" id="loginError1"></div>
      </div>

      <!-- Step 2: Password -->
      <div class="login-step" id="loginStep2">
        <div class="login-selected-profile" id="selectedProfileDisplay"></div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="off" style="width:100%" onkeydown="if(event.key==='Enter')connect()">
        </div>
        <button class="btn btn-accent" id="connectBtn" onclick="connect()" style="width:100%;padding:11px;font-size:14px;margin-top:6px">CONNECT</button>
        <div class="login-error" id="loginError2"></div>
        <div class="login-back" onclick="loginBackToProfiles()">&larr; Back to profiles</div>
      </div>
    </div>
    <div class="login-footer" id="loginFooter">
      Command Center v2.2.1
    </div>
  </div>
</div>

<!-- ═══════ HERO BANNER ═══════ -->
<div class="hero-banner" id="heroBanner" style="display:none">
  <div class="hero-bg-grid"></div>
  <div class="hero-bg-radial"></div>
  <img class="hero-image" id="heroImage" src="banner" alt="Banner" style="display:block">
  <div class="hero-placeholder" id="heroPlaceholder" style="display:none">
    <div class="hero-placeholder-inner">
      <div class="hero-placeholder-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
      </div>
      <div class="hero-placeholder-text">ZSlayerHQ Command Center</div>
    </div>
  </div>
  <div class="hero-scanline"></div>
  <div class="hero-vignette"></div>
  <div class="hero-bottom-fade"></div>
</div>

<!-- ═══════ MAIN INTERFACE ═══════ -->
<div class="main-container" id="mainContainer">

  <!-- ═══════ RAID INFO TAB ═══════ -->
  <div class="main-tab-panel" id="main-raidinfo">

    <!-- Status Bar -->
    <div class="raidinfo-status-bar" id="raidInfoStatusBar">
      <span id="telemRaidStatusBadge" class="telem-raid-status idle">Idle</span>
      <div class="dash-stat"><span class="dash-stat-label">Map</span><span class="dash-stat-value sm" id="telemMap">--</span></div>
      <div class="dash-stat"><span class="dash-stat-label">Elapsed</span><span class="dash-stat-value sm" id="telemTimer">--</span></div>
      <div class="dash-stat"><span class="dash-stat-label">Time of Day</span><span class="dash-stat-value sm" id="telemTimeOfDay">--</span></div>
      <div class="dash-stat"><span class="dash-stat-label">Season</span><span class="dash-stat-value sm" id="telemSeason">--</span></div>
      <div class="dash-stat"><span class="dash-stat-label">FPS</span><span class="telem-fps" id="telemFps">--</span></div>
      <div class="dash-stat"><span class="dash-stat-label">FPS Avg</span><span class="telem-fps" id="telemFpsAvg" style="font-size:12px;font-weight:500">--</span></div>
      <div class="dash-stat"><span class="dash-stat-label">CPU</span><span class="dash-stat-value sm" id="telemCpu">--</span></div>
      <div class="dash-stat"><span class="dash-stat-label">Memory</span><span class="dash-stat-value sm" id="telemMemory">--</span></div>
      <span id="raidInfoIdleMsg" class="raidinfo-idle-msg">Waiting for raid...</span>
    </div>

    <!-- System Info Bar (headless PC specs) -->
    <div id="telemSystemInfo" class="raidinfo-system-bar" style="display:none">
      <span class="system-info-label">Headless PC</span>
      <span class="system-info-item" id="sysInfoCpu"></span>
      <span class="system-info-sep">|</span>
      <span class="system-info-item" id="sysInfoGpu"></span>
      <span class="system-info-sep">|</span>
      <span class="system-info-item" id="sysInfoRam"></span>
      <span class="system-info-sep">|</span>
      <span class="system-info-item" id="sysInfoOs"></span>
    </div>

    <!-- System Gauges (CPU/RAM) -->
    <div class="system-gauges-panel" id="systemGaugesPanel" style="display:none">
      <details id="perfDetails" open>
      <summary class="section-header" style="cursor:pointer;list-style:none;user-select:none">
        <span id="perfSectionLabel">System Performance</span>
        <span style="font-size:10px;color:#6a6050;margin-left:6px" id="perfToggleHint">(click to collapse)</span>
        <span class="perf-mode-toggle" onclick="event.stopPropagation()">
          <button class="perf-mode-btn active" id="perfModeSystem" onclick="setPerfMode('system')">System Wide</button>
          <button class="perf-mode-btn" id="perfModeEft" onclick="setPerfMode('eft')">EFT</button>
        </span>
      </summary>
      <!-- CPU Row -->
      <div class="gauge-row">
        <div class="gauge-container">
          <svg class="gauge-svg" viewBox="0 0 120 70" id="cpuGaugeSvg">
            <!-- Background zone arcs -->
            <path d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="rgba(74,124,89,0.15)" stroke-width="12" stroke-linecap="round" id="cpuZoneGreen"/>
            <!-- Active arc track -->
            <path d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="rgba(200,170,110,0.08)" stroke-width="12" stroke-linecap="round"/>
            <!-- Fill arc -->
            <path d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="#4a7c59" stroke-width="12" stroke-linecap="round"
                  id="cpuGaugeArc" stroke-dasharray="157.08" stroke-dashoffset="157.08" style="transition: stroke-dashoffset 0.5s ease, stroke 0.5s ease"/>
          </svg>
          <div class="gauge-value" id="cpuGaugeValue" style="margin-top:-10px">--%</div>
          <div class="gauge-label">CPU</div>
          <div class="gauge-sub" id="cpuGaugeSub"></div>
        </div>
        <div class="chart-container" id="cpuChartContainer">
          <canvas id="cpuChart"></canvas>
          <div class="chart-tooltip" id="cpuChartTooltip"></div>
          <div class="chart-legend" id="cpuChartLegend" style="display:none">
            <span class="legend-item"><span class="legend-swatch" style="background:#4a7c59"></span>EFT</span>
            <span class="legend-item"><span class="legend-swatch" style="background:#c8aa6e"></span>Server</span>
          </div>
        </div>
      </div>
      <!-- RAM Row -->
      <div class="gauge-row">
        <div class="gauge-container">
          <svg class="gauge-svg" viewBox="0 0 120 70" id="ramGaugeSvg">
            <path d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="rgba(200,170,110,0.08)" stroke-width="12" stroke-linecap="round"/>
            <path d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="#4a7c59" stroke-width="12" stroke-linecap="round"
                  id="ramGaugeArc" stroke-dasharray="157.08" stroke-dashoffset="157.08" style="transition: stroke-dashoffset 0.5s ease, stroke 0.5s ease"/>
          </svg>
          <div class="gauge-value" id="ramGaugeValue" style="margin-top:-10px">--%</div>
          <div class="gauge-label">RAM</div>
          <div class="gauge-sub" id="ramGaugeSub"></div>
        </div>
        <div class="chart-container" id="ramChartContainer">
          <canvas id="ramChart"></canvas>
          <div class="chart-tooltip" id="ramChartTooltip"></div>
          <div class="chart-legend" id="ramChartLegend" style="display:none">
            <span class="legend-item"><span class="legend-swatch" style="background:#4a7c59"></span>EFT</span>
            <span class="legend-item"><span class="legend-swatch" style="background:#c8aa6e"></span>Server</span>
          </div>
        </div>
      </div>
      </details>
    </div>

    <!-- Alerts Section -->
    <div class="raidinfo-section" style="margin-bottom:12px" id="alertsSection">
      <div class="raidinfo-section-header">
        <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg> Alerts <span class="alert-count" id="alertBadge" style="display:none">0</span></span>
      </div>
      <div class="raidinfo-section-body alert-feed" id="alertFeed">
        <div class="telem-no-data">No alerts yet</div>
      </div>
    </div>

    <!-- Live Map -->
    <div class="live-map-panel" id="liveMapPanel" style="display:none">
      <div class="live-map-header">
        <span class="section-title">Live Map</span>
        <div class="live-map-controls">
          <label>Layer: <select id="mapLayerSelect"><option value="0">Ground</option></select></label>
          <label>
            Refresh:
            <input type="range" id="mapRefreshSlider" min="-1.301" max="1" step="0.01" value="0">
            <span class="rate-label" id="mapRefreshLabel">1.0s</span>
          </label>
          <label><input type="checkbox" id="mapShowNames" checked> Names</label>
          <label><input type="checkbox" id="mapShowDead"> Dead</label>
          <label><input type="checkbox" id="mapFollowPlayer" checked> Follow</label>
          <button class="btn-sm" onclick="openMapPopout()" title="Popout Map" style="padding:2px 8px;font-size:11px">&#x29C9; Popout</button>
        </div>
      </div>
      <div class="live-map-canvas-wrap" id="mapCanvasWrap">
        <canvas id="mapCanvas"></canvas>
        <div class="live-map-no-raid" id="mapNoRaid">Waiting for raid...</div>
      </div>
      <div class="live-map-legend">
        <span class="live-map-legend-item"><span class="live-map-legend-dot" style="background:#4a7c59"></span> PMC</span>
        <span class="live-map-legend-item"><span class="live-map-legend-dot" style="background:#c45050"></span> AI PMC</span>
        <span class="live-map-legend-item"><span class="live-map-legend-dot" style="background:#c8aa6e"></span> Scav</span>
        <span class="live-map-legend-item"><span class="live-map-legend-dot" style="background:#c87a3e"></span> Boss</span>
        <span class="live-map-legend-item"><span class="live-map-legend-dot" style="background:#b06030"></span> Raider/Rogue</span>
        <span class="live-map-legend-item"><span class="live-map-legend-dot" style="background:#6e4a7c"></span> Follower</span>
        <span class="live-map-legend-item"><span class="live-map-legend-dot" style="background:rgba(255,255,255,0.25)"></span> Dead</span>
      </div>
    </div>

    <!-- Two-Column Layout: Players+Bots | Kill Feed -->
    <div class="raidinfo-columns">

      <!-- Left Column: Players + Bots -->
      <div>
        <div class="raidinfo-section" style="margin-bottom:16px">
          <div class="raidinfo-section-header">
            <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Players</span>
          </div>
          <div class="raidinfo-section-body" id="telemPlayersSection">
            <div class="telem-no-data" id="telemPlayersEmpty">No players in raid</div>
            <table class="telem-player-table" id="telemPlayerTable" style="display:none">
              <thead><tr><th>Player</th><th>Lvl</th><th>Side</th><th>Kills</th><th>Status</th><th>Health</th><th>Ping</th></tr></thead>
              <tbody id="telemPlayerBody"></tbody>
            </table>
          </div>
        </div>

        <div class="raidinfo-section">
          <div class="raidinfo-section-header">
            <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg> AI / Bots</span>
          </div>
          <div class="raidinfo-section-body" id="telemBotsSection">
            <div class="telem-no-data" id="telemBotsEmpty">No bot data</div>
            <div class="telem-bots" id="telemBotsInner" style="display:none">
              <div class="telem-bot-group"><span class="telem-bot-label">AI PMCs</span><span class="telem-bot-value" id="telemPmcs">--</span></div>
              <div class="telem-bot-group"><span class="telem-bot-label">Scavs</span><span class="telem-bot-value" id="telemScavs">--</span></div>
              <div class="telem-bot-group"><span class="telem-bot-label">Raiders</span><span class="telem-bot-value" id="telemRaiders">--</span></div>
              <div class="telem-bot-group"><span class="telem-bot-label">Rogues</span><span class="telem-bot-value" id="telemRogues">--</span></div>
              <div class="telem-bot-group"><span class="telem-bot-label">Total AI</span><span class="telem-bot-value" id="telemTotalAI">--</span></div>
              <div class="telem-bot-group" id="telemBossGroup">
                <span class="telem-bot-label">Bosses</span>
                <div class="telem-boss-list" id="telemBossList"><span style="color:var(--text-dim);font-size:11px">None</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Kill Feed + Combat Stats -->
      <div>
        <div class="raidinfo-section" style="margin-bottom:16px">
          <div class="raidinfo-section-header">
            <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg> Kill Feed</span>
            <span id="telemKillCount" style="font-size:11px;font-family:var(--font-mono);color:var(--text-muted)"></span>
          </div>
          <div class="raidinfo-section-body" style="padding:8px 16px">
            <div class="telem-kill-feed" id="telemKillFeed">
              <div class="telem-no-data">No kills recorded yet</div>
            </div>
          </div>
        </div>

        <div class="raidinfo-section" id="telemCombatStatsSection" style="display:none">
          <div class="raidinfo-section-header">
            <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Combat Stats</span>
          </div>
          <div class="raidinfo-section-body" id="telemCombatStatsBody">
          </div>
        </div>
      </div>

    </div>

    <!-- Lifetime Stats -->
    <div class="lifetime-stats-panel" id="lifetimeStatsPanel" style="display:none">
      <div class="section-header" style="font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);font-family:var(--font-mono);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border-subtle)">Lifetime Stats</div>
      <div class="lifetime-stats-grid" id="lifetimeStatsGrid"></div>
    </div>

    <!-- Raid History (full-width) -->
    <div class="raidinfo-section">
      <div class="raidinfo-section-header">
        <span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg> Raid History</span>
        <span id="telemHistoryCount" style="font-size:11px;font-family:var(--font-mono);color:var(--text-muted)"></span>
      </div>
      <div style="max-height:500px;overflow-y:auto">
        <table class="telem-history-table" id="telemHistoryTable">
          <thead><tr><th>Map</th><th>Date</th><th>Duration</th><th>Players</th><th>Survived</th><th>Kills</th><th>Deaths</th><th>Bosses</th></tr></thead>
          <tbody id="telemHistoryBody">
            <tr><td colspan="8" class="telem-no-data">No raid history yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- ═══════ ITEMS TAB ═══════ -->
  <div class="main-tab-panel" id="main-items">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="items" onclick="switchTab('items')">Items</button>
      <button class="tab-btn" data-tab="presets" onclick="switchTab('presets')">Presets</button>
      <button class="tab-btn" data-tab="cart" onclick="switchTab('cart')">Cart <span class="badge" id="cartBadge" style="display:none">0</span></button>
    </div>

    <!-- Items Sub-Tab -->
    <div class="tab-panel active" id="tab-items">
      <div class="search-row">
        <div class="search-input-wrap">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="searchInput" placeholder="Search items by name or template ID...">
        </div>

        <!-- Custom Category Dropdown -->
        <div class="cat-dropdown" id="catDropdown">
          <div class="cat-trigger" id="catTrigger" onclick="toggleCatDropdown()">
            <span class="ct-icon" id="ctIcon"></span>
            <span class="ct-label" id="ctLabel">All Categories</span>
            <span class="ct-count" id="ctCount" style="display:none"></span>
            <span class="ct-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></span>
          </div>
          <div class="cat-panel" id="catPanel">
            <div class="cat-panel-search">
              <div class="search-wrap">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" id="catSearchInput" placeholder="Filter categories..." oninput="filterCategories(this.value)">
              </div>
            </div>
            <div class="cat-list" id="catList"></div>
          </div>
        </div>
      </div>

      <div class="results-info" id="resultsInfo"></div>

      <table class="item-table">
        <thead>
          <tr>
            <th style="width:30%" class="sortable" id="th-name" onclick="toggleSort('name')">Name <span class="sort-arrow">&#9650;</span></th>
            <th style="width:14%">Category</th>
            <th style="width:12%;text-align:right" class="sortable" id="th-price" onclick="toggleSort('price')">Price <span class="sort-arrow">&#9650;</span></th>
            <th style="width:10%;text-align:center" class="sortable" id="th-weight" onclick="toggleSort('weight')">Weight <span class="sort-arrow">&#9650;</span></th>
            <th style="width:8%;text-align:center">Stack</th>
            <th style="width:26%;text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="itemsBody">
          <tr class="loading-row"><td colspan="6">Search for items above</td></tr>
        </tbody>
      </table>

      <div class="pagination" id="pagination" style="display:none">
        <div class="pagination-info" id="paginationInfo"></div>
        <div class="pagination-btns">
          <button class="btn btn-sm" id="prevBtn" onclick="prevPage()">&#9664; Previous</button>
          <button class="btn btn-sm" id="nextBtn" onclick="nextPage()">Next &#9654;</button>
        </div>
      </div>
    </div>

    <!-- Presets Sub-Tab -->
    <div class="tab-panel" id="tab-presets">
      <div class="preset-grid" id="presetsGrid">
        <div style="color:var(--text-dim);padding:40px;text-align:center;font-family:var(--font-mono)">Loading presets...</div>
      </div>
    </div>

    <!-- Cart Sub-Tab -->
    <div class="tab-panel" id="tab-cart">
      <div id="cartContent"></div>
    </div>
  </div>

  <!-- ═══════ DASHBOARD ═══════ -->
  <div class="main-tab-panel active" id="main-dashboard">

    <!-- Top Stats Grid -->
    <div class="dash-grid">

      <!-- Server Status -->
      <div class="dash-widget" id="widgetServerStatus">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg> Server Status</span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Uptime</span><span class="dash-stat-value" id="dashUptime">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">SPT Version</span><span class="dash-stat-value sm" id="dashSptVer">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">CC Version</span><span class="dash-stat-value sm" id="dashCcVer">--</span></div>
          </div>
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Working Set</span><span class="dash-stat-value sm" id="dashMemory">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">GC Heap</span><span class="dash-stat-value sm" id="dashGcMemory">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Threads</span><span class="dash-stat-value sm" id="dashThreads">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Mods Loaded</span><span class="dash-stat-value sm" id="dashModCount">--</span></div>
          </div>
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">FIKA Server</span><span class="dash-stat-value sm" id="dashFikaServerVer">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">FIKA Client</span><span class="dash-stat-value sm" id="dashFikaClientVer">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Telemetry</span><span class="dash-stat-value sm" id="dashTelemetryVer">--</span></div>
          </div>
          <details style="margin-top:8px">
            <summary style="cursor:pointer;font-size:11px;color:var(--text-dim);font-family:var(--font-mono);letter-spacing:1px;text-transform:uppercase"><span id="dashModSummary">Mod List</span></summary>
            <div id="dashModList" style="max-height:180px;overflow-y:auto;margin-top:8px;font-size:12px"></div>
          </details>
        </div>
      </div>

      <!-- Online Players -->
      <div class="dash-widget" id="widgetPlayers">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Players</span>
          <span style="display:flex;align-items:center;gap:12px"><span id="dashHeadlessBadge" style="font-size:12px;font-family:var(--font-mono);font-weight:700;color:var(--text-muted);display:none"></span><span id="dashOnlineBadge" style="font-size:11px;font-family:var(--font-mono);color:var(--success-bright)"></span></span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Profiles</span><span class="dash-stat-value" id="dashTotalProfiles">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Online</span><span class="dash-stat-value" id="dashOnlineCount" style="color:var(--success-bright)">--</span></div>
          </div>
          <div class="dash-player-list" id="dashPlayerList"></div>
        </div>
      </div>

      <!-- Raid Stats (Server-wide) -->
      <div class="dash-widget" id="widgetRaids">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Raid Statistics</span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Raids</span><span class="dash-stat-value" id="dashTotalRaids">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Survival Rate</span><span class="dash-stat-value" id="dashSurvivalRate">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">K/D Ratio</span><span class="dash-stat-value" id="dashKD">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Headshots</span><span class="dash-stat-value" id="dashHeadshots">0</span></div>
          </div>
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Kills</span><span class="dash-stat-value" id="dashTotalKills">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">PMC Kills</span><span class="dash-stat-value" id="dashPmcKills">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Scav Kills</span><span class="dash-stat-value" id="dashScavKills">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Boss Kills</span><span class="dash-stat-value" id="dashBossKills">0</span></div>
          </div>
        </div>
      </div>

      <!-- Your Raid Stats (Logged-in player) -->
      <div class="dash-widget" id="widgetMyRaids" style="display:none">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Your Raid Statistics</span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Raids</span><span class="dash-stat-value" id="myTotalRaids">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Survival Rate</span><span class="dash-stat-value" id="mySurvivalRate">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">K/D Ratio</span><span class="dash-stat-value" id="myKD">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Headshots</span><span class="dash-stat-value" id="myHeadshots">0</span></div>
          </div>
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Kills</span><span class="dash-stat-value" id="myTotalKills">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">PMC Kills</span><span class="dash-stat-value" id="myPmcKills">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Scav Kills</span><span class="dash-stat-value" id="myScavKills">0</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Boss Kills</span><span class="dash-stat-value" id="myBossKills">0</span></div>
          </div>
        </div>
      </div>

      <!-- Economy -->
      <div class="dash-widget" id="widgetEconomy">
        <div class="dash-widget-header">
          <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg> Economy</span>
        </div>
        <div class="dash-widget-body">
          <div class="dash-stat-row">
            <div class="dash-stat"><span class="dash-stat-label">Total Roubles</span><span class="dash-stat-value" id="dashTotalRoubles">--</span></div>
            <div class="dash-stat"><span class="dash-stat-label">Average Wealth</span><span class="dash-stat-value sm" id="dashAvgWealth">--</span></div>
          </div>
          <div id="dashTopPlayers" style="margin-top:8px"></div>
        </div>
      </div>

    </div>

    <!-- Quick Actions -->
    <div class="dash-actions">
      <button class="btn btn-accent btn-sm" onclick="openBroadcastModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Send Broadcast</button>
      <button class="btn btn-sm" onclick="sendUrlsToPlayers()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Send URLs to Players</button>
      <button class="btn btn-sm" onclick="refreshDashboard()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> Refresh Data</button>
      <button class="btn btn-sm" onclick="openLogPopout()" title="Open logs in popout window"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg> Popout Logs</button>
      <span style="margin-left:auto;font-size:10px;font-family:var(--font-mono);color:var(--text-muted)">Server Local Time: <span id="dashLiveClock"></span></span>
    </div>

    <!-- Activity Log -->
    <div class="dash-widget full-width" style="margin-bottom:16px">
      <div class="dash-widget-header">
        <span class="dash-widget-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Activity Log</span>
        <select id="activityTypeFilter" style="font-size:11px;font-family:var(--font-mono);background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);padding:3px 8px" onchange="loadActivity()">
          <option value="">All Types</option>
          <option value="ItemGive">Item Give</option>
          <option value="PresetGive">Preset Give</option>
          <option value="Broadcast">Broadcast</option>
          <option value="ServerStart">Server Start</option>
        </select>
      </div>
      <div class="dash-widget-body" style="padding:0">
        <div id="dashActivity" style="max-height:300px;overflow-y:auto">
          <table class="activity-table">
            <thead><tr><th>Time</th><th>Type</th><th>Admin</th><th>Details</th></tr></thead>
            <tbody id="activityBody"><tr><td colspan="4" style="text-align:center;padding:24px;color:var(--text-muted)">Loading...</td></tr></tbody>
          </table>
        </div>
        <div id="activityPagination" style="display:none;padding:8px 16px;border-top:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;font-size:11px;font-family:var(--font-mono);color:var(--text-dim)">
          <span id="activityPageInfo"></span>
          <div style="display:flex;gap:6px">
            <button class="btn btn-xs" id="activityPrevBtn" onclick="activityPrev()">Prev</button>
            <button class="btn btn-xs" id="activityNextBtn" onclick="activityNext()">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Server Console -->
    <div class="console-panel" id="consolePanel">
      <div class="console-header" onclick="toggleConsole()">
        <span class="console-header-left"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg> Server Console <span id="consoleCount" style="color:var(--text-muted)"></span></span>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="console-filters" onclick="event.stopPropagation()">
            <button class="console-filter-btn active" data-level="info" onclick="toggleConsoleFilter(this)">Info</button>
            <button class="console-filter-btn active" data-level="warning" onclick="toggleConsoleFilter(this)">Warn</button>
            <button class="console-filter-btn active" data-level="error" onclick="toggleConsoleFilter(this)">Error</button>
            <button class="console-filter-btn" data-level="debug" onclick="toggleConsoleFilter(this)">Debug</button>
          </div>
          <span id="consoleToggleIcon" style="color:var(--text-muted);font-size:12px">&#x25BC;</span>
        </div>
      </div>
      <div class="console-search" id="consoleSearchWrap">
        <input type="text" id="consoleSearchInput" placeholder="Search console..." oninput="filterConsole()">
      </div>
      <div class="console-body" id="consoleBody"></div>
      <div class="console-jump" id="consoleJump"><button onclick="scrollConsoleBottom()">Jump to bottom</button></div>
    </div>

    <!-- Headless Process Manager -->
    <div class="card" id="headlessManagerCard" style="margin-top:16px;display:none">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
        <span style="display:flex;align-items:center;gap:10px">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;color:var(--accent-dim)"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span style="font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim)">Headless Client</span>
        </span>
        <span id="headlessStatusBadge" class="hl-status-pill"></span>
      </div>
      <div id="headlessManagerBody" style="padding:16px">
        <div id="headlessUnavailable" style="display:none;text-align:center;color:var(--text-muted);padding:12px">
          EscapeFromTarkov.exe not found — headless management unavailable
        </div>
        <div id="headlessControls" style="display:none">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:14px;flex-wrap:wrap">
            <div id="headlessUptimeInfo" style="font-size:12px;font-family:var(--font-mono);color:var(--text-dim)"></div>
            <div style="display:flex;gap:6px;margin-left:auto">
              <button class="btn btn-sm" id="btnHeadlessStart" onclick="startHeadless()">Start</button>
              <button class="btn btn-sm" id="btnHeadlessStop" onclick="stopHeadless()" disabled>Stop</button>
              <button class="btn btn-sm" id="btnHeadlessRestart" onclick="restartHeadless()" disabled>Restart</button>
            </div>
          </div>
          <div id="headlessCrashInfo" style="display:none;font-size:11px;color:var(--error-bright);margin-bottom:10px;font-family:var(--font-mono)"></div>
          <div style="border-top:1px solid var(--border-subtle);padding-top:12px;margin-top:4px">
            <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:10px">Settings</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 20px;font-size:12px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="hlAutoStart" onchange="saveHeadlessConfig()"> Auto-start with server
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="hlAutoRestart" onchange="saveHeadlessConfig()"> Auto-restart on crash
              </label>
              <div style="display:flex;align-items:center;gap:8px">
                <span style="color:var(--text-dim);white-space:nowrap">Auto-start delay:</span>
                <input type="range" id="hlDelay" min="1" max="300" value="30" oninput="document.getElementById('hlDelayVal').textContent=this.value+'s'" onchange="saveHeadlessConfig()" style="flex:1;accent-color:var(--accent)">
                <span id="hlDelayVal" style="font-family:var(--font-mono);color:var(--text-dim);min-width:35px">30s</span>
              </div>
              <div style="display:flex;flex-direction:column;gap:4px">
                <div id="hlProfileDisplay" style="display:none;font-size:12px">
                  <span id="hlProfileName" style="color:var(--text-bright);font-weight:600"></span>
                  <span id="hlProfileIdSmall" style="color:var(--text-muted);font-size:10px;font-family:var(--font-mono);margin-left:6px"></span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="color:var(--text-dim);white-space:nowrap">Profile ID:</span>
                  <input type="text" id="hlProfileId" placeholder="Enter profile ID" style="flex:1;padding:3px 8px;font-size:11px;font-family:var(--font-mono);background:var(--bg-input);border:1px solid var(--border-subtle);border-radius:var(--radius);color:var(--text)">
                  <button class="btn btn-sm" onclick="saveHeadlessConfig()" style="padding:3px 10px">Save</button>
                </div>
              </div>
            </div>
            <div id="hlProfileWarning" style="display:none;font-size:11px;color:var(--warning);margin-top:8px">Profile ID required — enter the session ID of the headless profile to enable start.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Headless Client Console -->
    <div class="console-panel" id="headlessPanel" style="margin-top:16px">
      <div class="console-header" onclick="toggleHeadless()">
        <span class="console-header-left"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg> Headless Client <span id="headlessCount" style="color:var(--text-muted)"></span></span>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="console-filters" onclick="event.stopPropagation()">
            <button class="console-filter-btn active" data-level="info" onclick="toggleHeadlessFilter(this)">Info</button>
            <button class="console-filter-btn active" data-level="warning" onclick="toggleHeadlessFilter(this)">Warn</button>
            <button class="console-filter-btn active" data-level="error" onclick="toggleHeadlessFilter(this)">Error</button>
            <button class="console-filter-btn" data-level="debug" onclick="toggleHeadlessFilter(this)">Debug</button>
          </div>
          <span id="headlessToggleIcon" style="color:var(--text-muted);font-size:12px">&#x25BC;</span>
        </div>
      </div>
      <div class="console-search" id="headlessSearchWrap">
        <input type="text" id="headlessSearchInput" placeholder="Search headless..." oninput="filterHeadless()">
      </div>
      <div class="console-body" id="headlessBody"></div>
      <div class="console-jump" id="headlessJump"><button onclick="scrollHeadlessBottom()">Jump to bottom</button></div>
    </div>

  </div>

  <!-- Broadcast Modal -->
  <div class="modal-overlay" id="broadcastModal">
    <div class="modal-box">
      <h3>Send Broadcast</h3>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px">Send a system message to all registered profiles.</p>
      <textarea id="broadcastMessage" placeholder="Enter your broadcast message..."></textarea>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeBroadcastModal()">Cancel</button>
        <button class="btn btn-accent" onclick="sendBroadcast()">Send</button>
      </div>
    </div>
  </div>

  <div class="main-tab-panel" id="main-players">
    <!-- Player Roster -->
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3 style="font-family:var(--font-mono);font-size:14px;text-transform:uppercase;color:var(--text-dim);letter-spacing:0.5px">Player Roster</h3>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm" onclick="openBroadcastMailModal()">Broadcast Mail</button>
          <button class="btn btn-ghost btn-sm" onclick="openGiveAllModal()">Give to All</button>
          <button class="btn btn-ghost btn-sm" onclick="loadPlayerRoster()">Refresh</button>
        </div>
      </div>
      <div class="player-search-row">
        <input type="text" id="playerSearchInput" placeholder="Search by nickname..." oninput="debouncePlayerSearch()">
        <select id="playerFactionFilter" onchange="loadPlayerRoster()">
          <option value="">All Factions</option>
          <option value="Bear">BEAR</option>
          <option value="Usec">USEC</option>
        </select>
      </div>
      <div id="playerRosterBody">
        <div style="color:var(--text-dim);text-align:center;padding:40px 0">Loading players...</div>
      </div>
      <div class="pagination" id="playerPagination" style="display:none">
        <span class="pagination-info" id="playerPaginationInfo"></span>
        <div class="pagination-btns">
          <button class="btn btn-ghost btn-sm" onclick="playerPagePrev()">Prev</button>
          <button class="btn btn-ghost btn-sm" onclick="playerPageNext()">Next</button>
        </div>
      </div>
    </div>

    <!-- Ban List Section -->
    <div class="card ban-section">
      <div class="ban-section-header" id="banSectionHeader" onclick="toggleBanSection()">
        <span class="toggle-arrow">&#9660;</span> Ban List <span id="banCount" style="color:var(--text-muted);font-size:11px">(0)</span>
      </div>
      <div class="ban-section-body" id="banSectionBody">
        <div id="banListBody">
          <div style="color:var(--text-dim);text-align:center;padding:20px 0;font-size:13px">No banned players</div>
        </div>
      </div>
    </div>

    <!-- Player Mail Modal -->
    <div class="modal-overlay" id="playerMailModal">
      <div class="modal-box" style="max-width:500px">
        <h3>Send Mail</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">To: <strong id="mailRecipientName"></strong></p>
        <div style="margin-bottom:10px">
          <label style="font-size:12px;color:var(--text-dim);margin-bottom:4px;display:block">Template</label>
          <select id="mailTemplate" onchange="applyMailTemplate()" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:6px 10px;font-size:13px;border-radius:var(--radius)">
            <option value="">Custom Message</option>
            <option value="welcome">Welcome</option>
            <option value="rules">Server Rules</option>
            <option value="event">Event Announcement</option>
          </select>
        </div>
        <textarea id="mailMessage" placeholder="Enter your message..."></textarea>
        <div style="margin:10px 0 6px"><span style="font-size:12px;color:var(--text-dim);font-family:var(--font-mono);text-transform:uppercase">Attach Items</span></div>
        <div id="mailItemRows"></div>
        <button class="btn btn-ghost btn-sm" onclick="addMailItemRow()" style="margin-bottom:10px;font-size:11px">+ Add Item</button>
        <div class="form-row">
          <div><label>Roubles</label><input type="number" id="mailRoubles" min="0" value="0"></div>
          <div><label>Dollars</label><input type="number" id="mailDollars" min="0" value="0"></div>
          <div><label>Euros</label><input type="number" id="mailEuros" min="0" value="0"></div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerMailModal')">Cancel</button>
          <button class="btn btn-accent" onclick="sendPlayerMail()">Send</button>
        </div>
      </div>
    </div>

    <!-- Player Modify Modal -->
    <div class="modal-overlay" id="playerModifyModal">
      <div class="modal-box" style="max-width:480px">
        <h3>Modify Player</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Player: <strong id="modifyTargetName"></strong></p>
        <div class="form-row">
          <div><label>Level (1-79)</label><input type="number" id="modifyLevel" min="1" max="79" placeholder="Leave empty to skip"></div>
          <div><label>Faction</label><select id="modifyFaction" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:8px 10px;font-size:13px;border-radius:var(--radius)"><option value="">No change</option><option value="Bear">BEAR</option><option value="Usec">USEC</option></select></div>
        </div>
        <div class="form-row">
          <div><label>Add Roubles</label><input type="number" id="modifyRoubles" min="0" value="0"></div>
          <div><label>Add Dollars</label><input type="number" id="modifyDollars" min="0" value="0"></div>
          <div><label>Add Euros</label><input type="number" id="modifyEuros" min="0" value="0"></div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerModifyModal')">Cancel</button>
          <button class="btn btn-accent" onclick="submitModify()">Apply</button>
        </div>
      </div>
    </div>

    <!-- Player Reset Modal -->
    <div class="modal-overlay" id="playerResetModal">
      <div class="modal-box" style="max-width:420px">
        <h3 style="color:var(--error-bright)">Reset Player</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Player: <strong id="resetTargetName"></strong></p>
        <div style="margin-bottom:12px">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetSkills"> Skills</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetQuests"> Quests</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetTraders"> Traders</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer"><input type="checkbox" id="resetHideout"> Hideout</label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:6px;cursor:pointer;color:var(--error-bright)"><input type="checkbox" id="resetFull" onchange="toggleFullReset()"> Full Reset (all above)</label>
        </div>
        <div style="font-size:12px;color:var(--error-bright);margin-bottom:6px">Type RESET to confirm:</div>
        <input type="text" class="confirmation-input" id="resetConfirmInput" placeholder="Type RESET" oninput="checkResetConfirm()">
        <div class="modal-actions" style="margin-top:12px">
          <button class="btn btn-ghost" onclick="closeModal('playerResetModal')">Cancel</button>
          <button class="danger-btn" id="resetConfirmBtn" disabled onclick="submitReset()">Reset</button>
        </div>
      </div>
    </div>

    <!-- Player Ban Modal -->
    <div class="modal-overlay" id="playerBanModal">
      <div class="modal-box" style="max-width:420px">
        <h3 style="color:var(--error-bright)">Ban Player</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Player: <strong id="banTargetName"></strong></p>
        <textarea id="banReason" placeholder="Reason for ban..."></textarea>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerBanModal')">Cancel</button>
          <button class="danger-btn" onclick="confirmBan()">Ban</button>
        </div>
      </div>
    </div>

    <!-- Give Items Modal -->
    <div class="modal-overlay" id="playerGiveModal">
      <div class="modal-box" style="max-width:480px">
        <h3 id="giveModalTitle">Give Items</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px" id="giveModalSub"></p>
        <div id="giveItemRows"></div>
        <button class="btn btn-ghost btn-sm" onclick="addGiveItemRow()" style="margin-bottom:10px;font-size:11px">+ Add Item</button>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('playerGiveModal')">Cancel</button>
          <button class="btn btn-accent" id="giveSubmitBtn" onclick="submitGive()">Send</button>
        </div>
      </div>
    </div>

    <!-- Broadcast Mail Modal -->
    <div class="modal-overlay" id="broadcastMailModal">
      <div class="modal-box" style="max-width:500px">
        <h3>Broadcast Mail</h3>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px">Send a message with optional items to all players.</p>
        <textarea id="broadcastMailMessage" placeholder="Enter your broadcast message..."></textarea>
        <div style="margin:10px 0 6px"><span style="font-size:12px;color:var(--text-dim);font-family:var(--font-mono);text-transform:uppercase">Attach Items</span></div>
        <div id="broadcastItemRows"></div>
        <button class="btn btn-ghost btn-sm" onclick="addBroadcastItemRow()" style="margin-bottom:10px;font-size:11px">+ Add Item</button>
        <div class="form-row">
          <div><label>Roubles</label><input type="number" id="broadcastRoubles" min="0" value="0"></div>
          <div><label>Dollars</label><input type="number" id="broadcastDollars" min="0" value="0"></div>
          <div><label>Euros</label><input type="number" id="broadcastEuros" min="0" value="0"></div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('broadcastMailModal')">Cancel</button>
          <button class="btn btn-accent" onclick="sendBroadcastMail()">Broadcast</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-tab-panel" id="main-flea">
    <!-- Warning banner -->
    <div style="background:rgba(200,122,62,0.1);border:1px solid rgba(200,122,62,0.3);border-radius:6px;padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--warning)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Changes apply to <strong>all players</strong> on the server. Click "Apply &amp; Regenerate" to activate.
    </div>

    <!-- Modifier Info Panel -->
    <div id="fleaInfoPanel" style="display:none;background:rgba(100,160,220,0.08);border:1px solid rgba(100,160,220,0.25);border-radius:6px;padding:14px 18px;margin-bottom:16px;font-size:12.5px;color:var(--text);line-height:1.7">
      <div style="font-weight:600;color:#7ab3e0;margin-bottom:8px;font-size:13px">How Modifiers Work</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Global Multiplier</span> &mdash; Base multiplier applied to <em>all</em> flea market buy prices.</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Category Multiplier</span> &mdash; Stacks multiplicatively with Global. E.g. 2&times; Global &times; 3&times; Category = <strong>6&times;</strong> final price. Leave at 1.0&times; for no additional change.</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Per-Item Override</span> &mdash; Replaces all other modifiers. The item uses <em>only</em> the override value.</div>
      <div style="margin-bottom:6px"><span style="color:var(--accent);font-weight:600">Tax Multiplier</span> &mdash; Scales flea market listing tax. 0 = free listings, 1 = normal, 2 = double tax. <span style="color:#7ab3e0;font-weight:600">Players must restart their game client</span> for tax changes to take effect.</div>
      <div style="border-top:1px solid rgba(100,160,220,0.15);padding-top:8px;margin-top:8px;color:var(--text-dim)">
        <strong>Price Formula:</strong> Final Price = Base Price &times; Global &times; Category<br>
        <strong>Exception:</strong> Items with a Per-Item Override use only that value<br>
        <strong>Economy Tip:</strong> Use tax multiplier to balance player income &mdash; higher tax discourages flea selling, lower tax encourages it
      </div>
    </div>
    <div style="margin-bottom:14px">
      <button onclick="document.getElementById('fleaInfoPanel').style.display=document.getElementById('fleaInfoPanel').style.display==='none'?'block':'none'" style="background:none;border:1px solid rgba(100,160,220,0.3);border-radius:4px;padding:4px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;color:#7ab3e0;font-size:12px;font-family:var(--font-mono)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        How Modifiers Work
      </button>
    </div>

    <!-- PRESETS -->
    <div class="cc-panel" style="border-left:3px solid #7ab3e0;padding:14px 20px;background:var(--bg-panel);border-radius:6px;margin-bottom:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="font-size:14px;font-weight:600;color:#7ab3e0;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Presets</div>
        <div style="display:flex;gap:6px">
          <button onclick="fleaExportPreset()" style="padding:4px 10px;background:var(--bg-dark);color:var(--text-dim);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:11px" title="Copy current config to clipboard">Export</button>
          <button onclick="fleaShowImport()" style="padding:4px 10px;background:var(--bg-dark);color:var(--text-dim);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:11px" title="Import preset from JSON">Import</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="fleaPresetSelect" style="flex:1;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-family:var(--font-mono);font-size:12px">
          <option value="">— Select a preset —</option>
        </select>
        <button onclick="fleaLoadPreset()" style="padding:6px 12px;background:var(--bg-dark);color:#7ab3e0;border:1px solid rgba(100,160,220,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Load</button>
        <button onclick="fleaDeletePreset()" style="padding:6px 12px;background:var(--bg-dark);color:var(--error-bright);border:1px solid rgba(139,58,58,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Delete</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <input type="text" id="fleaPresetName" placeholder="Preset name..." style="flex:1;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-family:var(--font-mono);font-size:12px">
        <button onclick="fleaSavePreset()" style="padding:6px 12px;background:rgba(100,160,220,0.15);color:#7ab3e0;border:1px solid rgba(100,160,220,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px;font-weight:600">Save Current</button>
      </div>
      <!-- Import text area (hidden by default) -->
      <div id="fleaImportArea" style="display:none;margin-top:10px">
        <textarea id="fleaImportJson" style="width:100%;height:100px;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;font-family:var(--font-mono);font-size:11px;resize:vertical" placeholder="Paste preset JSON here..."></textarea>
        <div style="display:flex;gap:8px;margin-top:6px;justify-content:flex-end">
          <button onclick="document.getElementById('fleaImportArea').style.display='none'" style="padding:4px 10px;background:var(--bg-dark);color:var(--text-dim);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:11px">Cancel</button>
          <button onclick="fleaImportPreset()" style="padding:4px 10px;background:rgba(100,160,220,0.15);color:#7ab3e0;border:1px solid rgba(100,160,220,0.3);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Import &amp; Load</button>
        </div>
      </div>
    </div>

    <!-- A) GLOBAL CONTROLS -->
    <div class="cc-panel" style="border-left:3px solid var(--accent);padding:16px 20px;background:var(--bg-panel);border-radius:6px;margin-bottom:14px">
      <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:14px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Global Price Controls</div>
      <div style="margin-bottom:16px">
        <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Global Price Multiplier</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input type="range" id="fleaGlobalBuy" min="0.1" max="10" step="0.1" value="1.0" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaGlobalBuy','fleaGlobalBuyVal')">
          <input type="number" id="fleaGlobalBuyVal" min="0.1" max="10" step="0.1" value="1.0" class="cc-num-input" oninput="fleaNumChanged('fleaGlobalBuyVal','fleaGlobalBuy')">
          <span style="font-size:12px;color:var(--text-dim)">&times;</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Price Variance</label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="range" id="fleaVariance" min="0" max="1" step="0.01" value="0" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaVariance','fleaVarianceVal',true)">
            <input type="number" id="fleaVarianceVal" min="0" max="100" step="1" value="0" class="cc-num-input" oninput="fleaVarianceNumChanged()">
            <span style="font-size:12px;color:var(--text-dim)">%</span>
          </div>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Min Price (&#8381;)</label>
          <input type="number" id="fleaMinPrice" min="1" max="50000000" step="1" value="1" class="cc-num-input cc-wide-input" oninput="fleaMarkDirty()">
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Max Price (&#8381;)</label>
          <input type="number" id="fleaMaxPrice" min="1" max="50000000" step="1" value="50000000" class="cc-num-input cc-wide-input" oninput="fleaMarkDirty()">
        </div>
      </div>
    </div>

    <!-- Tax restart notice (hidden by default, shown after Apply if tax changed) -->
    <div id="fleaTaxRestartNotice" style="display:none;background:rgba(100,160,220,0.08);border:1px solid rgba(100,160,220,0.25);border-radius:6px;padding:12px 16px;margin-bottom:14px;align-items:center;gap:10px;font-size:13px;color:#7ab3e0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      <div><strong>Client restart required.</strong> Tax changes have been applied to the server. All players must restart their game client for the new tax rates to take effect.</div>
      <button onclick="this.parentElement.style.display='none'" style="background:none;border:none;color:#7ab3e0;cursor:pointer;font-size:16px;padding:0 4px;flex-shrink:0">&times;</button>
    </div>

    <!-- B) MARKET SETTINGS -->
    <div class="cc-panel" style="border-left:3px solid var(--accent);padding:16px 20px;background:var(--bg-panel);border-radius:6px;margin-bottom:14px">
      <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:14px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Market Settings</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:flex;align-items:center;gap:6px;margin-bottom:6px">Flea Tax Multiplier
            <span style="background:rgba(100,160,220,0.15);color:#7ab3e0;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;text-transform:uppercase;letter-spacing:0.5px">Restart Required</span>
          </label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="range" id="fleaTax" min="0" max="5" step="0.1" value="1.0" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaTax','fleaTaxVal')">
            <input type="number" id="fleaTaxVal" min="0" max="5" step="0.1" value="1.0" class="cc-num-input" oninput="fleaNumChanged('fleaTaxVal','fleaTax')">
            <span style="font-size:12px;color:var(--text-dim)">&times;</span>
          </div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:4px">0 = free listings &middot; 1 = normal &middot; 2 = double tax</div>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Max Player Listings</label>
          <input type="number" id="fleaMaxOffers" min="1" max="100" step="1" value="2" class="cc-num-input cc-wide-input" oninput="fleaMarkDirty()">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px">
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Offer Duration (hours)</label>
          <input type="number" id="fleaDuration" min="1" max="168" step="1" value="24" class="cc-num-input cc-wide-input" oninput="fleaMarkDirty()">
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Restock Interval (minutes)</label>
          <input type="number" id="fleaRestock" min="1" max="360" step="1" value="60" class="cc-num-input cc-wide-input" oninput="fleaMarkDirty()">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center">
        <div style="display:flex;align-items:center;gap:10px">
          <label style="font-size:12px;color:var(--text-dim)">Barter Offers</label>
          <label class="cc-toggle"><input type="checkbox" id="fleaBarterEnabled" checked onchange="fleaBarterToggled()"><span class="cc-toggle-slider"></span></label>
        </div>
        <div>
          <label style="font-size:12px;color:var(--text-dim);display:block;margin-bottom:6px">Barter Frequency</label>
          <div style="display:flex;align-items:center;gap:10px">
            <input type="range" id="fleaBarterFreq" min="0" max="100" step="1" value="15" style="flex:1;accent-color:var(--accent)" oninput="fleaSliderChanged('fleaBarterFreq','fleaBarterFreqVal')">
            <input type="number" id="fleaBarterFreqVal" min="0" max="100" step="1" value="15" class="cc-num-input" oninput="fleaNumChanged('fleaBarterFreqVal','fleaBarterFreq')">
            <span style="font-size:12px;color:var(--text-dim)">%</span>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:24px;margin-top:12px">
        <div style="display:flex;align-items:center;gap:10px">
          <label style="font-size:12px;color:var(--text-dim)">Dollar Offers</label>
          <label class="cc-toggle"><input type="checkbox" id="fleaDollarEnabled" checked onchange="fleaMarkDirty()"><span class="cc-toggle-slider"></span></label>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <label style="font-size:12px;color:var(--text-dim)">Euro Offers</label>
          <label class="cc-toggle"><input type="checkbox" id="fleaEuroEnabled" checked onchange="fleaMarkDirty()"><span class="cc-toggle-slider"></span></label>
        </div>
      </div>
    </div>

    <!-- D) CATEGORY CONTROLS -->
    <div style="margin-top:14px">
      <div style="font-size:14px;font-weight:600;color:var(--accent);margin-bottom:12px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Category Multipliers</div>
      <div id="fleaCategoryGrid" class="flea-cat-grid">
        <div style="color:var(--text-dim);font-size:13px;padding:20px;text-align:center">Loading categories...</div>
      </div>
    </div>

    <!-- E) PER-ITEM OVERRIDES -->
    <div style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:10px" onclick="fleaToggleOverrides()">
        <span id="fleaOverrideArrow" style="font-size:12px;color:var(--text-dim);transition:transform 0.2s">&#9654;</span>
        <span style="font-size:14px;font-weight:600;color:var(--accent);font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Per-Item Overrides</span>
        <span id="fleaOverrideCount" style="font-size:11px;color:var(--text-dim);background:var(--bg-dark);padding:2px 8px;border-radius:10px">0</span>
      </div>
      <div id="fleaOverridePanel" style="display:none">
        <div style="display:flex;gap:10px;margin-bottom:10px;position:relative">
          <input type="text" id="fleaItemSearch" class="search-input" placeholder="Search items by name..." style="flex:1" oninput="fleaItemSearchDebounce()">
        </div>
        <div id="fleaItemSearchResults" class="flea-search-results" style="display:none"></div>
        <div id="fleaOverrideTable"></div>
      </div>
    </div>

    <!-- C) APPLY BUTTON -->
    <button id="fleaApplyBtn" class="cc-apply-btn" onclick="fleaApplyAndRegenerate()" disabled style="margin-top:14px">
      <span id="fleaApplyText">Apply &amp; Regenerate Offers</span>
      <span id="fleaApplySpinner" class="cc-spinner" style="display:none"></span>
    </button>

    <!-- F) STATUS BAR -->
    <div class="cc-status-bar">
      <span id="fleaStatusRegen">Last regenerated: Never</span>
      <span id="fleaStatusOffers">Active offers: —</span>
      <span style="color:var(--text-dim)">v2.3.0</span>
    </div>

    <!-- G) DEBUG PANEL -->
    <div style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:10px" onclick="fleaToggleDebug()">
        <span id="fleaDebugArrow" style="font-size:12px;color:var(--text-dim);transition:transform 0.2s">&#9654;</span>
        <span style="font-size:14px;font-weight:600;color:var(--text-dim);font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">Debug</span>
      </div>
      <div id="fleaDebugPanel" style="display:none">
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <button onclick="fleaRunDiagnostic()" style="padding:6px 16px;background:var(--bg-dark);color:var(--accent);border:1px solid var(--accent);border-radius:4px;cursor:pointer;font-family:var(--font-mono);font-size:12px">Run Diagnostic</button>
        </div>
        <div id="fleaDiagResult" style="margin-bottom:12px"></div>
        <div style="font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:6px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px">API Log</div>
        <div id="fleaApiLogPanel" style="max-height:300px;overflow-y:auto;background:var(--bg-dark);border-radius:4px;padding:8px;font-family:var(--font-mono);font-size:11px"></div>
      </div>
    </div>
  </div>

  <div class="main-tab-panel" id="main-traders">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg></div>
      <h2>Trader Control</h2>
      <p>Adjust trader prices, restock timers, loyalty levels, and currency settings.</p>
      <span class="phase-badge">Phase 4</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-quests">
    <!-- Quest Browser Controls -->
    <div style="display:flex;gap:10px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
      <input type="text" id="questSearchInput" class="search-input" placeholder="Search quests..." style="flex:1;min-width:200px;max-width:360px" oninput="debounceQuestSearch()">
      <span style="font-size:12px;color:var(--text-dim);font-family:var(--font-mono)" id="questCountLabel">0 quests</span>
    </div>
    <!-- Map Filter Chips -->
    <div class="qb-map-chips" id="questMapChips"></div>
    <!-- Quest Table -->
    <div class="table-wrap">
      <table class="data-table" id="questBrowserTable">
        <thead>
          <tr>
            <th class="qb-sortable" data-sort="name" onclick="setQuestSort('name')">Quest Name <span class="qb-sort-arrow" id="qbArrow_name"></span></th>
            <th class="qb-sortable" data-sort="trader" onclick="setQuestSort('trader')">Trader <span class="qb-sort-arrow" id="qbArrow_trader"></span></th>
            <th class="qb-sortable" data-sort="map" onclick="setQuestSort('map')">Map <span class="qb-sort-arrow" id="qbArrow_map"></span></th>
            <th class="qb-sortable" data-sort="level" onclick="setQuestSort('level')">Level <span class="qb-sort-arrow" id="qbArrow_level"></span></th>
            <th class="qb-sortable" data-sort="objectives" onclick="setQuestSort('objectives')">Obj. <span class="qb-sort-arrow" id="qbArrow_objectives"></span></th>
            <th style="width:30px"></th>
          </tr>
        </thead>
        <tbody id="questBrowserBody">
          <tr><td colspan="6" style="text-align:center;color:var(--text-dim);padding:30px">Loading quests...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="main-tab-panel" id="main-progression">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
      <h2>Progression & Skills</h2>
      <p>XP multipliers, skill leveling rates, fatigue settings, and hideout timers.</p>
      <span class="phase-badge">Phase 6</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-backups">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
      <h2>Backup & Restore</h2>
      <p>Create backups, restore configurations, and manage save snapshots.</p>
      <span class="phase-badge">Phase 7</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-events">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
      <h2>Scheduler & Events</h2>
      <p>Schedule automated events, timed actions, and recurring server tasks.</p>
      <span class="phase-badge">Phase 8</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-gamevalues">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
      <h2>Game Values</h2>
      <p>Edit ammo stats, armor values, weapon properties, bot spawns, and raid settings.</p>
      <span class="phase-badge">Phase 9</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-profiles">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 22h14a2 2 0 002-2V7.5L14.5 2H6a2 2 0 00-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M3 15h6"/><path d="M6 12v6"/></svg></div>
      <h2>Config Profiles</h2>
      <p>Save, load, and share configuration profiles. Export and import settings.</p>
      <span class="phase-badge">Phase 10</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-loadouts">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg></div>
      <h2>Gear Presets & Loadouts</h2>
      <p>Build and manage full gear loadouts. One-click equip for raid preparation.</p>
      <span class="phase-badge">Phase 11</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-bounties">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg></div>
      <h2>Bounty Board</h2>
      <p>Create and track bounties on players. Reward-based PvP challenges.</p>
      <span class="phase-badge">Phase 12</span>
    </div>
  </div>

  <div class="main-tab-panel" id="main-clans">
    <div class="coming-soon">
      <div class="coming-soon-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></div>
      <h2>Clan System</h2>
      <p>Form clans, manage shared storage, clan rankings, and group features.</p>
      <span class="phase-badge">Phase 13</span>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastContainer"></div>

<script>
(function() {
  'use strict';

  // ═══════════════════════════════════════════════════════
  // CATEGORY ICONS (inline SVG)
  // ═══════════════════════════════════════════════════════
  const ICONS = {
    weapon:      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.5 2.5l5 5-10 10-5-5L14.5 2.5z"/><path d="M3 21l3.5-3.5"/><path d="M5.5 13.5l5 5"/></svg>',
    ammo:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="8" y="2" width="8" height="20" rx="2"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="14" x2="16" y2="14"/></svg>',
    armor:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
    medical:     '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
    food:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
    barter:      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M20 21L3 4"/></svg>',
    key:         '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>',
    container:   '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
    mod:         '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',
    equipment:   '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>',
    tool:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>',
    electronics: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="15" x2="23" y2="15"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="15" x2="4" y2="15"/></svg>',
    money:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
    info:        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
    all:         '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
    fallback:    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    check:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
    x:           '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    alert:       '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
  };

  function getIconKey(name) {
    var n = (name || '').toLowerCase();
    if (n.includes('weapon') && !n.includes('mod')) return 'weapon';
    if (n.includes('ammo') || n.includes('ammunition')) return 'ammo';
    if (n.includes('armor') || n.includes('vest') || n.includes('helmet') || n.includes('plate')) return 'armor';
    if (n.includes('medical') || n.includes('medkit') || n.includes('drug') || n.includes('stimulant') || n.includes('medikit')) return 'medical';
    if (n.includes('food') || n.includes('drink') || n.includes('provision')) return 'food';
    if (n.includes('barter')) return 'barter';
    if (n.includes('key') || n.includes('keycard') || n.includes('mechanical')) return 'key';
    if (n.includes('container') || n.includes('backpack') || n.includes('rig') || n.includes('pouch') || n.includes('case') || n.includes('belt')) return 'container';
    if (n.includes('mod') || n.includes('mount') || n.includes('sight') || n.includes('muzzle') || n.includes('grip') || n.includes('stock') || n.includes('handguard') || n.includes('magazine') || n.includes('barrel') || n.includes('receiver') || n.includes('scope') || n.includes('flashlight') || n.includes('laser') || n.includes('silencer') || n.includes('suppressor') || n.includes('foregrip') || n.includes('bipod') || n.includes('charge') || n.includes('rail') || n.includes('gas block')) return 'mod';
    if (n.includes('equipment') || n.includes('gear') || n.includes('headwear') || n.includes('eyewear') || n.includes('facecover') || n.includes('headset') || n.includes('armband')) return 'equipment';
    if (n.includes('tool')) return 'tool';
    if (n.includes('electron') || n.includes('battery') || n.includes('circuit')) return 'electronics';
    if (n.includes('build') || n.includes('material')) return 'tool';
    if (n.includes('household') || n.includes('lubricant') || n.includes('fuel')) return 'barter';
    if (n.includes('jewelry') || n.includes('valuable')) return 'barter';
    if (n.includes('money') || n.includes('currency')) return 'money';
    if (n.includes('info') || n.includes('special') || n.includes('map')) return 'info';
    return 'fallback';
  }

  function icon(key, cls) {
    return '<span class="' + (cls || 'ci-icon') + '">' + (ICONS[key] || ICONS.fallback) + '</span>';
  }

  // ═══════════════════════════════════════════════════════
  // STATE
  // ═══════════════════════════════════════════════════════
  var sessionId = localStorage.getItem('zslayer_session') || '';
  var ccPassword = localStorage.getItem('zslayer_password') || '';
  var profileName = '';
  var cart = JSON.parse(localStorage.getItem('zslayer_cart') || '[]');
  var flatCats = [];
  var currentSearch = '';
  var currentCategory = '';
  var currentCategoryName = 'All Categories';
  var currentCategoryCount = null;
  var currentOffset = 0;
  var PAGE_SIZE = 50;
  var totalItems = 0;
  var searchTimer = null;
  var ddOpen = false;
  var currentSortField = 'name';
  var currentSortDir = 'asc';
  var lastItems = [];
  var currentMainTab = localStorage.getItem('zslayer_cc_tab') || 'dashboard';

  // ═══════════════════════════════════════════════════════
  // API
  // ═══════════════════════════════════════════════════════
  var BASE = '/zslayer/cc/';
  function api(endpoint, opts) {
    opts = opts || {};
    var h = { 'X-Session-Id': sessionId, 'X-Password': ccPassword };
    if (opts.body) h['Content-Type'] = 'application/json';
    return fetch(BASE + endpoint, Object.assign({}, opts, { headers: Object.assign(h, opts.headers || {}) }))
      .then(function(r) { return r.json().then(function(d) { if (!r.ok) throw new Error(d.error || 'Request failed'); return d; }); });
  }

  // ═══════════════════════════════════════════════════════
  // TOASTS
  // ═══════════════════════════════════════════════════════
  function toast(msg, type) {
    type = type || 'info';
    var iconSvg = type === 'success' ? ICONS.check : type === 'error' ? ICONS.x : ICONS.alert;
    var c = document.getElementById('toastContainer');
    var el = document.createElement('div');
    el.className = 'toast ' + type;
    el.innerHTML = '<span class="toast-icon">' + iconSvg + '</span>' + escH(msg);
    c.appendChild(el);
    setTimeout(function() { el.classList.add('toast-fade-out'); setTimeout(function() { el.remove(); }, 300); }, 3500);
  }

  // ═══════════════════════════════════════════════════════
  // AUTH — Profile Selector
  // ═══════════════════════════════════════════════════════
  var selectedLoginId = '';
  var selectedLoginName = '';
  var serverHasPassword = false;

  // ═══════════════════════════════════════════════════════
  // SERVER VITALS (login screen widget)
  // ═══════════════════════════════════════════════════════
  var vitalsTimer = null;

  function fetchVitals() {
    fetch(BASE + 'server-vitals')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var el = document.getElementById('serverVitals');
        el.style.display = '';
        document.getElementById('svOnline').textContent = d.playersOnline;
        document.getElementById('svTotal').textContent = d.totalProfiles;
        document.getElementById('svUptime').textContent = 'Uptime: ' + d.serverUptime;

        var dot = document.getElementById('svDot');
        var raidInfo = document.getElementById('svRaidInfo');
        if (d.activeRaid) {
          dot.className = 'server-vitals-dot';
          var sec = d.activeRaid.timeElapsedSec || 0;
          var mm = String(Math.floor(sec / 60)).padStart(2, '0');
          var ss = String(sec % 60).padStart(2, '0');
          raidInfo.innerHTML = escH(d.activeRaid.map) + ' &middot; ' + d.activeRaid.playersInRaid + ' PMCs'
            + '<br><span class="sv-muted">\u23F1 ' + mm + ':' + ss + ' elapsed</span>';
        } else {
          dot.className = 'server-vitals-dot amber';
          raidInfo.innerHTML = '<span class="sv-muted">No active raid</span>';
        }

        // Online players list
        var psec = document.getElementById('svPlayersSection');
        var plist = document.getElementById('svPlayersList');
        if (d.onlinePlayers && d.onlinePlayers.length > 0) {
          psec.style.display = '';
          var html = '';
          d.onlinePlayers.forEach(function(p) {
            var isRaid = p.status === 'In Raid';
            var badge = isRaid
              ? '<span class="sv-player-status raid">' + escH(p.status) + (p.map ? ' \u2014 ' + escH(p.map) : '') + '</span>'
              : '<span class="sv-player-status stash">' + escH(p.status) + '</span>';
            html += '<div class="sv-player-row"><span class="sv-player-name">' + escH(p.nickname) + '</span>' + badge + '</div>';
          });
          plist.innerHTML = html;
        } else {
          psec.style.display = 'none';
        }
      })
      .catch(function() {
        // silently ignore — widget stays hidden or stale
      });
  }

  function startVitalsPolling() {
    fetchVitals();
    if (!vitalsTimer) vitalsTimer = setInterval(fetchVitals, 10000);
  }

  function stopVitalsPolling() {
    if (vitalsTimer) { clearInterval(vitalsTimer); vitalsTimer = null; }
    var el = document.getElementById('serverVitals');
    if (el) el.style.display = 'none';
  }

  function loadProfileList() {
    var grid = document.getElementById('profileGrid');
    grid.innerHTML = '<div class="profile-loading">Loading profiles...</div>';
    document.getElementById('loginError1').style.display = 'none';

    fetch(BASE + 'profiles')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        serverHasPassword = data.hasPassword;
        var profiles = data.profiles || [];
        if (profiles.length === 0) {
          grid.innerHTML = '<div class="profile-empty">No profiles found on this server.</div>';
          return;
        }
        var lastUsedSid = localStorage.getItem('zslayer_session') || '';
        profiles = profiles.filter(function(p) { return !(p.nickname || '').toLowerCase().includes('headless'); });
        var html = '';
        profiles.forEach(function(p) {
          var factionClass = (p.side || '').toLowerCase();
          if (factionClass !== 'usec' && factionClass !== 'bear') factionClass = 'savage';
          var factionLabel = p.side || 'Savage';
          var firstLetter = (p.nickname || '?').charAt(0).toUpperCase();
          var isLastUsed = p.sessionId === lastUsedSid;
          var cardClass = 'profile-card' + (isLastUsed ? ' last-used' : '');
          html += '<div class="' + cardClass + '" onclick="selectProfile(\'' + escH(p.sessionId) + '\',\'' + escH(p.nickname) + '\')">'
            + '<div class="profile-avatar ' + factionClass + '">' + escH(firstLetter) + '</div>'
            + '<span class="profile-card-name">' + escH(p.nickname) + '</span>'
            + '<span class="faction-badge ' + factionClass + '">' + escH(factionLabel) + '</span>'
            + '<span class="profile-card-level">Lv ' + p.level + '</span>'
            + (isLastUsed ? '<span class="profile-card-last-tag">LAST USED</span>' : '')
            + '</div>';
        });
        grid.innerHTML = html;
      })
      .catch(function(e) {
        grid.innerHTML = '';
        var errEl = document.getElementById('loginError1');
        errEl.textContent = 'Failed to load profiles: ' + (e.message || 'Connection error');
        errEl.style.display = 'block';
      });
  }

  window.selectProfile = function(sid, name) {
    selectedLoginId = sid;
    selectedLoginName = name;
    if (serverHasPassword) {
      // Show password step
      document.getElementById('loginStep1').classList.remove('active');
      document.getElementById('loginStep2').classList.add('active');
      document.getElementById('selectedProfileDisplay').textContent = name;
      document.getElementById('loginError2').style.display = 'none';
      var pwInput = document.getElementById('passwordInput');
      pwInput.value = '';
      setTimeout(function() { pwInput.focus(); }, 60);
    } else {
      // No password — connect directly
      sessionId = sid;
      ccPassword = '';
      api('auth').then(function(data) {
        if (!data.authorized) {
          var errEl = document.getElementById('loginError1');
          errEl.textContent = data.reason || 'Access denied';
          errEl.style.display = 'block';
          sessionId = ''; ccPassword = '';
          return;
        }
        profileName = data.profileName;
        localStorage.setItem('zslayer_session', sid);
        localStorage.setItem('zslayer_password', '');
        showMain();
      }).catch(function(e) {
        var errEl = document.getElementById('loginError1');
        errEl.textContent = e.message || 'Connection failed';
        errEl.style.display = 'block';
        sessionId = ''; ccPassword = '';
      });
    }
  };

  window.connect = function() {
    var pwInput = document.getElementById('passwordInput');
    var errEl = document.getElementById('loginError2');
    var btn = document.getElementById('connectBtn');
    var pw = pwInput.value;
    btn.disabled = true; btn.textContent = 'CONNECTING...'; errEl.style.display = 'none';
    sessionId = selectedLoginId;
    ccPassword = pw;
    api('auth').then(function(data) {
      if (!data.authorized) { errEl.textContent = data.reason || 'Access denied'; errEl.style.display = 'block'; sessionId = ''; ccPassword = ''; return; }
      profileName = data.profileName;
      localStorage.setItem('zslayer_session', selectedLoginId);
      localStorage.setItem('zslayer_password', pw);
      showMain();
    }).catch(function(e) {
      errEl.textContent = e.message || 'Connection failed'; errEl.style.display = 'block'; sessionId = ''; ccPassword = '';
    }).finally(function() { btn.disabled = false; btn.textContent = 'CONNECT'; });
  };

  window.loginBackToProfiles = function() {
    document.getElementById('loginStep2').classList.remove('active');
    document.getElementById('loginStep1').classList.add('active');
    selectedLoginId = '';
    selectedLoginName = '';
  };

  window.logout = function() {
    sessionId = ''; profileName = ''; ccPassword = '';
    selectedLoginId = ''; selectedLoginName = '';
    localStorage.removeItem('zslayer_session');
    localStorage.removeItem('zslayer_password');
    document.getElementById('loginScreen').style.display = '';
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('heroBanner').style.display = 'none';
    document.getElementById('headerProfile').style.display = 'none';
    document.getElementById('navBar').style.display = 'none';
    // Reset to step 1
    document.getElementById('loginStep1').classList.add('active');
    document.getElementById('loginStep2').classList.remove('active');
    document.getElementById('passwordInput').value = '';
    loadProfileList();
    startVitalsPolling();
  };

  function showMain() {
    stopVitalsPolling();
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    document.getElementById('heroBanner').style.display = 'flex';
    document.getElementById('headerProfile').style.display = 'flex';
    document.getElementById('navBar').style.display = 'block';
    document.getElementById('profileNameDisplay').textContent = profileName;
    // Set initial category trigger icon
    document.getElementById('ctIcon').innerHTML = ICONS.all;

    // Restore main tab from hash or localStorage
    var hash = window.location.hash.replace('#', '');
    if (hash && document.getElementById('main-' + hash)) {
      currentMainTab = hash;
    }
    switchMainTab(currentMainTab);

    loadCategories();
    searchItems();
    loadPresets();
    updateCartBadge();
    initDashboard();
    loadConsoleHistory();
    loadHeadlessHistory();
    if (currentMainTab === 'players' && !playersLoaded) loadPlayerRoster();
  }

  // ═══════════════════════════════════════════════════════
  // MAIN NAV TABS (14-tab bar)
  // ═══════════════════════════════════════════════════════
  window.switchMainTab = function(tab) {
    currentMainTab = tab;
    localStorage.setItem('zslayer_cc_tab', tab);
    window.location.hash = tab;

    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(function(b) {
      b.classList.toggle('active', b.dataset.nav === tab);
    });

    // Show/hide main panels
    document.querySelectorAll('.main-tab-panel').forEach(function(p) {
      p.classList.toggle('active', p.id === 'main-' + tab);
    });

    // Lazy-load tabs on first visit
    if (tab === 'players' && !playersLoaded) loadPlayerRoster();
    if (tab === 'quests' && !questsLoaded) loadQuestBrowser();
    if (tab === 'flea' && !fleaLoaded) fleaInit();
    if (tab === 'raidinfo' && !raidInfoLoaded) raidInfoInit();

    // Manage raid info polling — start when on tab, stop when leaving
    if (tab === 'raidinfo') {
      startRaidInfoPolling();
    } else {
      stopRaidInfoPolling();
    }
  };

  // ═══════════════════════════════════════════════════════
  // SUB-TABS (Items/Presets/Cart within Items)
  // ═══════════════════════════════════════════════════════
  window.switchTab = function(tab) {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tab); });
    document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.toggle('active', p.id === 'tab-' + tab); });
    if (tab === 'cart') renderCart();
  };

  // ═══════════════════════════════════════════════════════
  // CATEGORY DROPDOWN
  // ═══════════════════════════════════════════════════════
  window.toggleCatDropdown = function() {
    ddOpen = !ddOpen;
    document.getElementById('catTrigger').classList.toggle('open', ddOpen);
    document.getElementById('catPanel').classList.toggle('open', ddOpen);
    if (ddOpen) {
      document.getElementById('catSearchInput').value = '';
      filterCategories('');
      setTimeout(function() { document.getElementById('catSearchInput').focus(); }, 60);
    }
  };

  function closeDd() {
    ddOpen = false;
    document.getElementById('catTrigger').classList.remove('open');
    document.getElementById('catPanel').classList.remove('open');
  }

  function selectCat(id, name, count) {
    currentCategory = id;
    currentCategoryName = name;
    currentCategoryCount = count;
    currentOffset = 0;

    // Update trigger display
    document.getElementById('ctLabel').textContent = name;
    var countEl = document.getElementById('ctCount');
    if (count !== null && count !== undefined) {
      countEl.textContent = count.toLocaleString();
      countEl.style.display = '';
    } else {
      countEl.style.display = 'none';
    }
    var iconKey = id ? getIconKey(name) : 'all';
    document.getElementById('ctIcon').innerHTML = ICONS[iconKey] || ICONS.fallback;

    // Update active state in dropdown
    document.querySelectorAll('.cat-item').forEach(function(el) {
      el.classList.toggle('active', (el.dataset.id || '') === id);
    });

    closeDd();
    searchItems();
  }

  window.filterCategories = function(q) {
    q = (q || '').toLowerCase();
    document.querySelectorAll('.cat-item').forEach(function(el) {
      var name = (el.dataset.name || '').toLowerCase();
      el.style.display = (!q || name.includes(q)) ? '' : 'none';
    });
  };

  document.addEventListener('click', function(e) {
    if (ddOpen && !document.getElementById('catDropdown').contains(e.target)) closeDd();
  });

  // ═══════════════════════════════════════════════════════
  // CATEGORIES
  // ═══════════════════════════════════════════════════════
  function loadCategories() {
    api('categories').then(function(data) {
      var cats = data.categories || [];
      flatCats = [];
      flattenCats(cats, 0);
      renderCatList();
    }).catch(function(e) { console.error('Categories error:', e); });
  }

  function flattenCats(cats, depth) {
    for (var i = 0; i < cats.length; i++) {
      var c = cats[i];
      flatCats.push({ id: c.id, name: c.name, count: c.itemCount, depth: depth, hasKids: c.children && c.children.length > 0 });
      if (c.children && c.children.length) flattenCats(c.children, depth + 1);
    }
  }

  function renderCatList() {
    var list = document.getElementById('catList');
    var html = '';

    // "All Categories" item
    html += '<div class="cat-item active" data-id="" data-name="All Categories" onclick="window._selCat(\'\',\'All Categories\',null)">';
    html += icon('all', 'ci-icon');
    html += '<span class="ci-name">All Categories</span></div>';
    html += '<div class="cat-sep"></div>';

    for (var i = 0; i < flatCats.length; i++) {
      var c = flatCats[i];
      var iKey = getIconKey(c.name);
      var indent = c.depth * 18;
      var parentCls = c.hasKids ? ' is-parent' : '';
      html += '<div class="cat-item' + parentCls + '" data-id="' + escA(c.id) + '" data-name="' + escA(c.name) + '" onclick="window._selCat(\'' + escA(c.id) + '\',\'' + escA(c.name) + '\',' + c.count + ')">';
      if (indent > 0) html += '<span class="ci-indent" style="width:' + indent + 'px"></span>';
      html += icon(iKey, 'ci-icon');
      html += '<span class="ci-name">' + escH(c.name) + '</span>';
      if (c.count > 0) html += '<span class="ci-count">' + c.count.toLocaleString() + '</span>';
      html += '</div>';
    }
    list.innerHTML = html;
  }

  window._selCat = function(id, name, count) { selectCat(id, name, count); };

  // ═══════════════════════════════════════════════════════
  // SORTING
  // ═══════════════════════════════════════════════════════
  window.toggleSort = function(field) {
    if (currentSortField === field) {
      currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortField = field;
      currentSortDir = field === 'name' ? 'asc' : 'desc';
    }
    updateSortHeaders();
    currentOffset = 0;
    searchItems();
  };

  function updateSortHeaders() {
    document.querySelectorAll('.item-table th.sortable').forEach(function(th) {
      var f = th.id.replace('th-', '');
      var arrow = th.querySelector('.sort-arrow');
      if (f === currentSortField) {
        th.classList.add('sort-active');
        arrow.textContent = currentSortDir === 'asc' ? '\u25B2' : '\u25BC';
      } else {
        th.classList.remove('sort-active');
        arrow.textContent = '\u25B2';
      }
    });
  }

  function formatPrice(p) {
    if (!p) return '<span class="price-zero">&mdash;</span>';
    return '\u20BD ' + p.toLocaleString();
  }

  function formatWeight(w) {
    if (!w) return '\u2014';
    return w < 1 ? (w * 1000).toFixed(0) + 'g' : w.toFixed(2) + 'kg';
  }

  // ═══════════════════════════════════════════════════════
  // ITEMS
  // ═══════════════════════════════════════════════════════
  function searchItems() {
    var body = document.getElementById('itemsBody');
    body.innerHTML = '<tr class="loading-row"><td colspan="6"><span class="spinner"></span> Searching...</td></tr>';
    var params = new URLSearchParams();
    if (currentSearch) params.set('search', currentSearch);
    if (currentCategory) params.set('category', currentCategory);
    params.set('limit', PAGE_SIZE);
    params.set('offset', currentOffset);
    params.set('sort', currentSortField);
    params.set('dir', currentSortDir);
    api('items?' + params.toString()).then(function(data) {
      totalItems = data.total;
      lastItems = data.items || [];
      renderItems(lastItems);
      updatePagination();
      updateSortHeaders();
    }).catch(function(e) {
      body.innerHTML = '<tr class="loading-row"><td colspan="6">Error: ' + escH(e.message) + '</td></tr>';
    });
  }

  function renderItems(items) {
    var body = document.getElementById('itemsBody');
    var info = document.getElementById('resultsInfo');
    if (items.length === 0) {
      body.innerHTML = '<tr class="loading-row"><td colspan="6">No items found</td></tr>';
      info.innerHTML = '<span><strong>0</strong> results</span>';
      return;
    }
    var from = currentOffset + 1;
    var to = Math.min(currentOffset + PAGE_SIZE, totalItems);
    var rangeText = totalItems > PAGE_SIZE ? ' &middot; showing ' + from + '&ndash;' + to : '';
    info.innerHTML = '<span><strong>' + totalItems.toLocaleString() + '</strong> result' + (totalItems !== 1 ? 's' : '') + rangeText + '</span>';

    body.innerHTML = items.map(function(item) {
      var catKey = getIconKey(item.category);
      return '<tr>' +
        '<td><div class="item-name-cell"><span class="item-name">' + escH(item.fullName) + '</span><span class="item-name-sub">' + escH(item.shortName) + '</span><span class="item-tpl">' + escH(item.tpl) + '</span></div></td>' +
        '<td><span class="item-cat-badge"><span class="badge-icon">' + (ICONS[catKey] || ICONS.fallback) + '</span> ' + escH(item.category) + '</span></td>' +
        '<td class="col-price">' + formatPrice(item.handbookPrice) + '</td>' +
        '<td class="col-weight">' + formatWeight(item.weight) + '</td>' +
        '<td class="col-stack">' + item.stackMaxSize + '</td>' +
        '<td class="col-actions"><div class="action-group">' +
          '<input type="number" value="1" min="1" max="9999" id="qty-' + item.tpl + '">' +
          '<button class="btn btn-xs btn-accent" onclick="giveItem(\'' + escA(item.tpl) + '\',\'' + escA(item.shortName) + '\')">Give</button>' +
          '<button class="btn btn-xs btn-ghost" onclick="addToCart(\'' + escA(item.tpl) + '\',\'' + escA(item.shortName) + '\',' + item.stackMaxSize + ')" title="Add to cart">+</button>' +
        '</div></td></tr>';
    }).join('');
  }

  function updatePagination() {
    var pag = document.getElementById('pagination');
    var hasPages = totalItems > PAGE_SIZE;
    pag.style.display = hasPages ? 'flex' : 'none';
    if (!hasPages) return;
    var page = Math.floor(currentOffset / PAGE_SIZE) + 1;
    var total = Math.ceil(totalItems / PAGE_SIZE);
    document.getElementById('paginationInfo').textContent = 'Page ' + page + ' of ' + total;
    document.getElementById('prevBtn').disabled = currentOffset === 0;
    document.getElementById('nextBtn').disabled = currentOffset + PAGE_SIZE >= totalItems;
  }

  window.prevPage = function() { currentOffset = Math.max(0, currentOffset - PAGE_SIZE); searchItems(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
  window.nextPage = function() { if (currentOffset + PAGE_SIZE < totalItems) { currentOffset += PAGE_SIZE; searchItems(); window.scrollTo({ top: 0, behavior: 'smooth' }); } };

  // Search input
  document.getElementById('searchInput').addEventListener('input', function() {
    var self = this;
    clearTimeout(searchTimer);
    searchTimer = setTimeout(function() { currentSearch = self.value.trim(); currentOffset = 0; searchItems(); }, 300);
  });
  document.getElementById('searchInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { clearTimeout(searchTimer); currentSearch = this.value.trim(); currentOffset = 0; searchItems(); }
  });

  // ═══════════════════════════════════════════════════════
  // GIVE
  // ═══════════════════════════════════════════════════════
  window.giveItem = function(tpl, name) {
    var qtyInput = document.getElementById('qty-' + tpl);
    var count = parseInt(qtyInput ? qtyInput.value : '1', 10) || 1;
    api('give', { method: 'POST', body: JSON.stringify({ items: [{ tpl: tpl, count: count }] }) }).then(function(data) {
      if (data.success) toast(count + 'x ' + name + ' sent to mailbox', 'success');
      else toast('Failed: ' + (data.error || 'Unknown error'), 'error');
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  // ═══════════════════════════════════════════════════════
  // CART
  // ═══════════════════════════════════════════════════════
  window.addToCart = function(tpl, name, stackMax) {
    var qtyInput = document.getElementById('qty-' + tpl);
    var count = parseInt(qtyInput ? qtyInput.value : '1', 10) || 1;
    var existing = cart.find(function(c) { return c.tpl === tpl; });
    if (existing) existing.count += count;
    else cart.push({ tpl: tpl, name: name, count: count, stackMax: stackMax });
    saveCart(); updateCartBadge(); toast(count + 'x ' + name + ' added to cart', 'info');
  };

  function saveCart() { localStorage.setItem('zslayer_cart', JSON.stringify(cart)); }
  function updateCartBadge() {
    var b = document.getElementById('cartBadge');
    b.style.display = cart.length > 0 ? 'inline-flex' : 'none';
    b.textContent = cart.length;
  }

  function renderCart() {
    var c = document.getElementById('cartContent');
    if (cart.length === 0) {
      c.innerHTML = '<div class="cart-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg><p>Your cart is empty</p><p class="sub">Use the + button on items to add them here</p></div>';
      return;
    }
    var html = '<table class="item-table"><thead><tr><th>Item</th><th style="text-align:center">Quantity</th><th style="text-align:right">Actions</th></tr></thead><tbody>';
    cart.forEach(function(item, i) {
      html += '<tr><td><div class="item-name-cell"><span class="item-name">' + escH(item.name) + '</span><span class="item-tpl">' + escH(item.tpl) + '</span></div></td>' +
        '<td style="text-align:center"><input type="number" value="' + item.count + '" min="1" max="9999" onchange="updateCartQty(' + i + ',this.value)"></td>' +
        '<td style="text-align:right"><button class="btn btn-sm btn-danger" onclick="removeFromCart(' + i + ')">Remove</button></td></tr>';
    });
    html += '</tbody></table>';
    html += '<div class="cart-summary">' + cart.length + ' item type' + (cart.length !== 1 ? 's' : '') + ' &middot; ' + cart.reduce(function(s, c) { return s + c.count; }, 0) + ' total items</div>';
    html += '<div class="cart-actions"><button class="btn btn-danger" onclick="clearCart()">Clear Cart</button><button class="btn btn-success" onclick="giveCart()">Give All Items</button></div>';
    c.innerHTML = html;
  }

  window.updateCartQty = function(i, v) { cart[i].count = Math.max(1, parseInt(v, 10) || 1); saveCart(); };
  window.removeFromCart = function(i) { var r = cart.splice(i, 1); saveCart(); updateCartBadge(); renderCart(); if (r.length) toast(r[0].name + ' removed', 'info'); };
  window.clearCart = function() { cart = []; saveCart(); updateCartBadge(); renderCart(); toast('Cart cleared', 'info'); };
  window.giveCart = function() {
    if (!cart.length) return;
    api('give', { method: 'POST', body: JSON.stringify({ items: cart.map(function(c) { return { tpl: c.tpl, count: c.count }; }) }) }).then(function(data) {
      if (data.success) { toast(data.itemsGiven + ' items sent to mailbox', 'success'); cart = []; saveCart(); updateCartBadge(); renderCart(); }
      else toast('Failed: ' + (data.error || 'Unknown'), 'error');
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  // ═══════════════════════════════════════════════════════
  // PRESETS
  // ═══════════════════════════════════════════════════════
  function loadPresets() {
    api('presets').then(function(data) {
      var presets = data.presets || [];
      var grid = document.getElementById('presetsGrid');
      if (!presets.length) { grid.innerHTML = '<div style="color:var(--text-dim);padding:60px;text-align:center;font-family:var(--font-mono)">No presets configured &mdash; add presets in server config</div>'; return; }
      grid.innerHTML = presets.map(function(p) {
        return '<div class="preset-card"><h3>' + escH(p.name) + '</h3><div class="preset-desc">' + escH(p.description) + '</div>' +
          '<ul class="preset-items">' + p.items.map(function(it) { return '<li><span class="count">' + it.count + 'x</span> ' + escH(it.note || it.tpl) + '</li>'; }).join('') + '</ul>' +
          '<button class="btn btn-accent btn-sm" onclick="givePreset(\'' + escA(p.id) + '\',\'' + escA(p.name) + '\')">Give Preset</button></div>';
      }).join('');
    }).catch(function(e) { document.getElementById('presetsGrid').innerHTML = '<div style="color:var(--error-bright)">Error: ' + escH(e.message) + '</div>'; });
  }

  window.givePreset = function(id, name) {
    api('preset', { method: 'POST', body: JSON.stringify({ presetId: id }) }).then(function(data) {
      if (data.success) toast(name + ' sent (' + data.itemsGiven + ' items)', 'success');
      else toast('Failed: ' + (data.error || 'Unknown'), 'error');
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  // ═══════════════════════════════════════════════════════
  // DASHBOARD
  // ═══════════════════════════════════════════════════════
  var dashRefreshTimer = null;
  var consoleTimer = null;
  var consoleSince = new Date().toISOString();
  var consoleCollapsed = false;
  var consoleFilters = { info: true, success: true, warning: true, error: true, debug: false };
  var consoleSearchQuery = '';
  var allConsoleEntries = [];
  var headlessTimer = null;
  var headlessStatusTimer = null;
  var headlessSince = new Date().toISOString();
  var headlessCollapsed = false;
  var headlessFilters = { info: true, success: true, warning: true, error: true, debug: false };
  var headlessSearchQuery = '';
  var allHeadlessEntries = [];
  var headlessConfigured = null;
  var activityOffset = 0;
  var activityTotal = 0;
  var ACTIVITY_PAGE = 20;
  var dashConfig = { refreshIntervalSeconds: 30, consolePollingMs: 3000 };
  var raidInfoLoaded = false;
  var raidInfoTimer = null;

  function initDashboard() {
    // Fetch config first, then load data
    api('dashboard/config').then(function(cfg) {
      dashConfig = cfg;
    }).catch(function(){}).finally(function() {
      refreshDashboard();
      startDashboardTimers();
    });
    // Live clock
    setInterval(function() {
      var el = document.getElementById('dashLiveClock');
      if (el) el.textContent = new Date().toLocaleTimeString();
    }, 1000);
  }

  function startDashboardTimers() {
    stopDashboardTimers();
    dashRefreshTimer = setInterval(refreshDashboard, dashConfig.refreshIntervalSeconds * 1000);
    consoleTimer = setInterval(pollConsole, dashConfig.consolePollingMs);
    headlessTimer = setInterval(pollHeadless, dashConfig.consolePollingMs);
    headlessStatusTimer = setInterval(pollHeadlessStatus, dashConfig.refreshIntervalSeconds * 1000);
  }

  function stopDashboardTimers() {
    if (dashRefreshTimer) { clearInterval(dashRefreshTimer); dashRefreshTimer = null; }
    if (consoleTimer) { clearInterval(consoleTimer); consoleTimer = null; }
    if (headlessTimer) { clearInterval(headlessTimer); headlessTimer = null; }
    if (headlessStatusTimer) { clearInterval(headlessStatusTimer); headlessStatusTimer = null; }
  }

  window.refreshDashboard = function() {
    loadServerStatus();
    loadPlayers();
    loadEconomy();
    loadRaidStats();
    loadMyRaidStats();
    loadActivity();
    pollConsole();
    pollHeadless();
    pollHeadlessStatus();
    // Live clock handles time display
  };

  function loadServerStatus() {
    api('dashboard/status').then(function(d) {
      document.getElementById('dashUptime').textContent = d.uptime;
      document.getElementById('dashSptVer').textContent = d.sptVersion || '--';
      document.getElementById('dashCcVer').textContent = d.ccVersion || '--';
      document.getElementById('dashMemory').textContent = d.workingSetMb + ' MB';
      document.getElementById('dashGcMemory').textContent = d.gcMemoryMb + ' MB';
      document.getElementById('dashThreads').textContent = d.threadCount;
      document.getElementById('dashModCount').textContent = d.modCount;
      document.getElementById('dashFikaServerVer').textContent = d.fikaServerVersion || '--';
      document.getElementById('dashFikaClientVer').textContent = d.headlessFikaVersion || '--';
      document.getElementById('dashTelemetryVer').textContent = d.headlessTelemetryVersion || '--';
      document.getElementById('dashModSummary').textContent = d.modCount + ' mods loaded';
      var modHtml = '';
      (d.mods || []).forEach(function(m) {
        modHtml += '<div style="padding:3px 0;border-bottom:1px solid var(--border-subtle);display:flex;justify-content:space-between">' +
          '<span style="color:var(--text)">' + escH(m.name) + '</span>' +
          '<span style="color:var(--text-muted);padding-right:8px">' + escH(m.version) + '</span></div>';
      });
      document.getElementById('dashModList').innerHTML = modHtml || '<span style="color:var(--text-muted)">No mods</span>';
    }).catch(function(e) { console.error('Status error:', e); });
  }

  function loadPlayers() {
    api('dashboard/players').then(function(d) {
      document.getElementById('dashTotalProfiles').textContent = d.totalProfiles;
      document.getElementById('dashOnlineCount').textContent = d.onlineCount;
      var onlineEl = document.getElementById('dashOnlineCount');
      onlineEl.style.color = d.onlineCount > 0 ? 'var(--success-bright)' : '#8b3a3a';
      document.getElementById('dashOnlineBadge').textContent = d.onlineCount > 0 ? d.onlineCount + ' online' : '';
      document.getElementById('dashOnlineBadge').style.color = d.onlineCount > 0 ? 'var(--success-bright)' : '#8b3a3a';
      // Headless badge in header
      var headless = (d.players || []).find(function(p) { return p.isHeadless; });
      var hlBadge = document.getElementById('dashHeadlessBadge');
      if (headless) {
        hlBadge.style.display = '';
        hlBadge.innerHTML = '\uD83E\uDD16 Headless Client <span id="dashHlStatusPill" class="hl-status-pill pill-stopped" style="font-size:10px;padding:1px 8px;margin-left:4px;vertical-align:middle">Stopped</span>';
        // Fetch actual headless process state
        api('headless/status').then(function(hs) {
          var pill = document.getElementById('dashHlStatusPill');
          if (!pill) return;
          if (!hs.available) {
            pill.className = 'hl-status-pill pill-unavailable';
            pill.textContent = 'N/A';
          } else if (hs.running) {
            pill.className = 'hl-status-pill pill-running';
            pill.textContent = 'Running';
          } else {
            pill.className = 'hl-status-pill pill-stopped';
            pill.textContent = 'Stopped';
          }
          pill.style.fontSize = '10px';
          pill.style.padding = '1px 8px';
        }).catch(function(){});
      } else {
        hlBadge.style.display = 'none';
      }
      var html = '';
      (d.players || []).forEach(function(p) {
        if (p.isHeadless) return;
        html += '<div class="dash-player">' +
          '<span class="online-dot ' + (p.online ? 'on' : 'off') + '"></span>' +
          '<span class="p-name">' + escH(p.nickname) + '</span>' +
          '<span class="p-detail">Lvl ' + p.level + ' · ' + escH(p.side).toUpperCase() + '</span></div>';
      });
      document.getElementById('dashPlayerList').innerHTML = html || '<div style="padding:12px;color:var(--text-muted);text-align:center">No profiles found</div>';
    }).catch(function(e) { console.error('Players error:', e); });
  }

  var RANK_COLORS = ['#FFD700', '#C0C0C0', '#CD7F32'];
  function loadEconomy() {
    api('dashboard/economy').then(function(d) {
      document.getElementById('dashTotalRoubles').textContent = formatRoubles(d.totalRoubles);
      document.getElementById('dashAvgWealth').textContent = formatRoubles(d.averageWealth);
      var html = '';
      (d.topPlayers || []).forEach(function(p, i) {
        var rankColor = i < 3 ? RANK_COLORS[i] : 'var(--accent-dim)';
        html += '<div class="dash-player">' +
          '<span style="color:' + rankColor + ';font-family:var(--font-mono);font-size:11px;width:18px;font-weight:700">#' + (i+1) + '</span>' +
          '<span class="p-name">' + escH(p.nickname) + '</span>' +
          '<span class="p-detail">' + formatRoubles(p.roubles) + '</span></div>';
      });
      document.getElementById('dashTopPlayers').innerHTML = html;
    }).catch(function(e) { console.error('Economy error:', e); });
  }

  var MAP_NAMES = {
    'factory4_day': 'Factory (Day)',
    'factory4_night': 'Factory (Night)',
    'bigmap': 'Customs',
    'Woods': 'Woods',
    'Shoreline': 'Shoreline',
    'Interchange': 'Interchange',
    'laboratory': 'The Lab',
    'Lighthouse': 'Lighthouse',
    'RezervBase': 'Reserve',
    'TarkovStreets': 'Streets',
    'Sandbox': 'Ground Zero',
    'Sandbox_high': 'Ground Zero (High)',
    'city': 'Streets'
  };
  function mapDisplayName(key) {
    if (key === 'Unknown') return 'Map data unavailable';
    return MAP_NAMES[key] || key;
  }

  function renderRaidStats(d, prefix) {
    var hasRaids = d.totalRaids > 0;
    document.getElementById(prefix + 'TotalRaids').textContent = d.totalRaids.toLocaleString();
    document.getElementById(prefix + 'SurvivalRate').textContent = hasRaids ? d.survivalRate.toFixed(1) + '%' : '--';
    document.getElementById(prefix + 'KD').textContent = hasRaids ? d.kdRatio.toFixed(2) : '--';
    document.getElementById(prefix + 'TotalKills').textContent = (d.totalKills || 0).toLocaleString();
    document.getElementById(prefix + 'PmcKills').textContent = (d.pmcKills || 0).toLocaleString();
    document.getElementById(prefix + 'ScavKills').textContent = (d.scavKills || 0).toLocaleString();
    document.getElementById(prefix + 'BossKills').textContent = (d.bossKills || 0).toLocaleString();
    document.getElementById(prefix + 'Headshots').textContent = (d.headshots || 0).toLocaleString();
  }

  function loadRaidStats() {
    api('dashboard/raids').then(function(d) {
      renderRaidStats(d, 'dash');
    }).catch(function(e) { console.error('Raids error:', e); });
  }

  function loadMyRaidStats() {
    if (!sessionId) return;
    var widget = document.getElementById('widgetMyRaids');
    api('dashboard/my-raids').then(function(d) {
      widget.style.display = '';
      renderRaidStats(d, 'my');
    }).catch(function(e) {
      widget.style.display = 'none';
      console.error('My raids error:', e);
    });
  }

  // ═══════════════════════════════════════════════════════
  // TELEMETRY — Live Raid, Kill Feed, Raid History
  // ═══════════════════════════════════════════════════════

  function raidInfoInit() {
    raidInfoLoaded = true;
    loadTelemetry();
    loadRaidHistory();
    startRaidInfoPolling();
  }

  function startRaidInfoPolling() {
    if (raidInfoTimer) return;
    raidInfoTimer = setInterval(loadTelemetry, 3000);
  }

  function stopRaidInfoPolling() {
    if (raidInfoTimer) { clearInterval(raidInfoTimer); raidInfoTimer = null; }
  }

  function loadTelemetry() {
    loadTelemetryCurrent();
    loadKillFeed();
  }

  function fpsClass(fps) {
    if (fps >= 50) return 'fps-good';
    if (fps >= 30) return 'fps-mid';
    return 'fps-low';
  }

  function pingClass(ms) {
    if (ms < 50) return 'ping-good';
    if (ms < 100) return 'ping-fair';
    if (ms < 150) return 'ping-warn';
    return 'ping-bad';
  }

  function healthClass(pct) {
    if (pct > 0.6) return 'hp-high';
    if (pct > 0.3) return 'hp-mid';
    return 'hp-low';
  }

  function actorClass(type) {
    if (type === 'pmc') return 'pmc';
    if (type === 'boss') return 'boss';
    return type || 'scav';
  }

  function formatAliveDeadCount(ad) {
    if (!ad) return '--';
    return '<span class="alive">' + ad.alive + '</span>\u{1F7E2} <span class="dead-count">' + ad.dead + '</span>\u{1F480}';
  }

  // Cache kill feed data for player kill count derivation
  var _cachedKillFeed = [];

  function countPlayerKills(playerName) {
    var count = 0;
    _cachedKillFeed.forEach(function(k) {
      if (k.killer && k.killer.name === playerName) count++;
    });
    return count;
  }

  function renderBodyPartChart(bp) {
    if (!bp) return '';
    var parts = [
      { label: 'Head', val: bp.head || 0, cls: 'bp-head' },
      { label: 'Chest', val: bp.chest || 0, cls: '' },
      { label: 'Stomach', val: bp.stomach || 0, cls: '' },
      { label: 'L. Arm', val: bp.leftArm || 0, cls: '' },
      { label: 'R. Arm', val: bp.rightArm || 0, cls: '' },
      { label: 'L. Leg', val: bp.leftLeg || 0, cls: '' },
      { label: 'R. Leg', val: bp.rightLeg || 0, cls: '' }
    ];
    var max = 1;
    parts.forEach(function(p) { if (p.val > max) max = p.val; });
    var html = '<div class="body-part-chart">';
    parts.forEach(function(p) {
      var pct = Math.round((p.val / max) * 100);
      html += '<div class="body-part-row">' +
        '<span class="body-part-label">' + p.label + '</span>' +
        '<div class="body-part-bar-bg"><div class="body-part-bar-fill ' + p.cls + '" style="width:' + pct + '%"></div></div>' +
        '<span class="body-part-count">' + p.val + '</span></div>';
    });
    html += '</div>';
    return html;
  }

  function renderCombatStats(ds) {
    var section = document.getElementById('telemCombatStatsSection');
    if (!ds || ds.totalHits === 0) {
      section.style.display = 'none';
      return;
    }
    section.style.display = '';
    var hsPct = ds.totalHits > 0 ? Math.round((ds.headshotCount / ds.totalHits) * 100) : 0;
    var html = '<div class="combat-stats-grid">' +
      '<div class="combat-stat-item"><span class="combat-stat-value">' + ds.totalHits + '</span><span class="combat-stat-label">Hits</span></div>' +
      '<div class="combat-stat-item"><span class="combat-stat-value">' + ds.headshotCount + '</span><span class="combat-stat-label">Headshots</span></div>' +
      '<div class="combat-stat-item"><span class="combat-stat-value">' + hsPct + '%</span><span class="combat-stat-label">HS Rate</span></div>' +
      '<div class="combat-stat-item"><span class="combat-stat-value">' + ds.totalDamageDealt + '</span><span class="combat-stat-label">Damage</span></div>' +
      '<div class="combat-stat-item"><span class="combat-stat-value">' + Math.round(ds.longestShot) + 'm</span><span class="combat-stat-label">Longest Shot</span></div>' +
      '<div class="combat-stat-item"><span class="combat-stat-value">' + Math.round(ds.avgDistance) + 'm</span><span class="combat-stat-label">Avg Distance</span></div>' +
      '</div>';
    html += renderBodyPartChart(ds.bodyParts);
    document.getElementById('telemCombatStatsBody').innerHTML = html;
  }

  function outcomeBadge(outcome) {
    var cls = 'kia';
    var label = outcome || 'Unknown';
    switch ((outcome || '').toLowerCase()) {
      case 'survived': cls = 'survived'; label = 'Survived'; break;
      case 'killed': cls = 'kia'; label = 'KIA'; break;
      case 'mia': cls = 'mia'; label = 'MIA'; break;
      case 'run-through': case 'runthrough': case 'runner': cls = 'runthrough'; label = 'Run Through'; break;
    }
    return '<span class="outcome-badge ' + cls + '">' + label + '</span>';
  }

  function loadTelemetryCurrent() {
    api('telemetry/current').then(function(d) {
      var idleMsg = document.getElementById('raidInfoIdleMsg');
      var rs = d.raidState || {};
      var perf = d.performance || {};
      var players = d.players || [];
      var bots = d.bots || {};
      var damageStats = d.damageStats;

      if (!d.raidActive) {
        idleMsg.style.display = '';
        document.getElementById('telemRaidStatusBadge').className = 'telem-raid-status idle';
        document.getElementById('telemRaidStatusBadge').textContent = 'Idle';
        document.getElementById('telemMap').textContent = '--';
        document.getElementById('telemTimer').textContent = '--';
        document.getElementById('telemTimeOfDay').textContent = '--';
        document.getElementById('telemFps').textContent = '--';
        document.getElementById('telemFps').className = 'telem-fps';
        document.getElementById('telemFpsAvg').textContent = '--';
        document.getElementById('telemCpu').textContent = '--';
        document.getElementById('telemCpu').style.color = '';
        document.getElementById('telemMemory').textContent = '--';
        document.getElementById('telemPlayerTable').style.display = 'none';
        document.getElementById('telemPlayersEmpty').style.display = '';
        document.getElementById('telemBotsInner').style.display = 'none';
        document.getElementById('telemBotsEmpty').style.display = '';
        // Keep combat stats visible after raid ends (don't hide)
        updateMapForRaid('', false);
        document.getElementById('telemSeason').textContent = d.season || '--';
        return;
      }

      idleMsg.style.display = 'none';

      // Update live map
      updateMapForRaid(rs.map || '', true);
      // Try loading map images for current map
      if (_mapConfig) {
        Object.keys(_mapConfig.layers).forEach(function(lv) { tryLoadMapImage(rs.map, lv); });
      }

      // Status badge
      var badge = document.getElementById('telemRaidStatusBadge');
      var statusClass = (rs.status || 'idle').replace(/\s+/g, '-');
      badge.className = 'telem-raid-status ' + statusClass;
      badge.textContent = rs.status || 'idle';

      // Header stats
      document.getElementById('telemMap').textContent = mapDisplayName(rs.map || '');
      document.getElementById('telemTimer').textContent = rs.raidTimer > 0 ? formatSeconds(rs.raidTimer) : '--';
      document.getElementById('telemTimeOfDay').textContent = rs.timeOfDay || '--';
      document.getElementById('telemSeason').textContent = d.season || '--';

      // FPS with min/max range
      var fpsEl = document.getElementById('telemFps');
      if (perf.fps) {
        var fpsText = perf.fps + ' FPS';
        if (perf.fpsMin && perf.fpsMax) fpsText += ' (' + perf.fpsMin + '-' + perf.fpsMax + ')';
        fpsEl.textContent = fpsText;
        fpsEl.className = 'telem-fps ' + fpsClass(perf.fps);
      } else {
        fpsEl.textContent = '--';
        fpsEl.className = 'telem-fps';
      }
      var fpsAvgEl = document.getElementById('telemFpsAvg');
      if (perf.fpsAvg) {
        fpsAvgEl.textContent = perf.fpsAvg + ' avg';
        fpsAvgEl.className = 'telem-fps ' + fpsClass(perf.fpsAvg);
        fpsAvgEl.style.fontSize = '12px';
        fpsAvgEl.style.fontWeight = '500';
      } else {
        fpsAvgEl.textContent = '--';
      }
      // CPU usage
      var cpuEl = document.getElementById('telemCpu');
      if (perf.cpuUsage > 0) {
        cpuEl.textContent = perf.cpuUsage + '%';
        cpuEl.style.color = perf.cpuUsage > 80 ? 'var(--danger)' : perf.cpuUsage > 50 ? 'var(--warning)' : '';
      } else {
        cpuEl.textContent = '--';
        cpuEl.style.color = '';
      }
      document.getElementById('telemMemory').textContent = perf.memoryMb ? Number(perf.memoryMb).toLocaleString() + ' MB' : '--';

      // System info (render once when received)
      if (perf.systemInfo && perf.systemInfo.cpuModel) {
        var si = perf.systemInfo;
        var sysBar = document.getElementById('telemSystemInfo');
        sysBar.style.display = '';
        document.getElementById('sysInfoCpu').textContent = si.cpuModel + ' (' + si.cpuCores + ' cores)';
        document.getElementById('sysInfoGpu').textContent = si.gpuModel + (si.gpuVramMb ? ' (' + si.gpuVramMb + ' MB)' : '');
        document.getElementById('sysInfoRam').textContent = si.totalRamMb ? (si.totalRamMb >= 1024 ? (si.totalRamMb / 1024).toFixed(0) + ' GB' : si.totalRamMb + ' MB') + ' RAM' : '';
        document.getElementById('sysInfoOs').textContent = si.os || '';
      }

      // Player table with kills column
      if (players.length > 0) {
        document.getElementById('telemPlayerTable').style.display = '';
        document.getElementById('telemPlayersEmpty').style.display = 'none';
        var phtml = '';
        players.forEach(function(p) {
          var alive = p.alive !== false;
          var hpPct = Math.round((p.health || 0) * 100);
          var hpCls = healthClass(p.health || 0);
          var kills = countPlayerKills(p.name);
          var pingHtml = '--';
          if (p.pingMs != null && p.pingMs === 0) {
            pingHtml = '<span class="telem-ping ping-good">Local</span>';
          } else if (p.pingMs != null) {
            pingHtml = '<span class="telem-ping ' + pingClass(p.pingMs) + '">' + p.pingMs + 'ms</span>';
          }
          var nameColor = (p.type === 'pmc') ? 'var(--success-bright)' : 'var(--accent)';
          phtml += '<tr' + (alive ? '' : ' class="dead"') + '>' +
            '<td style="color:' + nameColor + ';font-weight:600">' + escH(p.name) + '</td>' +
            '<td>' + p.level + '</td>' +
            '<td style="text-transform:uppercase;font-size:10px;letter-spacing:1px;color:var(--text-dim)">' + escH(p.side || '') + '</td>' +
            '<td style="font-family:var(--font-mono);font-weight:600">' + (kills > 0 ? kills : '--') + '</td>' +
            '<td>' + (alive ? '<span style="color:var(--success-bright)">Alive</span>' : '<span style="color:var(--error-bright)">Dead</span>') + '</td>' +
            '<td><div class="telem-health-bar"><div class="telem-health-fill ' + hpCls + '" style="width:' + hpPct + '%"></div></div> <span style="font-size:10px;color:var(--text-dim)">' + hpPct + '%</span></td>' +
            '<td>' + pingHtml + '</td></tr>';
        });
        document.getElementById('telemPlayerBody').innerHTML = phtml;
      } else {
        document.getElementById('telemPlayerTable').style.display = 'none';
        document.getElementById('telemPlayersEmpty').style.display = '';
      }

      // Bots + AI PMC counts
      var hasBots = bots.scavs || bots.raiders || bots.rogues || bots.aiPmcs || bots.totalAI;
      if (hasBots) {
        document.getElementById('telemBotsInner').style.display = '';
        document.getElementById('telemBotsEmpty').style.display = 'none';

        document.getElementById('telemPmcs').innerHTML = formatAliveDeadCount(bots.aiPmcs);
        document.getElementById('telemScavs').innerHTML = formatAliveDeadCount(bots.scavs);
        document.getElementById('telemRaiders').innerHTML = formatAliveDeadCount(bots.raiders);
        document.getElementById('telemRogues').innerHTML = formatAliveDeadCount(bots.rogues);
        document.getElementById('telemTotalAI').innerHTML = formatAliveDeadCount(bots.totalAI);

        // Bosses — always visible
        var bosses = bots.bosses || [];
        if (bosses.length > 0) {
          var bossHtml = '';
          bosses.forEach(function(b) {
            var cls = b.alive ? 'boss-alive' : 'boss-dead';
            bossHtml += '<span class="telem-boss-tag ' + cls + '">' + escH(b.name) + '</span>';
          });
          document.getElementById('telemBossList').innerHTML = bossHtml;
        } else {
          document.getElementById('telemBossList').innerHTML = '<span style="color:var(--text-dim);font-size:11px">None</span>';
        }
      } else {
        document.getElementById('telemBotsInner').style.display = 'none';
        document.getElementById('telemBotsEmpty').style.display = '';
      }

      // Combat stats panel
      renderCombatStats(damageStats);
    }).catch(function(e) {
      console.error('Telemetry current error:', e);
    });
  }

  function loadKillFeed() {
    api('telemetry/kill-feed').then(function(d) {
      var kills = d.kills || [];
      _cachedKillFeed = kills; // Cache for player kill count derivation
      var isLive = d.isLive;
      var countEl = document.getElementById('telemKillCount');
      if (kills.length === 0) {
        countEl.textContent = '';
      } else if (isLive) {
        countEl.textContent = kills.length + ' kills';
      } else {
        countEl.textContent = 'Last Raid \u2014 ' + kills.length + ' kills';
      }
      var feed = document.getElementById('telemKillFeed');
      if (kills.length === 0) {
        feed.innerHTML = '<div class="telem-no-data">No kills recorded yet</div>';
        return;
      }
      var html = '';
      kills.forEach(function(k) {
        var ts = new Date(k.timestamp);
        var timeStr = ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        var victimCls = actorClass(k.victim.type);
        var hs = k.isHeadshot ? ' <span class="telem-headshot">HS</span>' : '';
        var dist = k.distance > 0 ? Math.round(k.distance) + 'm' : '';
        var bodyPart = (k.bodyPart && k.bodyPart !== 'None' && k.bodyPart !== 'Unknown') ? k.bodyPart : '';

        // Color-coded border based on victim type
        var borderCls = '';
        if (k.victim.type === 'pmc') borderCls = ' kill-border-pmc';
        else if (k.victim.type === 'boss') borderCls = ' kill-border-boss';
        else if (k.victim.type === 'raider' || k.victim.type === 'rogue') borderCls = ' kill-border-raider';

        // Handle unknown/environmental deaths
        var killerHtml = '';
        var weaponHtml = '';
        if (!k.killer.name && !k.weaponName) {
          killerHtml = '<span style="color:var(--text-muted);font-style:italic">KIA</span>';
        } else {
          var killerCls = actorClass(k.killer.type);
          killerHtml = '<span class="telem-kill-name ' + killerCls + '">' + escH(k.killer.name || 'Unknown') + '</span>';
          if (k.weaponName) {
            weaponHtml = ' <span class="telem-kill-weapon">[' + escH(k.weaponName) + ']</span>';
          }
        }

        // Build meta info
        var metaParts = [];
        if (bodyPart) metaParts.push(bodyPart);
        var metaHtml = metaParts.length > 0 ? ' <span class="telem-kill-meta">(' + metaParts.join(', ') + ')</span>' : '';

        html += '<div class="telem-kill-entry' + borderCls + '">' +
          '<span class="telem-kill-time">' + timeStr + '</span>' +
          '<span class="telem-kill-detail">' +
            killerHtml +
            '<span class="telem-kill-arrow"> \u2192 </span>' +
            weaponHtml + ' ' +
            '<span class="telem-kill-name ' + victimCls + '">' + escH(k.victim.name) + '</span>' +
            hs + metaHtml +
          '</span>' +
          (dist ? '<span class="telem-kill-dist">' + dist + '</span>' : '') +
          '</div>';
      });
      feed.innerHTML = html;
    }).catch(function(e) {
      console.error('Kill feed error:', e);
    });
  }

  function loadRaidHistory() {
    api('telemetry/raid-history').then(function(d) {
      var raids = d.raids || [];
      var countEl = document.getElementById('telemHistoryCount');
      countEl.textContent = raids.length > 0 ? raids.length + ' raids' : '';
      var body = document.getElementById('telemHistoryBody');
      if (raids.length === 0) {
        body.innerHTML = '<tr><td colspan="8" class="telem-no-data">No raid history yet</td></tr>';
        return;
      }
      var html = '';
      raids.forEach(function(r, idx) {
        var ts = new Date(r.timestamp);
        var dateStr = ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        var bossHtml = '';
        (r.bosses || []).forEach(function(b) {
          var cls = b.alive ? 'boss-alive' : 'boss-dead';
          bossHtml += '<span class="telem-boss-tag ' + cls + '" style="font-size:9px;padding:1px 5px">' + escH(b.name) + '</span> ';
        });
        if (!bossHtml) bossHtml = '<span style="color:var(--text-muted)">--</span>';
        html += '<tr onclick="toggleRaidDetail(\'' + escH(r.id) + '\', this)" data-raid-id="' + escH(r.id) + '">' +
          '<td style="color:var(--accent)">' + escH(r.mapName || mapDisplayName(r.map)) + '</td>' +
          '<td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">' + dateStr + '</td>' +
          '<td>' + formatSeconds(r.duration) + '</td>' +
          '<td>' + r.playerCount + '</td>' +
          '<td style="color:var(--success-bright)">' + r.survived + '</td>' +
          '<td>' + r.totalKills + '</td>' +
          '<td style="color:var(--error-bright)">' + (r.totalDeaths || 0) + '</td>' +
          '<td>' + bossHtml + '</td></tr>' +
          '<tr class="telem-history-detail-row" style="display:none"><td colspan="8"><div class="telem-history-detail" id="raidDetail-' + escH(r.id) + '"><div class="telem-no-data">Loading...</div></div></td></tr>';
      });
      body.innerHTML = html;
    }).catch(function(e) {
      console.error('Raid history error:', e);
    });
  }

  window.toggleRaidDetail = function(raidId, rowEl) {
    var detailRow = rowEl.nextElementSibling;
    if (!detailRow) return;
    var isOpen = detailRow.style.display !== 'none';
    if (isOpen) {
      detailRow.style.display = 'none';
      return;
    }
    detailRow.style.display = '';
    var detail = document.getElementById('raidDetail-' + raidId);
    if (detail.dataset.loaded) return;
    api('telemetry/raid-history/' + raidId).then(function(d) {
      detail.dataset.loaded = '1';
      var html = '';

      // Summary stats bar
      if (d.summary) {
        html += '<div class="telem-history-sub">' +
          '<div class="dash-stat"><span class="dash-stat-label">Duration</span><span class="dash-stat-value sm">' + formatSeconds(d.summary.duration) + '</span></div>' +
          '<div class="dash-stat"><span class="dash-stat-label">Players</span><span class="dash-stat-value sm">' + d.summary.playerCount + '</span></div>' +
          '<div class="dash-stat"><span class="dash-stat-label">Survived</span><span class="dash-stat-value sm" style="color:var(--success-bright)">' + d.summary.survived + '</span></div>' +
          '<div class="dash-stat"><span class="dash-stat-label">Kills</span><span class="dash-stat-value sm">' + d.summary.totalKills + '</span></div>' +
          '<div class="dash-stat"><span class="dash-stat-label">Deaths</span><span class="dash-stat-value sm" style="color:var(--error-bright)">' + (d.summary.totalDeaths || 0) + '</span></div>' +
          '</div>';
      }

      // Boss status
      if (d.summary && d.summary.bosses && d.summary.bosses.length > 0) {
        html += '<div style="margin-bottom:12px">';
        d.summary.bosses.forEach(function(b) {
          var cls = b.alive ? 'boss-alive' : 'boss-dead';
          var killedByStr = (!b.alive && b.killedBy) ? ' (killed by ' + escH(b.killedBy) + ')' : '';
          html += '<span class="telem-boss-tag ' + cls + '">' + escH(b.name) + killedByStr + '</span> ';
        });
        html += '</div>';
      }

      // Player Scoreboard — sorted by kills descending
      if (d.players && d.players.length > 0) {
        var sorted = d.players.slice().sort(function(a, b) { return (b.kills || 0) - (a.kills || 0); });
        html += '<table class="player-scoreboard">' +
          '<thead><tr>' +
          '<th>Player</th><th>Side</th><th>Outcome</th><th>Kills</th><th>HS</th>' +
          '<th>Damage</th><th>Armor</th><th>Accuracy</th><th>Longest</th>' +
          '<th>XP</th><th>Extract</th>' +
          '</tr></thead><tbody>';
        sorted.forEach(function(p) {
          var hasEnhanced = p.hits > 0 || p.ammoUsed > 0 || p.damageDealt > 0 || p.headshots > 0;
          var accPct = hasEnhanced && p.ammoUsed > 0 ? Math.round((p.accuracy || 0) * 100) + '%' : '--';
          var dmg = p.damageDealt > 0 ? p.damageDealt : '--';
          var armDmg = p.armorDamage > 0 ? p.armorDamage : '--';
          var hs = hasEnhanced ? (p.headshots || 0) : '--';
          var longest = p.longestKill > 0 ? Math.round(p.longestKill) + 'm' : '--';
          var sideLabel = (p.side || '').toUpperCase();
          var lvl = p.level > 0 ? ' <span style="color:var(--text-muted);font-size:10px">Lv' + p.level + '</span>' : '';

          // XP tooltip with breakdown
          var xpVal = p.xpEarned > 0 ? p.xpEarned : '--';
          var xpTitle = '';
          if (p.xpEarned > 0) {
            var parts = [];
            if (p.xpKill) parts.push('Kill: ' + p.xpKill);
            if (p.xpKillStreak) parts.push('Streak: ' + p.xpKillStreak);
            if (p.xpDamage) parts.push('Damage: ' + p.xpDamage);
            if (p.xpLooting) parts.push('Loot: ' + p.xpLooting);
            if (p.xpExitStatus) parts.push('Extract: ' + p.xpExitStatus);
            if (p.xpBodyPart) parts.push('Bodypart: ' + p.xpBodyPart);
            if (parts.length > 0) xpTitle = ' title="' + escH(parts.join(' | ')) + '"';
          }

          html += '<tr>' +
            '<td style="color:var(--accent);font-weight:600">' + escH(p.name) + lvl + '</td>' +
            '<td class="num" style="font-size:10px;color:var(--text-muted)">' + sideLabel + '</td>' +
            '<td>' + outcomeBadge(p.outcome) + '</td>' +
            '<td class="num" style="font-weight:700">' + (p.kills || 0) + '</td>' +
            '<td class="num">' + hs + '</td>' +
            '<td class="num">' + dmg + '</td>' +
            '<td class="num">' + armDmg + '</td>' +
            '<td class="num">' + accPct + '</td>' +
            '<td class="num">' + longest + '</td>' +
            '<td class="num"' + xpTitle + ' style="cursor:' + (xpTitle ? 'help' : 'default') + '">' + xpVal + '</td>' +
            '<td style="color:var(--text-dim);font-size:10px">' + escH(p.extractPoint || '--') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
      }

      // Combat Stats (body part chart if available)
      if (d.damageStats && d.damageStats.totalHits > 0) {
        var ds = d.damageStats;
        var hsPct = ds.totalHits > 0 ? Math.round((ds.headshotCount / ds.totalHits) * 100) : 0;
        html += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-family:var(--font-mono);margin-bottom:6px">Combat Stats</div>';
        html += '<div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:8px;font-family:var(--font-mono);font-size:11px">' +
          '<span>Hits: <strong>' + ds.totalHits + '</strong></span>' +
          '<span>Headshots: <strong>' + ds.headshotCount + '</strong> (' + hsPct + '%)</span>' +
          '<span>Damage: <strong>' + ds.totalDamageDealt + '</strong></span>' +
          '<span>Longest: <strong>' + Math.round(ds.longestShot) + 'm</strong></span>' +
          '<span>Avg: <strong>' + Math.round(ds.avgDistance) + 'm</strong></span>' +
          '</div>';
        html += renderBodyPartChart(ds.bodyParts);
      }

      // Kill Timeline for this raid
      if (d.kills && d.kills.length > 0) {
        html += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-family:var(--font-mono);margin:12px 0 4px">Kill Timeline (' + d.kills.length + ')</div>';
        html += '<div style="max-height:300px;overflow-y:auto">';
        d.kills.forEach(function(k) {
          var killerCls = actorClass(k.killer.type);
          var victimCls = actorClass(k.victim.type);
          var hs = k.isHeadshot ? ' <span class="telem-headshot">HS</span>' : '';
          var dist = k.distance > 0 ? Math.round(k.distance) + 'm' : '';
          var bodyPart = (k.bodyPart && k.bodyPart !== 'None' && k.bodyPart !== 'Unknown') ? k.bodyPart : '';
          var meta = [];
          if (bodyPart) meta.push(bodyPart);
          var metaHtml = meta.length > 0 ? ' <span class="telem-kill-meta">(' + meta.join(', ') + ')</span>' : '';

          var borderCls = '';
          if (k.victim.type === 'pmc') borderCls = ' kill-border-pmc';
          else if (k.victim.type === 'boss') borderCls = ' kill-border-boss';

          var killerHtml = '';
          var weaponHtml = '';
          if (!k.killer.name && !k.weaponName) {
            killerHtml = '<span style="color:var(--text-muted);font-style:italic">KIA</span>';
          } else {
            killerHtml = '<span class="telem-kill-name ' + killerCls + '">' + escH(k.killer.name || 'Unknown') + '</span>';
            if (k.weaponName) weaponHtml = ' <span class="telem-kill-weapon">[' + escH(k.weaponName) + ']</span>';
          }

          html += '<div class="telem-kill-entry' + borderCls + '">' +
            '<span class="telem-kill-detail">' +
              killerHtml + '<span class="telem-kill-arrow"> \u2192 </span>' +
              weaponHtml + ' ' +
              '<span class="telem-kill-name ' + victimCls + '">' + escH(k.victim.name) + '</span>' +
              hs + metaHtml +
            '</span>' +
            (dist ? '<span class="telem-kill-dist">' + dist + '</span>' : '') +
            '</div>';
        });
        html += '</div>';
      }

      detail.innerHTML = html || '<div class="telem-no-data">No detail available</div>';
    }).catch(function(e) {
      detail.innerHTML = '<div class="telem-no-data">Failed to load detail</div>';
    });
  };

  window.loadActivity = function() {
    var typeFilter = document.getElementById('activityTypeFilter').value;
    var params = new URLSearchParams();
    params.set('limit', ACTIVITY_PAGE);
    params.set('offset', activityOffset);
    if (typeFilter) params.set('type', typeFilter);
    api('dashboard/activity?' + params.toString()).then(function(d) {
      activityTotal = d.total;
      var body = document.getElementById('activityBody');
      if (!d.entries || d.entries.length === 0) {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;color:var(--text-muted)">No activity recorded yet</td></tr>';
        document.getElementById('activityPagination').style.display = 'none';
        return;
      }
      body.innerHTML = d.entries.map(function(e) {
        var ts = new Date(e.timestamp);
        return '<tr>' +
          '<td style="white-space:nowrap;font-family:var(--font-mono);font-size:11px">' + ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString() + '</td>' +
          '<td><span class="activity-badge ' + escH(e.type) + '">' + escH(e.type) + '</span></td>' +
          '<td>' + escH(e.adminName) + '</td>' +
          '<td style="color:var(--text)">' + escH(e.details) + '</td></tr>';
      }).join('');
      if (activityTotal > ACTIVITY_PAGE) {
        var pag = document.getElementById('activityPagination');
        pag.style.display = 'flex';
        var page = Math.floor(activityOffset / ACTIVITY_PAGE) + 1;
        var totalPages = Math.ceil(activityTotal / ACTIVITY_PAGE);
        document.getElementById('activityPageInfo').textContent = 'Page ' + page + ' / ' + totalPages;
        document.getElementById('activityPrevBtn').disabled = activityOffset === 0;
        document.getElementById('activityNextBtn').disabled = activityOffset + ACTIVITY_PAGE >= activityTotal;
      } else {
        document.getElementById('activityPagination').style.display = 'none';
      }
    }).catch(function(e) { console.error('Activity error:', e); });
  };

  window.activityPrev = function() { activityOffset = Math.max(0, activityOffset - ACTIVITY_PAGE); loadActivity(); };
  window.activityNext = function() { if (activityOffset + ACTIVITY_PAGE < activityTotal) { activityOffset += ACTIVITY_PAGE; loadActivity(); } };

  // Console
  function pollConsole() {
    if (consoleCollapsed) return;
    api('console?since=' + encodeURIComponent(consoleSince)).then(function(d) {
      if (d.entries && d.entries.length > 0) {
        allConsoleEntries = allConsoleEntries.concat(d.entries);
        // Cap buffer
        if (allConsoleEntries.length > 1000) allConsoleEntries = allConsoleEntries.slice(-500);
        consoleSince = d.entries[d.entries.length - 1].timestamp;
        renderConsole();
      }
      document.getElementById('consoleCount').textContent = '(' + allConsoleEntries.length + ')';
    }).catch(function(){});
  }

  function loadConsoleHistory() {
    api('console?lines=200').then(function(d) {
      if (d.entries && d.entries.length > 0) {
        allConsoleEntries = d.entries;
        consoleSince = d.entries[d.entries.length - 1].timestamp;
        renderConsole();
        document.getElementById('consoleCount').textContent = '(' + allConsoleEntries.length + ')';
      }
    }).catch(function(){});
  }

  function renderConsole() {
    var body = document.getElementById('consoleBody');
    var q = consoleSearchQuery.toLowerCase();
    var html = '';
    var shown = 0;
    for (var i = 0; i < allConsoleEntries.length; i++) {
      var e = allConsoleEntries[i];
      var lvl = (e.level || 'info').toLowerCase();
      if (!consoleFilters[lvl]) continue;
      var msg = e.message || '';
      if (q && msg.toLowerCase().indexOf(q) === -1 && (e.source || '').toLowerCase().indexOf(q) === -1) continue;
      var ts = new Date(e.timestamp);
      var timeStr = ts.toLocaleTimeString();
      html += '<div class="console-line level-' + lvl + '">' +
        '<span class="ts">' + timeStr + '</span>' +
        (e.source ? '<span class="src">[' + escH(e.source) + ']</span>' : '') +
        '<span class="msg">' + escH(msg) + '</span></div>';
      shown++;
    }
    body.innerHTML = html || '<div style="padding:24px;text-align:center;color:var(--text-muted)">No console output</div>';
    // Auto-scroll
    var isNearBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 60;
    if (isNearBottom) body.scrollTop = body.scrollHeight;
    // Show jump button if not at bottom
    var jump = document.getElementById('consoleJump');
    if (body.scrollHeight > body.clientHeight + 80 && !isNearBottom) {
      jump.style.display = 'block';
    } else {
      jump.style.display = 'none';
    }
  }

  window.toggleConsole = function() {
    consoleCollapsed = !consoleCollapsed;
    document.getElementById('consoleBody').classList.toggle('collapsed', consoleCollapsed);
    document.getElementById('consoleSearchWrap').style.display = consoleCollapsed ? 'none' : 'block';
    document.getElementById('consoleJump').style.display = 'none';
    document.getElementById('consoleToggleIcon').innerHTML = consoleCollapsed ? '&#x25B6;' : '&#x25BC;';
    if (!consoleCollapsed) pollConsole();
  };

  window.toggleConsoleFilter = function(btn) {
    var lvl = btn.dataset.level;
    consoleFilters[lvl] = !consoleFilters[lvl];
    btn.classList.toggle('active', consoleFilters[lvl]);
    renderConsole();
  };

  window.filterConsole = function() {
    consoleSearchQuery = document.getElementById('consoleSearchInput').value;
    renderConsole();
  };

  window.scrollConsoleBottom = function() {
    var body = document.getElementById('consoleBody');
    body.scrollTop = body.scrollHeight;
    document.getElementById('consoleJump').style.display = 'none';
  };

  // ── Log Popout Window ──
  window.openLogPopout = function() {
    var popout = window.open('', 'cc_log_popout', 'width=1400,height=800,resizable=yes,scrollbars=no');
    if (!popout) { toast('Popout blocked — allow popups for this site', 'error'); return; }

    var apiBase = location.origin + '/zslayer/cc/';
    var headers = { 'X-Session-Id': sessionId, 'X-Password': ccPassword };

    popout.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Command Center — Logs</title>' +
    '<style>' +
      '@import url("https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap");' +
      '*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }' +
      'body { font-family: "Rajdhani", sans-serif; background: #080808; color: #c8bfa8; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }' +
      '::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-track { background: #0c0c0c; } ::-webkit-scrollbar-thumb { background: #2a2620; border-radius: 3px; }' +
      '.pop-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: #141310; border-bottom: 1px solid #2a2620; flex-shrink: 0; }' +
      '.pop-header-title { font-family: "Share Tech Mono", monospace; font-size: 12px; color: #c8aa6e; letter-spacing: 2px; text-transform: uppercase; }' +
      '.pop-header-status { font-family: "Share Tech Mono", monospace; font-size: 10px; color: #6a6050; }' +
      '.pop-panels { display: flex; flex: 1; overflow: hidden; }' +
      '.pop-panel { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #2a2620; overflow: hidden; }' +
      '.pop-panel:last-child { border-right: none; }' +
      '.pop-panel-header { display: flex; align-items: center; justify-content: space-between; padding: 6px 14px; background: #1c1b17; border-bottom: 1px solid #1f1d18; flex-shrink: 0; }' +
      '.pop-panel-title { font-family: "Share Tech Mono", monospace; font-size: 11px; color: #6a6050; text-transform: uppercase; letter-spacing: 1.5px; }' +
      '.pop-panel-count { font-family: "Share Tech Mono", monospace; font-size: 10px; color: #4a4438; }' +
      '.pop-body { flex: 1; overflow-y: auto; padding: 6px 14px; font-size: 12px; font-family: "Share Tech Mono", monospace; line-height: 1.6; }' +
      '.log-line { white-space: pre-wrap; word-break: break-all; }' +
      '.log-line .ts { color: #4a4438; margin-right: 8px; }' +
      '.log-line .src { color: #a08a50; margin-right: 6px; }' +
      '.log-line.level-info .msg { color: #6a6050; }' +
      '.log-line.level-success .msg { color: #6aad6a; }' +
      '.log-line.level-warning .msg { color: #c87a3e; }' +
      '.log-line.level-error .msg { color: #c45050; }' +
      '.log-line.level-debug .msg { color: #4a4438; }' +
      '.pop-empty { padding: 24px; text-align: center; color: #4a4438; font-style: italic; }' +
    '</style></head><body>' +
    '<div class="pop-header">' +
      '<span class="pop-header-title">Command Center — Logs</span>' +
      '<span class="pop-header-status" id="popStatus">Connecting...</span>' +
    '</div>' +
    '<div class="pop-panels">' +
      '<div class="pop-panel">' +
        '<div class="pop-panel-header"><span class="pop-panel-title">Server Console</span><span class="pop-panel-count" id="popServerCount"></span></div>' +
        '<div class="pop-body" id="popServerBody"><div class="pop-empty">Loading...</div></div>' +
      '</div>' +
      '<div class="pop-panel">' +
        '<div class="pop-panel-header"><span class="pop-panel-title">Headless Client</span><span class="pop-panel-count" id="popHeadlessCount"></span></div>' +
        '<div class="pop-body" id="popHeadlessBody"><div class="pop-empty">Loading...</div></div>' +
      '</div>' +
    '</div>' +
    '<script>' +
    'var apiBase = ' + JSON.stringify(apiBase) + ';' +
    'var headers = ' + JSON.stringify(headers) + ';' +
    'var serverEntries = [], headlessEntries = [];' +
    'var serverSince = new Date().toISOString(), headlessSince = new Date().toISOString();' +
    'var initialLoad = true;' +
    '' +
    'function escH(s) { return s ? s.replace(/&/g,"\\&amp;").replace(/</g,"\\&lt;").replace(/>/g,"\\&gt;") : ""; }' +
    '' +
    'function renderEntries(entries, bodyId, countId) {' +
    '  var body = document.getElementById(bodyId);' +
    '  var html = "";' +
    '  for (var i = 0; i < entries.length; i++) {' +
    '    var e = entries[i];' +
    '    var lvl = (e.level || "info").toLowerCase();' +
    '    var ts = new Date(e.timestamp).toLocaleTimeString();' +
    '    html += \'<div class="log-line level-\' + lvl + \'">\' +' +
    '      \'<span class="ts">\' + ts + \'</span>\' +' +
    '      (e.source ? \'<span class="src">[\' + escH(e.source) + \']</span>\' : "") +' +
    '      \'<span class="msg">\' + escH(e.message) + \'</span></div>\';' +
    '  }' +
    '  var wasBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 60;' +
    '  body.innerHTML = html || \'<div class="pop-empty">No output</div>\';' +
    '  document.getElementById(countId).textContent = "(" + entries.length + ")";' +
    '  if (wasBottom) body.scrollTop = body.scrollHeight;' +
    '}' +
    '' +
    'function poll() {' +
    '  var sq = initialLoad ? "lines=500" : "since=" + encodeURIComponent(serverSince);' +
    '  var hq = initialLoad ? "lines=500" : "since=" + encodeURIComponent(headlessSince);' +
    '  Promise.all([' +
    '    fetch(apiBase + "console?" + sq, { headers: headers }).then(function(r){ return r.json(); }).catch(function(){ return null; }),' +
    '    fetch(apiBase + "headless-console?" + hq, { headers: headers }).then(function(r){ return r.json(); }).catch(function(){ return null; })' +
    '  ]).then(function(results) {' +
    '    var s = results[0], h = results[1];' +
    '    document.getElementById("popStatus").textContent = "Connected — polling every 2s";' +
    '    if (s && s.entries && s.entries.length > 0) {' +
    '      if (initialLoad) serverEntries = s.entries; else serverEntries = serverEntries.concat(s.entries);' +
    '      if (serverEntries.length > 1000) serverEntries = serverEntries.slice(-500);' +
    '      serverSince = s.entries[s.entries.length - 1].timestamp;' +
    '      renderEntries(serverEntries, "popServerBody", "popServerCount");' +
    '    } else if (initialLoad) { renderEntries([], "popServerBody", "popServerCount"); }' +
    '    if (h && h.configured !== false && h.entries && h.entries.length > 0) {' +
    '      if (initialLoad) headlessEntries = h.entries; else headlessEntries = headlessEntries.concat(h.entries);' +
    '      if (headlessEntries.length > 1000) headlessEntries = headlessEntries.slice(-500);' +
    '      headlessSince = h.entries[h.entries.length - 1].timestamp;' +
    '      renderEntries(headlessEntries, "popHeadlessBody", "popHeadlessCount");' +
    '    } else if (h && h.configured === false) {' +
    '      document.getElementById("popHeadlessBody").innerHTML = \'<div class="pop-empty">Headless log not configured</div>\';' +
    '    } else if (initialLoad) { renderEntries([], "popHeadlessBody", "popHeadlessCount"); }' +
    '    initialLoad = false;' +
    '  }).catch(function() {' +
    '    document.getElementById("popStatus").textContent = "Connection error";' +
    '  });' +
    '}' +
    '' +
    'poll();' +
    'setInterval(poll, 2000);' +
    '<\/script></body></html>');
    popout.document.close();
  };

  // ── Map Popout Window ──
  var _mapPopoutWindow = null;
  var _mapPopoutCheckTimer = null;

  function setMainMapMinimized(minimized) {
    var panel = document.getElementById('liveMapPanel');
    if (!panel) return;
    var wrap = document.getElementById('mapCanvasWrap');
    var legend = document.querySelector('.live-map-legend');
    var placeholder = document.getElementById('mapPopoutPlaceholder');
    if (minimized) {
      if (wrap) wrap.style.display = 'none';
      if (legend) legend.style.display = 'none';
      if (!placeholder) {
        placeholder = document.createElement('div');
        placeholder.id = 'mapPopoutPlaceholder';
        placeholder.style.cssText = 'padding:20px;text-align:center;color:#6a6050;font-size:12px;font-family:var(--font-mono)';
        placeholder.innerHTML = 'Map is popped out <button class="btn-sm" onclick="closeMapPopout()" style="margin-left:8px;padding:2px 8px;font-size:11px">Restore</button>';
        panel.appendChild(placeholder);
      }
    } else {
      if (wrap) wrap.style.display = '';
      if (legend) legend.style.display = '';
      if (!placeholder) placeholder = document.getElementById('mapPopoutPlaceholder');
      if (placeholder) placeholder.remove();
    }
  }

  window.closeMapPopout = function() {
    if (_mapPopoutWindow && !_mapPopoutWindow.closed) _mapPopoutWindow.close();
    _mapPopoutWindow = null;
    if (_mapPopoutCheckTimer) { clearInterval(_mapPopoutCheckTimer); _mapPopoutCheckTimer = null; }
    setMainMapMinimized(false);
  };

  window.openMapPopout = function() {
    if (_mapPopoutWindow && !_mapPopoutWindow.closed) { _mapPopoutWindow.focus(); return; }

    var popApiBase = location.origin + '/zslayer/cc/';
    var popHeaders = JSON.stringify({ 'X-Session-Id': sessionId, 'X-Password': ccPassword });
    var popSessionId = JSON.stringify(sessionId);
    var popMapConfig = JSON.stringify(MAP_CONFIG);
    var popMapColors = JSON.stringify(MAP_COLORS);

    var html = [
      '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Command Center — Live Map</title>',
      '<style>',
      '@import url("https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap");',
      '*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }',
      'body { font-family: "Rajdhani", sans-serif; background: #080808; color: #c8bfa8; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }',
      '::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-track { background: #0c0c0c; } ::-webkit-scrollbar-thumb { background: #2a2620; border-radius: 3px; }',
      '.pop-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: #141310; border-bottom: 1px solid #2a2620; flex-shrink: 0; }',
      '.pop-header-title { font-family: "Share Tech Mono", monospace; font-size: 12px; color: #c8aa6e; letter-spacing: 2px; text-transform: uppercase; }',
      '.pop-header-status { font-family: "Share Tech Mono", monospace; font-size: 10px; color: #6a6050; }',
      '.pop-controls { display: flex; gap: 14px; align-items: center; padding: 6px 16px; background: #111; border-bottom: 1px solid #1f1d18; flex-shrink: 0; font-size: 11px; flex-wrap: wrap; }',
      '.pop-controls label { display: flex; align-items: center; gap: 4px; color: #8a7e6a; }',
      '.pop-controls select, .pop-controls input[type=range] { background: #1a1a1a; color: #c8bfa8; border: 1px solid #2a2620; border-radius: 3px; font-size: 10px; }',
      '.pop-canvas-wrap { flex: 1; position: relative; overflow: hidden; }',
      '.pop-canvas-wrap canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }',
      '.pop-legend { display: flex; gap: 14px; padding: 6px 16px; background: #111; border-top: 1px solid #1f1d18; flex-shrink: 0; font-size: 10px; font-family: "Share Tech Mono", monospace; color: #6a6050; flex-wrap: wrap; }',
      '.pop-legend-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }',
      '</style></head><body>',
      '<div class="pop-header">',
      '  <span class="pop-header-title">Command Center — Live Map</span>',
      '  <span class="pop-header-status" id="popStatus">Connecting...</span>',
      '</div>',
      '<div class="pop-controls">',
      '  <label>Layer: <select id="popLayerSelect"><option value="0">Ground</option></select></label>',
      '  <label>Refresh: <input type="range" id="popRefreshSlider" min="-1.301" max="1" step="0.01" value="0"> <span id="popRefreshLabel">1.0s</span></label>',
      '  <label><input type="checkbox" id="popShowNames" checked> Names</label>',
      '  <label><input type="checkbox" id="popShowDead"> Dead</label>',
      '  <label><input type="checkbox" id="popFollowPlayer" checked> Follow</label>',
      '</div>',
      '<div class="pop-canvas-wrap" id="popCanvasWrap"><canvas id="popCanvas"></canvas></div>',
      '<div class="pop-legend">',
      '  <span><span class="pop-legend-dot" style="background:#4a7c59"></span>PMC</span>',
      '  <span><span class="pop-legend-dot" style="background:#c45050"></span>AI PMC</span>',
      '  <span><span class="pop-legend-dot" style="background:#c8aa6e"></span>Scav</span>',
      '  <span><span class="pop-legend-dot" style="background:#c87a3e"></span>Boss</span>',
      '  <span><span class="pop-legend-dot" style="background:#b06030"></span>Raider/Rogue</span>',
      '  <span><span class="pop-legend-dot" style="background:#6e4a7c"></span>Follower</span>',
      '  <span><span class="pop-legend-dot" style="background:rgba(255,255,255,0.25)"></span>Dead</span>',
      '</div>',
      '<script>',
      'var apiBase = ' + JSON.stringify(popApiBase) + ';',
      'var headers = ' + popHeaders + ';',
      'var sessionId = ' + popSessionId + ';',
      'var MAP_CONFIG = ' + popMapConfig + ';',
      'var MAP_COLORS = ' + popMapColors + ';',
      'var _positions = [], _currentMap = "", _mapConfig = null, _zoom = 1, _panX = 0, _panY = 0;',
      'var _dragging = false, _dragStart = {x:0,y:0}, _panStart = {x:0,y:0}, _selectedLayer = "0";',
      'var _followPlayer = true, _refreshMs = 1000, _refreshTimer = null, _imgCache = {};',
      '',
      'function gameToMap(gx, gz, cfg) {',
      '  var rad = cfg.rotation * Math.PI / 180;',
      '  return { x: gx * Math.cos(rad) - gz * Math.sin(rad), y: gx * Math.sin(rad) + gz * Math.cos(rad) };',
      '}',
      '',
      'function drawIconShape(ctx, x, y, type, color, r, alpha) {',
      '  ctx.globalAlpha = alpha;',
      '  switch (type) {',
      '    case "pmc": _drawChevron(ctx,x,y,r,color); break;',
      '    case "aipmc": _drawDiamond(ctx,x,y,r,color); break;',
      '    case "boss": _drawSkull(ctx,x,y,r,color); break;',
      '    case "raider": case "rogue": _drawTriangle(ctx,x,y,r,color); break;',
      '    case "follower": _drawDiamond(ctx,x,y,r*0.8,color); break;',
      '    default: _drawCircle(ctx,x,y,r,color); break;',
      '  }',
      '  ctx.globalAlpha = 1;',
      '}',
      'function _drawChevron(ctx,x,y,r,c) {',
      '  ctx.beginPath(); ctx.moveTo(x,y-r); ctx.lineTo(x+r*0.8,y+r*0.4); ctx.lineTo(x+r*0.35,y+r*0.1);',
      '  ctx.lineTo(x,y+r*0.55); ctx.lineTo(x-r*0.35,y+r*0.1); ctx.lineTo(x-r*0.8,y+r*0.4); ctx.closePath();',
      '  ctx.fillStyle="rgba(0,0,0,0.45)"; ctx.fill(); ctx.fillStyle=c; ctx.fill();',
      '  ctx.strokeStyle="rgba(255,255,255,0.25)"; ctx.lineWidth=0.8; ctx.stroke();',
      '}',
      'function _drawDiamond(ctx,x,y,r,c) {',
      '  ctx.beginPath(); ctx.moveTo(x,y-r); ctx.lineTo(x+r,y); ctx.lineTo(x,y+r); ctx.lineTo(x-r,y); ctx.closePath();',
      '  ctx.fillStyle="rgba(0,0,0,0.45)"; ctx.fill(); ctx.fillStyle=c; ctx.fill();',
      '  ctx.strokeStyle="rgba(255,255,255,0.2)"; ctx.lineWidth=0.8; ctx.stroke();',
      '}',
      'function _drawTriangle(ctx,x,y,r,c) {',
      '  ctx.beginPath(); ctx.moveTo(x,y-r); ctx.lineTo(x+r*0.866,y+r*0.5); ctx.lineTo(x-r*0.866,y+r*0.5); ctx.closePath();',
      '  ctx.fillStyle="rgba(0,0,0,0.45)"; ctx.fill(); ctx.fillStyle=c; ctx.fill();',
      '  ctx.strokeStyle="rgba(255,255,255,0.2)"; ctx.lineWidth=0.8; ctx.stroke();',
      '}',
      'function _drawCircle(ctx,x,y,r,c) {',
      '  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle="rgba(0,0,0,0.45)"; ctx.fill();',
      '  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=c; ctx.fill();',
      '  ctx.strokeStyle="rgba(255,255,255,0.15)"; ctx.lineWidth=0.8; ctx.stroke();',
      '}',
      'function _drawSkull(ctx,x,y,r,c) {',
      '  var cr=r*0.9;',
      '  ctx.beginPath(); ctx.ellipse(x,y-r*0.1,cr,cr*0.95,0,0,Math.PI*2); ctx.fillStyle="rgba(0,0,0,0.45)"; ctx.fill();',
      '  ctx.beginPath(); ctx.ellipse(x,y-r*0.1,cr,cr*0.95,0,0,Math.PI*2); ctx.fillStyle=c; ctx.fill();',
      '  ctx.beginPath(); ctx.moveTo(x-r*0.5,y+r*0.25);',
      '  ctx.quadraticCurveTo(x-r*0.35,y+r*0.85,x,y+r*0.75);',
      '  ctx.quadraticCurveTo(x+r*0.35,y+r*0.85,x+r*0.5,y+r*0.25);',
      '  ctx.fillStyle=c; ctx.fill();',
      '  ctx.beginPath(); ctx.ellipse(x,y-r*0.1,cr,cr*0.95,0,0,Math.PI*2);',
      '  ctx.strokeStyle="rgba(255,255,255,0.2)"; ctx.lineWidth=0.8; ctx.stroke();',
      '  var er=r*0.22; ctx.fillStyle="#0a0c0e";',
      '  ctx.beginPath(); ctx.ellipse(x-r*0.3,y-r*0.15,er,er*1.15,0,0,Math.PI*2); ctx.fill();',
      '  ctx.beginPath(); ctx.ellipse(x+r*0.3,y-r*0.15,er,er*1.15,0,0,Math.PI*2); ctx.fill();',
      '  ctx.beginPath(); ctx.moveTo(x-r*0.08,y+r*0.08); ctx.lineTo(x+r*0.08,y+r*0.08); ctx.lineTo(x,y+r*0.25); ctx.closePath(); ctx.fill();',
      '}',
      '',
      'function drawMap() {',
      '  var canvas = document.getElementById("popCanvas");',
      '  var wrap = document.getElementById("popCanvasWrap");',
      '  if (!canvas || !wrap) return;',
      '  var dpr = window.devicePixelRatio || 1;',
      '  var w = wrap.clientWidth, h = wrap.clientHeight;',
      '  canvas.width = w * dpr; canvas.height = h * dpr;',
      '  var ctx = canvas.getContext("2d");',
      '  ctx.scale(dpr, dpr);',
      '  ctx.fillStyle = "#0a0c0e"; ctx.fillRect(0, 0, w, h);',
      '  if (!_mapConfig) {',
      '    ctx.fillStyle = "#333"; ctx.font = "13px monospace"; ctx.textAlign = "center";',
      '    ctx.fillText("Waiting for raid data...", w/2, h/2);',
      '    return;',
      '  }',
      '  var cfg = _mapConfig, bounds = cfg.bounds;',
      '  var mapW = bounds.max.x - bounds.min.x, mapH = bounds.max.y - bounds.min.y;',
      '  var pad = 30;',
      '  var scale = Math.min((w - pad*2) / mapW, (h - pad*2) / mapH) * _zoom;',
      '  var mapCx = (bounds.min.x + bounds.max.x) / 2, mapCy = (bounds.min.y + bounds.max.y) / 2;',
      '  if (_followPlayer && sessionId) {',
      '    var me = _positions.find(function(p){ return p.profileId === sessionId && p.alive; });',
      '    if (me) { var mp = gameToMap(me.x, me.z, cfg); _panX = -(mp.x - mapCx) * scale; _panY = -(mp.y - mapCy) * scale; }',
      '  }',
      '  var cx = w/2 + _panX, cy = h/2 + _panY;',
      '  var imgKey = _currentMap + "_" + _selectedLayer;',
      '  var img = _imgCache[imgKey];',
      '  if (img && img.complete && img.naturalWidth > 0) {',
      '    ctx.drawImage(img, cx + (bounds.min.x - mapCx) * scale, cy + (bounds.min.y - mapCy) * scale, mapW * scale, mapH * scale);',
      '  } else {',
      '    ctx.strokeStyle = "rgba(200,170,110,0.08)"; ctx.lineWidth = 1;',
      '    for (var gx = bounds.min.x; gx <= bounds.max.x; gx += 50) {',
      '      var sx = cx + (gx - mapCx) * scale;',
      '      ctx.beginPath(); ctx.moveTo(sx, cy + (bounds.min.y - mapCy) * scale); ctx.lineTo(sx, cy + (bounds.max.y - mapCy) * scale); ctx.stroke();',
      '    }',
      '    for (var gy = bounds.min.y; gy <= bounds.max.y; gy += 50) {',
      '      var sy = cy + (gy - mapCy) * scale;',
      '      ctx.beginPath(); ctx.moveTo(cx + (bounds.min.x - mapCx) * scale, sy); ctx.lineTo(cx + (bounds.max.x - mapCx) * scale, sy); ctx.stroke();',
      '    }',
      '    ctx.strokeStyle = "rgba(200,170,110,0.15)"; ctx.lineWidth = 1;',
      '    ctx.strokeRect(cx + (bounds.min.x - mapCx) * scale, cy + (bounds.min.y - mapCy) * scale, mapW * scale, mapH * scale);',
      '    ctx.fillStyle = "rgba(200,170,110,0.3)"; ctx.font = "16px monospace"; ctx.textAlign = "center";',
      '    ctx.fillText(cfg.name, cx, cy - 10);',
      '    ctx.font = "10px monospace"; ctx.fillText("Map image not loaded", cx, cy + 10);',
      '  }',
      '  var showNames = document.getElementById("popShowNames").checked;',
      '  var showDead = document.getElementById("popShowDead").checked;',
      '  var layerZ = cfg.layers[_selectedLayer] ? cfg.layers[_selectedLayer].z : null;',
      '  _positions.forEach(function(p) {',
      '    if (!showDead && !p.alive) return;',
      '    var onLayer = true;',
      '    if (layerZ && _selectedLayer !== "0") onLayer = p.y >= layerZ[0] && p.y <= layerZ[1];',
      '    var mp = gameToMap(p.x, p.z, cfg);',
      '    var sx = cx + (mp.x - mapCx) * scale, sy = cy + (mp.y - mapCy) * scale;',
      '    var color = MAP_COLORS[p.type] || MAP_COLORS.unknown;',
      '    var alpha = p.alive ? (onLayer ? 1.0 : 0.3) : 0.25;',
      '    var radius = p.type === "boss" ? 7 : (p.type === "pmc" || p.type === "aipmc") ? 5 : p.type === "follower" ? 3.5 : 4;',
      '    drawIconShape(ctx, sx, sy, p.type, color, radius, alpha);',
      '    if (p.alive && (p.type === "pmc" || p.type === "aipmc") && p.rotation != null) {',
      '      ctx.globalAlpha = alpha; var arrowLen = radius + 6, angle = -(p.rotation - cfg.rotation) * Math.PI / 180;',
      '      ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(sx + Math.sin(angle) * arrowLen, sy - Math.cos(angle) * arrowLen);',
      '      ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke(); ctx.globalAlpha = 1;',
      '    }',
      '    if (!p.alive) { ctx.globalAlpha = 0.6; ctx.strokeStyle = "#c45050"; ctx.lineWidth = 1.5;',
      '      ctx.beginPath(); ctx.moveTo(sx-4,sy-4); ctx.lineTo(sx+4,sy+4); ctx.stroke();',
      '      ctx.beginPath(); ctx.moveTo(sx+4,sy-4); ctx.lineTo(sx-4,sy+4); ctx.stroke(); ctx.globalAlpha = 1;',
      '    }',
      '    if (showNames && p.alive && (p.type === "pmc" || p.type === "aipmc" || p.type === "boss")) {',
      '      ctx.fillStyle = color; ctx.font = "9px monospace"; ctx.textAlign = "center"; ctx.fillText(p.name, sx, sy - radius - 4);',
      '    }',
      '  });',
      '  ctx.fillStyle = "rgba(200,170,110,0.5)"; ctx.font = "bold 11px monospace"; ctx.textAlign = "center"; ctx.fillText("N", w-20, 18);',
      '  ctx.fillStyle = "rgba(200,170,110,0.3)"; ctx.font = "9px monospace";',
      '  ctx.fillText("S", w-20, h-8); ctx.fillText("W", 10, h/2+4); ctx.textAlign = "left"; ctx.fillText("E", w-14, h/2+4);',
      '  var aliveCount = _positions.filter(function(p){ return p.alive; }).length;',
      '  ctx.fillStyle = "rgba(200,170,110,0.4)"; ctx.font = "10px monospace"; ctx.textAlign = "left";',
      '  ctx.fillText(aliveCount + " alive / " + _positions.length + " total", 8, 16);',
      '}',
      '',
      'function tryLoadImg(mapId, layer) {',
      '  var key = mapId + "_" + layer; if (_imgCache[key]) return;',
      '  var fm = { bigmap:"customs", factory4_day:"factory", factory4_night:"factory", Sandbox:"ground_zero", Sandbox_high:"ground_zero",',
      '    Interchange:"interchange", laboratory:"labs", Labyrinth:"labyrinth", Lighthouse:"lighthouse",',
      '    RezervBase:"reserve", Shoreline:"shoreline", TarkovStreets:"streets", Woods:"woods" };',
      '  var prefix = fm[mapId]; if (!prefix) return;',
      '  var suffix = (prefix==="factory"||prefix==="labyrinth"||prefix==="labs") ? "layer" : "level";',
      '  var img = new Image(); img.onload = function(){ drawMap(); };',
      '  img.src = apiBase + "maps/" + prefix + "_" + suffix + "_" + layer + ".png";',
      '  _imgCache[key] = img;',
      '}',
      '',
      'function updateMap(mapId) {',
      '  if (mapId === _currentMap) return;',
      '  _currentMap = mapId; _mapConfig = MAP_CONFIG[mapId] || null;',
      '  _zoom = 1; _panX = 0; _panY = 0; _selectedLayer = "0";',
      '  if (_mapConfig) {',
      '    var sel = document.getElementById("popLayerSelect"); sel.innerHTML = "";',
      '    Object.keys(_mapConfig.layers).sort(function(a,b){ return parseInt(a)-parseInt(b); }).forEach(function(lv) {',
      '      var o = document.createElement("option"); o.value = lv;',
      '      o.textContent = lv === "0" ? "Ground" : lv === "-1" ? "Underground" : "Level " + lv;',
      '      sel.appendChild(o);',
      '    });',
      '    _selectedLayer = "" + (_mapConfig.defaultLevel || 0); sel.value = _selectedLayer;',
      '    Object.keys(_mapConfig.layers).forEach(function(lv){ tryLoadImg(mapId, lv); });',
      '  }',
      '}',
      '',
      'function poll() {',
      '  Promise.all([',
      '    fetch(apiBase + "telemetry/positions", { headers: headers }).then(function(r){ return r.json(); }).catch(function(){ return null; }),',
      '    fetch(apiBase + "telemetry/current", { headers: headers }).then(function(r){ return r.json(); }).catch(function(){ return null; })',
      '  ]).then(function(res) {',
      '    var pos = res[0], cur = res[1];',
      '    if (pos) _positions = pos;',
      '    if (cur && cur.raidActive && cur.raidState && cur.raidState.map) updateMap(cur.raidState.map);',
      '    document.getElementById("popStatus").textContent = "Connected — " + (_currentMap ? _mapConfig ? _mapConfig.name : _currentMap : "no raid");',
      '    drawMap();',
      '  }).catch(function(e) {',
      '    document.getElementById("popStatus").textContent = "Connection error: " + e.message;',
      '  });',
      '}',
      '',
      'function startPolling() { if (_refreshTimer) clearInterval(_refreshTimer); _refreshTimer = setInterval(poll, _refreshMs); poll(); }',
      '',
      'var wrap = document.getElementById("popCanvasWrap");',
      'wrap.addEventListener("wheel", function(e) { e.preventDefault(); _zoom = Math.max(0.3, Math.min(10, _zoom * (e.deltaY > 0 ? 0.9 : 1.1))); drawMap(); }, { passive: false });',
      'wrap.addEventListener("mousedown", function(e) {',
      '  if (e.button !== 0) return;',
      '  if (_followPlayer) { _followPlayer = false; document.getElementById("popFollowPlayer").checked = false; }',
      '  _dragging = true; _dragStart = { x: e.clientX, y: e.clientY }; _panStart = { x: _panX, y: _panY };',
      '});',
      'window.addEventListener("mousemove", function(e) {',
      '  if (!_dragging) return; _panX = _panStart.x + (e.clientX - _dragStart.x); _panY = _panStart.y + (e.clientY - _dragStart.y); drawMap();',
      '});',
      'window.addEventListener("mouseup", function() { _dragging = false; });',
      'document.getElementById("popLayerSelect").addEventListener("change", function() { _selectedLayer = this.value; drawMap(); });',
      'document.getElementById("popFollowPlayer").addEventListener("change", function() { _followPlayer = this.checked; if (_followPlayer) drawMap(); });',
      '',
      'var slider = document.getElementById("popRefreshSlider");',
      'var slabel = document.getElementById("popRefreshLabel");',
      'function sliderToMs(v) { return Math.round(Math.pow(10, parseFloat(v)) * 1000); }',
      'function fmtRate(ms) { return ms < 1000 ? (ms/1000).toFixed(2)+"s" : ms >= 10000 ? (ms/1000).toFixed(0)+"s" : (ms/1000).toFixed(1)+"s"; }',
      'slider.addEventListener("input", function() { _refreshMs = sliderToMs(this.value); slabel.textContent = fmtRate(_refreshMs); });',
      'slider.addEventListener("change", function() { _refreshMs = sliderToMs(this.value); slabel.textContent = fmtRate(_refreshMs); startPolling(); });',
      '',
      'window.addEventListener("resize", function() { drawMap(); });',
      'startPolling();',
      '<\/script></body></html>'
    ].join('\n');

    var blob = new Blob([html], { type: 'text/html' });
    var blobUrl = URL.createObjectURL(blob);
    var popout = window.open(blobUrl, 'cc_map_popout', 'width=1200,height=900,resizable=yes,scrollbars=no');
    if (!popout) { toast('Popout blocked — allow popups for this site', 'error'); URL.revokeObjectURL(blobUrl); return; }

    _mapPopoutWindow = popout;
    setMainMapMinimized(true);

    // Detect when popout closes to restore main map
    _mapPopoutCheckTimer = setInterval(function() {
      if (!_mapPopoutWindow || _mapPopoutWindow.closed) {
        clearInterval(_mapPopoutCheckTimer);
        _mapPopoutCheckTimer = null;
        _mapPopoutWindow = null;
        setMainMapMinimized(false);
      }
    }, 1000);
  };

  // Headless Process Manager
  var headlessAction = null; // null | 'starting' | 'stopping' | 'restarting'

  function setHeadlessBadge(state, pid) {
    var badge = document.getElementById('headlessStatusBadge');
    badge.className = 'hl-status-pill';
    if (state === 'running') {
      badge.classList.add('pill-running');
      badge.innerHTML = '● Running' + (pid ? ' <span style="color:rgba(255,255,255,0.5);font-size:10px;margin-left:4px">PID ' + pid + '</span>' : '');
    } else if (state === 'stopped') {
      badge.classList.add('pill-stopped');
      badge.textContent = '● Stopped';
    } else if (state === 'starting') {
      badge.classList.add('pill-transition');
      badge.innerHTML = '<span class="hl-spinner"></span> Starting\u2026';
    } else if (state === 'stopping') {
      badge.classList.add('pill-transition');
      badge.innerHTML = '<span class="hl-spinner"></span> Stopping\u2026';
    } else if (state === 'restarting') {
      badge.classList.add('pill-transition');
      badge.innerHTML = '<span class="hl-spinner"></span> Restarting\u2026';
    } else {
      badge.classList.add('pill-unavailable');
      badge.textContent = 'Unavailable';
    }
  }

  function setHeadlessBtnStates(state, hasProfile) {
    var btnStart = document.getElementById('btnHeadlessStart');
    var btnStop = document.getElementById('btnHeadlessStop');
    var btnRestart = document.getElementById('btnHeadlessRestart');
    if (state === 'transition') {
      btnStart.disabled = true; btnStart.classList.add('btn-disabled');
      btnStop.disabled = true; btnStop.classList.add('btn-disabled');
      btnRestart.disabled = true; btnRestart.classList.add('btn-disabled');
    } else if (state === 'running') {
      btnStart.disabled = true; btnStart.classList.add('btn-disabled');
      btnStop.disabled = false; btnStop.classList.remove('btn-disabled');
      btnRestart.disabled = false; btnRestart.classList.remove('btn-disabled');
    } else {
      btnStart.disabled = !hasProfile; btnStart.classList.toggle('btn-disabled', !hasProfile);
      btnStop.disabled = true; btnStop.classList.add('btn-disabled');
      btnRestart.disabled = true; btnRestart.classList.add('btn-disabled');
    }
  }

  function pollHeadlessStatus() {
    api('headless/status').then(function(d) {
      var card = document.getElementById('headlessManagerCard');
      card.style.display = 'block';
      var unavail = document.getElementById('headlessUnavailable');
      var controls = document.getElementById('headlessControls');
      if (!d.available) {
        unavail.style.display = 'block';
        controls.style.display = 'none';
        setHeadlessBadge('unavailable');
        return;
      }
      unavail.style.display = 'none';
      controls.style.display = 'block';

      // Badge — show transition state if action in progress, otherwise actual state
      if (headlessAction) {
        setHeadlessBadge(headlessAction);
      } else {
        setHeadlessBadge(d.running ? 'running' : 'stopped', d.pid);
      }

      // Profile name display
      var profDisplay = document.getElementById('hlProfileDisplay');
      var profName = document.getElementById('hlProfileName');
      var profIdSmall = document.getElementById('hlProfileIdSmall');
      if (d.profileName) {
        profDisplay.style.display = 'block';
        profName.textContent = d.profileName;
        profIdSmall.textContent = d.profileId;
      } else {
        profDisplay.style.display = 'none';
      }

      var info = '';
      if (d.running && d.uptime) info += 'Uptime: ' + d.uptime;
      if (d.restartCount > 0) info += (info ? '  |  ' : '') + 'Restarts: ' + d.restartCount;
      document.getElementById('headlessUptimeInfo').textContent = info;

      // Button states
      if (headlessAction) {
        setHeadlessBtnStates('transition', false);
      } else {
        setHeadlessBtnStates(d.running ? 'running' : 'stopped', !!d.profileId);
      }

      var crash = document.getElementById('headlessCrashInfo');
      if (d.lastCrashReason && !d.running) {
        crash.style.display = 'block';
        crash.textContent = d.lastCrashReason;
      } else {
        crash.style.display = 'none';
      }
      document.getElementById('hlAutoStart').checked = d.autoStart;
      document.getElementById('hlAutoRestart').checked = d.autoRestart;
      document.getElementById('hlDelay').value = d.autoStartDelaySec;
      document.getElementById('hlDelayVal').textContent = d.autoStartDelaySec + 's';
      var pid = document.getElementById('hlProfileId');
      if (document.activeElement !== pid) pid.value = d.profileId;
      var warn = document.getElementById('hlProfileWarning');
      warn.style.display = d.profileId ? 'none' : 'block';
    }).catch(function(){});
  }

  window.startHeadless = function() {
    headlessAction = 'starting';
    pollHeadlessStatus();
    api('headless/start', { method: 'POST' }).then(function(d) {
      headlessAction = null;
      if (d.running) showToast('Headless client started (PID ' + d.pid + ')', 'success');
      else showToast(d.lastCrashReason || 'Failed to start', 'error');
      pollHeadlessStatus();
    }).catch(function() { headlessAction = null; showToast('Failed to start headless', 'error'); pollHeadlessStatus(); });
  };

  window.stopHeadless = function() {
    if (!confirm('Stop the headless client?')) return;
    headlessAction = 'stopping';
    pollHeadlessStatus();
    api('headless/stop', { method: 'POST' }).then(function() {
      headlessAction = null;
      showToast('Headless client stopped', 'success');
      pollHeadlessStatus();
    }).catch(function() { headlessAction = null; showToast('Failed to stop', 'error'); pollHeadlessStatus(); });
  };

  window.restartHeadless = function() {
    headlessAction = 'restarting';
    pollHeadlessStatus();
    api('headless/restart', { method: 'POST' }).then(function(d) {
      headlessAction = null;
      if (d.running) showToast('Headless client restarted (PID ' + d.pid + ')', 'success');
      else showToast(d.lastCrashReason || 'Failed to restart', 'error');
      pollHeadlessStatus();
    }).catch(function() { headlessAction = null; showToast('Failed to restart', 'error'); pollHeadlessStatus(); });
  };

  window.saveHeadlessConfig = function() {
    var body = {
      autoStart: document.getElementById('hlAutoStart').checked,
      autoRestart: document.getElementById('hlAutoRestart').checked,
      autoStartDelaySec: parseInt(document.getElementById('hlDelay').value),
      profileId: document.getElementById('hlProfileId').value.trim()
    };
    api('headless/config', { method: 'POST', body: JSON.stringify(body) }).then(function() {
      pollHeadlessStatus();
    }).catch(function() { showToast('Failed to save config', 'error'); });
  };

  // Headless Console
  function pollHeadless() {
    if (headlessCollapsed) return;
    if (headlessConfigured === false) return;
    api('headless-console?since=' + encodeURIComponent(headlessSince)).then(function(d) {
      if (d.configured === false) {
        headlessConfigured = false;
        document.getElementById('headlessBody').innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)">Headless log path not configured &mdash; set <code>headlessLogPath</code> in config.json</div>';
        document.getElementById('headlessCount').textContent = '';
        return;
      }
      headlessConfigured = true;
      if (d.entries && d.entries.length > 0) {
        allHeadlessEntries = allHeadlessEntries.concat(d.entries);
        if (allHeadlessEntries.length > 1000) allHeadlessEntries = allHeadlessEntries.slice(-500);
        headlessSince = d.entries[d.entries.length - 1].timestamp;
        renderHeadless();
      }
      document.getElementById('headlessCount').textContent = '(' + allHeadlessEntries.length + ')';
    }).catch(function(){});
  }

  function loadHeadlessHistory() {
    api('headless-console?lines=200').then(function(d) {
      if (d.configured === false) {
        headlessConfigured = false;
        document.getElementById('headlessBody').innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)">Headless log path not configured &mdash; set <code>headlessLogPath</code> in config.json</div>';
        document.getElementById('headlessCount').textContent = '';
        return;
      }
      headlessConfigured = true;
      if (d.entries && d.entries.length > 0) {
        allHeadlessEntries = d.entries;
        headlessSince = d.entries[d.entries.length - 1].timestamp;
        renderHeadless();
        document.getElementById('headlessCount').textContent = '(' + allHeadlessEntries.length + ')';
      }
    }).catch(function(){});
  }

  function renderHeadless() {
    var body = document.getElementById('headlessBody');
    var q = headlessSearchQuery.toLowerCase();
    var html = '';
    for (var i = 0; i < allHeadlessEntries.length; i++) {
      var e = allHeadlessEntries[i];
      var lvl = (e.level || 'info').toLowerCase();
      if (!headlessFilters[lvl]) continue;
      var msg = e.message || '';
      if (q && msg.toLowerCase().indexOf(q) === -1 && (e.source || '').toLowerCase().indexOf(q) === -1) continue;
      var ts = new Date(e.timestamp);
      var timeStr = ts.toLocaleTimeString();
      html += '<div class="console-line level-' + lvl + '">' +
        '<span class="ts">' + timeStr + '</span>' +
        (e.source ? '<span class="src">[' + escH(e.source) + ']</span>' : '') +
        '<span class="msg">' + escH(msg) + '</span></div>';
    }
    body.innerHTML = html || '<div style="padding:24px;text-align:center;color:var(--text-dim);font-style:italic">No log output yet &mdash; start the headless client to see logs here</div>';
    var isNearBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 60;
    if (isNearBottom) body.scrollTop = body.scrollHeight;
    var jump = document.getElementById('headlessJump');
    if (body.scrollHeight > body.clientHeight + 80 && !isNearBottom) {
      jump.style.display = 'block';
    } else {
      jump.style.display = 'none';
    }
  }

  window.toggleHeadless = function() {
    headlessCollapsed = !headlessCollapsed;
    document.getElementById('headlessBody').classList.toggle('collapsed', headlessCollapsed);
    document.getElementById('headlessSearchWrap').style.display = headlessCollapsed ? 'none' : 'block';
    document.getElementById('headlessJump').style.display = 'none';
    document.getElementById('headlessToggleIcon').innerHTML = headlessCollapsed ? '&#x25B6;' : '&#x25BC;';
    if (!headlessCollapsed) pollHeadless();
  };

  window.toggleHeadlessFilter = function(btn) {
    var lvl = btn.dataset.level;
    headlessFilters[lvl] = !headlessFilters[lvl];
    btn.classList.toggle('active', headlessFilters[lvl]);
    renderHeadless();
  };

  window.filterHeadless = function() {
    headlessSearchQuery = document.getElementById('headlessSearchInput').value;
    renderHeadless();
  };

  window.scrollHeadlessBottom = function() {
    var body = document.getElementById('headlessBody');
    body.scrollTop = body.scrollHeight;
    document.getElementById('headlessJump').style.display = 'none';
  };

  // Broadcast
  window.sendUrlsToPlayers = function() {
    if (!confirm('Send Command Center URLs to all players via in-game mail?')) return;
    api('dashboard/send-urls', { method: 'POST' }).then(function(d) {
      if (d.success) showToast('URLs sent to ' + d.recipientCount + ' player(s)', 'success');
      else showToast('Failed: ' + (d.error || 'Unknown error'), 'error');
    }).catch(function() { showToast('Failed to send URLs', 'error'); });
  };

  window.openBroadcastModal = function() {
    document.getElementById('broadcastModal').classList.add('open');
    document.getElementById('broadcastMessage').value = '';
    document.getElementById('broadcastMessage').focus();
  };

  window.closeBroadcastModal = function() {
    document.getElementById('broadcastModal').classList.remove('open');
  };

  window.sendBroadcast = function() {
    var msg = document.getElementById('broadcastMessage').value.trim();
    if (!msg) { toast('Message cannot be empty', 'error'); return; }
    api('dashboard/broadcast', { method: 'POST', body: JSON.stringify({ message: msg }) }).then(function(d) {
      if (d.success) {
        toast('Broadcast sent to ' + d.recipientCount + ' profiles', 'success');
        closeBroadcastModal();
        loadActivity();
      } else {
        toast('Failed: ' + (d.error || 'Unknown'), 'error');
      }
    }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  function formatRoubles(n) {
    if (n == null) return '--';
    if (n >= 1000000000) return '₽' + (n / 1000000000).toFixed(1) + 'B';
    if (n >= 1000000) return '₽' + (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return '₽' + (n / 1000).toFixed(0) + 'K';
    return '₽' + n.toLocaleString();
  }

  function formatSeconds(s) {
    if (s == null) return '--';
    var m = Math.floor(s / 60);
    var sec = s % 60;
    return m + 'm ' + sec + 's';
  }

  function formatPlaytime(totalSec) {
    if (!totalSec) return '--';
    var h = Math.floor(totalSec / 3600);
    var m = Math.floor((totalSec % 3600) / 60);
    if (h > 0) return h + 'h ' + m + 'm';
    return m + 'm';
  }

  // ═══════════════════════════════════════════════════════
  // SYSTEM GAUGES — CPU/RAM semicircle + history charts
  // ═══════════════════════════════════════════════════════

  var _perfHistory = [];
  var _perfHistoryTimer = null;
  var _perfMode = 'system'; // 'system' or 'eft'
  var _alertsData = [];
  var _lastAlertTimestamp = null;
  var _alertTimer = null;
  var _lifetimeStatsLoaded = false;

  // Semicircle arc length for SVG gauge (half circle r=50, from 10,65 to 110,65)
  var GAUGE_ARC_LEN = 157.08;

  function gaugeColor(pct) {
    if (pct > 90) return '#8b3a3a';
    if (pct > 80) return '#c87a3e';
    if (pct > 60) return '#c8aa6e';
    return '#4a7c59';
  }

  function updateGauge(arcId, valueId, pct, suffix) {
    var arc = document.getElementById(arcId);
    var val = document.getElementById(valueId);
    if (!arc || !val) return;
    var clamped = Math.min(Math.max(pct, 0), 100);
    var offset = GAUGE_ARC_LEN * (1 - clamped / 100);
    arc.setAttribute('stroke-dashoffset', offset.toFixed(2));
    arc.setAttribute('stroke', gaugeColor(clamped));
    val.textContent = clamped.toFixed(1) + (suffix || '%');
    val.style.color = gaugeColor(clamped);
  }

  function drawHistoryChart(canvasId, tooltipId, data, label, unit, color) {
    drawMultiLineChart(canvasId, tooltipId, [{ data: data, color: color || '#c8aa6e', label: label }], unit);
  }

  function drawMultiLineChart(canvasId, tooltipId, series, unit) {
    var canvas = document.getElementById(canvasId);
    var tooltip = document.getElementById(tooltipId);
    if (!canvas || series.length === 0) return;
    // Need at least 2 data points in any series
    var hasData = series.some(function(s) { return s.data.length >= 2; });
    if (!hasData) return;

    var ctx = canvas.getContext('2d');
    var dpr = window.devicePixelRatio || 1;
    var rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(dpr, dpr);

    var w = rect.width;
    var h = rect.height;
    var pad = { top: 8, right: 8, bottom: 20, left: 40 };
    var plotW = w - pad.left - pad.right;
    var plotH = h - pad.top - pad.bottom;

    // Auto-scale Y axis across all series
    var allVals = [];
    series.forEach(function(s) { s.data.forEach(function(d) { allVals.push(d.value); }); });
    var minV = Math.min.apply(null, allVals);
    var maxV = Math.max.apply(null, allVals);
    var range = maxV - minV;
    if (range < 1) { range = 10; minV = Math.max(0, minV - 5); maxV = minV + range; }
    else { minV = Math.max(0, minV - range * 0.15); maxV = maxV + range * 0.15; range = maxV - minV; }

    ctx.clearRect(0, 0, w, h);

    // Y-axis grid lines
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    ctx.font = '9px monospace';
    ctx.fillStyle = 'rgba(255,255,255,0.25)';
    ctx.textAlign = 'right';
    var ySteps = 4;
    for (var i = 0; i <= ySteps; i++) {
      var yVal = minV + (range * i / ySteps);
      var yPos = pad.top + plotH - (plotH * i / ySteps);
      ctx.beginPath();
      ctx.moveTo(pad.left, yPos);
      ctx.lineTo(w - pad.right, yPos);
      ctx.stroke();
      ctx.fillText(yVal.toFixed(1) + unit, pad.left - 4, yPos + 3);
    }

    // X-axis labels (time)
    ctx.textAlign = 'center';
    var now = Date.now();
    var windowMs = 5 * 60 * 1000;
    var tMin = now - windowMs;
    for (var m = 1; m <= 4; m++) {
      var tx = pad.left + plotW * (1 - m / 5);
      ctx.fillText(m + 'm ago', tx, h - 2);
    }
    ctx.fillText('now', pad.left + plotW, h - 2);

    // Draw each series
    var allPoints = []; // array of arrays for hover
    series.forEach(function(s, si) {
      if (s.data.length < 2) { allPoints.push([]); return; }
      ctx.beginPath();
      var points = [];
      for (var j = 0; j < s.data.length; j++) {
        var ts = new Date(s.data[j].timestamp).getTime();
        var x = pad.left + plotW * ((ts - tMin) / windowMs);
        var y = pad.top + plotH - (plotH * (s.data[j].value - minV) / range);
        x = Math.max(pad.left, Math.min(pad.left + plotW, x));
        points.push({ x: x, y: y, val: s.data[j].value, ts: ts, label: s.label });
        if (j === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = s.color;
      ctx.lineWidth = 1.5;
      ctx.stroke();

      // Gradient fill only for first (or single) series
      if (si === 0) {
        var grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + plotH);
        var baseColor = s.color === '#4a7c59' ? '74,124,89' : '200,170,110';
        grad.addColorStop(0, 'rgba(' + baseColor + ',0.1)');
        grad.addColorStop(1, 'rgba(' + baseColor + ',0)');
        ctx.lineTo(points[points.length - 1].x, pad.top + plotH);
        ctx.lineTo(points[0].x, pad.top + plotH);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.fill();
      }
      allPoints.push(points);
    });

    // Hover handler — show all series values at hover X
    canvas.onmousemove = function(e) {
      var cr = canvas.getBoundingClientRect();
      var mx = e.clientX - cr.left;
      var lines = [];
      var bestY = null;
      allPoints.forEach(function(points) {
        if (points.length === 0) return;
        var closest = null, minDist = Infinity;
        for (var k = 0; k < points.length; k++) {
          var dist = Math.abs(points[k].x - mx);
          if (dist < minDist) { minDist = dist; closest = points[k]; }
        }
        if (closest && minDist < 20) {
          lines.push(closest.label + ': ' + closest.val.toFixed(1) + unit);
          if (bestY === null) bestY = closest.y;
        }
      });
      if (lines.length > 0) {
        tooltip.style.display = 'block';
        tooltip.innerHTML = lines.join('<br>');
        tooltip.style.left = Math.min(mx + 8, w - 140) + 'px';
        tooltip.style.top = ((bestY || 0) - 14 * lines.length) + 'px';
      } else {
        tooltip.style.display = 'none';
      }
    };
    canvas.onmouseleave = function() { tooltip.style.display = 'none'; };
  }

  window.setPerfMode = setPerfMode;
  function setPerfMode(mode) {
    _perfMode = mode;
    document.getElementById('perfModeSystem').classList.toggle('active', mode === 'system');
    document.getElementById('perfModeEft').classList.toggle('active', mode === 'eft');
    document.getElementById('perfSectionLabel').textContent = mode === 'system' ? 'System Performance' : 'EFT + Server Performance';
    // Toggle legends
    document.getElementById('cpuChartLegend').style.display = mode === 'eft' ? '' : 'none';
    document.getElementById('ramChartLegend').style.display = mode === 'eft' ? '' : 'none';
    renderPerfGauges(_perfHistory);
  }

  function renderPerfGauges(data) {
    var panel = document.getElementById('systemGaugesPanel');
    if (!data || data.length === 0) return;
    panel.style.display = '';
    var latest = data[data.length - 1];

    if (_perfMode === 'system') {
      // ── System Wide mode ──
      updateGauge('cpuGaugeArc', 'cpuGaugeValue', latest.cpuPercent);
      updateGauge('ramGaugeArc', 'ramGaugeValue', latest.ramPercent);
      var cpuSub = document.getElementById('cpuGaugeSub');
      if (cpuSub) cpuSub.textContent = 'EFT Process: ' + (latest.processCpuPercent || 0).toFixed(1) + '%';
      var ramSub = document.getElementById('ramGaugeSub');
      if (latest.ramUsedMb && latest.ramTotalMb) {
        var usedGB = (latest.ramUsedMb / 1024).toFixed(1);
        var totalGB = (latest.ramTotalMb / 1024).toFixed(1);
        var processGB = ((latest.processRamUsedMb || 0) / 1024).toFixed(1);
        ramSub.innerHTML = usedGB + ' / ' + totalGB + ' GB<br><span style="font-size:10px;color:var(--text-dim)">EFT Process: ' + processGB + ' GB</span>';
      }
      // Single-line charts
      var cpuData = data.map(function(d) { return { timestamp: d.timestamp, value: d.cpuPercent }; });
      var ramData = data.map(function(d) { return { timestamp: d.timestamp, value: d.ramPercent }; });
      drawHistoryChart('cpuChart', 'cpuChartTooltip', cpuData, 'CPU', '%', '#c8aa6e');
      drawHistoryChart('ramChart', 'ramChartTooltip', ramData, 'RAM', '%', '#c8aa6e');
    } else {
      // ── EFT mode — combined EFT + Server ──
      var eftCpu = latest.processCpuPercent || 0;
      var srvCpu = latest.serverCpuPercent || 0;
      var combinedCpu = Math.min(eftCpu + srvCpu, 100);
      updateGauge('cpuGaugeArc', 'cpuGaugeValue', combinedCpu);
      var cpuSub = document.getElementById('cpuGaugeSub');
      if (cpuSub) cpuSub.textContent = 'EFT: ' + eftCpu.toFixed(1) + '% | Server: ' + srvCpu.toFixed(1) + '%';

      // RAM — show absolute GB, not %
      var eftRamMb = latest.processRamUsedMb || 0;
      var srvRamMb = latest.serverRamUsedMb || 0;
      var combinedRamGb = ((eftRamMb + srvRamMb) / 1024).toFixed(1);
      var totalGb = latest.ramTotalMb > 0 ? (latest.ramTotalMb / 1024).toFixed(1) : '?';
      var combinedRamPct = latest.ramTotalMb > 0 ? (eftRamMb + srvRamMb) / latest.ramTotalMb * 100 : 0;
      updateGauge('ramGaugeArc', 'ramGaugeValue', combinedRamPct);
      var ramVal = document.getElementById('ramGaugeValue');
      if (ramVal) { ramVal.textContent = combinedRamGb + ' GB'; ramVal.style.color = gaugeColor(combinedRamPct); }
      var ramSub = document.getElementById('ramGaugeSub');
      if (ramSub) {
        var eftGb = (eftRamMb / 1024).toFixed(1);
        var srvGb = (srvRamMb / 1024).toFixed(1);
        ramSub.innerHTML = 'EFT: ' + eftGb + ' GB | Server: ' + srvGb + ' GB<br><span style="font-size:10px;color:var(--text-dim)">of ' + totalGb + ' GB total</span>';
      }

      // Multi-line charts: EFT (green) + Server (gold)
      var eftCpuData = data.map(function(d) { return { timestamp: d.timestamp, value: d.processCpuPercent || 0 }; });
      var srvCpuData = data.map(function(d) { return { timestamp: d.timestamp, value: d.serverCpuPercent || 0 }; });
      drawMultiLineChart('cpuChart', 'cpuChartTooltip', [
        { data: eftCpuData, color: '#4a7c59', label: 'EFT' },
        { data: srvCpuData, color: '#c8aa6e', label: 'Server' }
      ], '%');

      var eftRamData = data.map(function(d) { return { timestamp: d.timestamp, value: (d.processRamUsedMb || 0) / 1024 }; });
      var srvRamData = data.map(function(d) { return { timestamp: d.timestamp, value: (d.serverRamUsedMb || 0) / 1024 }; });
      drawMultiLineChart('ramChart', 'ramChartTooltip', [
        { data: eftRamData, color: '#4a7c59', label: 'EFT' },
        { data: srvRamData, color: '#c8aa6e', label: 'Server' }
      ], ' GB');
    }
  }

  function loadPerformanceHistory() {
    api('telemetry/performance-history').then(function(data) {
      if (!Array.isArray(data)) return;
      _perfHistory = data;
      renderPerfGauges(data);
    }).catch(function(e) { console.error('Perf history error:', e); });
  }

  // ═══════════════════════════════════════════════════════
  // ALERTS — Raid event notifications
  // ═══════════════════════════════════════════════════════

  var _alertIcons = {
    'boss-spawn': '\u{1F451}',
    'pmc-kill': '\u{1F480}',
    'headshot': '\u{1F3AF}',
    'raid-start': '\u{1F680}',
    'raid-end': '\u{1F3C1}',
    'extract': '\u{1F6AA}'
  };

  function loadAlerts() {
    var url = 'telemetry/alerts';
    if (_lastAlertTimestamp) url += '?since=' + encodeURIComponent(_lastAlertTimestamp);
    api(url).then(function(d) {
      var alerts = d.alerts || [];
      if (alerts.length === 0 && _alertsData.length === 0) return;

      // Merge new alerts
      if (alerts.length > 0) {
        // Show toasts for new alerts
        if (_lastAlertTimestamp) {
          alerts.forEach(function(a) { showAlertToast(a); });
        }
        _alertsData = alerts.concat(_alertsData).slice(0, 100);
        _lastAlertTimestamp = alerts[0].timestamp;
      }

      // Update badge
      var badge = document.getElementById('alertBadge');
      if (_alertsData.length > 0) {
        badge.style.display = '';
        badge.textContent = _alertsData.length;
      } else {
        badge.style.display = 'none';
      }

      // Render feed
      renderAlertFeed();
    }).catch(function(e) { console.error('Alerts error:', e); });
  }

  var _alertsExpanded = false;

  function renderAlertFeed() {
    var feed = document.getElementById('alertFeed');
    var section = document.getElementById('alertsSection');
    if (_alertsData.length === 0) {
      feed.innerHTML = '<div class="telem-no-data">No alerts yet</div>';
      return;
    }
    var limit = _alertsExpanded ? _alertsData.length : 5;
    var items = _alertsData.slice(0, limit);
    var html = '';
    items.forEach(function(a) {
      var ts = new Date(a.timestamp);
      var timeStr = ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      var icon = _alertIcons[a.type] || '\u{1F514}';
      html += '<div class="alert-entry">' +
        '<span class="alert-icon ' + (a.type || '') + '">' + icon + '</span>' +
        '<span class="alert-msg">' + escH(a.message) + '</span>' +
        '<span class="alert-time">' + timeStr + '</span>' +
        '</div>';
    });
    if (_alertsData.length > 5) {
      if (_alertsExpanded) {
        html += '<div style="text-align:center;padding:4px"><a href="#" onclick="toggleAlertExpand();return false" style="color:#c8aa6e;font-size:10px">Show less</a></div>';
      } else {
        html += '<div style="text-align:center;padding:4px"><a href="#" onclick="toggleAlertExpand();return false" style="color:#c8aa6e;font-size:10px">Show all ' + _alertsData.length + ' alerts</a></div>';
      }
    }
    feed.innerHTML = html;
  }

  window.toggleAlertExpand = function() {
    _alertsExpanded = !_alertsExpanded;
    renderAlertFeed();
  };

  function showAlertToast(alert) {
    var container = document.getElementById('toastContainer');
    if (!container) return;
    var toastCls = 'toast';
    if (alert.type === 'boss-spawn') toastCls += ' toast-boss';
    else if (alert.type === 'pmc-kill') toastCls += ' toast-kill';
    else if (alert.type === 'headshot') toastCls += ' toast-headshot';
    else toastCls += ' toast-raid';

    var icon = _alertIcons[alert.type] || '\u{1F514}';
    var el = document.createElement('div');
    el.className = toastCls;
    el.innerHTML = icon + ' ' + escH(alert.message);
    container.appendChild(el);
    setTimeout(function() {
      el.classList.add('toast-out');
      setTimeout(function() { el.remove(); }, 300);
    }, 5000);
  }

  // ═══════════════════════════════════════════════════════
  // LIFETIME STATS — Aggregated player statistics
  // ═══════════════════════════════════════════════════════

  function loadLifetimeStats() {
    api('telemetry/lifetime-stats').then(function(d) {
      var panel = document.getElementById('lifetimeStatsPanel');
      if (d.totalRaids === 0) { panel.style.display = 'none'; return; }
      panel.style.display = '';

      var kd = d.deaths > 0 ? (d.totalKills / d.deaths).toFixed(1) : d.totalKills;
      var playtimeHrs = (d.totalPlayTimeSec / 3600).toFixed(1);

      var html = '';
      html += lsCard(d.totalRaids, 'Raids');
      html += lsCard(d.survivalRate + '%', 'Survival', d.survived + ' / ' + d.totalRaids);
      html += lsCard(kd, 'K/D Ratio');
      html += lsCard(d.totalKills, 'Total Kills');
      html += lsCard(d.pmcKills, 'PMC Kills');
      html += lsCard(d.scavKills, 'Scav Kills');
      html += lsCard(d.bossKills, 'Boss Kills');
      html += lsCard(d.avgKillsPerRaid, 'Avg Kills/Raid');
      html += lsCard(d.totalHeadshots, 'Headshots');
      if (d.longestShot > 0) html += lsCard(d.longestShot + 'm', 'Longest Shot');
      html += lsCard(d.favoriteMap || '--', 'Favorite Map');
      html += lsCard(formatSeconds(d.avgRaidDurationSec), 'Avg Duration');
      html += lsCard(playtimeHrs + 'h', 'Total Playtime');
      if (d.totalDamage > 0) html += lsCard(d.totalDamage.toLocaleString(), 'Total Damage');
      if (d.totalXp > 0) html += lsCard(d.totalXp.toLocaleString(), 'Total XP');

      document.getElementById('lifetimeStatsGrid').innerHTML = html;
      _lifetimeStatsLoaded = true;
    }).catch(function(e) { console.error('Lifetime stats error:', e); });
  }

  function lsCard(value, label, sub) {
    return '<div class="lifetime-stat-card">' +
      '<span class="lifetime-stat-value">' + value + '</span>' +
      '<span class="lifetime-stat-label">' + label + '</span>' +
      (sub ? '<span class="lifetime-stat-sub">' + sub + '</span>' : '') +
      '</div>';
  }

  // ═══════════════════════════════════════════════════════
  // LIVE MAP
  // ═══════════════════════════════════════════════════════

  // Map config data from DynamicMaps (bounds, rotation, layers)
  var MAP_CONFIG = {
    'bigmap': { name: 'Customs', rotation: 180, bounds: { min: { x: -372, y: -306 }, max: { x: 698, y: 235 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, 0.5] }, '0': { z: [-100, 100] }, '1': { z: [2.7, 100] }, '2': { z: [6.5, 100] }, '3': { z: [9.8, 100] } } },
    'factory4_day': { name: 'Factory', rotation: 90, bounds: { min: { x: -65, y: -64.5 }, max: { x: 77.6, y: 67.2 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, -1] }, '0': { z: [-1, 3] }, '1': { z: [3, 6] }, '2': { z: [6, 100] } } },
    'factory4_night': { name: 'Factory', rotation: 90, bounds: { min: { x: -65, y: -64.5 }, max: { x: 77.6, y: 67.2 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, -1] }, '0': { z: [-1, 3] }, '1': { z: [3, 6] }, '2': { z: [6, 100] } } },
    'Sandbox': { name: 'Ground Zero', rotation: 180, bounds: { min: { x: -99, y: -124 }, max: { x: 249, y: 364 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, 21] }, '0': { z: [-100, 100] }, '1': { z: [26, 32.3] }, '2': { z: [32.3, 100] } } },
    'Sandbox_high': { name: 'Ground Zero', rotation: 180, bounds: { min: { x: -99, y: -124 }, max: { x: 249, y: 364 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, 21] }, '0': { z: [-100, 100] }, '1': { z: [26, 32.3] }, '2': { z: [32.3, 100] } } },
    'Interchange': { name: 'Interchange', rotation: 180, bounds: { min: { x: -364, y: -443 }, max: { x: 534, y: 452 } }, defaultLevel: 0,
      layers: { '0': { z: [-100, 100] }, '1': { z: [25, 34] }, '2': { z: [34, 100] } } },
    'laboratory': { name: 'Labs', rotation: 270, bounds: { min: { x: -292, y: -441 }, max: { x: -96, y: -223 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, -0.9] }, '0': { z: [-0.9, 3] }, '1': { z: [3, 100] } } },
    'Labyrinth': { name: 'Labyrinth', rotation: 90, bounds: { min: { x: -52.5, y: -36.5 }, max: { x: 50.7, y: 75.3 } }, defaultLevel: 0,
      layers: { '0': { z: [-100, -1] } } },
    'Lighthouse': { name: 'Lighthouse', rotation: 180, bounds: { min: { x: -545, y: -998 }, max: { x: 512, y: 721 } }, defaultLevel: 0,
      layers: { '0': { z: [-100, 100] } } },
    'RezervBase': { name: 'Reserve', rotation: 180, bounds: { min: { x: -303.5, y: -275 }, max: { x: 292, y: 271.5 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, -8] }, '0': { z: [-8, 100] } } },
    'Shoreline': { name: 'Shoreline', rotation: 180, bounds: { min: { x: -1060, y: -415 }, max: { x: 508, y: 622 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, -5] }, '0': { z: [-100, 100] }, '1': { z: [-1, 2] }, '2': { z: [2, 100] } } },
    'TarkovStreets': { name: 'Streets', rotation: 180, bounds: { min: { x: -279, y: -299 }, max: { x: 324, y: 533 } }, defaultLevel: 0,
      layers: { '-1': { z: [-5, 0] }, '0': { z: [-100, 100] }, '1': { z: [3, 10] }, '2': { z: [6, 15] }, '3': { z: [9, 15] }, '4': { z: [12, 15] } } },
    'Woods': { name: 'Woods', rotation: 180, bounds: { min: { x: -756, y: -915 }, max: { x: 647, y: 443 } }, defaultLevel: 0,
      layers: { '-1': { z: [-100, 5.1] }, '0': { z: [-100, 100] }, '1': { z: [9.6, 100] } } }
  };

  // Entity colors
  var MAP_COLORS = {
    pmc: '#4a7c59',      // green
    aipmc: '#c45050',    // red — AI PMC bots
    scav: '#c8aa6e',     // gold
    boss: '#c87a3e',     // orange
    raider: '#b06030',   // darker orange
    rogue: '#b06030',
    follower: '#6e4a7c', // purple
    unknown: '#888'
  };

  // Map state
  var _mapPositions = [];
  var _mapCurrentMap = '';
  var _mapConfig = null;
  var _mapZoom = 1;
  var _mapPanX = 0, _mapPanY = 0;
  var _mapDragging = false;
  var _mapDragStart = { x: 0, y: 0 };
  var _mapPanStart = { x: 0, y: 0 };
  var _mapRefreshMs = 1000;
  var _mapRefreshTimer = null;
  var _mapSelectedLayer = '0';
  var _mapImageCache = {};
  var _mapFollowPlayer = true;
  var _mapRaidActive = false;

  // Initialize map refresh rate from localStorage
  (function() {
    var saved = localStorage.getItem('cc_mapRefreshMs');
    if (saved) _mapRefreshMs = parseInt(saved) || 1000;
  })();

  function mapSliderToMs(val) {
    // Logarithmic: slider value -1.301 to 1 maps to 0.05s to 10s
    return Math.round(Math.pow(10, parseFloat(val)) * 1000);
  }

  function mapMsToSlider(ms) {
    return Math.log10(ms / 1000);
  }

  function mapFormatRate(ms) {
    if (ms < 1000) return (ms / 1000).toFixed(2) + 's';
    if (ms >= 10000) return (ms / 1000).toFixed(0) + 's';
    return (ms / 1000).toFixed(1) + 's';
  }

  function initMapSlider() {
    var slider = document.getElementById('mapRefreshSlider');
    var label = document.getElementById('mapRefreshLabel');
    slider.value = mapMsToSlider(_mapRefreshMs);
    label.textContent = mapFormatRate(_mapRefreshMs);

    slider.addEventListener('input', function() {
      _mapRefreshMs = mapSliderToMs(this.value);
      label.textContent = mapFormatRate(_mapRefreshMs);
    });

    slider.addEventListener('change', function() {
      _mapRefreshMs = mapSliderToMs(this.value);
      label.textContent = mapFormatRate(_mapRefreshMs);
      localStorage.setItem('cc_mapRefreshMs', _mapRefreshMs);
      // Notify server so plugin adjusts its send rate
      api('telemetry/map-refresh-rate', 'POST', { intervalSec: _mapRefreshMs / 1000 });
      restartMapPolling();
    });
  }

  function restartMapPolling() {
    if (_mapRefreshTimer) clearInterval(_mapRefreshTimer);
    if (_mapRaidActive) {
      _mapRefreshTimer = setInterval(loadMapPositions, _mapRefreshMs);
    }
  }

  function loadMapPositions() {
    api('telemetry/positions').then(function(positions) {
      _mapPositions = positions || [];
      drawMap();
    }).catch(function() {});
  }

  function gameToMap(gx, gz, config) {
    // Apply coordinate rotation
    var rad = config.rotation * Math.PI / 180;
    var cos = Math.cos(rad);
    var sin = Math.sin(rad);
    var rx = gx * cos - gz * sin;
    var ry = gx * sin + gz * cos;
    return { x: rx, y: ry };
  }

  function updateMapForRaid(mapId, raidActive) {
    var panel = document.getElementById('liveMapPanel');
    var noRaid = document.getElementById('mapNoRaid');
    var canvas = document.getElementById('mapCanvas');

    _mapRaidActive = raidActive;

    if (!raidActive) {
      panel.style.display = 'none';
      if (_mapRefreshTimer) { clearInterval(_mapRefreshTimer); _mapRefreshTimer = null; }
      return;
    }

    panel.style.display = '';
    noRaid.style.display = 'none';
    canvas.style.display = '';

    // Resolve map config
    _mapCurrentMap = mapId;
    _mapConfig = MAP_CONFIG[mapId] || null;

    if (_mapConfig) {
      // Populate layer selector
      var sel = document.getElementById('mapLayerSelect');
      sel.innerHTML = '';
      var levels = Object.keys(_mapConfig.layers).sort(function(a, b) { return parseInt(a) - parseInt(b); });
      levels.forEach(function(lv) {
        var opt = document.createElement('option');
        opt.value = lv;
        var lvNum = parseInt(lv);
        opt.textContent = lvNum === 0 ? 'Ground' : lvNum < 0 ? 'Underground ' + lv : 'Floor ' + lv;
        sel.appendChild(opt);
      });
      _mapSelectedLayer = '' + (_mapConfig.defaultLevel || 0);
      sel.value = _mapSelectedLayer;
    }

    // Reset zoom/pan
    _mapZoom = 1;
    _mapPanX = 0;
    _mapPanY = 0;

    // Start polling
    restartMapPolling();
    loadMapPositions();
  }

  // ── Minimap Icon Drawing ──

  function drawIconShape(ctx, x, y, type, color, r, alpha) {
    ctx.globalAlpha = alpha;
    switch (type) {
      case 'pmc':    _drawChevron(ctx, x, y, r, color); break;
      case 'aipmc':  _drawDiamond(ctx, x, y, r, color); break;
      case 'boss':   _drawSkull(ctx, x, y, r, color); break;
      case 'raider':
      case 'rogue':  _drawTriangle(ctx, x, y, r, color); break;
      case 'follower': _drawSmallDiamond(ctx, x, y, r, color); break;
      default:       _drawCircle(ctx, x, y, r, color); break; // scav, unknown
    }
    ctx.globalAlpha = 1;
  }

  function _drawChevron(ctx, x, y, r, color) {
    // Upward chevron/arrow — military PMC feel
    ctx.beginPath();
    ctx.moveTo(x, y - r);
    ctx.lineTo(x + r * 0.8, y + r * 0.4);
    ctx.lineTo(x + r * 0.35, y + r * 0.1);
    ctx.lineTo(x, y + r * 0.55);
    ctx.lineTo(x - r * 0.35, y + r * 0.1);
    ctx.lineTo(x - r * 0.8, y + r * 0.4);
    ctx.closePath();
    // Dark backdrop
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.fill();
    // Colored fill (slightly inset via stroke trick)
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.lineWidth = 0.8;
    ctx.stroke();
  }

  function _drawDiamond(ctx, x, y, r, color) {
    ctx.beginPath();
    ctx.moveTo(x, y - r);
    ctx.lineTo(x + r, y);
    ctx.lineTo(x, y + r);
    ctx.lineTo(x - r, y);
    ctx.closePath();
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.fill();
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
    ctx.lineWidth = 0.8;
    ctx.stroke();
  }

  function _drawSmallDiamond(ctx, x, y, r, color) {
    _drawDiamond(ctx, x, y, r * 0.8, color);
  }

  function _drawTriangle(ctx, x, y, r, color) {
    ctx.beginPath();
    ctx.moveTo(x, y - r);
    ctx.lineTo(x + r * 0.866, y + r * 0.5);
    ctx.lineTo(x - r * 0.866, y + r * 0.5);
    ctx.closePath();
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.fill();
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
    ctx.lineWidth = 0.8;
    ctx.stroke();
  }

  function _drawCircle(ctx, x, y, r, color) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.lineWidth = 0.8;
    ctx.stroke();
  }

  function _drawSkull(ctx, x, y, r, color) {
    // Cranium (top oval)
    var cr = r * 0.9;
    ctx.beginPath();
    ctx.ellipse(x, y - r * 0.1, cr, cr * 0.95, 0, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(x, y - r * 0.1, cr, cr * 0.95, 0, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    // Jaw
    ctx.beginPath();
    ctx.moveTo(x - r * 0.5, y + r * 0.25);
    ctx.quadraticCurveTo(x - r * 0.35, y + r * 0.85, x, y + r * 0.75);
    ctx.quadraticCurveTo(x + r * 0.35, y + r * 0.85, x + r * 0.5, y + r * 0.25);
    ctx.fillStyle = color;
    ctx.fill();
    // Outline
    ctx.beginPath();
    ctx.ellipse(x, y - r * 0.1, cr, cr * 0.95, 0, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
    ctx.lineWidth = 0.8;
    ctx.stroke();
    // Eye sockets (dark)
    var eyeR = r * 0.22;
    ctx.fillStyle = '#0a0c0e';
    ctx.beginPath();
    ctx.ellipse(x - r * 0.3, y - r * 0.15, eyeR, eyeR * 1.15, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(x + r * 0.3, y - r * 0.15, eyeR, eyeR * 1.15, 0, 0, Math.PI * 2);
    ctx.fill();
    // Nose (small inverted triangle)
    ctx.beginPath();
    ctx.moveTo(x - r * 0.08, y + r * 0.08);
    ctx.lineTo(x + r * 0.08, y + r * 0.08);
    ctx.lineTo(x, y + r * 0.25);
    ctx.closePath();
    ctx.fill();
  }

  function drawMap() {
    var canvas = document.getElementById('mapCanvas');
    var wrap = document.getElementById('mapCanvasWrap');
    if (!canvas || !wrap) return;

    var dpr = window.devicePixelRatio || 1;
    var w = wrap.clientWidth;
    var h = wrap.clientHeight;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    var ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    // Clear
    ctx.fillStyle = '#0a0c0e';
    ctx.fillRect(0, 0, w, h);

    if (!_mapConfig) {
      // Unknown map — draw positions as-is
      ctx.fillStyle = '#333';
      ctx.font = '13px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('Map: ' + (_mapCurrentMap || 'Unknown') + ' (no config)', w / 2, h / 2);
      drawPositionsRaw(ctx, w, h);
      return;
    }

    var config = _mapConfig;
    var bounds = config.bounds;
    var mapW = bounds.max.x - bounds.min.x;
    var mapH = bounds.max.y - bounds.min.y;

    // Calculate scale to fit map in canvas with padding
    var pad = 30;
    var scaleX = (w - pad * 2) / mapW;
    var scaleY = (h - pad * 2) / mapH;
    var scale = Math.min(scaleX, scaleY) * _mapZoom;

    // Center offset
    var cx = w / 2 + _mapPanX;
    var cy = h / 2 + _mapPanY;

    // Map center in game coords
    var mapCx = (bounds.min.x + bounds.max.x) / 2;
    var mapCy = (bounds.min.y + bounds.max.y) / 2;

    // Auto-follow logged-in player
    if (_mapFollowPlayer && sessionId) {
      var me = _mapPositions.find(function(p) { return p.profileId === sessionId && p.alive; });
      if (me) {
        var mp = gameToMap(me.x, me.z, config);
        _mapPanX = -(mp.x - mapCx) * scale;
        _mapPanY = -(mp.y - mapCy) * scale;
        cx = w / 2 + _mapPanX;
        cy = h / 2 + _mapPanY;
      }
    }

    // Check if we have a map image loaded
    var imgKey = _mapCurrentMap + '_' + _mapSelectedLayer;
    var img = _mapImageCache[imgKey];
    if (img && img.complete && img.naturalWidth > 0) {
      // Draw map image
      var imgX = cx + (bounds.min.x - mapCx) * scale;
      var imgY = cy + (bounds.min.y - mapCy) * scale;
      var imgW = mapW * scale;
      var imgH = mapH * scale;
      ctx.drawImage(img, imgX, imgY, imgW, imgH);
    } else {
      // Draw placeholder grid
      ctx.strokeStyle = 'rgba(200,170,110,0.08)';
      ctx.lineWidth = 1;
      var gridSize = 50;
      for (var gx = bounds.min.x; gx <= bounds.max.x; gx += gridSize) {
        var sx = cx + (gx - mapCx) * scale;
        ctx.beginPath(); ctx.moveTo(sx, cy + (bounds.min.y - mapCy) * scale); ctx.lineTo(sx, cy + (bounds.max.y - mapCy) * scale); ctx.stroke();
      }
      for (var gy = bounds.min.y; gy <= bounds.max.y; gy += gridSize) {
        var sy = cy + (gy - mapCy) * scale;
        ctx.beginPath(); ctx.moveTo(cx + (bounds.min.x - mapCx) * scale, sy); ctx.lineTo(cx + (bounds.max.x - mapCx) * scale, sy); ctx.stroke();
      }

      // Map border
      ctx.strokeStyle = 'rgba(200,170,110,0.15)';
      ctx.lineWidth = 1;
      ctx.strokeRect(
        cx + (bounds.min.x - mapCx) * scale,
        cy + (bounds.min.y - mapCy) * scale,
        mapW * scale, mapH * scale
      );

      // Map name
      ctx.fillStyle = 'rgba(200,170,110,0.3)';
      ctx.font = '16px monospace';
      ctx.textAlign = 'center';
      ctx.fillText(config.name, cx, cy - 10);
      ctx.font = '10px monospace';
      ctx.fillText('Map image not loaded', cx, cy + 10);
    }

    // Draw entities
    var showNames = document.getElementById('mapShowNames').checked;
    var showDead = document.getElementById('mapShowDead').checked;
    var selectedLayerZ = _mapConfig.layers[_mapSelectedLayer] ? _mapConfig.layers[_mapSelectedLayer].z : null;

    _mapPositions.forEach(function(p) {
      if (!showDead && !p.alive) return;

      // Layer filter: check if entity's Y (elevation) is within selected layer's Z range
      var onLayer = true;
      if (selectedLayerZ && _mapSelectedLayer !== '0') {
        onLayer = p.y >= selectedLayerZ[0] && p.y <= selectedLayerZ[1];
      }

      // Transform game coords to map coords
      var mp = gameToMap(p.x, p.z, config);

      // Screen position
      var sx = cx + (mp.x - mapCx) * scale;
      var sy = cy + (mp.y - mapCy) * scale;

      // Determine color and size
      var color = MAP_COLORS[p.type] || MAP_COLORS.unknown;
      var alpha = p.alive ? (onLayer ? 1.0 : 0.3) : 0.25;
      var radius = (p.type === 'boss') ? 7 : (p.type === 'pmc' || p.type === 'aipmc') ? 5 : (p.type === 'follower') ? 3.5 : 4;

      // Draw icon shape
      drawIconShape(ctx, sx, sy, p.type, color, radius, alpha);

      // Draw rotation arrow for PMCs
      if (p.alive && (p.type === 'pmc' || p.type === 'aipmc') && p.rotation != null) {
        ctx.globalAlpha = alpha;
        var arrowLen = radius + 6;
        var angle = -(p.rotation - config.rotation) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(sx, sy);
        ctx.lineTo(sx + Math.sin(angle) * arrowLen, sy - Math.cos(angle) * arrowLen);
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.stroke();
        ctx.globalAlpha = 1;
      }

      // Dead X marker
      if (!p.alive) {
        ctx.globalAlpha = 0.6;
        ctx.strokeStyle = '#c45050';
        ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(sx - 4, sy - 4); ctx.lineTo(sx + 4, sy + 4); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(sx + 4, sy - 4); ctx.lineTo(sx - 4, sy + 4); ctx.stroke();
        ctx.globalAlpha = 1;
      }

      // Name label
      if (showNames && p.alive && (p.type === 'pmc' || p.type === 'aipmc' || p.type === 'boss')) {
        ctx.fillStyle = color;
        ctx.font = '9px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(p.name, sx, sy - radius - 4);
      }
    });

    // Draw compass
    ctx.fillStyle = 'rgba(200,170,110,0.5)';
    ctx.font = 'bold 11px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('N', w - 20, 18);
    ctx.fillStyle = 'rgba(200,170,110,0.3)';
    ctx.font = '9px monospace';
    ctx.fillText('S', w - 20, h - 8);
    ctx.fillText('W', 10, h / 2 + 4);
    ctx.textAlign = 'left';
    ctx.fillText('E', w - 14, h / 2 + 4);

    // Entity count
    var aliveCount = _mapPositions.filter(function(p) { return p.alive; }).length;
    ctx.fillStyle = 'rgba(200,170,110,0.4)';
    ctx.font = '10px monospace';
    ctx.textAlign = 'left';
    ctx.fillText(aliveCount + ' alive / ' + _mapPositions.length + ' total', 8, 16);
  }

  function drawPositionsRaw(ctx, w, h) {
    // Fallback for unknown maps: auto-fit all positions
    if (_mapPositions.length === 0) return;
    var minX = Infinity, maxX = -Infinity, minZ = Infinity, maxZ = -Infinity;
    _mapPositions.forEach(function(p) {
      if (p.x < minX) minX = p.x;
      if (p.x > maxX) maxX = p.x;
      if (p.z < minZ) minZ = p.z;
      if (p.z > maxZ) maxZ = p.z;
    });
    var rangeX = Math.max(maxX - minX, 10);
    var rangeZ = Math.max(maxZ - minZ, 10);
    var pad = 40;
    _mapPositions.forEach(function(p) {
      var sx = pad + ((p.x - minX) / rangeX) * (w - pad * 2);
      var sy = pad + ((p.z - minZ) / rangeZ) * (h - pad * 2);
      ctx.beginPath();
      ctx.arc(sx, sy, 4, 0, Math.PI * 2);
      ctx.fillStyle = MAP_COLORS[p.type] || '#888';
      ctx.globalAlpha = p.alive ? 1 : 0.25;
      ctx.fill();
      ctx.globalAlpha = 1;
    });
  }

  // Map interaction (zoom/pan)
  (function() {
    var wrap = document.getElementById('mapCanvasWrap');
    if (!wrap) return;

    wrap.addEventListener('wheel', function(e) {
      e.preventDefault();
      var delta = e.deltaY > 0 ? 0.9 : 1.1;
      _mapZoom = Math.max(0.3, Math.min(10, _mapZoom * delta));
      drawMap();
    }, { passive: false });

    wrap.addEventListener('mousedown', function(e) {
      if (e.button !== 0) return;
      if (_mapFollowPlayer) {
        _mapFollowPlayer = false;
        var cb = document.getElementById('mapFollowPlayer');
        if (cb) cb.checked = false;
      }
      _mapDragging = true;
      _mapDragStart = { x: e.clientX, y: e.clientY };
      _mapPanStart = { x: _mapPanX, y: _mapPanY };
    });

    window.addEventListener('mousemove', function(e) {
      if (!_mapDragging) return;
      _mapPanX = _mapPanStart.x + (e.clientX - _mapDragStart.x);
      _mapPanY = _mapPanStart.y + (e.clientY - _mapDragStart.y);
      drawMap();
    });

    window.addEventListener('mouseup', function() {
      _mapDragging = false;
    });

    // Layer selector
    var layerSel = document.getElementById('mapLayerSelect');
    if (layerSel) {
      layerSel.addEventListener('change', function() {
        _mapSelectedLayer = this.value;
        drawMap();
      });
    }

    // Follow checkbox
    var followCb = document.getElementById('mapFollowPlayer');
    if (followCb) {
      followCb.addEventListener('change', function() {
        _mapFollowPlayer = this.checked;
        if (_mapFollowPlayer) drawMap();
      });
    }

    // Init slider
    initMapSlider();
  })();

  // Performance panel collapse persistence
  (function() {
    var det = document.getElementById('perfDetails');
    if (!det) return;
    var saved = localStorage.getItem('cc_perfCollapsed');
    if (saved === '1') det.removeAttribute('open');
    det.addEventListener('toggle', function() {
      localStorage.setItem('cc_perfCollapsed', det.open ? '0' : '1');
      var hint = document.getElementById('perfToggleHint');
      if (hint) hint.textContent = det.open ? '(click to collapse)' : '(click to expand)';
    });
  })();

  // Try to load map images from server
  function tryLoadMapImage(mapId, layer) {
    var key = mapId + '_' + layer;
    if (_mapImageCache[key]) return;
    // Map internal name to image filename
    var fileMap = {
      'bigmap': 'customs', 'factory4_day': 'factory', 'factory4_night': 'factory',
      'Sandbox': 'ground_zero', 'Sandbox_high': 'ground_zero',
      'Interchange': 'interchange', 'laboratory': 'labs', 'Labyrinth': 'labyrinth',
      'Lighthouse': 'lighthouse', 'RezervBase': 'reserve', 'Shoreline': 'shoreline',
      'TarkovStreets': 'streets', 'Woods': 'woods'
    };
    var prefix = fileMap[mapId];
    if (!prefix) return;
    var suffix = prefix === 'factory' || prefix === 'labyrinth' || prefix === 'labs' ? 'layer' : 'level';
    var filename = prefix + '_' + suffix + '_' + layer + '.png';
    var img = new Image();
    img.onload = function() { drawMap(); };
    img.src = 'maps/' + filename;
    _mapImageCache[key] = img;
  }

  // Update raidInfoInit to include new data loading
  var _origRaidInfoInit = raidInfoInit;

  // Override loadTelemetry to also load perf history, alerts, and map positions
  var _origLoadTelemetry = loadTelemetry;
  var _telemTickCount = 0;

  loadTelemetry = function() {
    _origLoadTelemetry();
    _telemTickCount++;
    // Load perf history every other tick (~6s)
    if (_telemTickCount % 2 === 0) loadPerformanceHistory();
    // Load alerts every tick
    loadAlerts();
    // Load lifetime stats once, then every 10 ticks (~30s)
    if (!_lifetimeStatsLoaded || _telemTickCount % 10 === 0) loadLifetimeStats();
  };

  // ═══════════════════════════════════════════════════════
  // PLAYER MANAGEMENT
  // ═══════════════════════════════════════════════════════
  var playersData = [], playerSearch = '', playerFaction = '';
  var playerSort = 'level', playerSortDir = 'desc';
  var playerOffset = 0, playerTotal = 0, PLAYER_PAGE = 50;
  var expandedPlayerId = null, playerProfileCache = {};
  var playerSearchTimer = null;
  var currentMailTarget = '', currentModifyTarget = '', currentResetTarget = '', currentBanTarget = '';
  var currentGiveTarget = '', giveMode = 'player'; // 'player' or 'all'
  var banSectionCollapsed = false;
  var playersLoaded = false;

  var MAIL_TEMPLATES = {
    welcome: 'Welcome to the server! Please read the rules in Discord and enjoy your raids.',
    rules: 'Reminder: No cheating, no exploiting, be respectful to other players. Violations will result in a ban.',
    event: 'A special event is now live! Check Discord for details and enjoy the limited-time rewards.'
  };

  window.debouncePlayerSearch = function() {
    clearTimeout(playerSearchTimer);
    playerSearchTimer = setTimeout(function() { playerOffset = 0; loadPlayerRoster(); }, 300);
  };

  window.loadPlayerRoster = function() {
    var search = document.getElementById('playerSearchInput').value.trim();
    var faction = document.getElementById('playerFactionFilter').value;
    var qs = 'players?sort=' + encodeURIComponent(playerSort) + '&dir=' + encodeURIComponent(playerSortDir);
    if (search) qs += '&search=' + encodeURIComponent(search);
    if (faction) qs += '&faction=' + encodeURIComponent(faction);
    api(qs).then(function(data) {
      playersData = data.players || [];
      playerTotal = data.total || 0;
      playersLoaded = true;
      renderPlayerRoster();
      loadBanList();
    }).catch(function(e) {
      document.getElementById('playerRosterBody').innerHTML = '<div style="color:var(--error-bright);text-align:center;padding:30px">Error loading players: ' + escH(e.message) + '</div>';
    });
  };

  function renderPlayerRoster() {
    var body = document.getElementById('playerRosterBody');
    if (playersData.length === 0) {
      body.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:40px 0">No players found</div>';
      document.getElementById('playerPagination').style.display = 'none';
      return;
    }
    var paged = playersData.slice(playerOffset, playerOffset + PLAYER_PAGE);
    var html = '<table class="player-table"><thead><tr>';
    html += '<th onclick="togglePlayerSort(\'name\')">Name' + playerSortArrow('name') + '</th>';
    html += '<th onclick="togglePlayerSort(\'level\')">Level' + playerSortArrow('level') + '</th>';
    html += '<th>Side</th>';
    html += '<th onclick="togglePlayerSort(\'roubles\')">Roubles' + playerSortArrow('roubles') + '</th>';
    html += '<th>Status</th>';
    html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';
    for (var i = 0; i < paged.length; i++) {
      var p = paged[i];
      var isExpanded = expandedPlayerId === p.sessionId;
      html += '<tr class="' + (isExpanded ? 'expanded' : '') + '" style="cursor:pointer" onclick="togglePlayerExpand(\'' + escA(p.sessionId) + '\')">';
      html += '<td><span class="online-dot ' + (p.online ? 'on' : 'off') + '"></span>' + escH(p.nickname);
      if (p.banned) html += ' <span class="ban-badge">banned</span>';
      html += '</td>';
      html += '<td>' + p.level + '</td>';
      html += '<td><span class="faction-badge ' + (p.side || '').toLowerCase() + '">' + escH(p.side) + '</span></td>';
      html += '<td style="font-family:var(--font-mono);font-size:12px">' + formatRoubles(p.roubles) + '</td>';
      html += '<td>' + (p.online ? '<span style="color:var(--success-bright);font-size:12px">Online</span>' : '<span style="color:var(--text-muted);font-size:12px">Offline</span>') + '</td>';
      html += '<td style="white-space:nowrap">';
      html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openMailModal(\'' + escA(p.sessionId) + '\',\'' + escA(p.nickname) + '\')" title="Mail">Mail</button> ';
      html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openGiveModal(\'' + escA(p.sessionId) + '\',\'' + escA(p.nickname) + '\')" title="Give">Give</button> ';
      if (!p.banned) html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openBanModal(\'' + escA(p.sessionId) + '\',\'' + escA(p.nickname) + '\')" title="Ban" style="color:var(--error-bright)">Ban</button>';
      else html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();unbanPlayer(\'' + escA(p.sessionId) + '\')" title="Unban" style="color:var(--success-bright)">Unban</button>';
      html += '</td></tr>';
      if (isExpanded) {
        html += '<tr class="player-detail-row"><td colspan="6"><div class="player-detail-inner" id="playerDetailInner">Loading...</div></td></tr>';
      }
    }
    html += '</tbody></table>';
    body.innerHTML = html;

    // Pagination
    var pg = document.getElementById('playerPagination');
    if (playerTotal > PLAYER_PAGE) {
      pg.style.display = 'flex';
      document.getElementById('playerPaginationInfo').textContent = (playerOffset + 1) + '-' + Math.min(playerOffset + PLAYER_PAGE, playerTotal) + ' of ' + playerTotal;
    } else {
      pg.style.display = 'none';
    }

    if (expandedPlayerId) loadPlayerProfile(expandedPlayerId);
  }

  function playerSortArrow(field) {
    if (playerSort !== field) return '';
    return ' <span class="sort-arrow">' + (playerSortDir === 'asc' ? '&#9650;' : '&#9660;') + '</span>';
  }

  window.togglePlayerSort = function(field) {
    if (playerSort === field) playerSortDir = playerSortDir === 'asc' ? 'desc' : 'asc';
    else { playerSort = field; playerSortDir = field === 'name' ? 'asc' : 'desc'; }
    loadPlayerRoster();
  };

  window.playerPagePrev = function() {
    if (playerOffset > 0) { playerOffset -= PLAYER_PAGE; renderPlayerRoster(); }
  };
  window.playerPageNext = function() {
    if (playerOffset + PLAYER_PAGE < playerTotal) { playerOffset += PLAYER_PAGE; renderPlayerRoster(); }
  };

  // ── Player Expand / Profile Viewer ──
  window.togglePlayerExpand = function(sid) {
    if (expandedPlayerId === sid) { expandedPlayerId = null; renderPlayerRoster(); }
    else { expandedPlayerId = sid; renderPlayerRoster(); }
  };

  function loadPlayerProfile(sid) {
    api('player/' + encodeURIComponent(sid)).then(function(data) {
      playerProfileCache[sid] = data;
      renderPlayerProfile(data);
    }).catch(function(e) {
      var inner = document.getElementById('playerDetailInner');
      if (inner) inner.innerHTML = '<div style="color:var(--error-bright)">Error: ' + escH(e.message) + '</div>';
    });
  }

  var activeProfileTab = 'overview';

  function renderPlayerProfile(data) {
    var inner = document.getElementById('playerDetailInner');
    if (!inner) return;
    var sid = data.sessionId;
    var html = '';

    // Actions bar
    html += '<div class="player-actions-bar">';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openMailModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')">Mail</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openGiveModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')">Give Items</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModifyModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')">Modify</button>';
    html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openResetModal(\'' + escA(sid) + '\',\'' + escA(data.nickname) + '\')" style="color:var(--warning)">Reset</button>';
    html += '</div>';

    // Sub-tabs
    html += '<div class="player-profile-tabs" onclick="event.stopPropagation()">';
    var tabs = ['overview','stats','stash','skills','quests','hideout','traders'];
    var tabLabels = ['Overview','Stats','Stash','Skills','Quests','Hideout','Traders'];
    for (var i = 0; i < tabs.length; i++) {
      html += '<button class="ptab' + (activeProfileTab === tabs[i] ? ' active' : '') + '" onclick="event.stopPropagation();switchProfileTab(\'' + tabs[i] + '\',\'' + escA(sid) + '\')">' + tabLabels[i] + '</button>';
    }
    html += '</div>';

    // Panels
    html += renderProfileOverview(data);
    html += renderProfileStats(sid);
    html += renderProfileStash(sid);
    html += renderProfileSkills(data);
    html += renderProfileQuests(data);
    html += renderProfileHideout(data);
    html += renderProfileTraders(data);

    inner.innerHTML = html;
  }

  window.switchProfileTab = function(tab, sid) {
    activeProfileTab = tab;
    document.querySelectorAll('.player-profile-tabs .ptab').forEach(function(b) {
      b.classList.toggle('active', b.textContent.toLowerCase() === tab);
    });
    document.querySelectorAll('.profile-panel').forEach(function(p) {
      p.classList.toggle('active', p.dataset.panel === tab);
    });
    if (tab === 'stats' && sid) loadPlayerStats(sid);
    if (tab === 'stash' && sid) loadPlayerStash(sid, 0);
  };

  function renderProfileOverview(d) {
    var active = activeProfileTab === 'overview' ? ' active' : '';
    var xpPct = d.experienceToNextLevel > 0 ? Math.round(100 - (d.experienceToNextLevel / (d.experience + d.experienceToNextLevel) * 100)) : 100;
    var html = '<div class="profile-panel' + active + '" data-panel="overview">';
    html += '<div class="profile-header">';
    html += statCard('Level', d.level, '<div class="xp-bar"><div class="xp-bar-fill" style="width:' + xpPct + '%"></div></div><div class="psc-sub">' + (d.experience || 0).toLocaleString() + ' XP (' + (d.experienceToNextLevel || 0).toLocaleString() + ' to next)</div>');
    html += statCard('Faction', '<span class="faction-badge ' + (d.side || '').toLowerCase() + '">' + escH(d.side) + '</span>');
    html += statCard('Stash Value', formatRoubles(Math.round(d.stashValue || 0)), '', 'accent');
    html += statCard('Roubles', formatRoubles(d.currencies ? d.currencies.roubles : 0));
    html += statCard('Dollars', formatRoubles(d.currencies ? d.currencies.dollars : 0));
    html += statCard('Euros', formatRoubles(d.currencies ? d.currencies.euros : 0));
    html += '</div>';
    html += '<div class="profile-header">';
    html += statCard('Total Raids', d.totalRaids || 0);
    html += statCard('Survival Rate', (d.survivalRate || 0) + '%', '', 'accent');
    html += statCard('Kills', d.kills || 0, '', 'accent');
    html += statCard('PMC Kills', d.pmcKills || 0);
    html += statCard('Scav Kills', d.scavKills || 0);
    html += statCard('Boss Kills', d.bossKills || 0);
    html += statCard('K/D Ratio', (d.kdRatio || 0).toFixed(2), '', 'accent');
    html += '</div>';
    html += '<div class="profile-header">';
    html += statCard('Headshots', d.headshots || 0);
    html += statCard('Longest Shot', (d.longestShot || 0).toFixed(1) + 'm');
    html += statCard('Overall Accuracy', (d.overallAccuracy || 0).toFixed(1) + '%');
    html += statCard('Longest Win Streak', d.longestWinStreak || 0);
    var otSec = d.onlineTimeSec || 0;
    var otH = Math.floor(otSec / 3600);
    var otM = Math.floor((otSec % 3600) / 60);
    html += statCard('Online Time', otH > 0 ? otH + 'h ' + otM + 'm' : otM + 'm');
    html += '</div>';
    html += '</div>';
    return html;
  }

  function statCard(label, value, extra, cls) {
    return '<div class="profile-stat-card"><div class="psc-label">' + label + '</div><div class="psc-value' + (cls ? ' ' + cls : '') + '">' + value + '</div>' + (extra || '') + '</div>';
  }

  // ── Stats ──
  function renderProfileStats(sid) {
    var active = activeProfileTab === 'stats' ? ' active' : '';
    return '<div class="profile-panel' + active + '" data-panel="stats" id="statsPanel_' + sid + '">' +
      '<div style="color:var(--text-dim);text-align:center;padding:20px">Click to load full stats</div></div>';
  }

  function loadPlayerStats(sid) {
    var panel = document.getElementById('statsPanel_' + sid);
    if (!panel) return;
    panel.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px">Loading stats...</div>';

    api('player/' + sid + '/stats').then(function(s) {
      var html = '';

      function fmtTime(sec) {
        if (!sec) return '0s';
        var h = Math.floor(sec / 3600);
        var m = Math.floor((sec % 3600) / 60);
        var ss = sec % 60;
        if (h > 0) return h + 'h ' + m + 'm ' + ss + 's';
        if (m > 0) return m + 'm ' + ss + 's';
        return ss + 's';
      }

      function fmtDate(ts) {
        if (!ts) return '—';
        var d = new Date(ts * 1000);
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      }

      function fmtPct(v) { return (v || 0).toFixed(1) + '%'; }
      function fmtRatio(v) { return (v || 0).toFixed(2); }
      function fmtDist(v) { return v ? v.toFixed(1) + 'm' : '0m'; }
      function fmtDays(d) {
        if (!d) return '0 days';
        if (d >= 365) return Math.floor(d/365) + 'y ' + (d%365) + 'd';
        return d + ' days';
      }

      function statsSection(title, rows, startOpen) {
        var id = 'statsSection_' + title.replace(/[^a-zA-Z]/g,'');
        var o = startOpen ? ' open' : '';
        var h = '<div class="stats-section' + o + '" id="' + id + '">';
        h += '<div class="stats-section-header" onclick="this.parentElement.classList.toggle(\'open\')">';
        h += '<span>' + escH(title) + '</span>';
        h += '<span class="stats-toggle-icon"></span>';
        h += '</div>';
        h += '<div class="stats-section-body"><div class="stats-grid">';
        for (var i = 0; i < rows.length; i++) {
          h += statCard(rows[i][0], rows[i][1], '', rows[i][2] || '');
        }
        h += '</div></div></div>';
        return h;
      }

      // Raid Overview
      html += statsSection('Raid Overview', [
        ['Raids', s.raids || 0],
        ['Survived', s.survived || 0],
        ['KIA', s.kia || 0],
        ['MIA', s.mia || 0],
        ['AWOL', s.awol || 0],
        ['Kills', s.kills || 0, 'accent'],
        ['Online Time', fmtTime(s.onlineTimeSec)],
        ['Run-throughs', s.runThroughs || 0],
        ['Survival Rate', fmtPct(s.survivalRate), 'accent'],
        ['Avg Life Span', fmtTime(s.avgLifeSpanSec)],
        ['Win Streak (Current)', s.currentWinStreak || 0],
        ['Win Streak (Longest)', s.longestWinStreak || 0],
        ['Leave Rate', fmtPct(s.leaveRate)],
        ['K/D Ratio', fmtRatio(s.kdRatio), 'accent'],
        ['Account Lifetime', fmtDays(s.accountLifetimeDays)]
      ], true);

      // Common Stats
      html += statsSection('Common Stats', [
        ['Registration Date', fmtDate(s.registrationDate)],
        ['Last Session', fmtDate(s.lastSessionDate)],
        ['Survivor Class', s.survivorClass || '—'],
        ['Kill XP', (s.killExperience || 0).toLocaleString()],
        ['Looting XP', (s.lootingExperience || 0).toLocaleString()],
        ['Healing XP', (s.healingExperience || 0).toLocaleString()],
        ['Survival XP', (s.survivalExperience || 0).toLocaleString()],
        ['Stash Value', formatRoubles(Math.round(s.stashValue || 0)), 'accent']
      ], false);

      // Health & Physical Condition
      html += statsSection('Health & Physical Condition', [
        ['Blood Lost', (s.bloodLost || 0).toLocaleString()],
        ['Limbs Lost', s.limbsLost || 0],
        ['Least Damaged Area', s.leastDamagedArea || '—'],
        ['HP Healed', Math.round(s.hpHealed || 0).toLocaleString()],
        ['Fractures', s.fractures || 0],
        ['Concussions', s.concussions || 0],
        ['Dehydrations', s.dehydrations || 0],
        ['Exhaustions', s.exhaustions || 0],
        ['Drinks Consumed', s.drinksConsumed || 0],
        ['Food Consumed', s.foodConsumed || 0],
        ['Medicine Used', s.medicineUsed || 0]
      ], false);

      // Loot / Items Found
      html += statsSection('Loot / Items Found', [
        ['USD Found', '$' + (s.usdFound || 0).toLocaleString()],
        ['EUR Found', '\u20ac' + (s.eurFound || 0).toLocaleString()],
        ['RUB Found', formatRoubles(s.rubFound || 0)],
        ['Bodies Looted', s.bodiesLooted || 0],
        ['Places Looted', s.placesLooted || 0],
        ['Safes Unlocked', s.safesUnlocked || 0],
        ['Weapons Found', s.weaponsFound || 0],
        ['Mods Found', s.modsFound || 0],
        ['Throwables Found', s.throwablesFound || 0],
        ['Special Items Found', s.specialItemsFound || 0],
        ['Provisions Found', s.provisionsFound || 0],
        ['Keys Found', s.keysFound || 0],
        ['Barter Goods Found', s.barterGoodsFound || 0],
        ['Equipment Found', s.equipmentFound || 0]
      ], false);

      // Combat
      html += statsSection('Combat', [
        ['Damage Absorbed by Armor', (s.damageAbsorbedByArmor || 0).toLocaleString()],
        ['Ammo Used', (s.ammoUsed || 0).toLocaleString()],
        ['Hit Count', (s.hitCount || 0).toLocaleString()],
        ['Fatal Hits', (s.fatalHits || 0).toLocaleString()],
        ['Overall Accuracy', fmtPct(s.overallAccuracy)],
        ['Longest Shot', fmtDist(s.longestShot)],
        ['Lvl 0-10 Kills', s.killedLevel010 || 0],
        ['Lvl 11-30 Kills', s.killedLevel1130 || 0],
        ['Lvl 31-50 Kills', s.killedLevel3150 || 0],
        ['Lvl 51-70 Kills', s.killedLevel5170 || 0],
        ['Lvl 71-99 Kills', s.killedLevel7199 || 0],
        ['Lvl 100 Kills', s.killedLevel100 || 0],
        ['BEARs Killed', s.bearsKilled || 0],
        ['USECs Killed', s.usecsKilled || 0],
        ['Scavs Killed', s.scavsKilled || 0, 'accent'],
        ['PMCs Killed', s.pmcsKilled || 0, 'accent'],
        ['Bosses Killed', s.bossesKilled || 0, 'accent'],
        ['Headshots', s.headshots || 0, 'accent']
      ], false);

      panel.innerHTML = html;
    }).catch(function(e) {
      panel.innerHTML = '<div style="color:var(--error-bright);text-align:center;padding:20px">Error: ' + escH(e.message) + '</div>';
    });
  }

  // ── Stash ──
  var stashCache = {};
  function renderProfileStash(sid) {
    var active = activeProfileTab === 'stash' ? ' active' : '';
    return '<div class="profile-panel' + active + '" data-panel="stash" id="stashPanel_' + sid + '">' +
      '<div style="color:var(--text-dim);text-align:center;padding:20px">Click to load stash data</div></div>';
  }

  window.loadPlayerStash = function(sid, offset) {
    var panel = document.getElementById('stashPanel_' + sid);
    if (!panel) return;
    panel.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px">Loading stash...</div>';
    api('player/' + encodeURIComponent(sid) + '/stash?limit=50&offset=' + (offset || 0)).then(function(data) {
      stashCache[sid] = data;
      var html = '<div style="margin-bottom:8px;font-size:12px;color:var(--text-dim)">' + (data.totalItems || 0) + ' items | Stash value: ' + formatRoubles(Math.round(data.stashValue || 0)) + '</div>';
      if (data.items && data.items.length > 0) {
        html += '<table class="profile-mini-table"><thead><tr><th>Name</th><th>TPL</th><th>Qty</th></tr></thead><tbody>';
        for (var i = 0; i < data.items.length; i++) {
          var it = data.items[i];
          html += '<tr><td>' + escH(it.name) + '</td><td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">' + escH(it.tpl).substring(0, 12) + '...</td><td>' + it.count + '</td></tr>';
        }
        html += '</tbody></table>';
        // pagination
        var total = data.totalItems || 0;
        var off = data.offset || 0;
        var lim = data.limit || 50;
        if (total > lim) {
          html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px">';
          html += '<span style="color:var(--text-dim)">' + (off + 1) + '-' + Math.min(off + lim, total) + ' of ' + total + '</span>';
          html += '<div>';
          if (off > 0) html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();loadPlayerStash(\'' + escA(sid) + '\',' + (off - lim) + ')">Prev</button> ';
          if (off + lim < total) html += '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();loadPlayerStash(\'' + escA(sid) + '\',' + (off + lim) + ')">Next</button>';
          html += '</div></div>';
        }
      } else {
        html += '<div style="color:var(--text-dim);text-align:center;padding:20px">Stash is empty</div>';
      }
      panel.innerHTML = html;
    }).catch(function(e) {
      panel.innerHTML = '<div style="color:var(--error-bright)">Error: ' + escH(e.message) + '</div>';
    });
  };

  // ── Skills ──
  function renderProfileSkills(d) {
    var active = activeProfileTab === 'skills' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="skills">';
    var skills = d.skills || [];
    if (skills.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No skill data</div>'; }
    else {
      html += '<table class="profile-mini-table"><thead><tr><th>Skill</th><th>Level</th><th>Progress</th><th></th></tr></thead><tbody>';
      for (var i = 0; i < skills.length; i++) {
        var s = skills[i];
        var pct = Math.min(100, (s.progress % 100));
        html += '<tr><td>' + escH(s.id) + '</td><td>' + s.level;
        if (s.isElite) html += ' <span class="status-badge completed">Elite</span>';
        html += '</td><td><div class="skill-bar"><div class="skill-bar-fill" style="width:' + pct + '%"></div></div></td>';
        html += '<td style="font-size:11px;color:var(--text-dim)">' + Math.round(s.progress) + '</td></tr>';
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Quests ──
  var expandedQuests = {};
  window.toggleQuestDetail = function(idx) {
    expandedQuests[idx] = !expandedQuests[idx];
    var chevron = document.getElementById('qchev_' + idx);
    var detail = document.getElementById('qdet_' + idx);
    if (chevron) chevron.classList.toggle('expanded', !!expandedQuests[idx]);
    if (detail) detail.style.display = expandedQuests[idx] ? '' : 'none';
  };

  function renderProfileQuests(d) {
    var active = activeProfileTab === 'quests' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="quests">';
    var quests = d.quests || [];
    if (quests.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No quest data</div>'; }
    else {
      html += '<table class="profile-mini-table"><thead><tr><th>Quest Name</th><th>Quest ID</th><th>Trader</th><th>Status</th><th style="width:30px"></th></tr></thead><tbody>';
      for (var i = 0; i < quests.length; i++) {
        var q = quests[i];
        var st = (q.status || '').toLowerCase();
        var badgeCls = st.includes('success') || st.includes('complete') ? 'completed' : st.includes('fail') ? 'failed' : st.includes('started') || st.includes('avail') ? 'active' : 'locked';
        var qid = q.questId || '';
        var qidShort = qid.length > 8 ? qid.substring(0, 8) + '...' : qid;
        var hasConds = q.conditions && q.conditions.length > 0;
        var isExp = !!expandedQuests[i];
        html += '<tr>';
        html += '<td style="font-weight:500">' + escH(q.questName || qid) + '</td>';
        html += '<td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)" title="' + escA(qid) + '">' + escH(qidShort) + '</td>';
        html += '<td>' + escH(q.traderName || 'Unknown') + '</td>';
        html += '<td><span class="status-badge ' + badgeCls + '">' + escH(q.status) + '</span></td>';
        html += '<td style="text-align:center">';
        if (hasConds) {
          html += '<span id="qchev_' + i + '" class="quest-chevron' + (isExp ? ' expanded' : '') + '" onclick="event.stopPropagation();toggleQuestDetail(' + i + ')">&#9654;</span>';
        }
        html += '</td></tr>';
        // Detail row
        if (hasConds) {
          html += '<tr id="qdet_' + i + '" class="quest-detail-row" style="display:' + (isExp ? '' : 'none') + '"><td colspan="5"><div class="quest-detail-inner">';
          for (var j = 0; j < q.conditions.length; j++) {
            var c = q.conditions[j];
            var cls = c.completed ? 'completed' : 'pending';
            var icon = c.completed ? '&#10003;' : '&#9675;';
            html += '<div class="quest-condition ' + cls + '">';
            html += '<span class="qc-icon">' + icon + '</span>';
            html += '<span class="qc-type">' + escH(c.type) + '</span>';
            html += '<span class="qc-text">' + escH(c.description) + '</span>';
            html += '</div>';
          }
          html += '</div></td></tr>';
        }
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Hideout ──
  var HIDEOUT_NAMES = ['NotSet','Vents','Security','Lavatory','Stash','Generator','Heating','Water','MedStation','Nutrition','Illumination','Workbench','IntelCenter','ShootingRange','Library','ScavCase','Stash2','Stash3','Stash4','Christmas','EmergencyWall','Gym','Defective','IntegratedSecurity','MetalCutting','Greenhouse','CultistAltar'];
  function renderProfileHideout(d) {
    var active = activeProfileTab === 'hideout' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="hideout">';
    var areas = d.hideoutAreas || [];
    if (areas.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No hideout data</div>'; }
    else {
      html += '<table class="profile-mini-table"><thead><tr><th>Area</th><th>Level</th><th>Status</th></tr></thead><tbody>';
      for (var i = 0; i < areas.length; i++) {
        var a = areas[i];
        var name = HIDEOUT_NAMES[a.areaType] || ('Area ' + a.areaType);
        var status = a.constructing ? '<span style="color:var(--warning);font-size:11px">Constructing</span>' : a.active ? '<span style="color:var(--success-bright);font-size:11px">Active</span>' : '<span style="color:var(--text-dim);font-size:11px">Inactive</span>';
        html += '<tr><td>' + escH(name) + '</td><td>' + a.level + '</td><td>' + status + '</td></tr>';
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Traders ──
  function renderProfileTraders(d) {
    var active = activeProfileTab === 'traders' ? ' active' : '';
    var html = '<div class="profile-panel' + active + '" data-panel="traders">';
    var traders = d.traders || [];
    if (traders.length === 0) { html += '<div style="color:var(--text-dim);padding:20px;text-align:center">No trader data</div>'; }
    else {
      var romans = ['0','I','II','III','IV'];
      html += '<table class="profile-mini-table"><thead><tr><th>Trader</th><th>Loyalty</th><th>Standing</th><th>Sales</th></tr></thead><tbody>';
      for (var i = 0; i < traders.length; i++) {
        var t = traders[i];
        html += '<tr><td>' + escH(t.traderName) + '</td>';
        html += '<td style="color:var(--accent);font-family:var(--font-mono)">' + (romans[t.loyaltyLevel] || t.loyaltyLevel) + '</td>';
        html += '<td style="font-family:var(--font-mono)">' + (t.standing || 0).toFixed(2) + '</td>';
        html += '<td style="font-family:var(--font-mono);font-size:12px">' + formatRoubles(t.salesSum || 0) + '</td></tr>';
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    return html;
  }

  // ── Modals ──
  window.closeModal = function(id) {
    document.getElementById(id).classList.remove('open');
  };

  window.openMailModal = function(sid, name) {
    currentMailTarget = sid;
    document.getElementById('mailRecipientName').textContent = name;
    document.getElementById('mailMessage').value = '';
    document.getElementById('mailTemplate').value = '';
    document.getElementById('mailRoubles').value = '0';
    document.getElementById('mailDollars').value = '0';
    document.getElementById('mailEuros').value = '0';
    document.getElementById('mailItemRows').innerHTML = '';
    document.getElementById('playerMailModal').classList.add('open');
  };

  window.applyMailTemplate = function() {
    var key = document.getElementById('mailTemplate').value;
    if (MAIL_TEMPLATES[key]) document.getElementById('mailMessage').value = MAIL_TEMPLATES[key];
  };

  window.addMailItemRow = function() {
    var container = document.getElementById('mailItemRows');
    var row = document.createElement('div');
    row.className = 'mail-item-row';
    row.innerHTML = '<input type="text" placeholder="Item Template ID" class="mail-item-tpl"><input type="number" min="1" value="1" class="mail-item-count" style="max-width:80px"><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">X</button>';
    container.appendChild(row);
  };

  window.sendPlayerMail = function() {
    var msg = document.getElementById('mailMessage').value.trim();
    if (!msg) { toast('Message is required', 'error'); return; }
    var items = collectItemRows('mailItemRows');
    var body = {
      message: msg, items: items,
      roubles: parseInt(document.getElementById('mailRoubles').value) || 0,
      dollars: parseInt(document.getElementById('mailDollars').value) || 0,
      euros: parseInt(document.getElementById('mailEuros').value) || 0
    };
    api('player/' + encodeURIComponent(currentMailTarget) + '/mail', { method: 'POST', body: JSON.stringify(body) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Mail sent', 'success'); closeModal('playerMailModal'); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openModifyModal = function(sid, name) {
    currentModifyTarget = sid;
    document.getElementById('modifyTargetName').textContent = name;
    document.getElementById('modifyLevel').value = '';
    document.getElementById('modifyFaction').value = '';
    document.getElementById('modifyRoubles').value = '0';
    document.getElementById('modifyDollars').value = '0';
    document.getElementById('modifyEuros').value = '0';
    document.getElementById('playerModifyModal').classList.add('open');
  };

  window.submitModify = function() {
    var body = {};
    var lvl = parseInt(document.getElementById('modifyLevel').value);
    if (lvl > 0) body.level = lvl;
    var fac = document.getElementById('modifyFaction').value;
    if (fac) body.faction = fac;
    var r = parseInt(document.getElementById('modifyRoubles').value) || 0;
    var d = parseInt(document.getElementById('modifyDollars').value) || 0;
    var e = parseInt(document.getElementById('modifyEuros').value) || 0;
    if (r > 0) body.roubles = r;
    if (d > 0) body.dollars = d;
    if (e > 0) body.euros = e;
    api('player/' + encodeURIComponent(currentModifyTarget) + '/modify', { method: 'POST', body: JSON.stringify(body) })
      .then(function(res) {
        if (res.success) { toast(res.message || 'Modified', 'success'); closeModal('playerModifyModal'); delete playerProfileCache[currentModifyTarget]; if (expandedPlayerId === currentModifyTarget) loadPlayerProfile(currentModifyTarget); loadPlayerRoster(); }
        else toast(res.error || 'Failed', 'error');
      }).catch(function(err) { toast('Error: ' + err.message, 'error'); });
  };

  window.openResetModal = function(sid, name) {
    currentResetTarget = sid;
    document.getElementById('resetTargetName').textContent = name;
    document.getElementById('resetSkills').checked = false;
    document.getElementById('resetQuests').checked = false;
    document.getElementById('resetTraders').checked = false;
    document.getElementById('resetHideout').checked = false;
    document.getElementById('resetFull').checked = false;
    document.getElementById('resetConfirmInput').value = '';
    document.getElementById('resetConfirmBtn').disabled = true;
    document.getElementById('playerResetModal').classList.add('open');
  };

  window.toggleFullReset = function() {
    var full = document.getElementById('resetFull').checked;
    document.getElementById('resetSkills').checked = full;
    document.getElementById('resetQuests').checked = full;
    document.getElementById('resetTraders').checked = full;
    document.getElementById('resetHideout').checked = full;
  };

  window.checkResetConfirm = function() {
    document.getElementById('resetConfirmBtn').disabled = document.getElementById('resetConfirmInput').value.trim() !== 'RESET';
  };

  window.submitReset = function() {
    var cats = [];
    if (document.getElementById('resetFull').checked) cats.push('full');
    else {
      if (document.getElementById('resetSkills').checked) cats.push('skills');
      if (document.getElementById('resetQuests').checked) cats.push('quests');
      if (document.getElementById('resetTraders').checked) cats.push('traders');
      if (document.getElementById('resetHideout').checked) cats.push('hideout');
    }
    if (cats.length === 0) { toast('Select at least one category', 'error'); return; }
    api('player/' + encodeURIComponent(currentResetTarget) + '/reset', { method: 'POST', body: JSON.stringify({ categories: cats }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Reset complete', 'success'); closeModal('playerResetModal'); delete playerProfileCache[currentResetTarget]; if (expandedPlayerId === currentResetTarget) loadPlayerProfile(currentResetTarget); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openBanModal = function(sid, name) {
    currentBanTarget = sid;
    document.getElementById('banTargetName').textContent = name;
    document.getElementById('banReason').value = '';
    document.getElementById('playerBanModal').classList.add('open');
  };

  window.confirmBan = function() {
    var reason = document.getElementById('banReason').value.trim() || 'No reason given';
    api('players/ban', { method: 'POST', body: JSON.stringify({ sessionId: currentBanTarget, reason: reason }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Banned', 'success'); closeModal('playerBanModal'); loadPlayerRoster(); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.unbanPlayer = function(sid) {
    api('players/unban', { method: 'POST', body: JSON.stringify({ sessionId: sid }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Unbanned', 'success'); loadPlayerRoster(); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openGiveModal = function(sid, name) {
    currentGiveTarget = sid; giveMode = 'player';
    document.getElementById('giveModalTitle').textContent = 'Give Items';
    document.getElementById('giveModalSub').textContent = 'To: ' + name;
    document.getElementById('giveItemRows').innerHTML = '';
    addGiveItemRow();
    document.getElementById('playerGiveModal').classList.add('open');
  };

  window.openGiveAllModal = function() {
    giveMode = 'all';
    document.getElementById('giveModalTitle').textContent = 'Give Items to All';
    document.getElementById('giveModalSub').textContent = 'Items will be sent to all registered players.';
    document.getElementById('giveItemRows').innerHTML = '';
    addGiveItemRow();
    document.getElementById('playerGiveModal').classList.add('open');
  };

  window.addGiveItemRow = function() {
    var container = document.getElementById('giveItemRows');
    var row = document.createElement('div');
    row.className = 'mail-item-row';
    row.innerHTML = '<input type="text" placeholder="Item Template ID" class="give-item-tpl"><input type="number" min="1" value="1" class="give-item-count" style="max-width:80px"><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">X</button>';
    container.appendChild(row);
  };

  window.submitGive = function() {
    var items = collectItemRows('giveItemRows');
    if (items.length === 0) { toast('Add at least one item', 'error'); return; }
    var endpoint = giveMode === 'all' ? 'player/give-all' : 'player/' + encodeURIComponent(currentGiveTarget) + '/give';
    api(endpoint, { method: 'POST', body: JSON.stringify({ items: items }) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Items sent', 'success'); closeModal('playerGiveModal'); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  window.openBroadcastMailModal = function() {
    document.getElementById('broadcastMailMessage').value = '';
    document.getElementById('broadcastRoubles').value = '0';
    document.getElementById('broadcastDollars').value = '0';
    document.getElementById('broadcastEuros').value = '0';
    document.getElementById('broadcastItemRows').innerHTML = '';
    document.getElementById('broadcastMailModal').classList.add('open');
  };

  window.addBroadcastItemRow = function() {
    var container = document.getElementById('broadcastItemRows');
    var row = document.createElement('div');
    row.className = 'mail-item-row';
    row.innerHTML = '<input type="text" placeholder="Item Template ID" class="bc-item-tpl"><input type="number" min="1" value="1" class="bc-item-count" style="max-width:80px"><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">X</button>';
    container.appendChild(row);
  };

  window.sendBroadcastMail = function() {
    var msg = document.getElementById('broadcastMailMessage').value.trim();
    if (!msg) { toast('Message is required', 'error'); return; }
    var items = [];
    document.querySelectorAll('#broadcastItemRows .mail-item-row').forEach(function(row) {
      var tpl = row.querySelector('.bc-item-tpl').value.trim();
      var cnt = parseInt(row.querySelector('.bc-item-count').value) || 1;
      if (tpl) items.push({ tpl: tpl, count: cnt });
    });
    var body = {
      message: msg, items: items,
      roubles: parseInt(document.getElementById('broadcastRoubles').value) || 0,
      dollars: parseInt(document.getElementById('broadcastDollars').value) || 0,
      euros: parseInt(document.getElementById('broadcastEuros').value) || 0
    };
    api('player/broadcast', { method: 'POST', body: JSON.stringify(body) })
      .then(function(d) {
        if (d.success) { toast(d.message || 'Broadcast sent', 'success'); closeModal('broadcastMailModal'); }
        else toast(d.error || 'Failed', 'error');
      }).catch(function(e) { toast('Error: ' + e.message, 'error'); });
  };

  function collectItemRows(containerId) {
    var items = [];
    document.querySelectorAll('#' + containerId + ' .mail-item-row').forEach(function(row) {
      var tplInput = row.querySelector('input[type="text"]');
      var cntInput = row.querySelector('input[type="number"]');
      var tpl = tplInput ? tplInput.value.trim() : '';
      var cnt = cntInput ? (parseInt(cntInput.value) || 1) : 1;
      if (tpl) items.push({ tpl: tpl, count: cnt });
    });
    return items;
  }

  // ── Ban List ──
  function loadBanList() {
    api('players/bans').then(function(data) {
      var entries = data.entries || [];
      document.getElementById('banCount').textContent = '(' + entries.length + ')';
      var body = document.getElementById('banListBody');
      if (entries.length === 0) {
        body.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px 0;font-size:13px">No banned players</div>';
        return;
      }
      var html = '<table class="profile-mini-table"><thead><tr><th>Nickname</th><th>Session</th><th>Reason</th><th>Date</th><th></th></tr></thead><tbody>';
      for (var i = 0; i < entries.length; i++) {
        var b = entries[i];
        var maskedSid = b.sessionId ? '...' + b.sessionId.slice(-4) : '';
        html += '<tr><td>' + escH(b.nickname) + '</td>';
        html += '<td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">' + escH(maskedSid) + '</td>';
        html += '<td>' + escH(b.reason) + '</td>';
        html += '<td style="font-size:11px;color:var(--text-dim)">' + new Date(b.bannedAt).toLocaleDateString() + '</td>';
        html += '<td><button class="btn btn-ghost btn-sm" onclick="unbanPlayer(\'' + escA(b.sessionId) + '\')" style="color:var(--success-bright)">Unban</button></td></tr>';
      }
      html += '</tbody></table>';
      body.innerHTML = html;
    }).catch(function() {});
  }

  window.toggleBanSection = function() {
    banSectionCollapsed = !banSectionCollapsed;
    document.getElementById('banSectionHeader').classList.toggle('collapsed', banSectionCollapsed);
    document.getElementById('banSectionBody').classList.toggle('collapsed', banSectionCollapsed);
  };

  // ═══════════════════════════════════════════════════════
  // QUEST BROWSER
  // ═══════════════════════════════════════════════════════
  var questsLoaded = false;
  var questBrowserData = [];
  var questBrowserMaps = [];
  var questBrowserExpanded = {};
  var questBrowserSort = 'trader';
  var questBrowserSortDir = 'asc';
  var questBrowserMapFilter = 'all';
  var questSearchTimer = null;
  var questPlayersCache = null;

  function debounceQuestSearch() {
    clearTimeout(questSearchTimer);
    questSearchTimer = setTimeout(function() { loadQuestBrowser(); }, 300);
  }

  function loadQuestBrowser() {
    var search = (document.getElementById('questSearchInput') || {}).value || '';
    var params = 'quests?sort=' + encodeURIComponent(questBrowserSort)
      + '&dir=' + encodeURIComponent(questBrowserSortDir);
    if (search) params += '&search=' + encodeURIComponent(search);
    if (questBrowserMapFilter && questBrowserMapFilter !== 'all')
      params += '&map=' + encodeURIComponent(questBrowserMapFilter);

    api(params).then(function(d) {
      questsLoaded = true;
      questBrowserData = d.quests || [];
      questBrowserMaps = d.maps || [];
      document.getElementById('questCountLabel').textContent = d.total + ' quests';
      renderQuestMapChips();
      renderQuestBrowserTable();
    }).catch(function(e) {
      document.getElementById('questBrowserBody').innerHTML =
        '<tr><td colspan="6" style="text-align:center;color:var(--error-bright);padding:20px">Failed to load quests: ' + escH(e.message) + '</td></tr>';
    });
  }

  function renderQuestMapChips() {
    var el = document.getElementById('questMapChips');
    var total = 0;
    questBrowserMaps.forEach(function(m) { total += m.count; });

    var html = '<button class="qb-chip' + (questBrowserMapFilter === 'all' ? ' active' : '') +
      '" onclick="setQuestMapFilter(\'all\')">All <span class="qb-chip-count">(' + total + ')</span></button>';

    questBrowserMaps.forEach(function(m) {
      var active = questBrowserMapFilter === m.location ? ' active' : '';
      html += '<button class="qb-chip' + active + '" onclick="setQuestMapFilter(\'' + escA(m.location) + '\')">' +
        escH(m.locationName) + ' <span class="qb-chip-count">(' + m.count + ')</span></button>';
    });
    el.innerHTML = html;
  }

  function renderQuestBrowserTable() {
    // Update sort arrows
    ['name','trader','map','level','objectives'].forEach(function(f) {
      var arrow = document.getElementById('qbArrow_' + f);
      if (arrow) arrow.textContent = questBrowserSort === f ? (questBrowserSortDir === 'asc' ? '\u25B2' : '\u25BC') : '';
    });

    var body = document.getElementById('questBrowserBody');
    if (questBrowserData.length === 0) {
      body.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim);padding:30px">No quests found</td></tr>';
      return;
    }

    var html = '';
    questBrowserData.forEach(function(q, i) {
      var isExp = !!questBrowserExpanded[q.questId];
      html += '<tr>';
      html += '<td style="font-weight:500">' + escH(q.questName) + '</td>';
      html += '<td>' + escH(q.traderName) + '</td>';
      html += '<td>' + escH(q.locationName) + '</td>';
      html += '<td style="text-align:center">' + q.levelRequired + '</td>';
      html += '<td style="text-align:center">' + q.objectiveCount + '</td>';
      html += '<td><span class="quest-chevron' + (isExp ? ' expanded' : '') + '" id="qbchev_' + i + '" onclick="toggleQuestBrowserDetail(\'' + escA(q.questId) + '\',' + i + ')">&#9654;</span></td>';
      html += '</tr>';
      // Detail row (hidden by default)
      html += '<tr class="qb-detail-row" id="qbdet_' + i + '" style="display:' + (isExp ? '' : 'none') + '">';
      html += '<td colspan="6"><div class="qb-detail-inner" id="qbdetc_' + i + '">';
      if (isExp) html += buildQuestDetailHtml(q.questId, i);
      html += '</div></td></tr>';
    });
    body.innerHTML = html;
  }

  window.toggleQuestBrowserDetail = function(questId, idx) {
    var wasExpanded = !!questBrowserExpanded[questId];
    questBrowserExpanded[questId] = !wasExpanded;
    var chevron = document.getElementById('qbchev_' + idx);
    var detail = document.getElementById('qbdet_' + idx);
    var detailContent = document.getElementById('qbdetc_' + idx);
    if (chevron) chevron.classList.toggle('expanded', !wasExpanded);
    if (detail) detail.style.display = wasExpanded ? 'none' : '';
    if (!wasExpanded && detailContent) {
      detailContent.innerHTML = '<div style="color:var(--text-dim);font-size:12px;padding:8px">Loading...</div>';
      api('quests/' + encodeURIComponent(questId)).then(function(d) {
        detailContent.innerHTML = buildQuestDetailFromData(d);
      }).catch(function(e) {
        detailContent.innerHTML = '<div style="color:var(--error-bright);font-size:12px;padding:8px">Failed to load: ' + escH(e.message) + '</div>';
      });
    }
  };

  function buildQuestDetailHtml(questId, idx) {
    return '<div style="color:var(--text-dim);font-size:12px;padding:8px">Loading...</div>';
  }

  function buildQuestDetailFromData(d) {
    var html = '';
    // Objectives
    if (d.objectives && d.objectives.length > 0) {
      html += '<h4>Objectives</h4><ul class="qb-obj-list">';
      d.objectives.forEach(function(obj) {
        html += '<li class="qb-obj-item">';
        html += '<span class="qb-obj-type">' + escH(obj.type) + '</span>';
        html += '<span>' + escH(obj.description) + '</span>';
        html += '</li>';
      });
      html += '</ul>';
    } else {
      html += '<div style="font-size:12px;color:var(--text-dim);margin-bottom:8px">No objectives defined</div>';
    }

    // Player state setter
    html += '<h4>Set Player Quest State</h4>';
    html += '<div class="qb-state-setter">';
    html += '<label>Player</label>';
    html += '<select id="qbPlayer_' + escA(d.questId) + '" class="qb-player-select" style="min-width:140px">';
    html += '<option value="">Select player...</option>';
    if (questPlayersCache) {
      questPlayersCache.forEach(function(p) {
        html += '<option value="' + escA(p.sessionId) + '">' + escH(p.nickname) + ' (Lv ' + p.level + ')</option>';
      });
    }
    html += '</select>';
    html += '<label>Status</label>';
    html += '<select id="qbStatus_' + escA(d.questId) + '">';
    ['Locked','AvailableForStart','Started','AvailableForFinish','Success','Fail','FailRestartable','MarkedAsFailed','Expired'].forEach(function(s) {
      html += '<option value="' + s + '">' + s + '</option>';
    });
    html += '</select>';
    html += '<button class="btn btn-accent btn-sm" onclick="submitQuestBrowserState(\'' + escA(d.questId) + '\')">Set</button>';
    html += '<span id="qbStateMsg_' + escA(d.questId) + '" style="font-size:12px"></span>';
    html += '</div>';

    return html;
  }

  window.submitQuestBrowserState = function(questId) {
    var playerSel = document.getElementById('qbPlayer_' + questId);
    var statusSel = document.getElementById('qbStatus_' + questId);
    var msgEl = document.getElementById('qbStateMsg_' + questId);
    if (!playerSel || !statusSel) return;
    var sid = playerSel.value;
    var status = statusSel.value;
    if (!sid) { if (msgEl) { msgEl.style.color = 'var(--error-bright)'; msgEl.textContent = 'Select a player'; } return; }
    if (msgEl) { msgEl.style.color = 'var(--text-dim)'; msgEl.textContent = 'Setting...'; }

    api('quests/' + encodeURIComponent(questId) + '/state', {
      method: 'POST',
      body: JSON.stringify({ sessionId: sid, status: status })
    }).then(function(d) {
      if (d.success) {
        if (msgEl) { msgEl.style.color = 'var(--success-bright)'; msgEl.textContent = d.message || 'Done'; }
      } else {
        if (msgEl) { msgEl.style.color = 'var(--error-bright)'; msgEl.textContent = d.error || 'Failed'; }
      }
    }).catch(function(e) {
      if (msgEl) { msgEl.style.color = 'var(--error-bright)'; msgEl.textContent = e.message; }
    });
  };

  window.setQuestSort = function(field) {
    if (questBrowserSort === field) {
      questBrowserSortDir = questBrowserSortDir === 'asc' ? 'desc' : 'asc';
    } else {
      questBrowserSort = field;
      questBrowserSortDir = 'asc';
    }
    questBrowserExpanded = {};
    loadQuestBrowser();
  };

  window.setQuestMapFilter = function(location) {
    questBrowserMapFilter = location;
    questBrowserExpanded = {};
    loadQuestBrowser();
  };

  // Pre-fetch player list for quest state setter
  function ensureQuestPlayersCache() {
    if (questPlayersCache !== null) return;
    api('players').then(function(d) {
      questPlayersCache = d.players || [];
    }).catch(function() { questPlayersCache = []; });
  }

  // Override loadQuestBrowser to also load players cache
  var _origLoadQuestBrowser = loadQuestBrowser;
  loadQuestBrowser = function() {
    ensureQuestPlayersCache();
    _origLoadQuestBrowser();
  };

  // ═══════════════════════════════════════════════════════
  // UTILS
  // ═══════════════════════════════════════════════════════
  // FLEA MARKET TAB
  // ═══════════════════════════════════════════════════════
  var fleaLoaded = false;
  var fleaDirty = false;
  var fleaConfig = null;
  var fleaCategories = [];
  var fleaOverridesOpen = false;
  var fleaItemSearchTimer = null;

  function fleaInit() {
    fleaLoaded = true;
    Promise.all([
      api('flea/config'),
      api('flea/categories'),
      api('flea/status')
    ]).then(function(results) {
      fleaConfig = results[0];
      fleaCategories = results[1].categories || [];
      fleaPopulateUI();
      fleaUpdateStatus(results[2]);
      fleaDirty = false;
      fleaUpdateApplyBtn();
      fleaRefreshPresets();
    }).catch(function(e) {
      toast('Failed to load flea config: ' + e.message, 'error');
    });
  }

  function fleaPopulateUI() {
    if (!fleaConfig) return;
    var c = fleaConfig;
    // Global controls
    document.getElementById('fleaGlobalBuy').value = c.globalBuyMultiplier;
    document.getElementById('fleaGlobalBuyVal').value = c.globalBuyMultiplier;
    document.getElementById('fleaVariance').value = c.dynamicPriceVariance;
    document.getElementById('fleaVarianceVal').value = Math.round(c.dynamicPriceVariance * 100);
    document.getElementById('fleaMinPrice').value = c.minPriceRoubles;
    document.getElementById('fleaMaxPrice').value = c.maxPriceRoubles;
    // Market settings
    document.getElementById('fleaTax').value = c.fleaTaxMultiplier;
    document.getElementById('fleaTaxVal').value = c.fleaTaxMultiplier;
    document.getElementById('fleaMaxOffers').value = c.playerMaxOffers;
    document.getElementById('fleaDuration').value = c.offerDurationHours;
    document.getElementById('fleaRestock').value = c.restockIntervalMinutes;
    document.getElementById('fleaBarterEnabled').checked = c.barterOffersEnabled;
    document.getElementById('fleaBarterFreq').value = c.barterOfferFrequency;
    document.getElementById('fleaBarterFreqVal').value = c.barterOfferFrequency;
    fleaBarterToggled();
    document.getElementById('fleaDollarEnabled').checked = c.dollarOffersEnabled !== false;
    document.getElementById('fleaEuroEnabled').checked = c.euroOffersEnabled !== false;
    // Categories
    fleaRenderCategories();
    // Item overrides
    fleaRenderOverrides();
  }

  function fleaGatherConfig() {
    var c = fleaConfig || {};
    c.globalBuyMultiplier = parseFloat(document.getElementById('fleaGlobalBuyVal').value) || 1.0;
    c.dynamicPriceVariance = parseFloat(document.getElementById('fleaVariance').value) || 0;
    c.minPriceRoubles = parseInt(document.getElementById('fleaMinPrice').value) || 1;
    c.maxPriceRoubles = parseInt(document.getElementById('fleaMaxPrice').value) || 50000000;
    c.fleaTaxMultiplier = parseFloat(document.getElementById('fleaTaxVal').value) || 1.0;
    c.playerMaxOffers = parseInt(document.getElementById('fleaMaxOffers').value) || 2;
    c.offerDurationHours = parseInt(document.getElementById('fleaDuration').value) || 24;
    c.restockIntervalMinutes = parseInt(document.getElementById('fleaRestock').value) || 60;
    c.barterOffersEnabled = document.getElementById('fleaBarterEnabled').checked;
    c.barterOfferFrequency = parseInt(document.getElementById('fleaBarterFreqVal').value) || 15;
    c.dollarOffersEnabled = document.getElementById('fleaDollarEnabled').checked;
    c.euroOffersEnabled = document.getElementById('fleaEuroEnabled').checked;
    // Gather category multipliers — all categories sent (stacking: global × category)
    c.categoryMultipliers = {};
    fleaCategories.forEach(function(cat) {
      var buyEl = document.getElementById('fleaCatBuy_' + cat.key);
      if (buyEl) {
        c.categoryMultipliers[cat.key] = {
          buyMultiplier: parseFloat(buyEl.value) || 1.0
        };
      }
    });
    return c;
  }

  window.fleaApplyAndRegenerate = function() {
    var btn = document.getElementById('fleaApplyBtn');
    var txt = document.getElementById('fleaApplyText');
    var spin = document.getElementById('fleaApplySpinner');
    btn.disabled = true;
    txt.textContent = 'Applying...';
    spin.style.display = '';

    // Track if tax changed to show restart notice
    var oldTax = fleaConfig ? fleaConfig.fleaTaxMultiplier : 1.0;
    var cfg = fleaGatherConfig();
    var taxChanged = Math.abs(cfg.fleaTaxMultiplier - oldTax) > 0.001;

    fleaLoggedFetch('flea/config', { method: 'POST', body: JSON.stringify(cfg) })
    .then(function(savedConfig) {
      fleaConfig = savedConfig;
      txt.textContent = 'Regenerating offers...';
      return fleaLoggedFetch('flea/regenerate', { method: 'POST' });
    })
    .then(function(regen) {
      if (regen.success) {
        toast('Regenerated ' + regen.offerCount.toLocaleString() + ' offers in ' + regen.durationMs + 'ms', 'success');
        // Show restart notice if tax was changed
        if (taxChanged) {
          var notice = document.getElementById('fleaTaxRestartNotice');
          if (notice) notice.style.display = 'flex';
        }
      } else {
        toast('Regeneration failed: ' + (regen.error || 'Unknown error'), 'error');
      }
      fleaDirty = false;
      fleaUpdateApplyBtn();
      return fleaLoggedFetch('flea/status', { method: 'GET' });
    })
    .then(function(status) {
      fleaUpdateStatus(status);
    })
    .catch(function(e) {
      toast('Error: ' + e.message, 'error');
    })
    .finally(function() {
      btn.disabled = false;
      txt.textContent = 'Apply & Regenerate Offers';
      spin.style.display = 'none';
      if (fleaDirty) btn.disabled = false;
    });
  };

  function fleaMarkDirty() {
    fleaDirty = true;
    fleaUpdateApplyBtn();
  }

  function fleaUpdateApplyBtn() {
    var btn = document.getElementById('fleaApplyBtn');
    btn.disabled = !fleaDirty;
    btn.classList.toggle('dirty', fleaDirty);
    // Update nav unsaved indicator
    var navBtn = document.querySelector('.nav-btn[data-nav="flea"]');
    if (navBtn) {
      var dot = navBtn.querySelector('.flea-unsaved-dot');
      if (!dot) {
        dot = document.createElement('span');
        dot.className = 'flea-unsaved-dot';
        navBtn.appendChild(dot);
      }
      dot.classList.toggle('visible', fleaDirty);
    }
  }

  window.fleaSliderChanged = function(sliderId, numId, isPercent) {
    var v = parseFloat(document.getElementById(sliderId).value);
    document.getElementById(numId).value = isPercent ? Math.round(v * 100) : v;
    fleaMarkDirty();
  };

  window.fleaNumChanged = function(numId, sliderId) {
    var v = parseFloat(document.getElementById(numId).value);
    if (!isNaN(v)) document.getElementById(sliderId).value = v;
    fleaMarkDirty();
  };

  window.fleaVarianceNumChanged = function() {
    var v = parseInt(document.getElementById('fleaVarianceVal').value) || 0;
    document.getElementById('fleaVariance').value = v / 100;
    fleaMarkDirty();
  };

  window.fleaBarterToggled = function() {
    var on = document.getElementById('fleaBarterEnabled').checked;
    document.getElementById('fleaBarterFreq').disabled = !on;
    document.getElementById('fleaBarterFreqVal').disabled = !on;
    fleaMarkDirty();
  };

  // ── Flea Presets ──
  function fleaRefreshPresets() {
    fleaLoggedFetch('flea/presets', { method: 'GET' }).then(function(data) {
      var sel = document.getElementById('fleaPresetSelect');
      var prev = sel.value;
      sel.innerHTML = '<option value="">— Select a preset —</option>';
      (data.presets || []).forEach(function(p) {
        var opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name + (p.description ? ' — ' + p.description : '');
        sel.appendChild(opt);
      });
      if (prev) sel.value = prev;
    }).catch(function() {});
  }

  window.fleaSavePreset = function() {
    var name = document.getElementById('fleaPresetName').value.trim();
    if (!name) { toast('Enter a preset name', 'error'); return; }
    fleaLoggedFetch('flea/presets', {
      method: 'POST',
      body: JSON.stringify({ name: name, description: '' })
    }).then(function() {
      toast('Preset "' + name + '" saved', 'success');
      document.getElementById('fleaPresetName').value = '';
      fleaRefreshPresets();
    }).catch(function(e) { toast('Save failed: ' + e.message, 'error'); });
  };

  window.fleaLoadPreset = function() {
    var name = document.getElementById('fleaPresetSelect').value;
    if (!name) { toast('Select a preset first', 'error'); return; }
    fleaLoggedFetch('flea/presets/load', {
      method: 'POST',
      body: JSON.stringify({ name: name })
    }).then(function(preset) {
      if (preset && preset.config) {
        fleaConfig = preset.config;
        fleaPopulateUI();
        fleaMarkDirty();
        toast('Loaded preset "' + name + '" — click Apply to activate', 'success');
      } else {
        toast('Preset not found', 'error');
      }
    }).catch(function(e) { toast('Load failed: ' + e.message, 'error'); });
  };

  window.fleaDeletePreset = function() {
    var name = document.getElementById('fleaPresetSelect').value;
    if (!name) { toast('Select a preset first', 'error'); return; }
    if (!confirm('Delete preset "' + name + '"?')) return;
    fleaLoggedFetch('flea/presets/' + encodeURIComponent(name), {
      method: 'DELETE'
    }).then(function() {
      toast('Deleted preset "' + name + '"', 'success');
      fleaRefreshPresets();
    }).catch(function(e) { toast('Delete failed: ' + e.message, 'error'); });
  };

  window.fleaExportPreset = function() {
    var cfg = fleaGatherConfig();
    var preset = { name: 'exported', description: 'Exported from Command Center', config: cfg };
    var json = JSON.stringify(preset, null, 2);
    navigator.clipboard.writeText(json).then(function() {
      toast('Config copied to clipboard', 'success');
    }).catch(function() {
      // Fallback: show in import area
      document.getElementById('fleaImportArea').style.display = 'block';
      document.getElementById('fleaImportJson').value = json;
      toast('Clipboard failed — JSON shown below', 'warning');
    });
  };

  window.fleaShowImport = function() {
    var area = document.getElementById('fleaImportArea');
    area.style.display = area.style.display === 'none' ? 'block' : 'none';
    document.getElementById('fleaImportJson').value = '';
  };

  window.fleaImportPreset = function() {
    var json = document.getElementById('fleaImportJson').value.trim();
    if (!json) { toast('Paste preset JSON first', 'error'); return; }
    var preset;
    try { preset = JSON.parse(json); } catch(e) { toast('Invalid JSON: ' + e.message, 'error'); return; }
    // Accept either a full preset object or just a config object
    var config = preset.config || preset;
    if (!config.globalBuyMultiplier && config.globalBuyMultiplier !== 0) {
      toast('Invalid preset — missing config data', 'error'); return;
    }
    // If it has a name, import it to the server
    if (preset.name && preset.config) {
      fleaLoggedFetch('flea/presets/import', {
        method: 'POST',
        body: JSON.stringify(preset)
      }).then(function() {
        fleaConfig = preset.config;
        fleaPopulateUI();
        fleaMarkDirty();
        document.getElementById('fleaImportArea').style.display = 'none';
        fleaRefreshPresets();
        toast('Imported "' + preset.name + '" — click Apply to activate', 'success');
      }).catch(function(e) { toast('Import failed: ' + e.message, 'error'); });
    } else {
      // Just a config blob — load directly into UI
      fleaConfig = config;
      fleaPopulateUI();
      fleaMarkDirty();
      document.getElementById('fleaImportArea').style.display = 'none';
      toast('Config loaded — click Apply to activate', 'success');
    }
  };

  // ── Category cards ──
  function fleaRenderCategories() {
    var grid = document.getElementById('fleaCategoryGrid');
    if (!fleaCategories.length) {
      grid.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:20px;text-align:center;grid-column:1/-1">No categories loaded</div>';
      return;
    }
    var catMults = (fleaConfig && fleaConfig.categoryMultipliers) || {};
    var html = '';
    fleaCategories.forEach(function(cat) {
      var m = catMults[cat.key] || { buyMultiplier: 1.0 };
      var isModified = m.buyMultiplier !== 1.0;
      html += '<div class="flea-cat-card' + (isModified ? ' modified' : '') + '" id="fleaCatCard_' + cat.key + '">';
      html += '<div class="flea-cat-card-header">';
      html += '<div><span class="flea-cat-name">' + escH(cat.name) + '</span> <span class="flea-cat-count">' + cat.itemCount + '</span></div>';
      html += '<button class="flea-cat-reset" onclick="fleaCatReset(\'' + escA(cat.key) + '\')">Reset</button>';
      html += '</div>';
      html += '<div class="flea-cat-slider-row"><label>Mult</label>';
      html += '<input type="range" min="0.1" max="10" step="0.1" value="' + m.buyMultiplier + '" id="fleaCatBuySlider_' + cat.key + '" oninput="fleaCatSlider(\'' + escA(cat.key) + '\')">';
      html += '<input type="number" class="cc-num-input" min="0.1" max="10" step="0.1" value="' + m.buyMultiplier + '" id="fleaCatBuy_' + cat.key + '" oninput="fleaCatNum(\'' + escA(cat.key) + '\')">';
      html += '<span style="font-size:11px;color:var(--text-dim)">&times;</span></div>';
      html += '</div>';
    });
    grid.innerHTML = html;
  }

  window.fleaCatSlider = function(key) {
    var v = parseFloat(document.getElementById('fleaCatBuySlider_' + key).value);
    document.getElementById('fleaCatBuy_' + key).value = v;
    fleaCatUpdateCard(key);
    fleaMarkDirty();
  };

  window.fleaCatNum = function(key) {
    var v = parseFloat(document.getElementById('fleaCatBuy_' + key).value);
    if (!isNaN(v)) document.getElementById('fleaCatBuySlider_' + key).value = v;
    fleaCatUpdateCard(key);
    fleaMarkDirty();
  };

  window.fleaCatReset = function(key) {
    document.getElementById('fleaCatBuy_' + key).value = 1.0;
    document.getElementById('fleaCatBuySlider_' + key).value = 1.0;
    fleaCatUpdateCard(key);
    fleaMarkDirty();
  };

  function fleaCatUpdateCard(key) {
    var card = document.getElementById('fleaCatCard_' + key);
    if (!card) return;
    var b = parseFloat(document.getElementById('fleaCatBuy_' + key).value) || 1.0;
    card.classList.toggle('modified', b !== 1.0);
  }

  // ── Per-item overrides ──
  window.fleaToggleOverrides = function() {
    fleaOverridesOpen = !fleaOverridesOpen;
    document.getElementById('fleaOverridePanel').style.display = fleaOverridesOpen ? '' : 'none';
    document.getElementById('fleaOverrideArrow').style.transform = fleaOverridesOpen ? 'rotate(90deg)' : '';
  };

  function fleaRenderOverrides() {
    var overrides = (fleaConfig && fleaConfig.itemOverrides) || {};
    var keys = Object.keys(overrides);
    document.getElementById('fleaOverrideCount').textContent = keys.length;
    var el = document.getElementById('fleaOverrideTable');
    if (!keys.length) {
      el.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:16px;text-align:center">No item overrides. Search above to add items.</div>';
      return;
    }
    var html = '<table class="flea-override-table"><thead><tr><th>Item Name</th><th>Template ID</th><th>Multiplier</th><th></th></tr></thead><tbody>';
    keys.forEach(function(tpl) {
      var o = overrides[tpl];
      html += '<tr>';
      html += '<td>' + escH(o.name) + '</td>';
      html += '<td style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim)">' + escH(tpl.substring(0, 12)) + '...</td>';
      html += '<td><input type="number" class="cc-num-input" min="0.01" max="100" step="0.01" value="' + o.buyMultiplier + '" onchange="fleaOverrideChanged(\'' + escA(tpl) + '\',this.value)"></td>';
      html += '<td><button class="flea-override-remove" onclick="fleaRemoveOverride(\'' + escA(tpl) + '\')">Remove</button></td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    el.innerHTML = html;
  }

  window.fleaOverrideChanged = function(tpl, val) {
    if (!fleaConfig || !fleaConfig.itemOverrides || !fleaConfig.itemOverrides[tpl]) return;
    fleaConfig.itemOverrides[tpl].buyMultiplier = parseFloat(val) || 1.0;
    fleaMarkDirty();
  };

  window.fleaRemoveOverride = function(tpl) {
    if (!fleaConfig || !fleaConfig.itemOverrides) return;
    delete fleaConfig.itemOverrides[tpl];
    fleaRenderOverrides();
    fleaMarkDirty();
  };

  function fleaItemSearchDebounce() {
    clearTimeout(fleaItemSearchTimer);
    fleaItemSearchTimer = setTimeout(fleaItemSearch, 300);
  }

  function fleaItemSearch() {
    var q = document.getElementById('fleaItemSearch').value.trim();
    var resultsEl = document.getElementById('fleaItemSearchResults');
    if (q.length < 2) { resultsEl.style.display = 'none'; return; }
    api('flea/items/search?q=' + encodeURIComponent(q)).then(function(data) {
      var items = data.items || [];
      if (!items.length) {
        resultsEl.innerHTML = '<div style="padding:12px;color:var(--text-dim);font-size:13px;text-align:center">No items found</div>';
        resultsEl.style.display = '';
        return;
      }
      var html = '';
      items.forEach(function(item) {
        html += '<div class="flea-search-item" onclick="fleaAddOverride(\'' + escA(item.templateId) + '\',\'' + escA(item.name) + '\')">';
        html += '<div><strong>' + escH(item.name) + '</strong> <span style="font-size:11px;color:var(--text-dim)">' + escH(item.category) + '</span></div>';
        html += '<span style="font-family:var(--font-mono);font-size:12px;color:var(--accent)">&#8381;' + (item.basePrice || 0).toLocaleString() + '</span>';
        html += '</div>';
      });
      resultsEl.innerHTML = html;
      resultsEl.style.display = '';
    }).catch(function() { resultsEl.style.display = 'none'; });
  }

  window.fleaAddOverride = function(tpl, name) {
    if (!fleaConfig) fleaConfig = {};
    if (!fleaConfig.itemOverrides) fleaConfig.itemOverrides = {};
    if (fleaConfig.itemOverrides[tpl]) {
      toast(name + ' already has an override', 'info');
      return;
    }
    fleaConfig.itemOverrides[tpl] = { name: name, buyMultiplier: 1.0 };
    fleaRenderOverrides();
    fleaMarkDirty();
    document.getElementById('fleaItemSearch').value = '';
    document.getElementById('fleaItemSearchResults').style.display = 'none';
    toast('Added override for ' + name, 'success');
    // Auto-open overrides if closed
    if (!fleaOverridesOpen) fleaToggleOverrides();
  };

  // Close search results when clicking outside
  document.addEventListener('click', function(e) {
    var results = document.getElementById('fleaItemSearchResults');
    var search = document.getElementById('fleaItemSearch');
    if (results && search && !results.contains(e.target) && e.target !== search) {
      results.style.display = 'none';
    }
  });

  function fleaUpdateStatus(status) {
    if (!status) return;
    var regenEl = document.getElementById('fleaStatusRegen');
    var offersEl = document.getElementById('fleaStatusOffers');
    if (status.lastRegeneratedUtc) {
      var d = new Date(status.lastRegeneratedUtc);
      var ago = Math.round((Date.now() - d.getTime()) / 60000);
      regenEl.textContent = 'Last regenerated: ' + (ago < 1 ? 'Just now' : ago + 'm ago');
    } else {
      regenEl.textContent = 'Last regenerated: Never';
    }
    offersEl.textContent = 'Active offers: ' + (status.activeOfferCount != null ? status.activeOfferCount.toLocaleString() : '—');
  }

  // ── Debug Panel ──
  var fleaDebugOpen = false;
  var fleaApiLog = [];

  window.fleaToggleDebug = function() {
    fleaDebugOpen = !fleaDebugOpen;
    document.getElementById('fleaDebugPanel').style.display = fleaDebugOpen ? '' : 'none';
    document.getElementById('fleaDebugArrow').style.transform = fleaDebugOpen ? 'rotate(90deg)' : '';
  };

  window.fleaRunDiagnostic = function() {
    var el = document.getElementById('fleaDiagResult');
    el.innerHTML = '<div style="color:var(--text-dim)">Running diagnostic...</div>';
    fleaLoggedFetch('flea/debug', { method: 'GET' })
    .then(function(data) {
      var html = '<div style="background:var(--bg-dark);border-radius:4px;padding:12px;margin-bottom:8px">';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">';
      html += '<div><span style="color:var(--text-dim);font-size:11px">Price Modification</span><br><span style="color:' + (data.priceModificationActive ? '#4caf50' : '#f44336') + ';font-weight:600">' + (data.priceModificationActive ? 'ACTIVE' : 'INACTIVE') + '</span></div>';
      html += '<div><span style="color:var(--text-dim);font-size:11px">Prices in Table</span><br><span style="color:var(--text-main);font-weight:600">' + (data.totalPricesInTable || 0).toLocaleString() + '</span></div>';
      html += '<div><span style="color:var(--text-dim);font-size:11px">Modified Prices</span><br><span style="color:' + (data.modifiedPriceCount > 0 ? 'var(--accent)' : 'var(--text-dim)') + ';font-weight:600">' + (data.modifiedPriceCount || 0).toLocaleString() + '</span></div>';
      html += '</div>';
      html += '<div style="font-size:11px;color:var(--text-dim);margin-bottom:6px">Global Multiplier: <span style="color:var(--accent)">' + (data.currentGlobalMultiplier || 1.0) + 'x</span></div>';
      if (data.samples && data.samples.length) {
        html += '<table style="width:100%;font-size:11px;border-collapse:collapse">';
        html += '<tr style="color:var(--text-dim);text-align:left"><th style="padding:4px 6px">Item</th><th style="padding:4px 6px;text-align:right">Original</th><th style="padding:4px 6px;text-align:right">Current</th><th style="padding:4px 6px;text-align:right">Mult</th><th style="padding:4px 6px">Source</th></tr>';
        data.samples.forEach(function(s) {
          var changed = Math.abs(s.originalPrice - s.currentPrice) > 0.5;
          var color = changed ? 'var(--accent)' : 'var(--text-main)';
          html += '<tr style="border-top:1px solid var(--bg-panel)">';
          html += '<td style="padding:4px 6px;color:var(--text-main)">' + s.name + '</td>';
          html += '<td style="padding:4px 6px;text-align:right;color:var(--text-dim)">' + Math.round(s.originalPrice).toLocaleString() + '</td>';
          html += '<td style="padding:4px 6px;text-align:right;color:' + color + ';font-weight:600">' + Math.round(s.currentPrice).toLocaleString() + '</td>';
          html += '<td style="padding:4px 6px;text-align:right;color:var(--text-main)">' + s.effectiveMultiplier.toFixed(2) + 'x</td>';
          html += '<td style="padding:4px 6px;color:var(--text-dim)">' + s.multiplierSource + '</td>';
          html += '</tr>';
        });
        html += '</table>';
      }
      html += '</div>';
      el.innerHTML = html;
    })
    .catch(function(e) {
      el.innerHTML = '<div style="color:#f44336">Diagnostic failed: ' + e.message + '</div>';
    });
  };

  // Logged fetch wrapper for API log
  function fleaLoggedFetch(path, options) {
    var entry = {
      time: new Date().toISOString().substr(11, 12),
      method: (options && options.method) || 'GET',
      path: path,
      requestBody: null,
      status: null,
      responseBody: null,
      durationMs: 0
    };
    if (options && options.body) {
      try { entry.requestBody = JSON.parse(options.body); } catch(e) { entry.requestBody = options.body; }
    }
    var start = Date.now();
    return api(path, options).then(function(data) {
      entry.durationMs = Date.now() - start;
      entry.status = 200;
      entry.responseBody = data;
      fleaApiLog.unshift(entry);
      if (fleaApiLog.length > 10) fleaApiLog.pop();
      fleaRenderApiLog();
      return data;
    }).catch(function(err) {
      entry.durationMs = Date.now() - start;
      entry.status = 'ERR';
      entry.responseBody = { error: err.message };
      fleaApiLog.unshift(entry);
      if (fleaApiLog.length > 10) fleaApiLog.pop();
      fleaRenderApiLog();
      throw err;
    });
  }

  function fleaRenderApiLog() {
    var el = document.getElementById('fleaApiLogPanel');
    if (!el) return;
    if (!fleaApiLog.length) {
      el.innerHTML = '<div style="color:var(--text-dim);padding:4px">No API calls logged yet</div>';
      return;
    }
    var html = '';
    fleaApiLog.forEach(function(e) {
      var statusColor = e.status === 200 ? '#4caf50' : '#f44336';
      html += '<div style="border-bottom:1px solid var(--bg-panel);padding:4px 0">';
      html += '<span style="color:var(--text-dim)">' + e.time + '</span> ';
      html += '<span style="color:var(--accent);font-weight:600">' + e.method + '</span> ';
      html += '<span style="color:var(--text-main)">' + e.path + '</span> ';
      html += '<span style="color:' + statusColor + '">' + e.status + '</span> ';
      html += '<span style="color:var(--text-dim)">' + e.durationMs + 'ms</span>';
      if (e.requestBody) {
        var reqStr = JSON.stringify(e.requestBody);
        if (reqStr.length > 300) reqStr = reqStr.substr(0, 300) + '...';
        html += '<div style="color:var(--text-dim);padding-left:12px;word-break:break-all">REQ: ' + reqStr + '</div>';
      }
      if (e.responseBody) {
        var resStr = JSON.stringify(e.responseBody);
        if (resStr.length > 300) resStr = resStr.substr(0, 300) + '...';
        html += '<div style="color:var(--text-dim);padding-left:12px;word-break:break-all">RES: ' + resStr + '</div>';
      }
      html += '</div>';
    });
    el.innerHTML = html;
  }

  // ═══════════════════════════════════════════════════════
  function escH(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
  function escA(s) { return s ? s.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"') : ''; }

  // ═══════════════════════════════════════════════════════
  // HASH NAVIGATION
  // ═══════════════════════════════════════════════════════
  window.addEventListener('hashchange', function() {
    var hash = window.location.hash.replace('#', '');
    if (hash && document.getElementById('main-' + hash)) {
      switchMainTab(hash);
    }
  });

  // ═══════════════════════════════════════════════════════
  // AUTO-LOGIN + PROFILE LIST
  // ═══════════════════════════════════════════════════════
  if (sessionId) {
    api('auth').then(function(data) {
      if (data.authorized) { profileName = data.profileName; showMain(); }
      else { sessionId = ''; ccPassword = ''; localStorage.removeItem('zslayer_session'); localStorage.removeItem('zslayer_password'); loadProfileList(); startVitalsPolling(); }
    }).catch(function() { sessionId = ''; ccPassword = ''; localStorage.removeItem('zslayer_session'); localStorage.removeItem('zslayer_password'); loadProfileList(); startVitalsPolling(); });
  } else {
    loadProfileList();
    startVitalsPolling();
  }
})();
</script>
</body>
</html>
